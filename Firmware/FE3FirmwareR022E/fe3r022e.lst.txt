------- FILE fe3r022e.asm LEVEL 1 PASS 3
      1  c000 ????						; VIC 20 Final Expansion Cartridge - Revision 022
      2  c000 ????						; Thomas Winkler - Sep. 2009
      3  c000 ????
      4  c000 ????						; Thanks to Leif Bloomquist
      5  c000 ????						; Thanks to everyone on the Denial forums
      6  c000 ????						; http://www.sleepingelephant.com/denial/
      7  c000 ????						; Flash patch r021 by Nils Eilers
      8  c000 ????						; firmware patch r022d by Dirk Vroomen, April 2014 (full ram for loader-files)
      9  c000 ????						; firmware patch r022e by Dirk Vroomen, May 2015   (Basic-Relinker call missing)
     10  c000 ????
     11  c000 ????				      processor	6502	;VIC20
     12  c000 ????
     13  9000					      org	$9000,0	;Modulstart (Fill value=0)
     14  9000
     15  9000					      rorg	$7000
     16  9000
     17  9000
     18  9000
     19  9000							;------------------------------
     20  9000		       03 3c	   CAS_BUF    =	$033c	;CASSETTE BUFFER
     21  9000		       03 3c	   F_IO       =	CAS_BUF +0	;IO FLAG
     22  9000		       03 3d	   F_WE       =	CAS_BUF +1	;WEDGE FLAG
     23  9000		       03 3e	   F_CURDEV   =	CAS_BUF +2	;WEDGE FLAG
     24  9000		       03 3f	   F_JOYREP   =	CAS_BUF +3	;JOYSTICK TIMER
     25  9000
     26  9000		       03 40	   MY_WEDGE_LO =	CAS_BUF +4	;WEDGE LOW ADDRESS
     27  9000
     28  9000		       03 41	   F_END      =	CAS_BUF +5
     29  9000							;------------------------------
     30  9000
     31  9000
     32  9000		       00 08	   FLGCOM     =	$08
     33  9000
     34  9000
     35  9000		       00 7a	   CHRPTR     =	$7a	;Char Pointer
     36  9000		       00 22	   PT1	      =	$22	;Pointer
     37  9000		       00 24	   PT2	      =	$24	;Pointer
     38  9000		       00 14	   PT3	      =	$14	;Pointer
     39  9000
     40  9000		       00 61	   FAC	      =	$61
     41  9000
     42  9000		       00 d1	   C_LINE     =	$d1	;pointer current line char RAM
     43  9000		       00 f3	   C_COLP     =	$f3	;pointer current line color RAM
     44  9000
     45  9000		       00 d4	   C_CTRL     =	$d4	;control mode
     46  9000
     47  9000		       00 d6	   C_ROW      =	$d6	;cursor row
     48  9000		       00 d3	   C_COL      =	$d3	;cursor column
     49  9000		       00 d7	   C_CHR      =	$d7	;cuurent char
     50  9000
     51  9000
     52  9000		       00 2b	   BASSTRT    =	$2B	;BASIC START
     53  9000		       00 2d	   BASVAR     =	$2d	;BASIC VARS
     54  9000		       00 2f	   BASARR     =	$2f	;BASIC ARRAYS
     55  9000		       00 31	   BASAEND    =	$31	;BASIC ARRAYS END
     56  9000		       00 33	   BASSTR     =	$33	;BASIC STRINGS
     57  9000		       00 35	   STRPTR     =	$35	;STRING POINTER
     58  9000		       00 37	   BASEND     =	$37	;BASIC END
     59  9000
     60  9000		       00 c1	   SAVESTART  =	$c1
     61  9000		       00 c3	   LOADPTR    =	$c3
     62  9000		       00 ac	   LOADSTART  =	$ac
     63  9000		       00 ae	   LOADEND    =	$ae
     64  9000
     65  9000		       00 c6	   KEYANZ     =	$c6
     66  9000
     67  9000
     68  9000		       00 90	   IECSTAT    =	$90
     69  9000
     70  9000		       00 b7	   LEN_FNAM   =	$b7
     71  9000		       00 bb	   PTR_FNAM   =	$bb
     72  9000
     73  9000		       00 93	   SY_VERIFY  =	$93
     74  9000		       00 90	   SY_STATUS  =	$90
     75  9000		       00 b9	   SY_SA      =	$b9
     76  9000		       00 ba	   SY_DN      =	$ba
     77  9000		       00 b8	   SY_FN      =	$b8
     78  9000
     79  9000		       00 9d	   DIRECT_MODE =	$9d	;Direct=$80/RUN=0
     80  9000
     81  9000
     82  9000		       00 73	   CHRGET     =	$0073	;GET NEXT CHAR
     83  9000		       00 79	   CHRGOT     =	$0079	;GET LAST CHAR
     84  9000
     85  9000		       02 00	   BIP	      =	$0200	;BASIC Input Buffer 88 Bytes
     86  9000		       02 58	   BIP_E      =	BIP +88	;BASIC Input Buffer End - Stack
     87  9000		       01 00	   STP	      =	$0100	;LOW Stack - Text Buffer
     88  9000
     89  9000
     90  9000		       9c 02	   IO_FINAL   =	$9c02	;FINAL EXPANSION REGISTER 1 (39938,39939)
     91  9000
     92  9000		       00 00	   FEMOD_START =	$00	;MODE START
     93  9000		       00 40	   FEMOD_ROM  =	$40	;MODE EEPROM (READ EEPROM, WRITE RAM)
     94  9000		       00 20	   FEMOD_FLASH =	$20	;MODE FLASH EEPROM (READ EEPROM, WRITE EEPROM)
     95  9000		       00 80	   FEMOD_RAM_1 =	$80	;MODE RAM 1 (READ::BANK 1,WRITE::BANK 1/2)
     96  9000		       00 c0	   FEMOD_RAM_2 =	$C0	;MODE RAM 2 (WRITE::BANK 1,READ::BANK 1/2)
     97  9000		       00 a0	   FEMOD_SRAM =	$A0	;MODE BIG SRAM (SRAM 512KB, BANK 0 TO 15)
     98  9000
     99  9000		       fd 22	   SOFT_RESET =	$fd22	;SOFT RESET
    100  9000		       e5 0a	   CURSOR_POS =	$e50a
    101  9000
    102  9000		       ff d2	   BSOUT      =	$ffd2
    103  9000		       ff e4	   GETIN      =	$ffe4
    104  9000
    105  9000
    106  9000
    107  9000		       ff c0	   OPEN       =	$ffc0	; Open Vector [F40A] Open File
    108  9000							; Preparing: SETLFS, SETNAM
    109  9000		       ff c3	   CLOSE      =	$ffc3	; Close Vector [F34A] Close File
    110  9000		       ff ba	   SETLFS     =	$ffba	; Set Logical File Parameters
    111  9000		       ff bd	   SETNAM     =	$ffbd	; Set Filename / Command
    112  9000		       ff d5	   LOAD       =	$ffd5	; Load RAM From Device
    113  9000							;CHROUT  = $ffd2     ; Output Vector, chrout [F27A] Output One Character
    114  9000							; Preparing: OPEN, CHKOUT (not for video output)
    115  9000		       ff c6	   CHKIN      =	$ffc6	; Set Input [F2C7] Set Input Device
    116  9000							; Preparing: OPEN
    117  9000		       ff cf	   CHRIN      =	$ffcf	; Input Vector, chrin [F20E] Input a byte
    118  9000							; Preparing: OPEN, CHKIN
    119  9000		       cb 1e	   PRNSTR     =	$cb1e	; print string in A/Y, 0 terminated
    120  9000		       dd cd	   PRNINT     =	$ddcd	; print integer in X/A
    121  9000		       c4 37	   PRNERR     =	$c437	; print basic error message in X = (from $01 to $1e)
    122  9000		       e4 67	   BASSFT     =	$e467	; BASIC Warm Restart [RUNSTOP-RESTORE]
    123  9000		       00 79	   CHRGETSUB  =	$0079	; CHRGET subroutine return point after modify
    124  9000		       c3 bf	   SY_MOVEMEM =	$c3bf	; Move memory from (start($5f-$60)/end+1($5a-$5b)) to (end+1($58-$59))
    125  9000		       ff e4	   GETIN      =	$ffe4	; Get a byte From Keyboad or serial device
    126  9000		       cd 9e	   FRMEVL     =	$cd9e	; Evaluate Expression in Text
    127  9000		       fd 22	   RESET      =	$fd22	; Reset Vic
    128  9000		       c4 74	   READY      =	$c474	; Restart BASIC
    129  9000		       e5 18	   CINT1      =	$e518	; Initialize I/O
    130  9000		       e5 5f	   CLRSCN     =	$e55f	; clear screen
    131  9000
    132  9000							; TurboLoad
    133  9000		       ff 93	   secnd      =	$ff93	; send secondary address for LISTEN
    134  9000		       ff a8	   ciout      =	$ffa8	; write serial data
    135  9000		       ff ae	   unlsn      =	$ffae	; send UNLISTEN command
    136  9000		       ff b1	   listn      =	$ffb1	; send LISTEN command
    137  9000		       00 ba	   fa	      =	$ba	; Current Device Number
    138  9000
    139  9000		       ff cc	   CLRCH      =	$ffcc	; Restore Default I/O status
    140  9000
    141  9000		       00 ba	   dir_current_device =	$ba
    142  9000		       00 d3	   dir_current_curposline =	$d3
    143  9000		       00 90	   dir_status_word_st =	$90
    144  9000		       00 c7	   dir_reverse_flag =	$c7
    145  9000		       00 2b	   dir_basicstartaddress_lo =	$2b
    146  9000		       00 2c	   dir_basicstartaddress_hi =	$2c
    147  9000
    148  9000		       00 3a	   dir_basiclinenumber_hi =	$3a
    149  9000		       00 22	   dir_index1_lo =	$22
    150  9000		       00 23	   dir_index1_hi =	$23
    151  9000		       00 7a	   dir_basicpointer_lo =	$7a
    152  9000		       00 7b	   dir_basicpointer_hi =	$7b
    153  9000		       00 9b	   dir_tapecharparity =	$9b	;unmovable ???
    154  9000		       00 c5	   dir_current_key =	$c5
    155  9000		       00 c6	   dir_chars_in_key_buffer =	$c6
    156  9000		       00 9d	   dir_output_control =	$9d	;Direct=$80/RUN=0
    157  9000		       00 ce	   dir_char_under_cursor =	$ce
    158  9000
    159  9000							; TurboLoad
    160  9000		       00 90	   fl_status_word_st =	$90
    161  9000		       00 93	   fl_load_verify_flag =	$93	; Load=0 else Verify
    162  9000		       00 ba	   fl_current_device =	$ba
    163  9000		       00 b7	   fl_char_in_file_name =	$b7
    164  9000		       00 bb	   fl_filename_pointer_lo =	$bb
    165  9000		       00 bc	   fl_filename_pointer_hi =	$bc
    166  9000		       00 b9	   fl_current_sa =	$b9
    167  9000		       00 b8	   fl_current_logical_file =	$b8
    168  9000		       00 ae	   fl_endprogram_address_lo =	$ae	; is used as temp pointer of code
    169  9000		       00 af	   fl_endprogram_address_hi =	$af	; to send to the drive too
    170  9000		       00 bb	   fl_filename_pointer =	$bb	; $BB-$BC Pointer: to file name
    171  9000		       00 9d	   fl_output_control =	$9d	; Direct=$80/RUN=0 
    172  9000
    173  9000		       00 2b	   fl_basicstartaddress_lo =	$2b
    174  9000		       00 2c	   fl_basicstartaddress_hi =	$2c
    175  9000
    176  9000							; ----- other zero page locations (movable) ------
    177  9000
    178  9000		       00 fd	   dir_old_key =	$fd
    179  9000		       00 fe	   dir_command_set =	$fe
    180  9000
    181  9000							; TurboLoad
    182  9000							; $f7-$fa is RS232 pointers, $fb-$fe is unused
    183  9000		       00 f7	   iec0d1a    =	$f7
    184  9000		       00 f8	   iec0d1b    =	$f8
    185  9000		       00 f9	   iec1d1a    =	$f9
    186  9000		       00 fa	   iec1d1b    =	$fa
    187  9000
    188  9000		       00 fc	   store      =	$fc
    189  9000
    190  9000		       00 f7	   mwcmd      =	$f7	;f7-fc used first to temp store SETLFS & SETNAM parameters
    191  9000							;	and after to send the "M-W" command to the drive.
    192  9000							;	Since these operations are made before the
    193  9000							;	fastloading process i share the same location of
    194  9000							;	iec0d1a,iec0d1b,iec1d1a,iec1d1b and store variables.
    195  9000							;	Used as temp value for loader start routine too.
    196  9000
    197  9000							; shared address because used with CTRL+F1/F3/F5/F7 
    198  9000		       00 f7	   From_Lo    =	$f7	;FB	    ;From address (lo-byte)
    199  9000		       00 f8	   From_Hi    =	$f8	;FC	    ;From address (hi-byte)
    200  9000		       00 f9	   To_Lo      =	$f9	;FD	    ;to address (lo-byte)
    201  9000		       00 fa	   To_Hi      =	$fa	;FE	    ;ti address (hi-byte)
    202  9000
    203  9000							; **************** other page locations used ****************
    204  9000
    205  9000							; ----- used by the kernal (unmovable) ------
    206  9000		       02 8d	   dir_shift_ctrl_cbm_flag =	$028d
    207  9000		       02 77	   dir_keyboard_buffer =	$0277	;($0277-$0280)
    208  9000
    209  9000		       02 82	   dir_start_memory_hi =	$282	; Start of memory (hi-byte)
    210  9000		       02 84	   dir_top_memory_hi =	$284	; Top of memory (hi-byte)
    211  9000		       02 88	   dir_screen_mem_page =	$288	; Screen memory page start (hi-byte)
    212  9000
    213  9000
    214  9000							; **************** I/O constants ****************************
    215  9000
    216  9000							; TurboLoad
    217  9000		       00 20	   AMOUNT     =	$20	; amount of data bytes to transfer with one M-W command
    218  9000		       00 ef	   ESCBYTE    =	$ef	; the escape char used in the transfers
    219  9000		       00 14	   RETRIES    =	20	; amount of retries in reading a block
    220  9000
    221  9000		       00 08	   DEFAULT_DEVICE =	8	; Default device number
    222  9000
    223  9000		       00 d6	   CheckByte  =	#214
    224  9000
    225  9000		       91 2c	   iecport1   =	$912c	;$dd00	;$912c
    226  9000		       00 20	   dato       =	32	;32	;32
    227  9000		       00 02	   clko       =	2	;16	;2
    228  9000		       91 1f	   iecport2   =	$911f	;$dd00	;$911f
    229  9000		       00 80	   atno       =	128	;8	;128
    230  9000		       00 01	   clki       =	1	;64	;1
    231  9000		       00 02	   dati       =	2	;128	;2
    232  9000
    233  9000							; ***********************************************************************
    234  9000
    235  9000
    236  9000
    237  9000
    238  9000
    239  9000
    240  9000
    241  9000							; ==============================================================
    242  9000							; Startup screen
    243  9000							; ==============================================================
    244  9000
    245  9000				   STARTUPSCREEN
    246  9000							; dc.b CLRHOME, WHITE, CR, RVSON, "DISK UTILITY CARTRIDGE", CR, CR
    247  9000		       93 0e 9e 12*	      dc.b	CLRHOME,FONT2,YELLOW,RVSON,"*fINAL eXPANSION V3.2*", CR
    248  901b		       12 35 31 32*	      dc.b	RVSON, "512/512kb sYSTEM R022E", CR, CR, CR
    249  9035		       05 12 66 31*	      dc.b	WHITE,RVSON,"f1",RVSOFF," ram mANAGER", CR, CR
    250  9048							;  dc.b "",RVSON,"f2",RVSOFF,"  basic uN-new", CR, CR
    251  9048		       0d 0d		      dc.b	CR, CR
    252  904a		       12 66 33 92*	      dc.b	RVSON,"f3",RVSOFF," dISK lOADER", CR, CR
    253  905c		       12 66 34 92*	      dc.b	RVSON,"f4",RVSOFF,"  hELP", CR, CR
    254  9068		       12 66 35 92*	      dc.b	RVSON,"f5",RVSOFF," cART lOADER", CR, CR
    255  907a							;  dc.b CR, CR
    256  907a		       12 66 36 92*	      dc.b	RVSON,"f6",RVSOFF,"  fe3 uTILITIES", CR, CR
    257  908f							;  dc.b CR, CR
    258  908f		       05 12 66 37*	      dc.b	WHITE,RVSON,"f7",RVSOFF," basic (wEDGE)", CR, CR
    259  90a4		       12 66 38 92*	      dc.b	"",RVSON,"f8",RVSOFF,"  basic (NORMAL)", CR, CR, CR
    260  90bb		       12 2b 92 2f*	      dc.b	RVSON,"+",RVSOFF,"/",RVSON,"-",RVSOFF," dRIVE #"
    261  90ca		       00		      dc.b	$00
    262  90cb
    263  90cb
    264  90cb							; ==============================================================
    265  90cb							; Help screen
    266  90cb							; ==============================================================
    267  90cb
    268  90cb
    269  90cb				   HELPSCREEN
    270  90cb		       05		      dc.b	WHITE
    271  90cc				   HELPSCREEN3
    272  90cc		       93 0e 12 66*	      dc.b	CLRHOME,FONT2,RVSON,"fe3 wEDGE cOMMANDS", CR, CR	;RVSOFF Not Needed
    273  90e3		       24 20 20 64*	      dc.b	"$  dIRECTORY", CR
    274  90f0		       40 20 20 73*	      dc.b	AT, "	sTATUS/cOMMAND", CR
    275  9102		       2f 20 20 6c*	      dc.b	"/  lOAD", CR
    276  910a		       25 20 20 6c*	      dc.b	"%  lOAD bINARY", CR
    277  9119		       23 20 20 64*	      dc.b	"#  dRIVE", CR,CR
    278  9123		       4f 4c 44 2f*	      dc.b	"OLD/UNNEW basic", CR
    279  9133		       4b 49 4c 4c*	      dc.b	"KILL/OFF  END WEDGE", CR
    280  9147		       4e 4f 49 4f*	      dc.b	"NOIO/BLKD/BLKP", CR
    281  9156		       52 45 53 45*	      dc.b	"RESET", CR
    282  915c		       0d		      dc.b	CR	;RVSOFF Not Needed
    283  915d		       73 79 73 34*	      dc.b	"sys41000 hELP", CR
    284  916b		       73 79 73 34*	      dc.b	"sys41003 wEDGE", CR
    285  917a		       73 79 73 34*	      dc.b	"sys41006 wEDGE at $340", CR, CR, CR
    286  9193		       00		      dc.b	$00
    287  9194
    288  9194							; ==============================================================
    289  9194							; RAM setting menu
    290  9194							; ==============================================================
    291  9194
    292  9194				   RAMSCREEN
    293  9194		       93 0e 9e 12*	      dc.b	CLRHOME,FONT2,YELLOW,RVSON, "	ram cONFIGURATION   ",CR,CR,CR
    294  91b1		       05 12 66 31*	      dc.b	WHITE,RVSON,"f1",RVSOFF," 3 kb (6655)", CR, CR
    295  91c4		       12 66 32 92*	      dc.b	"",RVSON,"f2",RVSOFF,"  8 kb (11775)", CR, CR
    296  91d8		       12 66 33 92*	      dc.b	RVSON,"f3",RVSOFF," 16 kb (19967)", CR, CR
    297  91ec		       12 66 34 92*	      dc.b	"",RVSON,"f4",RVSOFF,"  24 kb (28159)", CR, CR
    298  9201		       12 66 35 92*	      dc.b	RVSON,"f5",RVSOFF," 24+3 kb (28159)", CR, CR
    299  9217		       12 66 36 92*	      dc.b	"",RVSON,"f6",RVSOFF,"  oFF (NO wEDGE!)", CR, CR
    300  922e		       12 66 37 92*	      dc.b	RVSON,"f7",RVSOFF," aLL ram (28159)", CR, CR, CR
    301  9245		       12 66 38 92*	      dc.b	"",RVSON,"f8",RVSOFF,"  mAIN mENU", CR, CR, CR
    302  9257		       69 6f 20 12*	      dc.b	"io ",RVSON,"r",RVSOFF,"EGISTER ( )", CR
    303  9269		       65 41 53 59*	      dc.b	"eASY ",RVSON,"w",RVSOFF,"EDGE  ( )"
    304  927a		       00		      dc.b	$00
    305  927b
    306  927b
    307  927b							; ==============================================================
    308  927b							; UTILITY menu
    309  927b							; ==============================================================
    310  927b
    311  927b				   UTILSCREEN
    312  927b		       93 0e 9e 12*	      dc.b	CLRHOME,FONT2,YELLOW,RVSON, "	  fe3 uTILITIES     ",CR,CR,CR
    313  9298		       05 12 66 31*	      dc.b	WHITE,RVSON,"f1",RVSOFF," fLASH pROGRAM", CR, CR
    314  92ad		       12 66 32 92*	      dc.b	"",RVSON,"f2",RVSOFF,"  fLASH fIRMWARE", CR, CR
    315  92c3		       12 66 33 92*	      dc.b	RVSON,"f3",RVSOFF," fLASH iNFO", CR, CR
    316  92d4							;dc.b CR, CR
    317  92d4							;dc.b "",RVSON,"f4",RVSOFF,"  24 kb (28159)", CR, CR
    318  92d4		       0d 0d		      dc.b	CR, CR
    319  92d6							;  dc.b RVSON,"f5",RVSOFF," bACKUP fLASH", CR, CR
    320  92d6		       0d 0d		      dc.b	CR, CR
    321  92d8							;dc.b "",RVSON,"f6",RVSOFF,"  oFF", CR, CR
    322  92d8		       0d 0d		      dc.b	CR, CR
    323  92da							;  dc.b RVSON,"f7",RVSOFF," rESTORE fLASH", CR, CR, CR
    324  92da		       0d 0d 0d 	      dc.b	CR, CR, CR
    325  92dd				   F8SCREEN
    326  92dd		       12 66 38 92*	      dc.b	"",RVSON,"f8",RVSOFF,"  mAIN mENU", CR, CR, CR
    327  92ef		       00		      dc.b	$00
    328  92f0
    329  92f0
    330  92f0							; ==============================================================
    331  92f0							; MENU FOOTER
    332  92f0							; ==============================================================
    333  92f0
    334  92f0				   MENUSCREEN
    335  92f0		       13 9e 0d 0d	      dc.b	HOME,YELLOW, CR, CR
    336  92f4							;  dc.b 210,210,210,210,210,210,210,210,210,210,210
    337  92f4		       60 60 60 60*	      dc.b	96,96,96,96,96,96,96,96,96,96,96
    338  92ff		       60 60 60 60*	      dc.b	96,96,96,96,96,96,96,96,96,96,96
    339  930a		       0d 0d 0d 0d*	      dc.b	CR, CR, CR, CR, CR, CR, CR, CR, CR
    340  9313		       0d 0d 0d 0d*	      dc.b	CR, CR, CR, CR, CR, CR, CR, CR, CR
    341  931c		       60 60 60 60*	      dc.b	96,96,96,96,96,96,96,96,96,96,96
    342  9327		       60 60 60 60*	      dc.b	96,96,96,96,96,96,96,96,96,96,96, CR
    343  9333							;  dc.b 197,197,197,197,197,197,197,197,197,197,197,CR
    344  9333
    345  9333							;	"---- DISK LOADER -----"
    346  9333		       12 66 31 92*	      dc.b	RVSON,"f1",RVSOFF,"/",RVSON,"f3",RVSOFF,":pGuP/dWN "
    347  9346		       12 66 38 92*	      dc.b	RVSON,"f8",RVSOFF,":eXIT",CR
    348  9350		       12 66 35 92*	      dc.b	RVSON,"f5",RVSOFF,"/",RVSON,"f7",RVSOFF,":fIRST-/lAST lINE"
    349  936a		       13 00		      dc.b	HOME,$00
    350  936c
    351  936c
    352  936c							; ==============================================================
    353  936c							; The credits!
    354  936c							; ==============================================================
    355  936c
    356  936c				   THECREDITS
    357  936c		       93 9e 56 33*	      dc.b	CLRHOME, YELLOW, "V3 06/2009", CR, CR
    358  937a		       1c 43 52 45*	      dc.b	RED, "CREATED BY:", CR, CR
    359  9388		       90		      dc.b	BLACK
    360  9389		       4c 45 49 46*	      dc.b	"LEIF BLOOMQUIST", CR
    361  9399		       41 4e 44 45*	      dc.b	"ANDERS PERSSON", CR
    362  93a8		       41 4e 44 45*	      dc.b	"ANDERS CARLSSON", CR
    363  93b8		       43 48 52 49*	      dc.b	"CHRISTOPHER PREST", CR
    364  93ca		       42 52 49 41*	      dc.b	"BRIAN LYONS", CR
    365  93d6		       4c 45 45 20*	      dc.b	"LEE DAVIDSON", CR
    366  93e3		       53 43 48 4c*	      dc.b	"SCHLOWSKI", CR
    367  93ed		       56 49 50 45*	      dc.b	"VIPERSAN", CR
    368  93f6		       44 41 4e 49*	      dc.b	"DANIEL KAHLIN", CR
    369  9404		       4a 45 46 46*	      dc.b	"JEFF DANIELS", CR
    370  9411		       4d 49 43 48*	      dc.b	"MICHAEL KLEIN", CR
    371  941f		       44 41 56 49*	      dc.b	"DAVID A. HOOK", CR
    372  942d		       4e 49 4c 53*	      dc.b	"NILS EILERS", CR
    373  9439		       44 49 52 4b*	      dc.b	"DIRK VROOMEN", CR
    374  9446		       54 4f 4d 4d*	      dc.b	"TOMMY WINKLER", CR, CR
    375  9455		       00		      dc.b	$00
    376  9456
    377  9456				   THECREDITSP2
    378  9456		       9c		      dc.b	PURPLE
    379  9457		       57 57 57 2e*	      dc.b	"WWW.SLEEPINGELEPHANT", CR
    380  946c		       2e 43 4f 4d*	      dc.b	".COM/DENIAL/", CR
    381  9479		       1f		      dc.b	BLUE
    382  947a		       00		      dc.b	$00
    383  947b
    384  947b				   MSG_EXISTS
    385  947b		       0d 12 41 92*	      dc.b	CR,RVSON,"A",RVSOFF,"BORT ",RVSON,"R",RVSOFF,"EPLACE ",RVSON,"U",RVSOFF,"PDATE ",CR,0
    386  9499
    387  9499
    388  9499
    389  9499
    390  9499
    391  9499							; ==============================================================
    392  9499							; ROM $6 FUNCTIONS
    393  9499							; ==============================================================
    394  9499
    395  9499		       00 00	   EXEC_SAVE  =	0
    396  9499		       00 01	   EXEC_LOADER =	1
    397  9499
    398  9499
    399  9499				   DO_EXECUTE subroutine
    400  9499		       aa		      tax
    401  949a		       d0 03		      bne	.1
    402  949c		       4c a6 74 	      jmp	RPROC_SAVE
    403  949f
    404  949f				   .1
    405  949f		       ca		      dex
    406  94a0		       d0 03		      bne	.2
    407  94a2		       4c 7a 75 	      jmp	RPROC_LOADER
    408  94a5
    409  94a5				   .2
    410  94a5		       60		      rts
    411  94a6
    412  94a6
    413  94a6
    414  94a6
    415  94a6							; ==============================================================
    416  94a6							; PROC AFTER "FILE EXISTS"
    417  94a6							; ==============================================================
    418  94a6
    419  94a6		       00 27	   CH_OLDFILE =	39	; '
    420  94a6							;CH_OLDFILE = 36			  ; $
    421  94a6
    422  94a6
    423  94a6				   RPROC_SAVE subroutine
    424  94a6		       ad 00 01 	      lda	STP
    425  94a9		       c9 36		      cmp	#"6"
    426  94ab		       d0 25		      bne	.rts
    427  94ad		       ad 01 01 	      lda	STP +1
    428  94b0		       c9 33		      cmp	#"3"
    429  94b2		       d0 1e		      bne	.rts
    430  94b4
    431  94b4		       a9 7b		      lda	#<MSG_EXISTS
    432  94b6		       a0 74		      ldy	#>MSG_EXISTS
    433  94b8		       20 31 bf 	      jsr	STROUT
    434  94bb
    435  94bb				   .key
    436  94bb		       20 e0 a1 	      jsr	WAIT_KEY
    437  94be		       c9 41		      cmp	#"A"
    438  94c0		       f0 10		      beq	.rts
    439  94c2		       c9 52		      cmp	#"R"
    440  94c4		       f0 0e		      beq	.replace
    441  94c6		       c9 55		      cmp	#"U"
    442  94c8		       f0 1e		      beq	.update
    443  94ca		       d0 ef		      bne	.key
    444  94cc
    445  94cc				   .err
    446  94cc							;jsr PRINT_DISK_ERR
    447  94cc		       20 b5 b5 	      jsr	GET_DISK_STAT
    448  94cf		       20 9e b5 	      jsr	PRINT_BIP_0
    449  94d2				   .rts
    450  94d2		       18		      clc
    451  94d3		       60		      rts
    452  94d4
    453  94d4
    454  94d4				   .replace
    455  94d4		       a9 1e		      lda	#<MSG_DEL_FILE
    456  94d6		       a0 75		      ldy	#>MSG_DEL_FILE
    457  94d8		       20 1e cb 	      jsr	SY_STROUT
    458  94db				   .repl2
    459  94db		       20 5b 75 	      jsr	START_DISK_SCRATCH
    460  94de		       b0 ec		      bcs	.err
    461  94e0		       20 4d b5 	      jsr	IECNAMOUT_2
    462  94e3
    463  94e3				   .okul
    464  94e3		       20 17 bb 	      jsr	UNLISTEN
    465  94e6		       38		      sec
    466  94e7		       60		      rts
    467  94e8
    468  94e8
    469  94e8				   .update
    470  94e8		       a9 31		      lda	#<MSG_DEL_OLDFILE
    471  94ea		       a0 75		      ldy	#>MSG_DEL_OLDFILE
    472  94ec		       20 1e cb 	      jsr	SY_STROUT
    473  94ef
    474  94ef		       20 5b 75 	      jsr	START_DISK_SCRATCH
    475  94f2		       b0 d8		      bcs	.err
    476  94f4		       a9 27		      lda	#CH_OLDFILE
    477  94f6		       20 5b ba 	      jsr	IECOUT
    478  94f9		       20 4d b5 	      jsr	IECNAMOUT_2
    479  94fc		       20 17 bb 	      jsr	UNLISTEN
    480  94ff
    481  94ff		       a9 48		      lda	#<MSG_RENAME_FILE
    482  9501		       a0 75		      ldy	#>MSG_RENAME_FILE
    483  9503		       20 1e cb 	      jsr	SY_STROUT
    484  9506
    485  9506		       20 5f 75 	      jsr	START_DISK_RENAME
    486  9509		       b0 c1		      bcs	.err
    487  950b		       a9 27		      lda	#CH_OLDFILE
    488  950d		       20 5b ba 	      jsr	IECOUT
    489  9510		       20 4d b5 	      jsr	IECNAMOUT_2
    490  9513		       a9 3d		      lda	#"="
    491  9515		       20 5b ba 	      jsr	IECOUT
    492  9518		       20 4d b5 	      jsr	IECNAMOUT_2
    493  951b		       4c e3 74 	      jmp	.okul
    494  951e
    495  951e
    496  951e
    497  951e
    498  951e				   MSG_DEL_FILE
    499  951e		       44 45 4c 45*	      dc.b	"DELETING FILE ...",13,0
    500  9531				   MSG_DEL_OLDFILE
    501  9531		       44 45 4c 45*	      dc.b	"DELETING OLD FILE ...",13,0
    502  9548				   MSG_RENAME_FILE
    503  9548		       52 45 4e 41*	      dc.b	"RENAMING FILE ...",13,0
    504  955b
    505  955b
    506  955b
    507  955b
    508  955b							; ==============================================================
    509  955b							; DISK COMMANDS RENAME AND SCRATCH
    510  955b							; ==============================================================
    511  955b
    512  955b
    513  955b				   START_DISK_SCRATCH
    514  955b		       a9 53		      lda	#"S"
    515  955d		       d0 02		      bne	START_DISK_CMD
    516  955f
    517  955f				   START_DISK_RENAME
    518  955f		       a9 52		      lda	#"R"
    519  9561
    520  9561				   START_DISK_CMD subroutine
    521  9561		       48		      pha
    522  9562		       20 65 b5 	      jsr	DISK_LISTEN_6F
    523  9565		       a5 90		      lda	IECSTAT
    524  9567		       30 0b		      bmi	.err
    525  9569
    526  9569		       68		      pla
    527  956a		       20 5b ba 	      jsr	IECOUT
    528  956d		       a9 3a		      lda	#":"
    529  956f		       20 5b ba 	      jsr	IECOUT
    530  9572		       18		      clc
    531  9573		       60		      rts
    532  9574
    533  9574				   .err
    534  9574		       20 17 bb 	      jsr	UNLISTEN
    535  9577		       68		      pla
    536  9578		       38		      sec
    537  9579		       60		      rts
    538  957a
    539  957a
    540  957a
    541  957a
    542  957a							; =====================================================================
    543  957a							; MENU LOADER
    544  957a							; Schaltet in ROM Modus und lädt 1 oder mehrere Dateien in den Speicher
    545  957a							; Lade Instruktionen stehen in der Tabelle DL_LDBUF
    546  957a							; =====================================================================
    547  957a
    548  957a				   RPROC_LOADER subroutine
    549  957a							;LOADER PARAM	     :: "filename",B|P|C [,$adress]	B=BASIC Code,P=Program,C=Cartridge
    550  957a		       20 12 ab 	      jsr	SET_PT2_LDBUF
    551  957d
    552  957d		       ae 67 03 	      ldx	DL_CNTLDR
    553  9580				   .2
    554  9580		       8a		      txa
    555  9581		       48		      pha
    556  9582		       20 a8 75 	      jsr	PRINT_LOADMSG	;SET LOAD INFO, PRINT MESSAGE
    557  9585		       20 0a 76 	      jsr	GET_FILETYP
    558  9588		       e0 42		      cpx	#"B"
    559  958a		       d0 06		      bne	.3
    560  958c
    561  958c		       20 7f a8 	      jsr	LOAD_BASIC_2
    562  958f		       4c 95 75 	      jmp	.4
    563  9592
    564  9592				   .3
    565  9592		       20 6a b3 	      jsr	MY_IECLOAD
    566  9595				   .4
    567  9595		       b0 0d		      bcs	.ERR
    568  9597
    569  9597		       20 df aa 	      jsr	ADD_PT2_LDBUF	;NEXT LDBUF
    570  959a
    571  959a		       68		      pla
    572  959b		       aa		      tax
    573  959c		       ca		      dex
    574  959d		       d0 e1		      bne	.2
    575  959f
    576  959f				   .E
    577  959f		       20 67 b2 	      jsr	PRINT_IO
    578  95a2		       18		      clc
    579  95a3		       60		      rts
    580  95a4
    581  95a4				   .ERR
    582  95a4		       68		      pla
    583  95a5		       4c d7 aa 	      jmp	LOAD_ERR
    584  95a8
    585  95a8
    586  95a8
    587  95a8
    588  95a8							;PRINT LOAD MESSAGE
    589  95a8				   PRINT_LOADMSG subroutine
    590  95a8		       a0 12		      ldy	#LDBUF_LAD
    591  95aa		       b1 24		      lda	(PT2),y	; LOAD ADR LOW
    592  95ac		       85 c3		      sta	LOADPTR
    593  95ae		       c8		      iny
    594  95af		       b1 24		      lda	(PT2),y	; LOAD ADR HIGH
    595  95b1		       85 c4		      sta	LOADPTR +1
    596  95b3		       f0 02		      beq	.2B
    597  95b5
    598  95b5		       a9 ff		      lda	#$ff
    599  95b7				   .2B
    600  95b7		       a8		      tay		; SA
    601  95b8		       c8		      iny
    602  95b9		       a9 01		      lda	#1
    603  95bb		       ae 3e 03 	      ldx	F_CURDEV	; device#
    604  95be		       20 ba ff 	      jsr	SETFNUM
    605  95c1
    606  95c1		       20 0a 76 	      jsr	GET_FILETYP
    607  95c4		       e0 42		      cpx	#"B"
    608  95c6		       d0 16		      bne	.3B
    609  95c8
    610  95c8		       20 eb aa 	      jsr	PRINT_LOADING
    611  95cb		       4c 4f 41 44*	      dc.b	"LOAD BASIC PROG",0
    612  95db		       4c 85 a8 	      jmp	LOAD_BASIC_START
    613  95de
    614  95de				   .3B
    615  95de		       e0 43		      cpx	#"C"
    616  95e0		       d0 1a		      bne	.3C
    617  95e2
    618  95e2		       a5 c4		      lda	LOADPTR +1
    619  95e4		       d0 04		      bne	.3B2
    620  95e6		       a9 a0		      lda	#$a0	;DEFAULT CARTRIDGE ADDRESS
    621  95e8		       85 c4		      sta	LOADPTR +1
    622  95ea				   .3B2
    623  95ea		       a0 02		      ldy	#2
    624  95ec		       84 b9		      sty	SY_SA
    625  95ee		       20 eb aa 	      jsr	PRINT_LOADING
    626  95f1		       4c 4f 41 44*	      dc.b	"LOAD CART",0
    627  95fb		       60		      rts
    628  95fc
    629  95fc				   .3C
    630  95fc		       20 eb aa 	      jsr	PRINT_LOADING
    631  95ff		       4c 4f 41 44*	      dc.b	"LOAD PROG",0
    632  9609		       60		      rts
    633  960a
    634  960a				   GET_FILETYP subroutine
    635  960a		       a0 11		      ldy	#LDBUF_TYP
    636  960c		       b1 24		      lda	(PT2),y
    637  960e		       aa		      tax
    638  960f		       60		      rts
    639  9610
    640  9610
    641  9610
    642  9610
    643  9610
    644  9610							; ==============================================================
    645  9610							; END :: ROM $6 FUNCTIONS
    646  9610							; ==============================================================
    647  9610
    648  9610
    649  9610					      rend
    650  9610
    651  9610
    652  9610
    653  9610
    654  a000					      org	$a000,0	;$A000   (Fill value=0)
    655  a000
    656  a000							; ==============================================================
    657  a000							; Startup
    658  a000							; ==============================================================
    659  a000		       09 a0		      dc.w	START	; Entry point for power up
    660  a002		       a0 a1		      dc.w	RESTORE	; Entry point for warm start (RESTORE)
    661  a004
    662  a004				   CARTID
    663  a004		       41 30 c3 c2*	      dc.b	"A0",$C3,$C2,$CD	; 'A0CBM' boot string
    664  a009
    665  a009
    666  a009		       cb 1e	   SY_STROUT  =	$cb1e	;String in AC/YR ausgeben
    667  a009
    668  a009		       fd 8d	   SY_RAMTAS  =	$fd8d
    669  a009							;SY_RAMTAS2 = $fd9b
    670  a009		       fd 52	   SY_INITVEC =	$fd52
    671  a009		       fd f9	   SY_INITIO1 =	$fdf9
    672  a009		       e5 18	   SY_INITIO2 =	$e518
    673  a009
    674  a009		       e4 5b	   SY_INITVEC2 =	$e45b	; Init Vectors
    675  a009		       e3 a4	   SY_BASRAM  =	$e3a4	; BASIC RAM
    676  a009		       e4 04	   SY_INITMSG =	$e404	; INIT Message (needed so keycheck routine below works)
    677  a009
    678  a009
    679  a009
    680  a009
    681  a009				   START
    682  a009		       20 8d fd 	      jsr	SY_RAMTAS	; RAMTAS - Initialise System Constants
    683  a00c		       20 52 fd 	      jsr	SY_INITVEC	; Init Vectors
    684  a00f		       20 f9 fd 	      jsr	SY_INITIO1	; Init I/O
    685  a012		       20 18 e5 	      jsr	SY_INITIO2	; Init I/O
    686  a015		       58		      cli
    687  a016
    688  a016							;BASIC Init (Partial)
    689  a016		       20 5b e4 	      jsr	SY_INITVEC2	; Init Vectors
    690  a019		       20 a4 e3 	      jsr	SY_BASRAM	; BASIC RAM
    691  a01c		       20 04 e4 	      jsr	SY_INITMSG	; INIT Message (needed so keycheck routine below works)
    692  a01f
    693  a01f							; Force startup with device #8 (disk)
    694  a01f		       a9 08		      lda	#$08
    695  a021		       8d 3e 03 	      sta	F_CURDEV
    696  a024		       d0 38		      bne	START2
    697  a026
    698  a026
    699  a028					      org	$a028	; - equals 41000 decimal, easy to remember!
    700  a028
    701  a028				   JMP_TABLE
    702  a028		       4c f5 a1 	      jmp	HELP2	; sys 41000: Help sreen
    703  a02b		       4c 9d af 	      jmp	MY_WEDGE_INIT	; sys 41003: Init Wedge
    704  a02e		       4c 86 ae 	      jmp	MOVE_WEDGE_LOW	; sys 41006: Copy Wedge to low mem
    705  a031		       4c e2 bb 	      jmp	SET_BASE_VECTORS	; sys 41009: Set Base vectors
    706  a034
    707  a034
    708  a034							; COPY FIRMWARE FROM EEPROM TO SRAM
    709  a034				   COPYROM    subroutine
    710  a034		       a9 a0		      lda	#>$a000
    711  a036		       a0 00		      ldy	#<$a000
    712  a038		       a2 20		      ldx	#32	; copy 32 pages
    713  a03a
    714  a03a				   COPYROM_2
    715  a03a		       85 25		      sta	PT2 +1
    716  a03c		       84 24		      sty	PT2
    717  a03e
    718  a03e		       20 73 a3 	      jsr	TEST_RAM	;RAM OK?
    719  a041		       90 14		      bcc	.02
    720  a043
    721  a043		       a0 00		      ldy	#0
    722  a045				   .01
    723  a045		       b1 24		      lda	(PT2),y
    724  a047		       91 24		      sta	(PT2),y
    725  a049		       c8		      iny
    726  a04a		       d0 f9		      bne	.01
    727  a04c		       e6 25		      inc	PT2 +1
    728  a04e		       ca		      dex
    729  a04f		       d0 f4		      bne	.01
    730  a051							;sty CARTID
    731  a051							;sty CARTID +1
    732  a051
    733  a051		       a9 90		      lda	#FEMOD_RAM_1 +$10	; ALL RAM, PROTECT BLK-5
    734  a053		       8d 02 9c 	      sta	IO_FINAL
    735  a056		       38		      sec
    736  a057				   .02
    737  a057		       60		      rts
    738  a058
    739  a058
    740  a058
    741  a058				   INIT_CART  subroutine
    742  a058		       a9 6e		      lda	#$6e	; Blue Screen
    743  a05a							;lda #$6d		   ; Blue Screen,green border
    744  a05a							;lda #$6b		   ; Blue Screen, cyan border
    745  a05a		       8d 0f 90 	      sta	$900f	; Screen Color
    746  a05d		       60		      rts
    747  a05e
    748  a05e
    749  a05e				   START2     subroutine
    750  a05e		       a9 2e		      lda	#"."
    751  a060		       8d 3c 03 	      sta	F_IO
    752  a063		       a9 58		      lda	#"X"
    753  a065		       8d 3d 03 	      sta	F_WE
    754  a068
    755  a068				   .CHECK
    756  a068							; Check which control keys are pressed.
    757  a068		       ad 8d 02 	      lda	$028d
    758  a06b
    759  a06b							; if C=, go straight to BASIC.
    760  a06b		       c9 02		      cmp	#$02
    761  a06d		       d0 03		      bne	.SHIFT
    762  a06f				   .basic
    763  a06f		       4c 93 a1 	      jmp	BASIC
    764  a072
    765  a072							; if SHIFT, go straight to BASIC with wedge enabled.
    766  a072				   .SHIFT
    767  a072		       c9 01		      cmp	#$01
    768  a074		       d0 03		      bne	.CTRL
    769  a076				   .wedge
    770  a076		       4c 68 a1 	      jmp	STARTWEDGE
    771  a079
    772  a079							; if CTRL, start Boot-LOADER
    773  a079				   .CTRL
    774  a079		       c9 04		      cmp	#$04
    775  a07b		       d0 4a		      bne	.01
    776  a07d
    777  a07d				   .bootloader		; execute boot-loader
    778  a07d		       a9 40		      lda	#FEMOD_ROM	;ROM
    779  a07f		       20 58 a3 	      jsr	UNLOCK_IO	;UNLOCK IO
    780  a082		       20 58 a0 	      jsr	INIT_CART
    781  a085		       20 34 a0 	      jsr	COPYROM
    782  a088		       a9 08		      lda	#$08
    783  a08a		       8d 3e 03 	      sta	F_CURDEV
    784  a08d
    785  a08d		       20 58 a0 	      jsr	INIT_CART	; Screen Colors
    786  a090		       20 69 bf 	      jsr	SPAR_PRINTSTRING
    787  a093		       93 9e 0e 12*	      dc.b	CLRHOME,YELLOW,FONT2,RVSON,"---- bOOT lOADER  ----",CR,CR,0
    788  a0b0		       20 34 a0 	      jsr	COPYROM	; COPY FIRMWARE TO SRAM
    789  a0b3		       20 56 a4 	      jsr	DLOADER_INIT
    790  a0b6		       20 a8 a7 	      jsr	BLD_TABLE
    791  a0b9		       20 14 a7 	      jsr	LIST_PAGE
    792  a0bc		       20 e1 a6 	      jsr	LIST_MARKER
    793  a0bf		       68		      pla
    794  a0c0		       68		      pla
    795  a0c1		       20 ec a3 	      jsr	DLOA_00
    796  a0c4		       4c d3 a0 	      jmp	SSCREEN
    797  a0c7
    798  a0c7				   .01
    799  a0c7		       a9 40		      lda	#FEMOD_ROM	;ROM
    800  a0c9		       20 58 a3 	      jsr	UNLOCK_IO	;UNLOCK IO
    801  a0cc		       d0 a1		      bne	.basic
    802  a0ce		       20 34 a0 	      jsr	COPYROM
    803  a0d1		       90 9c		      bcc	.basic
    804  a0d3
    805  a0d3							;CARTID
    806  a0d3
    807  a0d3
    808  a0d3							; ==============================================================
    809  a0d3							; Default Startup - show init screen
    810  a0d3							; ==============================================================
    811  a0d3
    812  a0d3				   SSCREEN    subroutine
    813  a0d3		       20 58 a0 	      jsr	INIT_CART
    814  a0d6		       a9 00		      lda	#<STARTUPSCREEN
    815  a0d8		       a0 70		      ldy	#>STARTUPSCREEN
    816  a0da		       20 2c a1 	      jsr	STROUT_R
    817  a0dd		       20 1f a2 	      jsr	SHOWDRIVE
    818  a0e0
    819  a0e0				   SETUPTIMEOUT
    820  a0e0							;Initialize Timer
    821  a0e0							;  ldy $a1 ; part of TI clock, updated every 256/60 = 4.2 seconds
    822  a0e0							;  iny
    823  a0e0							;  iny
    824  a0e0							;  iny     ;Jump ahead three 'ticks' = 12.6 seconds
    825  a0e0
    826  a0e0							; Check for timeout
    827  a0e0				   .TIMEOUT
    828  a0e0							;  cpy $a1
    829  a0e0							;  bne KEYS
    830  a0e0
    831  a0e0							;STARTWEDGE_H
    832  a0e0							;  jmp STARTWEDGE
    833  a0e0
    834  a0e0							; Check keys
    835  a0e0				   .KEYS
    836  a0e0		       20 e0 a1 	      jsr	WAIT_KEY
    837  a0e3
    838  a0e3				   .DENIAL
    839  a0e3		       c9 43		      cmp	#$43	; 'C' --> show credits
    840  a0e5		       d0 06		      bne	.F1
    841  a0e7		       20 a3 a1 	      jsr	CREDITS
    842  a0ea		       4c b6 a1 	      jmp	WAITSPACE_2
    843  a0ed
    844  a0ed				   .F1
    845  a0ed		       c9 85		      cmp	#$85	;F1
    846  a0ef		       d0 03		      bne	.DEL
    847  a0f1		       4c 56 a2 	      jmp	RAMMENU
    848  a0f4
    849  a0f4				   .DEL
    850  a0f4							;  cmp #$14  ;DEL
    851  a0f4							;  bne .F2
    852  a0f4							;  jmp STARTWEDGE
    853  a0f4
    854  a0f4				   .F2
    855  a0f4							;  cmp #$89  ;F2
    856  a0f4							;  bne F3
    857  a0f4							;  jsr INIT_BASIC
    858  a0f4							;  jsr SY_INITMSG			  ; INIT Message
    859  a0f4							;  jmp DO_UNNEW
    860  a0f4
    861  a0f4				   .F3
    862  a0f4		       c9 86		      cmp	#$86	;F3
    863  a0f6		       d0 03		      bne	.F4
    864  a0f8
    865  a0f8		       4c f4 a3 	      jmp	DLOADER
    866  a0fb
    867  a0fb				   .F4
    868  a0fb		       c9 8a		      cmp	#$8a	;F4
    869  a0fd		       d0 03		      bne	.F5
    870  a0ff		       4c e8 a1 	      jmp	HELP
    871  a102
    872  a102				   .F5
    873  a102		       c9 87		      cmp	#$87	;F5
    874  a104		       d0 03		      bne	.F6
    875  a106		       4c 6b ab 	      jmp	CART_LOADER
    876  a109
    877  a109				   .F6
    878  a109		       c9 8b		      cmp	#$8b	;F6
    879  a10b		       d0 03		      bne	.PLUS
    880  a10d		       4c ba a3 	      jmp	UTIL_MENU
    881  a110
    882  a110				   .PLUS
    883  a110		       c9 2b		      cmp	#$2b	;+
    884  a112		       d0 03		      bne	.MINUS
    885  a114		       4c fc a1 	      jmp	INCDRIVE
    886  a117
    887  a117				   .MINUS
    888  a117		       c9 2d		      cmp	#$2D	;-
    889  a119		       d0 03		      bne	.F7
    890  a11b		       4c 02 a2 	      jmp	DECDRIVE
    891  a11e
    892  a11e				   .F7
    893  a11e		       c9 88		      cmp	#$88	;F7
    894  a120		       d0 03		      bne	.F8
    895  a122		       4c 68 a1 	      jmp	STARTWEDGE
    896  a125
    897  a125				   .F8
    898  a125		       c9 8c		      cmp	#$8C
    899  a127		       d0 b7		      bne	.TIMEOUT
    900  a129		       4c 93 a1 	      jmp	BASIC
    901  a12c
    902  a12c
    903  a12c
    904  a12c
    905  a12c							; ==============================================================
    906  a12c							; DISPLAY STRING IN ROM    in AC/YR
    907  a12c							; ==============================================================
    908  a12c
    909  a12c				   STROUT_R   subroutine
    910  a12c		       20 41 a1 	      jsr	SET_ROM
    911  a12f		       20 31 bf 	      jsr	STROUT
    912  a132		       4c 3b a1 	      jmp	SET_BACK
    913  a135
    914  a135							; ==============================================================
    915  a135							; EXECUTE FUNCTION IN ROM    in AC
    916  a135							; ==============================================================
    917  a135
    918  a135				   EXECUTE_R  subroutine
    919  a135		       20 41 a1 	      jsr	SET_ROM
    920  a138		       20 99 74 	      jsr	DO_EXECUTE
    921  a13b
    922  a13b				   SET_BACK
    923  a13b		       a5 02		      lda	2
    924  a13d		       8d 02 9c 	      sta	IO_FINAL
    925  a140		       60		      rts
    926  a141
    927  a141				   SET_ROM
    928  a141		       48		      pha
    929  a142		       ad 02 9c 	      lda	IO_FINAL
    930  a145		       85 02		      sta	2
    931  a147		       a9 40		      lda	#FEMOD_ROM
    932  a149		       8d 02 9c 	      sta	IO_FINAL
    933  a14c		       68		      pla
    934  a14d		       60		      rts
    935  a14e
    936  a14e
    937  a14e							; ==============================================================
    938  a14e							; Start Wedge and return to BASIC
    939  a14e							; ==============================================================
    940  a14e				   INIT_BASIC
    941  a14e		       20 52 fd 	      jsr	SY_INITVEC	; Init Vectors
    942  a151		       20 f9 fd 	      jsr	SY_INITIO1	; Init I/O
    943  a154		       20 18 e5 	      jsr	SY_INITIO2	; Init I/O
    944  a157		       58		      cli
    945  a158
    946  a158							;  lda #$06
    947  a158							;  sta $0286 ; Restore blue text
    948  a158
    949  a158							;BASIC Init (Partial)
    950  a158		       20 5b e4 	      jsr	SY_INITVEC2	; Init Vectors
    951  a15b		       4c a4 e3 	      jmp	SY_BASRAM	; BASIC RAM
    952  a15e
    953  a15e							;Clear keyboard buffer
    954  a15e							;  lda #$00
    955  a15e							;  sta KEYANZ
    956  a15e
    957  a15e							; Restore normal startup colors
    958  a15e				   INIT_DEF
    959  a15e		       a9 1b		      lda	#$1b
    960  a160		       8d 0f 90 	      sta	$900f
    961  a163
    962  a163							; Restore normal startup colors
    963  a163		       a9 8e		      lda	#FONT1
    964  a165		       4c d1 b6 	      jmp	CHROUT
    965  a168
    966  a168
    967  a168		       e4 67	   BASIC_WARM =	$e467
    968  a168
    969  a168
    970  a168				   STARTWEDGE
    971  a168		       78		      sei
    972  a169		       20 8d fd 	      jsr	SY_RAMTAS	; RAMTAS - Initialise System Constants
    973  a16c		       20 4e a1 	      jsr	INIT_BASIC
    974  a16f
    975  a16f		       20 9d af 	      jsr	MY_WEDGE_INIT
    976  a172
    977  a172				   STARTWEDGE1
    978  a172		       20 04 e4 	      jsr	SY_INITMSG	; INIT Message
    979  a175		       20 e2 bb 	      jsr	SET_BASE_VECTORS	; Set Base vectors
    980  a178
    981  a178				   STARTWEDGE2
    982  a178
    983  a178							;jsr COPYROM				; COPY FIRMWARE TO SRAM
    984  a178							;bcc xxx				; ==> RAM ERROR
    985  a178
    986  a178		       a9 cd		      lda	#<WEDGEMESSAGE1b
    987  a17a		       a0 bb		      ldy	#>WEDGEMESSAGE1b
    988  a17c		       20 2c a1 	      jsr	STROUT_R
    989  a17f
    990  a17f		       ad 03 03 	      lda	PTR_INPUT_LOOP +1
    991  a182
    992  a182				   STWE_3
    993  a182		       20 49 b8 	      jsr	HEXOUT2
    994  a185		       a9 8f		      lda	#<WEDGEMESSAGE2
    995  a187		       a0 a1		      ldy	#>WEDGEMESSAGE2
    996  a189		       20 2c a1 	      jsr	STROUT_R
    997  a18c		       4c 67 e4 	      jmp	BASIC_WARM
    998  a18f
    999  a18f
   1000  a18f							; ==============================================================
   1001  a18f							; Wedge Message
   1002  a18f							; ==============================================================
   1003  a18f
   1004  a18f							;WEDGEMESSAGE1a
   1005  a18f							;  dc.b $11, $1C, "EASYWEDGE ($", 0
   1006  a18f
   1007  a18f				   WEDGEMESSAGE2
   1008  a18f		       29 11 1f 00	      dc.b	")",$11, $1F, 0
   1009  a193
   1010  a193
   1011  a193							; ==============================================================
   1012  a193							; Return to BASIC
   1013  a193							; ==============================================================
   1014  a193				   BASIC
   1015  a193		       78		      sei
   1016  a194		       20 8d fd 	      jsr	SY_RAMTAS	; RAMTAS - Initialise System Constants
   1017  a197		       20 4e a1 	      jsr	INIT_BASIC
   1018  a19a				   BASIC1
   1019  a19a		       20 04 e4 	      jsr	SY_INITMSG	; INIT Message
   1020  a19d				   BASIC2
   1021  a19d							;lda #0
   1022  a19d							;jsr SY_RAMTAS2			 ;calculate RAM size
   1023  a19d
   1024  a19d							; Complete BASIC Warm Start (since init is done above)
   1025  a19d		       4c 67 e4 	      jmp	BASIC_WARM
   1026  a1a0
   1027  a1a0
   1028  a1a0
   1029  a1a0
   1030  a1a0
   1031  a1a0							; ==============================================================
   1032  a1a0							; Handle the RESTORE key
   1033  a1a0							; ==============================================================
   1034  a1a0				   RESTORE
   1035  a1a0		       4c c7 fe 	      jmp	$fec7	; Continue as if no cartridge installed
   1036  a1a3
   1037  a1a3
   1038  a1a3
   1039  a1a3							; ==============================================================
   1040  a1a3							; List all the Denial Helpers
   1041  a1a3							; ==============================================================
   1042  a1a3				   CREDITS
   1043  a1a3		       a9 1e		      lda	#$1e
   1044  a1a5		       8d 0f 90 	      sta	$900f	; Screen colors
   1045  a1a8		       a9 6c		      lda	#<THECREDITS
   1046  a1aa		       a0 73		      ldy	#>THECREDITS
   1047  a1ac		       20 2c a1 	      jsr	STROUT_R
   1048  a1af		       a9 56		      lda	#<THECREDITSP2
   1049  a1b1		       a0 74		      ldy	#>THECREDITSP2
   1050  a1b3		       4c 2c a1 	      jmp	STROUT_R
   1051  a1b6
   1052  a1b6
   1053  a1b6							; ==============================================================
   1054  a1b6							; Wait here for space bar or F8
   1055  a1b6							; ==============================================================
   1056  a1b6				   WAITSPACE_2
   1057  a1b6		       20 bc a1 	      jsr	WAITSPACE
   1058  a1b9		       4c d3 a0 	      jmp	SSCREEN
   1059  a1bc
   1060  a1bc
   1061  a1bc				   WAITSPACE
   1062  a1bc		       20 e4 ff 	      jsr	GETIN
   1063  a1bf		       c9 8c		      cmp	#$8C	;F8
   1064  a1c1		       f0 04		      beq	WASP_1
   1065  a1c3		       c9 20		      cmp	#$20	;SPACE
   1066  a1c5		       d0 f5		      bne	WAITSPACE
   1067  a1c7				   WASP_1
   1068  a1c7		       60		      rts
   1069  a1c8
   1070  a1c8				   WAIT_KEY_TX
   1071  a1c8		       20 69 bf 	      jsr	SPAR_PRINTSTRING
   1072  a1cb		       0d 0d 50 52*	      dc.b	13,13,"PRESS ANY KEY ...",13,0
   1073  a1e0				   WAIT_KEY
   1074  a1e0		       20 e4 ff 	      jsr	GETIN
   1075  a1e3		       c9 00		      cmp	#0
   1076  a1e5		       f0 f9		      beq	WAIT_KEY
   1077  a1e7		       60		      rts
   1078  a1e8
   1079  a1e8
   1080  a1e8							; ==============================================================
   1081  a1e8							; Help Screen
   1082  a1e8							; ==============================================================
   1083  a1e8				   HELP
   1084  a1e8		       20 f5 a1 	      jsr	HELP2
   1085  a1eb		       a9 dd		      lda	#<F8SCREEN
   1086  a1ed		       a0 72		      ldy	#>F8SCREEN
   1087  a1ef		       20 2c a1 	      jsr	STROUT_R
   1088  a1f2		       4c b6 a1 	      jmp	WAITSPACE_2
   1089  a1f5
   1090  a1f5
   1091  a1f5				   HELP2
   1092  a1f5		       a9 cc		      lda	#<HELPSCREEN3
   1093  a1f7		       a0 70		      ldy	#>HELPSCREEN3
   1094  a1f9		       4c 2c a1 	      jmp	STROUT_R
   1095  a1fc
   1096  a1fc
   1097  a1fc							; ==============================================================
   1098  a1fc							; Increment/Decrement the drive#
   1099  a1fc							; ==============================================================
   1100  a1fc
   1101  a1fc				   INCDRIVE
   1102  a1fc		       ee 3e 03 	      inc	F_CURDEV
   1103  a1ff		       4c 05 a2 	      jmp	CHECKDRIVE
   1104  a202
   1105  a202				   DECDRIVE
   1106  a202		       ce 3e 03 	      dec	F_CURDEV
   1107  a205
   1108  a205							; Make sure drive is valid - 8 to 15
   1109  a205				   CHECKDRIVE
   1110  a205		       18		      clc
   1111  a206				   CHECKLOW
   1112  a206		       ad 3e 03 	      lda	F_CURDEV
   1113  a209		       e9 08		      sbc	#$08
   1114  a20b		       b0 05		      bcs	CHECKHIGH
   1115  a20d		       a9 08		      lda	#$08
   1116  a20f		       8d 3e 03 	      sta	F_CURDEV
   1117  a212				   CHECKHIGH
   1118  a212		       18		      clc
   1119  a213		       ad 3e 03 	      lda	F_CURDEV
   1120  a216		       e9 0f		      sbc	#$0F
   1121  a218		       90 05		      bcc	SHOWDRIVE
   1122  a21a		       a9 0f		      lda	#$0F
   1123  a21c		       8d 3e 03 	      sta	F_CURDEV
   1124  a21f
   1125  a21f				   SHOWDRIVE
   1126  a21f		       a9 01		      lda	#$01
   1127  a221		       8d 86 02 	      sta	$0286	;White text
   1128  a224
   1129  a224							;Move Cursor
   1130  a224		       a2 15		      ldx	#$15	; Row
   1131  a226		       a0 0b		      ldy	#$0b	; Column
   1132  a228		       20 65 bf 	      jsr	SET_CURSOR
   1133  a22b
   1134  a22b		       ad 3e 03 	      lda	F_CURDEV
   1135  a22e		       c9 08		      cmp	#$08
   1136  a230		       f0 07		      beq	DIGIT
   1137  a232		       c9 09		      cmp	#$09
   1138  a234		       f0 03		      beq	DIGIT
   1139  a236		       4c 46 a2 	      jmp	DIGITS
   1140  a239
   1141  a239				   DIGIT
   1142  a239		       69 2f		      adc	#$2F	;convert to ascii
   1143  a23b		       20 d2 ff 	      jsr	$ffd2
   1144  a23e		       a9 20		      lda	#$20
   1145  a240		       20 d2 ff 	      jsr	$ffd2	;append a space
   1146  a243		       4c e0 a0 	      jmp	SETUPTIMEOUT
   1147  a246
   1148  a246				   DIGITS
   1149  a246		       a9 31		      lda	#$31	;'1'
   1150  a248		       20 d2 ff 	      jsr	$ffd2
   1151  a24b		       ad 3e 03 	      lda	F_CURDEV
   1152  a24e		       69 26		      adc	#$26
   1153  a250		       20 d2 ff 	      jsr	$ffd2
   1154  a253		       4c e0 a0 	      jmp	SETUPTIMEOUT
   1155  a256
   1156  a256
   1157  a256							; ==============================================================
   1158  a256							; SUBMENU RAM CONFIG
   1159  a256							; ==============================================================
   1160  a256
   1161  a256				   RAMMENU
   1162  a256		       a9 94		      lda	#<RAMSCREEN
   1163  a258		       a0 71		      ldy	#>RAMSCREEN
   1164  a25a		       20 2c a1 	      jsr	STROUT_R
   1165  a25d
   1166  a25d							; Check keys
   1167  a25d				   KEYS_0
   1168  a25d		       20 9d a3 	      jsr	SHOW_IO
   1169  a260		       20 aa a3 	      jsr	SHOW_WE
   1170  a263
   1171  a263				   KEYS_1
   1172  a263		       20 e4 ff 	      jsr	GETIN
   1173  a266
   1174  a266
   1175  a266
   1176  a266				   F1_1
   1177  a266		       c9 85		      cmp	#$85	;F1
   1178  a268		       d0 04		      bne	F2_1
   1179  a26a
   1180  a26a							;jsr SetVicAs3K
   1181  a26a		       a9 9e		      lda	#FEMOD_RAM_1 +$1E	;3KB RAM
   1182  a26c		       d0 62		      bne	SET_RAM
   1183  a26e
   1184  a26e				   F2_1
   1185  a26e		       c9 89		      cmp	#$89	;F2
   1186  a270		       d0 04		      bne	F3_1
   1187  a272
   1188  a272							;jsr SetVicAs8K
   1189  a272		       a9 9d		      lda	#FEMOD_RAM_1 +$1D	;8KB RAM
   1190  a274		       d0 5a		      bne	SET_RAM
   1191  a276
   1192  a276				   F3_1
   1193  a276		       c9 86		      cmp	#$86	;F3
   1194  a278		       d0 04		      bne	F4_1
   1195  a27a
   1196  a27a							;jsr SetVicAs16K
   1197  a27a		       a9 99		      lda	#FEMOD_RAM_1 +$19	;16KB RAM
   1198  a27c		       d0 52		      bne	SET_RAM
   1199  a27e
   1200  a27e				   F4_1
   1201  a27e		       c9 8a		      cmp	#$8a	;F4
   1202  a280		       d0 04		      bne	F5_1
   1203  a282
   1204  a282							;jsr SetVicAs24K
   1205  a282		       a9 91		      lda	#FEMOD_RAM_1 +$11	;24KB RAM
   1206  a284		       d0 4a		      bne	SET_RAM
   1207  a286
   1208  a286				   F5_1
   1209  a286		       c9 87		      cmp	#$87	;F5
   1210  a288		       d0 04		      bne	F6_1
   1211  a28a
   1212  a28a							;jsr SetVicAs24K
   1213  a28a		       a9 90		      lda	#FEMOD_RAM_1 +$10	;24+3KB RAM
   1214  a28c		       d0 42		      bne	SET_RAM
   1215  a28e
   1216  a28e				   F6_1
   1217  a28e		       c9 8b		      cmp	#$8b	;F6
   1218  a290		       d0 07		      bne	F7_1
   1219  a292
   1220  a292		       a9 80		      lda	#FEMOD_RAM_1	;3KB RAM
   1221  a294		       a2 ff		      ldx	#$FF	;OFF
   1222  a296		       4c ee b8 	      jmp	RESET_SYSTEM
   1223  a299
   1224  a299				   F7_1
   1225  a299		       c9 88		      cmp	#$88	;F7
   1226  a29b		       d0 04		      bne	F8_1
   1227  a29d
   1228  a29d							;jsr SetVicAs24K
   1229  a29d		       a9 80		      lda	#FEMOD_RAM_1	;ALL RAM
   1230  a29f		       d0 2f		      bne	SET_RAM
   1231  a2a1
   1232  a2a1				   F8_1
   1233  a2a1		       c9 8c		      cmp	#$8C
   1234  a2a3		       d0 03		      bne	KEY_W
   1235  a2a5		       4c d3 a0 	      jmp	SSCREEN
   1236  a2a8
   1237  a2a8				   KEY_W
   1238  a2a8		       c9 57		      cmp	#"W"
   1239  a2aa		       f0 15		      beq	W_FLAG
   1240  a2ac
   1241  a2ac				   KEY_R
   1242  a2ac		       c9 52		      cmp	#"R"
   1243  a2ae		       f0 02		      beq	IO_FLAG
   1244  a2b0		       d0 b1		      bne	KEYS_1
   1245  a2b2
   1246  a2b2
   1247  a2b2							;-------- CHANGE IO REGISTER FLAG
   1248  a2b2				   IO_FLAG
   1249  a2b2		       a9 2e		      lda	#"."
   1250  a2b4		       cd 3c 03 	      cmp	F_IO
   1251  a2b7		       d0 02		      bne	IOF2
   1252  a2b9		       a9 58		      lda	#"X"
   1253  a2bb
   1254  a2bb				   IOF2
   1255  a2bb		       8d 3c 03 	      sta	F_IO
   1256  a2be		       4c 5d a2 	      jmp	KEYS_0
   1257  a2c1
   1258  a2c1
   1259  a2c1							;-------- CHANGE WEDGE FLAG
   1260  a2c1				   W_FLAG
   1261  a2c1		       a9 2e		      lda	#"."
   1262  a2c3		       cd 3d 03 	      cmp	F_WE
   1263  a2c6		       d0 02		      bne	WEF2
   1264  a2c8		       a9 58		      lda	#"X"
   1265  a2ca
   1266  a2ca				   WEF2
   1267  a2ca		       8d 3d 03 	      sta	F_WE
   1268  a2cd		       4c 5d a2 	      jmp	KEYS_0
   1269  a2d0
   1270  a2d0
   1271  a2d0
   1272  a2d0
   1273  a2d0				   SET_RAM
   1274  a2d0							;sta DL_IOBASE
   1275  a2d0		       8d 02 9c 	      sta	IO_FINAL
   1276  a2d3		       8d 04 a0 	      sta	CARTID	;DELETE CARTRIDGE ID IF RAM
   1277  a2d6		       48		      pha
   1278  a2d7		       ae 3c 03 	      ldx	F_IO
   1279  a2da		       e0 2e		      cpx	#"."
   1280  a2dc		       d0 05		      bne	SET_RAM5
   1281  a2de
   1282  a2de		       a2 80		      ldx	#$80
   1283  a2e0		       8e 03 9c 	      stx	IO_FINAL +1	; LOCK IO (REGISTER INVISIBLE)
   1284  a2e3				   SET_RAM5
   1285  a2e3		       29 a0		      and	#$a0
   1286  a2e5		       c9 80		      cmp	#$80
   1287  a2e7		       d0 07		      bne	SET_RAM6	; WEDGE ONLY FOR RAM, RAM-NOIO
   1288  a2e9
   1289  a2e9		       ae 3d 03 	      ldx	F_WE
   1290  a2ec		       e0 58		      cpx	#"X"
   1291  a2ee		       f0 07		      beq	SET_RAM8
   1292  a2f0				   SET_RAM6
   1293  a2f0		       68		      pla
   1294  a2f1		       20 b3 ae 	      jsr	SetVicMemConfig
   1295  a2f4		       4c 9a a1 	      jmp	BASIC1
   1296  a2f7
   1297  a2f7				   SET_RAM8
   1298  a2f7		       68		      pla
   1299  a2f8		       48		      pha
   1300  a2f9		       20 b3 ae 	      jsr	SetVicMemConfig
   1301  a2fc		       68		      pla
   1302  a2fd		       29 bf		      and	#$bf
   1303  a2ff		       c9 80		      cmp	#$80	; WEDGE $5 ONLY FOR ALL RAM
   1304  a301		       d0 09		      bne	SET_RAM9
   1305  a303		       20 04 e4 	      jsr	SY_INITMSG	; INIT Message
   1306  a306		       20 86 ae 	      jsr	MOVE_WEDGE_LOW	; COPY WEDGE TO $500
   1307  a309		       4c 78 a1 	      jmp	STARTWEDGE2
   1308  a30c				   SET_RAM9
   1309  a30c		       20 9d af 	      jsr	MY_WEDGE_INIT
   1310  a30f		       4c 72 a1 	      jmp	STARTWEDGE1
   1311  a312
   1312  a312
   1313  a312							;-------- SWITCH CARTRIDGE AND RUN BASIC
   1314  a312				   RUNBASIC
   1315  a312							;jsr INIT_BASIC
   1316  a312							;jsr $e404 ; INIT Message
   1317  a312
   1318  a312							; Complete BASIC Warm Start (since init is done above)
   1319  a312							;jmp BASIC_WARM
   1320  a312
   1321  a312		       a0 14		      ldy	#(__SET_IO_RUN_E - __SET_IO_RUN)
   1322  a314		       a9 a3		      lda	#>__SET_IO_RUN
   1323  a316		       a2 24		      ldx	#<__SET_IO_RUN
   1324  a318		       20 03 b9 	      jsr	COPY_PROC
   1325  a31b
   1326  a31b		       ad 94 02 	      lda	BIP_IOBASE
   1327  a31e		       ae 95 02 	      ldx	BIP_IOBASE +1
   1328  a321		       4c 00 02 	      jmp	BIP
   1329  a324
   1330  a324
   1331  a324							;-------- RAM PROCEDURE TO SWITCH CARTRIDGE AND RUN BASIC
   1332  a324				   __SET_IO_RUN
   1333  a324		       8d 02 9c 	      sta	IO_FINAL
   1334  a327		       8e 03 9c 	      stx	IO_FINAL +1
   1335  a32a		       20 33 c5 	      jsr	SY_PGMLINK	;Relinks BASIC Program from and to any address...
   1336  a32d		       a9 00		      lda	#0
   1337  a32f		       20 90 ff 	      jsr	$ff90
   1338  a332		       20 59 c6 	      JSR	SY_BASCLR2	;CLR
   1339  a335		       4c ae c7 	      JMP	$C7AE
   1340  a338				   __SET_IO_RUN_E
   1341  a338
   1342  a338
   1343  a338
   1344  a338
   1345  a338
   1346  a338							;-------- SWITCH CARTRIDGE AND RUN CODE
   1347  a338				   SYS_XY
   1348  a338		       98		      tya
   1349  a339		       48		      pha
   1350  a33a		       8a		      txa
   1351  a33b		       48		      pha
   1352  a33c
   1353  a33c							;jsr INIT_BASIC
   1354  a33c
   1355  a33c		       a0 09		      ldy	#(__SET_IO_RESET_E - __SET_IO_RESET)
   1356  a33e		       a9 b9		      lda	#>__SET_IO_RESET
   1357  a340		       a2 11		      ldx	#<__SET_IO_RESET
   1358  a342		       20 03 b9 	      jsr	COPY_PROC
   1359  a345
   1360  a345		       a0 07		      ldy	#(__SET_IO_RESET_E - __SET_IO_RESET) -2
   1361  a347		       68		      pla
   1362  a348		       99 00 02 	      sta	BIP,y
   1363  a34b		       68		      pla
   1364  a34c		       99 01 02 	      sta	BIP+1,y
   1365  a34f				   SYS_XY_2
   1366  a34f		       ad 94 02 	      lda	BIP_IOBASE
   1367  a352		       ae 95 02 	      ldx	BIP_IOBASE +1
   1368  a355		       4c 00 02 	      jmp	BIP
   1369  a358
   1370  a358
   1371  a358
   1372  a358
   1373  a358
   1374  a358
   1375  a358
   1376  a358
   1377  a358							;-------- UNLOCK IO IN START-MODE
   1378  a358				   UNLOCK_IO
   1379  a358		       48		      pha
   1380  a359		       a0 0d		      ldy	#(__UNLOCK_IO_E - __UNLOCK_IO)
   1381  a35b		       a9 a3		      lda	#>__UNLOCK_IO
   1382  a35d		       a2 66		      ldx	#<__UNLOCK_IO
   1383  a35f		       20 03 b9 	      jsr	COPY_PROC
   1384  a362		       68		      pla
   1385  a363		       4c 00 02 	      jmp	BIP
   1386  a366
   1387  a366							;-------- UNLOCK START MODE AND SET MODE
   1388  a366				   __UNLOCK_IO
   1389  a366							;  sei
   1390  a366		       ae 00 a0 	      ldx	$a000	;
   1391  a369		       8e 00 a0 	      stx	$a000	;UNLOCK IO
   1392  a36c		       8d 02 9c 	      sta	IO_FINAL
   1393  a36f		       cd 02 9c 	      cmp	IO_FINAL
   1394  a372							;  cli
   1395  a372		       60		      rts
   1396  a373				   __UNLOCK_IO_E
   1397  a373
   1398  a373
   1399  a373
   1400  a373
   1401  a373
   1402  a373
   1403  a373							;-------- TEST IF RAM IS AT (PT1)
   1404  a373				   TEST_RAM
   1405  a373		       a0 1e		      ldy	#(__TEST_RAM_E - __TEST_RAM)
   1406  a375		       a9 a3		      lda	#>__TEST_RAM
   1407  a377		       a2 7f		      ldx	#<__TEST_RAM
   1408  a379		       20 03 b9 	      jsr	COPY_PROC
   1409  a37c		       4c 00 02 	      jmp	BIP
   1410  a37f
   1411  a37f							;-------- TEST IF RAM IS AT (PT1)  ZF=1 :: RAM IS OK
   1412  a37f				   __TEST_RAM
   1413  a37f							;ldx IO_FINAL
   1414  a37f		       78		      sei
   1415  a380		       a9 80		      lda	#FEMOD_RAM_1	;RAM
   1416  a382		       8d 02 9c 	      sta	IO_FINAL
   1417  a385
   1418  a385		       a0 00		      ldy	#0
   1419  a387		       b1 24		      lda	(PT2),y
   1420  a389		       48		      pha
   1421  a38a		       49 ff		      eor	#$ff
   1422  a38c		       91 24		      sta	(PT2),y	;STORE INVERTED VALUE
   1423  a38e		       d1 24		      cmp	(PT2),y	;CHECK IF ($A) WRITEABLE
   1424  a390		       f0 01		      beq	__TERA_1
   1425  a392		       18		      clc		;RAM ERROR!!
   1426  a393				   __TERA_1
   1427  a393		       68		      pla
   1428  a394		       91 24		      sta	(PT2),y	;RESTORE OLD VALUE
   1429  a396
   1430  a396		       a2 40		      ldx	#FEMOD_ROM	;ROM
   1431  a398		       8e 02 9c 	      stx	IO_FINAL
   1432  a39b		       58		      cli
   1433  a39c		       60		      rts
   1434  a39d				   __TEST_RAM_E
   1435  a39d
   1436  a39d
   1437  a39d
   1438  a39d
   1439  a39d				   SHOW_IO
   1440  a39d							;Move Cursor
   1441  a39d		       a2 15		      ldx	#21	; Row
   1442  a39f		       a0 0d		      ldy	#13	; Column
   1443  a3a1		       20 65 bf 	      jsr	SET_CURSOR
   1444  a3a4
   1445  a3a4		       ad 3c 03 	      lda	F_IO
   1446  a3a7		       4c d2 ff 	      jmp	BSOUT
   1447  a3aa
   1448  a3aa				   SHOW_WE
   1449  a3aa							;Move Cursor
   1450  a3aa		       a2 16		      ldx	#22	; Row
   1451  a3ac		       a0 0d		      ldy	#13	; Column
   1452  a3ae		       20 65 bf 	      jsr	SET_CURSOR
   1453  a3b1
   1454  a3b1		       ad 3d 03 	      lda	F_WE
   1455  a3b4		       4c d2 ff 	      jmp	BSOUT
   1456  a3b7
   1457  a3b7
   1458  a3b7							; ==============================================================
   1459  a3b7							; Define some common PETSCII codes
   1460  a3b7							; http://sta.c64.org/cbm64petkey.html
   1461  a3b7							; ==============================================================
   1462  a3b7
   1463  a3b7		       00 93	   CLRHOME    =	$93
   1464  a3b7		       00 13	   HOME       =	$13
   1465  a3b7		       00 12	   RVSON      =	$12
   1466  a3b7		       00 92	   RVSOFF     =	$92
   1467  a3b7		       00 0d	   CR	      =	$0D
   1468  a3b7		       00 90	   BLACK      =	$90
   1469  a3b7		       00 05	   WHITE      =	$05
   1470  a3b7		       00 1c	   RED	      =	$1C
   1471  a3b7		       00 1f	   BLUE       =	$1F
   1472  a3b7		       00 1e	   GREEN      =	$1E
   1473  a3b7		       00 9c	   PURPLE     =	$9C
   1474  a3b7		       00 9e	   YELLOW     =	$9E
   1475  a3b7		       00 8e	   FONT1      =	142	; BIG LETTERS & GRAFIC
   1476  a3b7		       00 0e	   FONT2      =	14	; BIG AND SMALL LETTERS
   1477  a3b7		       00 40	   AT	      =	$40
   1478  a3b7
   1479  a3b7
   1480  a3b7
   1481  a3b7							; ==============================================================
   1482  a3b7							; SUBMENU UTILITY
   1483  a3b7							; ==============================================================
   1484  a3b7				   UTIL_FLI
   1485  a3b7		       20 ff ac 	      jsr	FLASH_INFO
   1486  a3ba
   1487  a3ba				   UTIL_MENU  subroutine
   1488  a3ba		       20 58 a0 	      jsr	INIT_CART	; Screen Colors
   1489  a3bd		       a9 7b		      lda	#<UTILSCREEN
   1490  a3bf		       a0 72		      ldy	#>UTILSCREEN
   1491  a3c1		       20 2c a1 	      jsr	STROUT_R
   1492  a3c4
   1493  a3c4							; Check keys
   1494  a3c4				   .KEYS
   1495  a3c4							;jsr SHOW_IO
   1496  a3c4							;jsr SHOW_WE
   1497  a3c4
   1498  a3c4		       20 e4 ff 	      jsr	GETIN
   1499  a3c7
   1500  a3c7
   1501  a3c7
   1502  a3c7				   .F1
   1503  a3c7		       c9 85		      cmp	#$85	;F1
   1504  a3c9		       d0 03		      bne	.F2
   1505  a3cb
   1506  a3cb		       4c 16 a9 	      jmp	CART_FLASHER
   1507  a3ce
   1508  a3ce
   1509  a3ce				   .F2
   1510  a3ce		       c9 89		      cmp	#$89	;F2
   1511  a3d0		       d0 03		      bne	F3_UT1
   1512  a3d2
   1513  a3d2		       4c ab a8 	      jmp	FIRMW_FLASHER
   1514  a3d5
   1515  a3d5
   1516  a3d5				   F3_UT1
   1517  a3d5		       c9 86		      cmp	#$86	;F3
   1518  a3d7		       f0 de		      beq	UTIL_FLI
   1519  a3d9
   1520  a3d9				   .F4
   1521  a3d9							;  cmp #$8a  ;F4
   1522  a3d9							;  bne F5_UT1
   1523  a3d9
   1524  a3d9
   1525  a3d9				   .F5
   1526  a3d9		       c9 87		      cmp	#$87	;F5
   1527  a3db		       d0 00		      bne	.F6
   1528  a3dd
   1529  a3dd
   1530  a3dd				   .F6
   1531  a3dd		       c9 8b		      cmp	#$8b	;F6
   1532  a3df		       d0 00		      bne	.F7
   1533  a3e1
   1534  a3e1
   1535  a3e1				   .F7
   1536  a3e1		       c9 88		      cmp	#$88	;F7
   1537  a3e3		       d0 00		      bne	.F8
   1538  a3e5
   1539  a3e5
   1540  a3e5				   .F8
   1541  a3e5		       c9 8c		      cmp	#$8C
   1542  a3e7		       d0 db		      bne	.KEYS
   1543  a3e9		       4c d3 a0 	      jmp	SSCREEN
   1544  a3ec
   1545  a3ec
   1546  a3ec
   1547  a3ec
   1548  a3ec							; ========================================================================
   1549  a3ec							; DISK LOADER
   1550  a3ec							; Schaltet in den RAM Modus
   1551  a3ec							; Ladet die Loaderkonfig Datei (LOADER) in den BASIC Speicher
   1552  a3ec							; Baut eine String Zeigertabelle auf ab TBL_NAMES ($6)
   1553  a3ec							; Führt die Menü Auswahl Prozedur aus
   1554  a3ec							; ========================================================================
   1555  a3ec
   1556  a3ec
   1557  a3ec
   1558  a3ec							;-------------- PRINT DLOADER SCREEN
   1559  a3ec				   DLOA_00    subroutine
   1560  a3ec		       20 c1 a5 	      jsr	MENU_SEL
   1561  a3ef		       90 03		      bcc	.01
   1562  a3f1		       20 3e a6 	      jsr	MESE_EXEC
   1563  a3f4				   .01
   1564  a3f4
   1565  a3f4				   DLOADER    subroutine
   1566  a3f4		       a9 91		      lda	#$91	; Patch von dabone, damit auf 24k umgeschaltet wird
   1567  a3f6		       20 b3 ae 	      jsr	SetVicMemConfig
   1568  a3f9		       20 58 a0 	      jsr	INIT_CART	; Screen Colors
   1569  a3fc		       20 69 bf 	      jsr	SPAR_PRINTSTRING
   1570  a3ff		       93 9e 0e 12*	      dc.b	CLRHOME,YELLOW,FONT2,RVSON,"---- dISK lOADER  ----",CR,CR,0
   1571  a41c
   1572  a41c		       20 26 a4 	      jsr	DLOADER1
   1573  a41f		       e0 0d		      cpx	#13	;CR
   1574  a421		       f0 c9		      beq	DLOA_00
   1575  a423		       4c d3 a0 	      jmp	SSCREEN
   1576  a426
   1577  a426
   1578  a426				   DLOADER1   subroutine
   1579  a426		       20 34 a0 	      jsr	COPYROM	; COPY FIRMWARE TO SRAM
   1580  a429		       b0 1d		      bcs	.02	; ==> RAM OK
   1581  a42b
   1582  a42b		       20 7d bf 	      jsr	SPAR_MSGBOX
   1583  a42e		       02 03 1c 72*	      dc.b	2, 3, RED, "ram eRROR at $a ...",0
   1584  a445				   .exit
   1585  a445		       a2 00		      ldx	#0
   1586  a447		       60		      rts
   1587  a448
   1588  a448							;lda #<MSG_RAMMERR
   1589  a448							;ldy #>MSG_RAMMERR
   1590  a448							;jmp MSG_BOX
   1591  a448
   1592  a448
   1593  a448				   .02
   1594  a448		       20 56 a4 	      jsr	DLOADER_INIT
   1595  a44b		       b0 f8		      bcs	.exit
   1596  a44d
   1597  a44d		       20 a8 a7 	      jsr	BLD_TABLE
   1598  a450		       20 dc a4 	      jsr	MENU_HANDLER
   1599  a453		       b8		      clv
   1600  a454		       50 d0		      bvc	DLOADER1
   1601  a456
   1602  a456
   1603  a456							;-------------- LOAD LOADER FILE
   1604  a456				   DLOADER_INIT
   1605  a456		       20 76 a4 	      jsr	MENU_INIT
   1606  a459
   1607  a459							;lda #<MSG_LOAD
   1608  a459							;ldy #>MSG_LOAD
   1609  a459							;jsr STR_AT
   1610  a459		       20 72 bf 	      jsr	SPAR_PRINTSTRING_AT
   1611  a45c		       01 03 05 4c*	      dc.b	1, 3, WHITE, "LOADING ...",0
   1612  a46b
   1613  a46b		       20 5d a8 	      jsr	LOAD_MENU
   1614  a46e		       08		      php
   1615  a46f		       a2 01		      ldx	#1
   1616  a471		       20 56 bf 	      jsr	DEL_LINE
   1617  a474		       28		      plp
   1618  a475				   DLOADER_E
   1619  a475		       60		      rts
   1620  a476
   1621  a476
   1622  a476							;-------------- PRINT DLOADER SCREEN
   1623  a476				   MENU_INIT
   1624  a476		       a9 f0		      lda	#<MENUSCREEN
   1625  a478		       a0 72		      ldy	#>MENUSCREEN
   1626  a47a		       20 2c a1 	      jsr	STROUT_R
   1627  a47d
   1628  a47d		       a9 05		      lda	#5
   1629  a47f		       85 08		      sta	FLGCOM
   1630  a481		       a9 00		      lda	#0
   1631  a483		       8d 61 03 	      sta	DL_SLINIDX
   1632  a486		       a9 03		      lda	#DL_STARTLINE
   1633  a488		       8d 64 03 	      sta	DL_SEL
   1634  a48b				   MEIN_E
   1635  a48b		       60		      rts
   1636  a48c
   1637  a48c
   1638  a48c							; ==============================================================
   1639  a48c							; GET KEY / JOYSTICK
   1640  a48c							; ==============================================================
   1641  a48c
   1642  a48c				   GETJOY
   1643  a48c		       a5 a2		      lda	$a2
   1644  a48e		       cd 3f 03 	      cmp	F_JOYREP
   1645  a491		       d0 41		      bne	GEJO_E
   1646  a493
   1647  a493		       18		      clc
   1648  a494		       69 04		      adc	#4
   1649  a496		       8d 3f 03 	      sta	F_JOYREP
   1650  a499
   1651  a499		       78		      sei
   1652  a49a		       ad 1f 91 	      lda	VIA1 +$f
   1653  a49d		       29 3c		      and	#$3c
   1654  a49f		       a2 7f		      ldx	#127
   1655  a4a1		       8e 22 91 	      stx	VIA2 +$2
   1656  a4a4		       ae 20 91 	      ldx	VIA2
   1657  a4a7		       30 02		      bmi	GEJO_1
   1658  a4a9		       09 02		      ora	#2
   1659  a4ab				   GEJO_1
   1660  a4ab		       a2 ff		      ldx	#255
   1661  a4ad		       8e 22 91 	      stx	VIA2 +$2
   1662  a4b0		       58		      cli
   1663  a4b1		       a8		      tay
   1664  a4b2		       a2 11		      ldx	#17
   1665  a4b4		       29 08		      and	#8	;down
   1666  a4b6		       f0 1f		      beq	GEJO_9
   1667  a4b8		       98		      tya
   1668  a4b9		       a2 91		      ldx	#145
   1669  a4bb		       29 04		      and	#4	;up
   1670  a4bd		       f0 18		      beq	GEJO_9
   1671  a4bf		       98		      tya
   1672  a4c0		       a2 0d		      ldx	#13
   1673  a4c2		       29 20		      and	#32	;fire
   1674  a4c4		       f0 11		      beq	GEJO_9
   1675  a4c6		       98		      tya
   1676  a4c7		       a2 1d		      ldx	#29
   1677  a4c9		       29 02		      and	#2	;right
   1678  a4cb		       f0 0a		      beq	GEJO_9
   1679  a4cd		       98		      tya
   1680  a4ce		       a2 9d		      ldx	#157
   1681  a4d0		       29 10		      and	#16	;left
   1682  a4d2		       f0 03		      beq	GEJO_9
   1683  a4d4				   GEJO_E
   1684  a4d4		       4c e4 ff 	      jmp	GETIN
   1685  a4d7
   1686  a4d7				   GEJO_9
   1687  a4d7		       8a		      txa
   1688  a4d8		       60		      rts
   1689  a4d9
   1690  a4d9
   1691  a4d9							; ==============================================================
   1692  a4d9							; MENU HANDLER
   1693  a4d9							; ==============================================================
   1694  a4d9
   1695  a4d9		       60 00	   TBL_NAMES  =	$6000
   1696  a4d9
   1697  a4d9		       60 00	   TBL_NAMES_CNT =	TBL_NAMES
   1698  a4d9
   1699  a4d9
   1700  a4d9		       00 d6	   DL_CURLIN  =	C_ROW	;TEMP. AKT LINE TO DRAW
   1701  a4d9
   1702  a4d9		       03 41	   TBL_CLBUF  =	F_END	;CATALOG BUFFER (CATALOG ENTRY)
   1703  a4d9
   1704  a4d9		       03 61	   TBL_DATA   =	F_END + CLBUF_END
   1705  a4d9		       03 61	   DL_SLINIDX =	TBL_DATA	;INDEX OF FIRST LINE
   1706  a4d9		       03 62	   DL_CURIDX  =	TBL_DATA +1	;TEMP. AKT. INDEX
   1707  a4d9		       03 63	   DL_CNT     =	TBL_DATA +2	;TEMP. COUNTER
   1708  a4d9		       03 64	   DL_SEL     =	TBL_DATA +3	;selected menu line
   1709  a4d9		       03 65	   DL_LINCNT  =	TBL_DATA +4	;count of lines
   1710  a4d9		       03 66	   DL_LASTLIN =	TBL_DATA +5	;last line
   1711  a4d9		       03 67	   DL_CNTLDR  =	TBL_DATA +6	;LOAD FILES COUNT
   1712  a4d9		       03 68	   DL_CNTLDR2 =	TBL_DATA +7	;LOAD FILES COUNT
   1713  a4d9		       03 69	   DL_IOBASE  =	TBL_DATA +8	;BASE FOR IO2 REGISTER 1 AND 2
   1714  a4d9							;DL_RUNADR  = TBL_DATA +10		 ;RUN ADDRESS: 0=RUN BASIC, 1=RESET, 2=invalid, n=SYS
   1715  a4d9
   1716  a4d9
   1717  a4d9							;FILE HEADER (LOAD BUFFER)
   1718  a4d9		       03 6d	   DL_LDBUF   =	TBL_DATA +12	;LOAD BUFFER - bis zu 4 x DATEI,OPTIONS
   1719  a4d9		       00 00	   LDBUF_LEN  =	0	;OFFSET FILENAME LENGTH
   1720  a4d9		       00 01	   LDBUF_FN   =	1	;OFFSET FILENAME
   1721  a4d9		       00 11	   LDBUF_TYP  =	17	;OFFSET TYPE: B=BASIC, P=PROGRAM, C=CARTRIDGE
   1722  a4d9		       00 12	   LDBUF_LAD  =	18	;OFFSET LOAD ADRESS
   1723  a4d9		       00 14	   LDBUF_FLEN =	20	;OFFSET FILE LENGTH
   1724  a4d9		       00 16	   LDBUF_END  =	22	;STRUCT LDBUF LEN
   1725  a4d9
   1726  a4d9
   1727  a4d9							;CATALOG ENTRY
   1728  a4d9		       00 00	   CLBUF_LEN  =	0	;OFFSET ENTRY NAME LENGTH
   1729  a4d9		       00 01	   CLBUF_NAM  =	1	;OFFSET ENTRY NAME
   1730  a4d9		       00 15	   CLBUF_CNT  =	21	;OFFSET FILES COUNT
   1731  a4d9		       00 16	   CLBUF_PLEN =	22	;OFFSET PACKAGE LENGTH
   1732  a4d9		       00 18	   CLBUF_SADR =	24	;OFFSET START ADDRESS
   1733  a4d9		       00 1a	   CLBUF_SBANK =	26	;OFFSET START BANK
   1734  a4d9		       00 1b	   CLBUF_EADR =	27	;OFFSET END ADDRESS
   1735  a4d9		       00 1d	   CLBUF_EBANK =	29	;OFFSET END BANK
   1736  a4d9		       00 20	   CLBUF_END  =	32	;STRUCT LDBUF LEN
   1737  a4d9
   1738  a4d9
   1739  a4d9							;CLOADER PACKAGE HEADER
   1740  a4d9		       00 00	   CLHDR_CMD  =	0	;OFFSET START COMMAND (SYS/RES/RUN)
   1741  a4d9		       00 01	   CLHDR_IO1  =	1	;OFFSET IO REGISTER 1
   1742  a4d9		       00 02	   CLHDR_IO2  =	2	;OFFSET IO REGISTER 2
   1743  a4d9		       00 03	   CLHDR_ADR  =	3	;OFFSET START ADDRESS
   1744  a4d9		       00 05	   CLHDR_END  =	5	;STRUCT LDHDR LEN
   1745  a4d9
   1746  a4d9
   1747  a4d9
   1748  a4d9
   1749  a4d9
   1750  a4d9
   1751  a4d9
   1752  a4d9		       00 03	   DL_STARTLINE =	3	;start line
   1753  a4d9		       00 11	   DL_LINES   =	17	;number of lines
   1754  a4d9
   1755  a4d9
   1756  a4d9
   1757  a4d9							;-------------- RETURN TO MAIN SCREEN
   1758  a4d9				   MEHA_E
   1759  a4d9		       68		      pla
   1760  a4da		       68		      pla
   1761  a4db		       60		      rts
   1762  a4dc
   1763  a4dc
   1764  a4dc							;-------------- HANDLE MENU KEY INPUT
   1765  a4dc				   MENU_HANDLER
   1766  a4dc		       20 14 a7 	      jsr	LIST_PAGE
   1767  a4df		       20 e1 a6 	      jsr	LIST_MARKER
   1768  a4e2
   1769  a4e2				   MEHA_1
   1770  a4e2		       a9 00		      lda	#0
   1771  a4e4		       85 c6		      sta	KEYANZ
   1772  a4e6				   MEHA_5
   1773  a4e6		       20 8c a4 	      jsr	GETJOY
   1774  a4e9		       aa		      tax
   1775  a4ea
   1776  a4ea		       c9 00		      cmp	#$00
   1777  a4ec		       f0 f8		      beq	MEHA_5
   1778  a4ee
   1779  a4ee		       c9 8c		      cmp	#$8C	;F8
   1780  a4f0		       f0 e7		      beq	MEHA_E
   1781  a4f2
   1782  a4f2		       c9 0d		      cmp	#13	;CR
   1783  a4f4		       f0 e3		      beq	MEHA_E
   1784  a4f6
   1785  a4f6		       20 fc a4 	      jsr	MEHA_8
   1786  a4f9		       b8		      clv
   1787  a4fa		       50 e6		      bvc	MEHA_1
   1788  a4fc
   1789  a4fc
   1790  a4fc				   MEHA_8
   1791  a4fc		       c9 11		      cmp	#17	;CURSOR DOWN
   1792  a4fe		       f0 5c		      beq	MARKER_DOWN
   1793  a500
   1794  a500		       c9 91		      cmp	#145	;CURSOR up
   1795  a502		       f0 48		      beq	MARKER_UP
   1796  a504
   1797  a504		       c9 85		      cmp	#$85	;F1
   1798  a506		       f0 0d		      beq	PAGEUP
   1799  a508
   1800  a508		       c9 86		      cmp	#$86	;F3
   1801  a50a		       f0 21		      beq	PAGEDWN
   1802  a50c
   1803  a50c		       c9 87		      cmp	#$87	;F5
   1804  a50e		       f0 2d		      beq	MARKER_FIRST
   1805  a510
   1806  a510		       c9 88		      cmp	#$88	;F7
   1807  a512		       f0 30		      beq	MARKER_LAST
   1808  a514		       60		      rts
   1809  a515
   1810  a515
   1811  a515							;--------------------
   1812  a515				   PAGEUP
   1813  a515		       ad 61 03 	      lda	DL_SLINIDX
   1814  a518		       f0 11		      beq	PAUP_E
   1815  a51a		       38		      sec
   1816  a51b		       e9 11		      sbc	#DL_LINES
   1817  a51d				   PAUP_1
   1818  a51d		       8d 61 03 	      sta	DL_SLINIDX
   1819  a520		       20 14 a7 	      jsr	LIST_PAGE
   1820  a523
   1821  a523		       ae 64 03 	      ldx	DL_SEL
   1822  a526		       ec 66 03 	      cpx	DL_LASTLIN
   1823  a529		       b0 31		      bcs	MARKER_DOWN
   1824  a52b				   PAUP_E
   1825  a52b		       e8		      inx
   1826  a52c		       60		      rts
   1827  a52d
   1828  a52d
   1829  a52d				   PAGEDWN
   1830  a52d		       ad 61 03 	      lda	DL_SLINIDX
   1831  a530		       18		      clc
   1832  a531		       69 11		      adc	#DL_LINES
   1833  a533		       b0 05		      bcs	PADW_E
   1834  a535		       cd 00 60 	      cmp	TBL_NAMES_CNT
   1835  a538		       90 e3		      bcc	PAUP_1
   1836  a53a				   PADW_E
   1837  a53a		       a2 01		      ldx	#1
   1838  a53c		       60		      rts
   1839  a53d
   1840  a53d
   1841  a53d				   MARKER_FIRST
   1842  a53d		       20 00 a7 	      jsr	HIDE_MARKER
   1843  a540		       a2 03		      ldx	#(DL_STARTLINE)
   1844  a542		       d0 26		      bne	SET_MARKER
   1845  a544
   1846  a544				   MARKER_LAST
   1847  a544		       20 00 a7 	      jsr	HIDE_MARKER
   1848  a547		       ae 66 03 	      ldx	DL_LASTLIN
   1849  a54a		       d0 1e		      bne	SET_MARKER
   1850  a54c
   1851  a54c				   MARKER_UP
   1852  a54c		       20 00 a7 	      jsr	HIDE_MARKER
   1853  a54f		       ae 64 03 	      ldx	DL_SEL
   1854  a552		       ca		      dex
   1855  a553		       e0 02		      cpx	#DL_STARTLINE-1
   1856  a555		       d0 03		      bne	MAUP_2
   1857  a557		       ae 66 03 	      ldx	DL_LASTLIN
   1858  a55a				   MAUP_2
   1859  a55a		       d0 0e		      bne	SET_MARKER
   1860  a55c
   1861  a55c				   MARKER_DOWN
   1862  a55c		       20 00 a7 	      jsr	HIDE_MARKER
   1863  a55f		       ae 64 03 	      ldx	DL_SEL
   1864  a562		       ec 66 03 	      cpx	DL_LASTLIN
   1865  a565		       90 02		      bcc	MADO_2
   1866  a567				   MADO_0
   1867  a567		       a2 02		      ldx	#(DL_STARTLINE-1)
   1868  a569				   MADO_2
   1869  a569		       e8		      inx
   1870  a56a
   1871  a56a				   SET_MARKER
   1872  a56a		       8e 64 03 	      stx	DL_SEL
   1873  a56d		       4c e1 a6 	      jmp	LIST_MARKER
   1874  a570
   1875  a570
   1876  a570
   1877  a570
   1878  a570							; ========================================================================
   1879  a570							; DISK LOADER - SELEKTIERTEN MENÜPUNKT AUSFÜHREN
   1880  a570							; Sucht den gewählten Menü Eintrag im BASIC Text
   1881  a570							; Interpretiert die Befehle im BASIC Text
   1882  a570							; Datei Ladebefehle kommen in einen Buffer (DL_LDBUF) für den LOADER
   1883  a570							; Diskbefehle werden sofort ausgeführt
   1884  a570							; Folgebefehle werden interpretiert (RAM Konfig, IO Konfig, Start Modus)
   1885  a570							; ========================================================================
   1886  a570
   1887  a570							;----MENU PUNKT GEWÄHLT!
   1888  a570		       00 7a	   BASPTR     =	$7a
   1889  a570
   1890  a570
   1891  a570
   1892  a570
   1893  a570							;INIT CATALOG BUFFER
   1894  a570				   INIT_CATALOG subroutine
   1895  a570		       a9 00		      lda	#0
   1896  a572		       a0 1f		      ldy	#CLBUF_END -1
   1897  a574				   .00
   1898  a574		       99 41 03 	      sta	TBL_CLBUF,y
   1899  a577		       88		      dey
   1900  a578		       10 fa		      bpl	.00
   1901  a57a
   1902  a57a		       a2 00		      ldx	#0
   1903  a57c
   1904  a57c							;COPY ENTRY STRING
   1905  a57c		       a0 05		      ldy	#5
   1906  a57e				   .1
   1907  a57e		       b1 24		      lda	(PT2),y
   1908  a580		       f0 0d		      beq	.E
   1909  a582		       c9 22		      cmp	#34
   1910  a584		       f0 09		      beq	.E
   1911  a586
   1912  a586		       9d 42 03 	      sta	TBL_CLBUF+1,x	;
   1913  a589		       e8		      inx
   1914  a58a		       c8		      iny
   1915  a58b		       e0 14		      cpx	#(CLBUF_CNT - CLBUF_NAM)	;MAX. LENGTH
   1916  a58d		       d0 ef		      bne	.1
   1917  a58f				   .E
   1918  a58f		       8e 41 03 	      stx	TBL_CLBUF	;ENTRY LENGTH
   1919  a592		       60		      rts
   1920  a593
   1921  a593
   1922  a593
   1923  a593							;SET PTR TO LOADER TAB
   1924  a593				   SET_LDBUF  subroutine
   1925  a593		       a9 6d		      lda	#<(DL_LDBUF)
   1926  a595		       a0 03		      ldy	#>(DL_LDBUF)
   1927  a597		       85 22		      sta	PT1
   1928  a599		       84 23		      sty	PT1 +1
   1929  a59b		       60		      rts
   1930  a59c
   1931  a59c
   1932  a59c
   1933  a59c
   1934  a59c
   1935  a59c							;PROCESS SELECTED MENU ENTRY
   1936  a59c				   MENU_SEL_INIT subroutine
   1937  a59c		       a9 00		      lda	#0
   1938  a59e		       8d 93 02 	      sta	BIP_CMD
   1939  a5a1		       8d 67 03 	      sta	DL_CNTLDR
   1940  a5a4		       20 7a a6 	      jsr	INV_ADDR
   1941  a5a7
   1942  a5a7		       a9 80		      lda	#FEMOD_RAM_1	;RAM SELECT
   1943  a5a9		       8d 69 03 	      sta	DL_IOBASE
   1944  a5ac		       a9 00		      lda	#0	;ALL RESOURCES
   1945  a5ae		       8d 6a 03 	      sta	DL_IOBASE +1
   1946  a5b1
   1947  a5b1		       ad 64 03 	      lda	DL_SEL
   1948  a5b4		       38		      sec
   1949  a5b5		       e9 03		      sbc	#DL_STARTLINE
   1950  a5b7		       b0 01		      bcs	.1
   1951  a5b9		       60		      rts
   1952  a5ba				   .1
   1953  a5ba		       18		      clc
   1954  a5bb		       6d 61 03 	      adc	DL_SLINIDX
   1955  a5be		       4c 86 a7 	      jmp	TBL_PTR	;SET PT2 TO ENTRY STRING
   1956  a5c1
   1957  a5c1
   1958  a5c1							;PROCESS SELECTED MENU ENTRY
   1959  a5c1				   MENU_SEL   subroutine
   1960  a5c1		       ad 65 03 	      lda	DL_LINCNT
   1961  a5c4		       d0 02		      bne	.0
   1962  a5c6		       18		      clc
   1963  a5c7		       60		      rts
   1964  a5c8
   1965  a5c8				   .0
   1966  a5c8		       20 9c a5 	      jsr	MENU_SEL_INIT	;SET PT2 TO ENTRY STRING
   1967  a5cb		       b0 61		      bcs	.EE
   1968  a5cd
   1969  a5cd		       20 70 a5 	      jsr	INIT_CATALOG	;INITIALIZE CATALOG BUFFER
   1970  a5d0		       20 93 a5 	      jsr	SET_LDBUF	;
   1971  a5d3
   1972  a5d3				   .nextline
   1973  a5d3		       20 d1 a6 	      jsr	NEXTLINE
   1974  a5d6		       f0 58		      beq	.E
   1975  a5d8		       a0 04		      ldy	#4
   1976  a5da				   .5
   1977  a5da		       b1 24		      lda	(PT2),y
   1978  a5dc		       f0 52		      beq	.E	;CODE ENDE
   1979  a5de		       c9 22		      cmp	#34	;NEXT MENU ENTRY
   1980  a5e0		       f0 4e		      beq	.E
   1981  a5e2
   1982  a5e2		       c9 aa		      cmp	#$aa	;"+" - LOADER ANWEISUNG
   1983  a5e4		       d0 ed		      bne	.nextline
   1984  a5e6
   1985  a5e6		       98		      tya
   1986  a5e7		       38		      sec
   1987  a5e8		       65 24		      adc	PT2
   1988  a5ea		       85 7a		      sta	CHRPTR
   1989  a5ec		       a5 25		      lda	PT2 +1
   1990  a5ee		       69 00		      adc	#0
   1991  a5f0		       85 7b		      sta	CHRPTR +1
   1992  a5f2
   1993  a5f2				   .do_cmd
   1994  a5f2		       20 79 00 	      jsr	CHRGOT
   1995  a5f5		       d0 08		      bne	.2b
   1996  a5f7				   .2c
   1997  a5f7		       aa		      tax
   1998  a5f8		       f0 d9		      beq	.nextline
   1999  a5fa
   2000  a5fa		       20 73 00 	      jsr	CHRGET	;SKIP ":"
   2001  a5fd		       f0 f8		      beq	.2c
   2002  a5ff				   .2b
   2003  a5ff		       20 05 a6 	      jsr	.do_line
   2004  a602		       4c f2 a5 	      jmp	.do_cmd
   2005  a605
   2006  a605							;INTERPRET COMMAND
   2007  a605				   .do_line
   2008  a605		       c9 22		      cmp	#34	;+"FILENAME"
   2009  a607		       d0 03		      bne	.6
   2010  a609		       4c ec a7 	      jmp	SEL_LOAD
   2011  a60c
   2012  a60c				   .6
   2013  a60c		       c9 40		      cmp	#"@"	;+@"diskcmd"
   2014  a60e		       d0 03		      bne	.7
   2015  a610		       4c 97 b1 	      jmp	DO_DISKCMD
   2016  a613
   2017  a613				   .7
   2018  a613		       20 ab b8 	      jsr	TOKENIZER
   2019  a616		       d0 03		      bne	.8
   2020  a618		       4c e8 b8 	      jmp	NEXT_STATEMENT
   2021  a61b
   2022  a61b				   .8
   2023  a61b		       e0 01		      cpx	#TOK_NOIO	;NOIO
   2024  a61d		       f0 68		      beq	SEL_NOIO
   2025  a61f		       e0 02		      cpx	#TOK_BLKP	;BLOCK WRITE PROTECT
   2026  a621		       f0 6d		      beq	SEL_BLOCK1
   2027  a623		       e0 03		      cpx	#TOK_BLKD	;BLOCK DISABLE
   2028  a625		       f0 6d		      beq	SEL_BLOCK2
   2029  a627
   2030  a627		       8e 93 02 	      stx	BIP_CMD
   2031  a62a							;cpx #TOK_RELO 			;RELOAD
   2032  a62a							;beq SEL_RELOAD
   2033  a62a							;cpx #TOK_RUN				;RUN
   2034  a62a							;beq SEL_RUN
   2035  a62a		       e0 07		      cpx	#TOK_SYS	;SYS
   2036  a62c		       f0 47		      beq	SEL_SYS
   2037  a62e							;cpx #TOK_RES				;RESET
   2038  a62e							;beq SEL_RESET
   2039  a62e				   .EE
   2040  a62e		       18		      clc
   2041  a62f		       60		      rts
   2042  a630
   2043  a630				   .E
   2044  a630				   SET_BIP_IOBASE SUBROUTINE
   2045  a630		       ad 6a 03 	      lda	DL_IOBASE +1
   2046  a633		       8d 95 02 	      sta	BIP_IOBASE +1
   2047  a636		       ad 69 03 	      lda	DL_IOBASE
   2048  a639		       8d 94 02 	      sta	BIP_IOBASE
   2049  a63c		       38		      sec
   2050  a63d		       60		      rts
   2051  a63e
   2052  a63e
   2053  a63e
   2054  a63e
   2055  a63e							; ========================================================================
   2056  a63e							; DISK LOADER - SELEKTIERTEN MENÜPUNKT AUSFÜHREN
   2057  a63e							; Alle Zeilen mit Anweisungen sind bereits verarbeitet
   2058  a63e							; + Anweisungen auf den Stack
   2059  a63e							; + Dateien laden
   2060  a63e							; + Anweisungen vom Stack ausführen
   2061  a63e							; ========================================================================
   2062  a63e
   2063  a63e		       02 93	   BIP_CMD    =	$0293	;COMMAND BYTE
   2064  a63e		       02 94	   BIP_IOBASE =	BIP_CMD +1	;BASE FOR IO2 REGISTER 1 AND 2
   2065  a63e		       02 96	   BIP_RUNADR =	BIP_CMD +3	;RUN ADDRESS: 0=RUN BASIC, 1=RESET, 2=invalid, n=SYS
   2066  a63e
   2067  a63e
   2068  a63e							;EXECUTE DLOADER BUFFER
   2069  a63e				   MESE_EXEC  subroutine
   2070  a63e		       ad 67 03 	      lda	DL_CNTLDR
   2071  a641		       f0 31		      beq	.RELOAD
   2072  a643		       ae 93 02 	      ldx	BIP_CMD
   2073  a646		       f0 2c		      beq	.RELOAD
   2074  a648		       e0 05		      cpx	#TOK_RELO	;RELOAD
   2075  a64a		       f0 28		      beq	.RELOAD
   2076  a64c
   2077  a64c		       20 c5 b6 	      jsr	CLROUT
   2078  a64f		       20 aa ae 	      jsr	SET_MEM_CONFIG
   2079  a652		       20 04 e4 	      jsr	SY_INITMSG	; INIT Message (e404)
   2080  a655		       20 c9 b6 	      jsr	CROUT
   2081  a658
   2082  a658		       a9 40		      lda	#FEMOD_ROM
   2083  a65a		       8d 02 9c 	      sta	IO_FINAL	; EEPROM!
   2084  a65d		       20 58 a8 	      jsr	DO_LOADER	; LOAD FILES
   2085  a660		       b0 0f		      bcs	.err
   2086  a662
   2087  a662				   EXEC_PACKAGE
   2088  a662		       ae 93 02 	      ldx	BIP_CMD
   2089  a665		       e0 04		      cpx	#TOK_RES	;RESET
   2090  a667		       f0 30		      beq	LOCO_RES
   2091  a669		       e0 06		      cpx	#TOK_RUN	;RUN
   2092  a66b		       f0 3c		      beq	LOCO_RUN
   2093  a66d		       e0 07		      cpx	#TOK_SYS	;SYS
   2094  a66f		       f0 42		      beq	LOCO_SYS
   2095  a671				   .err
   2096  a671		       4c f4 a3 	      jmp	DLOADER
   2097  a674
   2098  a674				   .RELOAD
   2099  a674		       60		      rts
   2100  a675
   2101  a675
   2102  a675							;------------
   2103  a675				   SEL_SYS    subroutine
   2104  a675		       20 94 b7 	      jsr	GETADR
   2105  a678		       b0 06		      bcs	.5
   2106  a67a				   INV_ADDR
   2107  a67a		       a9 00		      lda	#0
   2108  a67c		       aa		      tax
   2109  a67d		       8d 93 02 	      sta	BIP_CMD
   2110  a680				   .5
   2111  a680		       8e 96 02 	      stx	BIP_RUNADR
   2112  a683		       8d 97 02 	      sta	BIP_RUNADR +1
   2113  a686		       60		      rts
   2114  a687
   2115  a687
   2116  a687							;------------
   2117  a687				   SEL_NOIO   subroutine
   2118  a687		       a9 80		      lda	#$80	;RAM, NO-IO
   2119  a689		       0d 6a 03 	      ora	DL_IOBASE +1
   2120  a68c		       8d 6a 03 	      sta	DL_IOBASE +1
   2121  a68f		       60		      rts
   2122  a690
   2123  a690
   2124  a690
   2125  a690
   2126  a690							;------------ BLOCK WRITE PROTECT
   2127  a690				   SEL_BLOCK1 subroutine
   2128  a690		       a0 00		      ldy	#0
   2129  a692		       f0 02		      beq	.2a
   2130  a694
   2131  a694
   2132  a694							;------------ BLOCK DISABLE
   2133  a694				   SEL_BLOCK2
   2134  a694		       a0 01		      ldy	#1
   2135  a696				   .2a
   2136  a696		       4c 86 b2 	      jmp	SEL_BLOCK_P
   2137  a699
   2138  a699
   2139  a699							;------------
   2140  a699				   LOCO_RES   subroutine
   2141  a699		       a9 7f		      lda	#<MSG_RES
   2142  a69b		       a0 bb		      ldy	#>MSG_RES
   2143  a69d		       20 31 bf 	      jsr	STROUT
   2144  a6a0
   2145  a6a0		       ad 94 02 	      lda	BIP_IOBASE
   2146  a6a3		       ae 95 02 	      ldx	BIP_IOBASE +1
   2147  a6a6		       4c ee b8 	      jmp	RESET_SYSTEM
   2148  a6a9
   2149  a6a9							;------------
   2150  a6a9				   LOCO_RUN   subroutine
   2151  a6a9		       a9 9c		      lda	#<MSG_RUN
   2152  a6ab		       a0 a8		      ldy	#>MSG_RUN
   2153  a6ad		       20 31 bf 	      jsr	STROUT
   2154  a6b0		       4c 12 a3 	      jmp	RUNBASIC
   2155  a6b3
   2156  a6b3							;------------
   2157  a6b3				   LOCO_SYS   subroutine
   2158  a6b3		       a9 98		      lda	#<MSG_SYS
   2159  a6b5		       a0 a8		      ldy	#>MSG_SYS
   2160  a6b7		       20 31 bf 	      jsr	STROUT
   2161  a6ba		       a9 20		      lda	#32
   2162  a6bc		       20 d2 ff 	      jsr	BSOUT
   2163  a6bf		       ae 96 02 	      ldx	BIP_RUNADR
   2164  a6c2		       ad 97 02 	      lda	BIP_RUNADR +1
   2165  a6c5		       20 3c b8 	      jsr	HEXOUT
   2166  a6c8
   2167  a6c8		       ae 96 02 	      ldx	BIP_RUNADR
   2168  a6cb		       ac 97 02 	      ldy	BIP_RUNADR +1
   2169  a6ce
   2170  a6ce		       4c 38 a3 	      jmp	SYS_XY
   2171  a6d1
   2172  a6d1
   2173  a6d1
   2174  a6d1							; ==============================================================
   2175  a6d1							; SUBS
   2176  a6d1							; ==============================================================
   2177  a6d1
   2178  a6d1
   2179  a6d1
   2180  a6d1				   NEXTLINE   subroutine
   2181  a6d1		       a0 01		      ldy	#1
   2182  a6d3		       b1 24		      lda	(PT2),y
   2183  a6d5		       f0 09		      beq	.E
   2184  a6d7		       aa		      tax
   2185  a6d8		       88		      dey
   2186  a6d9		       b1 24		      lda	(PT2),y
   2187  a6db		       85 24		      sta	PT2
   2188  a6dd		       86 25		      stx	PT2 +1
   2189  a6df		       8a		      txa		;RESET Z
   2190  a6e0				   .E
   2191  a6e0		       60		      rts
   2192  a6e1
   2193  a6e1
   2194  a6e1							;----PRINT MARKER
   2195  a6e1				   LIST_MARKER subroutine
   2196  a6e1		       ad 65 03 	      lda	DL_LINCNT
   2197  a6e4		       d0 01		      bne	LIMA_1
   2198  a6e6		       60		      rts
   2199  a6e7
   2200  a6e7				   LIMA_1
   2201  a6e7		       a9 9e		      lda	#YELLOW
   2202  a6e9		       20 d1 b6 	      jsr	CHROUT
   2203  a6ec		       ae 64 03 	      ldx	DL_SEL
   2204  a6ef		       a0 00		      ldy	#0
   2205  a6f1		       20 65 bf 	      jsr	SET_CURSOR
   2206  a6f4		       a9 3e		      lda	#62	;">"
   2207  a6f6		       20 14 b7 	      jsr	PUTCHR
   2208  a6f9		       a9 3c		      lda	#60	;"<"
   2209  a6fb		       a0 15		      ldy	#$15
   2210  a6fd		       4c 1b b7 	      jmp	PUTCHR3
   2211  a700
   2212  a700				   HIDE_MARKER subroutine
   2213  a700		       ae 64 03 	      ldx	DL_SEL
   2214  a703		       a0 00		      ldy	#0
   2215  a705		       20 65 bf 	      jsr	SET_CURSOR
   2216  a708		       a9 20		      lda	#32
   2217  a70a		       20 14 b7 	      jsr	PUTCHR
   2218  a70d		       a0 15		      ldy	#$15
   2219  a70f		       a9 20		      lda	#32
   2220  a711		       4c 1b b7 	      jmp	PUTCHR3
   2221  a714
   2222  a714
   2223  a714
   2224  a714
   2225  a714
   2226  a714
   2227  a714							;----LIST PAGE
   2228  a714				   LIST_PAGE  subroutine
   2229  a714		       a9 00		      lda	#0
   2230  a716		       8d 65 03 	      sta	DL_LINCNT
   2231  a719		       a9 03		      lda	#DL_STARTLINE
   2232  a71b		       85 d6		      sta	DL_CURLIN
   2233  a71d		       a9 11		      lda	#DL_LINES
   2234  a71f		       8d 63 03 	      sta	DL_CNT
   2235  a722
   2236  a722		       ad 61 03 	      lda	DL_SLINIDX
   2237  a725		       8d 62 03 	      sta	DL_CURIDX
   2238  a728
   2239  a728				   LIPA_2
   2240  a728		       a6 d6		      ldx	DL_CURLIN
   2241  a72a		       a0 01		      ldy	#1
   2242  a72c		       20 65 bf 	      jsr	SET_CURSOR
   2243  a72f		       20 b2 ea 	      jsr	$eab2	;zeiger in color RAM
   2244  a732
   2245  a732		       a9 05		      lda	#WHITE
   2246  a734		       20 d1 b6 	      jsr	CHROUT
   2247  a737
   2248  a737		       ad 62 03 	      lda	DL_CURIDX
   2249  a73a		       20 51 a7 	      jsr	LIST_LINE	;LIST LINE (AC)
   2250  a73d		       e6 d6		      inc	DL_CURLIN
   2251  a73f		       ee 62 03 	      inc	DL_CURIDX
   2252  a742		       ce 63 03 	      dec	DL_CNT
   2253  a745		       d0 e1		      bne	LIPA_2
   2254  a747
   2255  a747		       ad 65 03 	      lda	DL_LINCNT
   2256  a74a		       18		      clc
   2257  a74b		       69 02		      adc	#DL_STARTLINE -1
   2258  a74d		       8d 66 03 	      sta	DL_LASTLIN
   2259  a750		       60		      rts
   2260  a751
   2261  a751
   2262  a751
   2263  a751							;----LIST LINE. AC=TAB ENTRY
   2264  a751				   LIST_LINE  subroutine
   2265  a751		       20 86 a7 	      jsr	TBL_PTR	;SET PT2 TO ENTRY STRING
   2266  a754		       b0 24		      bcs	.E
   2267  a756
   2268  a756		       ee 65 03 	      inc	DL_LINCNT
   2269  a759							;ldy #5
   2270  a759		       a4 08		      ldy	FLGCOM
   2271  a75b				   .1
   2272  a75b		       b1 24		      lda	(PT2),y
   2273  a75d		       f0 1b		      beq	.E
   2274  a75f		       c9 22		      cmp	#34
   2275  a761		       f0 17		      beq	.E
   2276  a763							;jsr CHROUT
   2277  a763		       20 23 b7 	      jsr	CONVCHR
   2278  a766		       90 0f		      bcc	.5
   2279  a768				   .3
   2280  a768		       84 d7		      sty	C_CHR
   2281  a76a		       20 19 b7 	      jsr	PUTCHR2
   2282  a76d		       a5 d3		      lda	C_COL
   2283  a76f		       c9 15		      cmp	#$15
   2284  a771		       f0 12		      beq	.EE
   2285  a773		       e6 d3		      inc	C_COL
   2286  a775		       a4 d7		      ldy	C_CHR
   2287  a777				   .5
   2288  a777		       c8		      iny
   2289  a778		       d0 e1		      bne	.1
   2290  a77a				   .E
   2291  a77a		       a9 20		      lda	#32
   2292  a77c		       a4 d3		      ldy	$d3
   2293  a77e				   .E2
   2294  a77e		       91 d1		      sta	(C_LINE),y
   2295  a780		       c8		      iny
   2296  a781		       c0 15		      cpy	#$15
   2297  a783		       d0 f9		      bne	.E2
   2298  a785				   .EE
   2299  a785		       60		      rts
   2300  a786
   2301  a786
   2302  a786							;----OFFSET (AC) --> TAB POINTER
   2303  a786							; :: SET PT1 TO MENU ENTRY TABLE
   2304  a786							; :: SET PT2 TO MENU ENTRY STRING
   2305  a786				   TBL_PTR    subroutine
   2306  a786		       cd 00 60 	      cmp	TBL_NAMES	;NUMBER OF ENTRIES
   2307  a789		       b0 1c		      bcs	.exit
   2308  a78b
   2309  a78b		       a0 60		      ldy	#>(TBL_NAMES+1)
   2310  a78d		       0a		      asl		;*2
   2311  a78e		       90 02		      bcc	.1
   2312  a790		       c8		      iny
   2313  a791		       18		      clc
   2314  a792				   .1
   2315  a792		       69 01		      adc	#<(TBL_NAMES+1)
   2316  a794		       85 22		      sta	PT1	;ADDR LO - ENTRY
   2317  a796		       90 01		      bcc	.2
   2318  a798		       c8		      iny
   2319  a799				   .2
   2320  a799		       84 23		      sty	PT1 +1	;ADDR HI - ENTRY
   2321  a79b
   2322  a79b		       a0 01		      ldy	#1
   2323  a79d		       b1 22		      lda	(PT1),y
   2324  a79f		       85 25		      sta	PT2 +1	;ADDR LO - ENTRY STRING
   2325  a7a1		       88		      dey
   2326  a7a2		       b1 22		      lda	(PT1),y
   2327  a7a4		       85 24		      sta	PT2	;ADDR HI - ENTRY STRING
   2328  a7a6
   2329  a7a6		       18		      clc
   2330  a7a7				   .exit
   2331  a7a7		       60		      rts
   2332  a7a8
   2333  a7a8
   2334  a7a8							;----BUILD NAME TABLE FROM BASIC TEXT
   2335  a7a8				   BLD_TABLE  subroutine
   2336  a7a8		       20 de a7 	      jsr	BLD_TABLE_INIT	;INITIALIZE BLD TABLE
   2337  a7ab
   2338  a7ab		       a5 2b		      lda	BASSTRT
   2339  a7ad		       a6 2c		      ldx	BASSTRT +1
   2340  a7af
   2341  a7af				   .2
   2342  a7af		       85 22		      sta	PT1
   2343  a7b1		       86 23		      stx	PT1 +1
   2344  a7b3
   2345  a7b3		       a0 01		      ldy	#1
   2346  a7b5		       b1 22		      lda	(PT1),y
   2347  a7b7		       f0 24		      beq	.E
   2348  a7b9
   2349  a7b9		       aa		      tax
   2350  a7ba		       a0 04		      ldy	#4
   2351  a7bc		       b1 22		      lda	(PT1),y
   2352  a7be		       c9 22		      cmp	#34
   2353  a7c0		       d0 14		      bne	.5
   2354  a7c2
   2355  a7c2							; FOUND PROGRAM NAME
   2356  a7c2		       a0 00		      ldy	#0
   2357  a7c4		       a5 22		      lda	PT1
   2358  a7c6		       91 24		      sta	(PT2),y
   2359  a7c8		       a5 23		      lda	PT1 +1
   2360  a7ca		       c8		      iny
   2361  a7cb		       91 24		      sta	(PT2),y
   2362  a7cd
   2363  a7cd		       20 f8 ab 	      jsr	INC_PT2
   2364  a7d0		       20 f8 ab 	      jsr	INC_PT2
   2365  a7d3		       ee 00 60 	      inc	TBL_NAMES
   2366  a7d6
   2367  a7d6				   .5
   2368  a7d6		       a0 00		      ldy	#0
   2369  a7d8		       b1 22		      lda	(PT1),y
   2370  a7da		       4c af a7 	      jmp	.2
   2371  a7dd
   2372  a7dd				   .E
   2373  a7dd		       60		      rts
   2374  a7de
   2375  a7de							;INITIALIZE BLD TABLE
   2376  a7de				   BLD_TABLE_INIT subroutine
   2377  a7de		       a9 00		      lda	#0
   2378  a7e0		       8d 00 60 	      sta	TBL_NAMES
   2379  a7e3
   2380  a7e3		       a9 01		      lda	#<(TBL_NAMES+1)
   2381  a7e5		       a0 60		      ldy	#>(TBL_NAMES+1)
   2382  a7e7		       85 24		      sta	PT2
   2383  a7e9		       84 25		      sty	PT2 +1
   2384  a7eb		       60		      rts
   2385  a7ec
   2386  a7ec
   2387  a7ec
   2388  a7ec
   2389  a7ec							; ==============================================================
   2390  a7ec							; MENU SELECT PARAM
   2391  a7ec							; ==============================================================
   2392  a7ec
   2393  a7ec				   SEL_LOAD
   2394  a7ec							;LOADER PARAM	     :: +"filename",B|P|C|@ [,$adress]
   2395  a7ec							;			B=BASIC Code,P=Program,C=Cartridge,@=DOS COMMAND
   2396  a7ec		       a0 01		      ldy	#LDBUF_FN
   2397  a7ee		       a2 10		      ldx	#16
   2398  a7f0				   SELO_2
   2399  a7f0		       b1 7a		      lda	(CHRPTR),y
   2400  a7f2		       f0 0a		      beq	SELO_5
   2401  a7f4		       c9 22		      cmp	#34	; "
   2402  a7f6		       f0 06		      beq	SELO_5
   2403  a7f8		       91 22		      sta	(PT1),y	; SAVE FILENAME
   2404  a7fa		       c8		      iny
   2405  a7fb		       ca		      dex
   2406  a7fc		       d0 f2		      bne	SELO_2
   2407  a7fe				   SELO_5
   2408  a7fe		       88		      dey
   2409  a7ff		       f0 56		      beq	SELO_E
   2410  a801		       98		      tya
   2411  a802		       48		      pha
   2412  a803		       8a		      txa
   2413  a804		       f0 08		      beq	SELO_7a
   2414  a806		       a9 00		      lda	#0
   2415  a808				   SELO_7
   2416  a808		       c8		      iny
   2417  a809		       91 22		      sta	(PT1),y	; FILL FILENAME WITH 0
   2418  a80b		       ca		      dex
   2419  a80c		       d0 fa		      bne	SELO_7
   2420  a80e				   SELO_7a
   2421  a80e		       a8		      tay
   2422  a80f		       68		      pla
   2423  a810		       91 22		      sta	(PT1),y	; SAVE FILENAME LENGTH
   2424  a812		       38		      sec
   2425  a813		       65 7a		      adc	CHRPTR
   2426  a815		       85 7a		      sta	CHRPTR
   2427  a817		       90 02		      bcc	SELO_8
   2428  a819		       e6 7b		      inc	CHRPTR +1
   2429  a81b				   SELO_8
   2430  a81b		       20 73 00 	      jsr	CHRGET
   2431  a81e		       20 aa b7 	      jsr	CHKCOM
   2432  a821		       b0 08		      bcs	SELO_8a
   2433  a823		       c9 42		      cmp	#"B"	;BASIC FILE
   2434  a825		       f0 06		      beq	SELO_9
   2435  a827		       c9 43		      cmp	#"C"	;CARTRIDGE FILE
   2436  a829		       f0 02		      beq	SELO_9
   2437  a82b							;cmp #"@"
   2438  a82b							;beq SELO_9
   2439  a82b				   SELO_8a
   2440  a82b		       a9 50		      lda	#"P"	;NORMAL PROG
   2441  a82d				   SELO_9
   2442  a82d		       a0 11		      ldy	#LDBUF_TYP
   2443  a82f		       91 22		      sta	(PT1),y	; PROGRAM TYPE
   2444  a831		       20 73 00 	      jsr	CHRGET
   2445  a834		       20 aa b7 	      jsr	CHKCOM
   2446  a837		       b0 05		      bcs	SELO_9a
   2447  a839		       20 94 b7 	      jsr	GETADR
   2448  a83c		       b0 03		      bcs	SELO_9b
   2449  a83e				   SELO_9a
   2450  a83e		       a9 00		      lda	#0
   2451  a840		       aa		      tax
   2452  a841				   SELO_9b
   2453  a841		       a0 13		      ldy	#LDBUF_LAD +1
   2454  a843		       91 22		      sta	(PT1),y	; LOAD ADR HIGH
   2455  a845		       88		      dey
   2456  a846		       8a		      txa
   2457  a847		       91 22		      sta	(PT1),y	; LOAD ADR LOW
   2458  a849
   2459  a849		       ee 67 03 	      inc	DL_CNTLDR
   2460  a84c		       18		      clc
   2461  a84d		       a9 16		      lda	#LDBUF_END
   2462  a84f		       65 22		      adc	PT1
   2463  a851		       85 22		      sta	PT1
   2464  a853		       90 02		      bcc	SELO_E
   2465  a855		       e6 23		      inc	PT1 +1
   2466  a857				   SELO_E
   2467  a857		       60		      rts
   2468  a858
   2469  a858
   2470  a858
   2471  a858
   2472  a858							; =====================================================================
   2473  a858							; MENU LOADER
   2474  a858							; Schaltet in ROM Modus und lädt 1 oder mehrere Dateien in den Speicher
   2475  a858							; Lade Instruktionen stehen in der Tabelle DL_LDBUF
   2476  a858							; =====================================================================
   2477  a858
   2478  a858				   DO_LOADER  subroutine
   2479  a858		       a9 01		      lda	#EXEC_LOADER
   2480  a85a		       4c 35 a1 	      jmp	EXECUTE_R
   2481  a85d
   2482  a85d
   2483  a85d
   2484  a85d							; ==============================================================
   2485  a85d							; LOAD MENU DATA    "LOADER"
   2486  a85d							; ==============================================================
   2487  a85d
   2488  a85d		       ff ba	   SETFNUM    =	$ffba
   2489  a85d		       ff bd	   SETFNAM    =	$ffbd
   2490  a85d		       ff d5	   LOAD       =	$ffd5
   2491  a85d
   2492  a85d		       c6 59	   SY_BASCLR2 =	$c659
   2493  a85d		       c6 60	   SY_BASCLR  =	$c660
   2494  a85d		       c5 33	   SY_PGMLINK =	$c533
   2495  a85d
   2496  a85d				   LOAD_MENU  subroutine
   2497  a85d		       a2 a0		      ldx	#<(MSG_LOADER)
   2498  a85f		       a0 a8		      ldy	#>(MSG_LOADER)
   2499  a861		       a9 06		      lda	#6
   2500  a863		       20 bd ff 	      jsr	SETFNAM
   2501  a866		       a9 01		      lda	#1
   2502  a868		       ae 3e 03 	      ldx	F_CURDEV	; device#
   2503  a86b		       a0 00		      ldy	#0
   2504  a86d		       20 ba ff 	      jsr	SETFNUM
   2505  a870		       a9 00		      lda	#0	;load
   2506  a872		       a6 2b		      ldx	BASSTRT	;Start lo#
   2507  a874		       a4 2c		      ldy	BASSTRT +1	;Start hi#
   2508  a876		       20 d5 ff 	      jsr	LOAD
   2509  a879		       4c 5a b1 	      jmp	BASLOAD_END
   2510  a87c
   2511  a87c				   LOAD_BASIC subroutine
   2512  a87c		       20 85 a8 	      jsr	LOAD_BASIC_START
   2513  a87f				   LOAD_BASIC_2
   2514  a87f		       20 6a b3 	      jsr	MY_IECLOAD
   2515  a882		       4c 5a b1 	      jmp	BASLOAD_END
   2516  a885
   2517  a885				   LOAD_BASIC_START subroutine
   2518  a885		       a9 01		      lda	#1
   2519  a887		       ae 3e 03 	      ldx	F_CURDEV	; device#
   2520  a88a		       a0 00		      ldy	#0
   2521  a88c		       20 ba ff 	      jsr	SETFNUM
   2522  a88f		       a6 2b		      ldx	BASSTRT	;Start lo#
   2523  a891		       a4 2c		      ldy	BASSTRT +1	;Start hi#
   2524  a893		       86 c3		      stx	LOADPTR
   2525  a895		       84 c4		      sty	LOADPTR +1
   2526  a897		       60		      rts
   2527  a898
   2528  a898
   2529  a898
   2530  a898
   2531  a898		       f4 95	   SYS_IECOPEN =	$f495
   2532  a898		       ee 14	   SYS_TALK   =	$ee14
   2533  a898		       ee ce	   SYS_TALKSA =	$eece
   2534  a898							;SYS_LOAD2   = $f58a
   2535  a898							;SYS_LOAD2C  = $f5a3
   2536  a898		       e4 c1	   SYS_SETADR =	$e4c1
   2537  a898
   2538  a898
   2539  a898
   2540  a898
   2541  a898							; ==============================================================
   2542  a898							; LOADER TEXT
   2543  a898							; ==============================================================
   2544  a898
   2545  a898				   MSG_SYS
   2546  a898		       53 59 53 00	      dc.b	"SYS",0
   2547  a89c				   MSG_RUN
   2548  a89c		       52 55 4e 00	      dc.b	"RUN",0
   2549  a8a0
   2550  a8a0				   MSG_LOADER
   2551  a8a0		       4c 4f 41 44*	      dc.b	"LOADER",0
   2552  a8a7
   2553  a8a7				   MSG_DOS
   2554  a8a7		       40 20 3c 00	      dc.b	"@ ",60,0
   2555  a8ab							;  lda #60				    ;"<"
   2556  a8ab							;  lda #62				    ;">"
   2557  a8ab
   2558  a8ab
   2559  a8ab
   2560  a8ab
   2561  a8ab
   2562  a8ab
   2563  a8ab							; ========================================================================
   2564  a8ab							; FIRMWARE FLASHER
   2565  a8ab							; Schaltet in den RAM Modus
   2566  a8ab							; Ladet die Firmware Datei (FE3FIRMWARE) in den Speicher ab $2
   2567  a8ab							; Flashed den Bereich $2 bis $4 in den EEPROM
   2568  a8ab							; ========================================================================
   2569  a8ab
   2570  a8ab
   2571  a8ab		       20 00	   FLLO_STARTADR =	$2000
   2572  a8ab
   2573  a8ab
   2574  a8ab				   FIRMW_FLASHER subroutine
   2575  a8ab		       a9 90		      lda	#FEMOD_RAM_1 +$10	;RAM MODUS, BLK-5 PROTECTED
   2576  a8ad		       8d 02 9c 	      sta	IO_FINAL
   2577  a8b0		       20 b3 ae 	      jsr	SetVicMemConfig
   2578  a8b3
   2579  a8b3		       20 04 e4 	      jsr	SY_INITMSG	; INIT Message (e404)
   2580  a8b6		       20 c9 b6 	      jsr	CROUT
   2581  a8b9
   2582  a8b9							;CHANGE TO ROOT
   2583  a8b9		       20 94 bf 	      jsr	SPAR_DISKCMD
   2584  a8bc		       43 44 5f 00	      dc.b	"CD_",0	;EXIT D64
   2585  a8c0		       20 94 bf 	      jsr	SPAR_DISKCMD
   2586  a8c3		       43 44 2f 2f*	      dc.b	"CD//",0	;--> ROOT
   2587  a8c8
   2588  a8c8							;SET FILENAME PARAM
   2589  a8c8		       20 8e bf 	      jsr	SPAR_GETSTRING
   2590  a8cb		       0b 46 45 33*	      dc.b	11,"FE3FIRMWARE",0
   2591  a8d8		       85 24		      sta	PT2
   2592  a8da		       84 25		      sty	PT2 +1
   2593  a8dc
   2594  a8dc							;SET FILE PARAM
   2595  a8dc		       20 24 ab 	      jsr	LOAD_CART_AT
   2596  a8df		       90 1d		      bcc	.ok
   2597  a8e1
   2598  a8e1		       20 8e bf 	      jsr	SPAR_GETSTRING
   2599  a8e4		       0f 46 45 33*	      dc.b	15,"FE3FIRMWARE.PRG",0
   2600  a8f5		       85 24		      sta	PT2
   2601  a8f7		       84 25		      sty	PT2 +1
   2602  a8f9		       20 24 ab 	      jsr	LOAD_CART_AT
   2603  a8fc		       b0 0a		      bcs	.err
   2604  a8fe
   2605  a8fe				   .ok
   2606  a8fe							;FLASH FIRMWARE
   2607  a8fe		       20 b4 bc 	      jsr	MOVE_FLASH_FW
   2608  a901		       a9 00		      lda	#<FLLO_STARTADR
   2609  a903		       a0 20		      ldy	#>FLLO_STARTADR
   2610  a905		       20 5c 12 	      jsr	FLASHER
   2611  a908
   2612  a908				   .err
   2613  a908		       20 e0 a1 	      jsr	WAIT_KEY
   2614  a90b		       4c ba a3 	      jmp	UTIL_MENU
   2615  a90e
   2616  a90e
   2617  a90e
   2618  a90e
   2619  a90e							; ========================================================================
   2620  a90e							; CART FLASHER
   2621  a90e							; Schaltet in den RAM Modus
   2622  a90e							; Ladet die Loaderkonfig Datei (LOADER) in den BASIC Speicher
   2623  a90e							; Baut eine String Zeigertabelle auf ab TBL_NAMES ($6)
   2624  a90e							; Führt die Menü Auswahl Prozedur aus
   2625  a90e							; ========================================================================
   2626  a90e
   2627  a90e
   2628  a90e
   2629  a90e							;-------------- PRINT DLOADER SCREEN AND FLASH SELECTED FILES
   2630  a90e
   2631  a90e					      subroutine
   2632  a90e				   .00
   2633  a90e		       20 c1 a5 	      jsr	MENU_SEL
   2634  a911		       90 03		      bcc	.01
   2635  a913		       20 43 a9 	      jsr	MENU_FLASHER
   2636  a916				   .01
   2637  a916
   2638  a916				   CART_FLASHER
   2639  a916		       20 58 a0 	      jsr	INIT_CART	; Screen Colors
   2640  a919		       20 69 bf 	      jsr	SPAR_PRINTSTRING
   2641  a91c		       93 9e 0e 12*	      dc.b	CLRHOME,YELLOW,FONT2,RVSON,"---- cART fLASHER ----",CR,CR,0
   2642  a939
   2643  a939		       20 26 a4 	      jsr	DLOADER1
   2644  a93c		       e0 0d		      cpx	#13	;CR
   2645  a93e		       f0 ce		      beq	.00
   2646  a940		       4c ba a3 	      jmp	UTIL_MENU
   2647  a943
   2648  a943
   2649  a943
   2650  a943							;-------------- EXECUTE SELECTED MENU
   2651  a943
   2652  a943				   MENU_FLASHER subroutine
   2653  a943		       ad 67 03 	      lda	DL_CNTLDR	;NUMBER OF FILES
   2654  a946		       f0 61		      beq	.exit
   2655  a948
   2656  a948		       20 c5 b6 	      jsr	CLROUT	;CLEAR SCREEN
   2657  a94b
   2658  a94b		       ae 93 02 	      ldx	BIP_CMD
   2659  a94e		       f0 59		      beq	.exit
   2660  a950		       e0 05		      cpx	#TOK_RELO	;RELOAD
   2661  a952		       f0 55		      beq	.exit
   2662  a954
   2663  a954		       a9 90		      lda	#FEMOD_RAM_1 +$10	;RAM MODUS, BLK-5 PROTECTED
   2664  a956		       8d 02 9c 	      sta	IO_FINAL
   2665  a959		       20 b3 ae 	      jsr	SetVicMemConfig
   2666  a95c
   2667  a95c		       20 04 e4 	      jsr	SY_INITMSG	; INIT Message (e404)
   2668  a95f		       20 c9 b6 	      jsr	CROUT
   2669  a962
   2670  a962							;SAVE FILE COUNT
   2671  a962		       ad 67 03 	      lda	DL_CNTLDR
   2672  a965		       8d 56 03 	      sta	TBL_CLBUF +CLBUF_CNT
   2673  a968
   2674  a968							;GET ENTRY COUNT
   2675  a968		       20 6d ad 	      jsr	FLASH_SEARCH_END	;SEARCH LAST ENTRY
   2676  a96b		       8a		      txa
   2677  a96c		       30 3e		      bmi	.errfull
   2678  a96e
   2679  a96e							;LOAD FILES TO RAM DISK
   2680  a96e		       20 ff ad 	      jsr	RAMD_INIT	; INIT RAM DISK
   2681  a971		       20 87 aa 	      jsr	FLSH_LOADER	; LOAD FILES
   2682  a974		       b0 33		      bcs	.exit
   2683  a976
   2684  a976		       20 08 ae 	      jsr	RAMD_SIZE	; GET LENGTH OF PACKAGE
   2685  a979		       85 af		      sta	LOADEND +1
   2686  a97b		       86 ae		      stx	LOADEND
   2687  a97d		       8d 58 03 	      sta	TBL_CLBUF +CLBUF_PLEN +1
   2688  a980		       8e 57 03 	      stx	TBL_CLBUF +CLBUF_PLEN
   2689  a983
   2690  a983							;PRINT PACKAGE SIZE
   2691  a983		       20 69 bf 	      jsr	SPAR_PRINTSTRING
   2692  a986		       0d 50 41 43*	      dc.b	13,"PACKAGE SIZE ",0
   2693  a995		       a5 af		      lda	LOADEND +1
   2694  a997		       a6 ae		      ldx	LOADEND
   2695  a999		       20 3c b8 	      jsr	HEXOUT
   2696  a99c
   2697  a99c				   FLASH_PACKAGE_DEBUG
   2698  a99c		       20 d7 a9 	      jsr	FLASH_PACKAGE	; FLASH PACKAGE
   2699  a99f		       b0 21		      bcs	.errflash
   2700  a9a1
   2701  a9a1		       20 40 aa 	      jsr	FLASH_ENTRY	; FLASH CATALOG
   2702  a9a4		       b0 1c		      bcs	.errflash
   2703  a9a6
   2704  a9a6				   .wait
   2705  a9a6		       20 c8 a1 	      jsr	WAIT_KEY_TX
   2706  a9a9				   .exit
   2707  a9a9		       4c 16 a9 	      jmp	CART_FLASHER
   2708  a9ac
   2709  a9ac
   2710  a9ac
   2711  a9ac				   .errfull
   2712  a9ac		       20 69 bf 	      jsr	SPAR_PRINTSTRING
   2713  a9af		       0d 1c 43 41*	      dc.b	CR,RED,"CATALOG FULL!",0
   2714  a9bf		       18		      clc
   2715  a9c0		       90 e7		      bcc	.exit
   2716  a9c2
   2717  a9c2				   .errflash
   2718  a9c2		       20 69 bf 	      jsr	SPAR_PRINTSTRING
   2719  a9c5		       0d 1c 46 4c*	      dc.b	CR,RED,"FLASH ERROR!",0
   2720  a9d4		       18		      clc
   2721  a9d5		       90 cf		      bcc	.wait
   2722  a9d7
   2723  a9d7
   2724  a9d7							;WRITE PACKAGE INTO FLASH
   2725  a9d7				   FLASH_PACKAGE subroutine
   2726  a9d7		       20 69 bf 	      jsr	SPAR_PRINTSTRING
   2727  a9da		       0d 46 4c 41*	      dc.b	CR,"FLASHING PACKAGE...",0
   2728  a9ef
   2729  a9ef							;------------------------
   2730  a9ef							;PREPARE TO FLASH PACKAGE
   2731  a9ef							;------------------------
   2732  a9ef		       20 ff ad 	      jsr	RAMD_INIT	;INIT RAM DISK
   2733  a9f2		       20 b4 bc 	      jsr	MOVE_FLASH_FW	;PREPARE FLASH CODE
   2734  a9f5
   2735  a9f5		       20 6d ad 	      jsr	FLASH_SEARCH_END	;SEARCH LAST ENTRY
   2736  a9f8		       20 9d ad 	      jsr	FLASH_EADR	;GET FLASH START ADDRESS
   2737  a9fb		       8d 5a 03 	      sta	TBL_CLBUF +CLBUF_SADR +1	;ADR HI
   2738  a9fe		       8e 59 03 	      stx	TBL_CLBUF +CLBUF_SADR	;ADR LO
   2739  aa01		       8c 5b 03 	      sty	TBL_CLBUF +CLBUF_SBANK	;BANK
   2740  aa04
   2741  aa04							;PREPARE RAMD WRITE TO FLASH
   2742  aa04		       86 c1		      stx	SAVESTART
   2743  aa06		       85 c2		      sta	SAVESTART +1
   2744  aa08		       98		      tya
   2745  aa09		       09 20		      ora	#FEMOD_FLASH	;PROG MODE
   2746  aa0b		       8d 22 13 	      sta	__flash_BANK
   2747  aa0e
   2748  aa0e		       a0 00		      ldy	#0
   2749  aa10				   .flash
   2750  aa10		       a5 ae		      lda	LOADEND
   2751  aa12		       d0 06		      bne	.05
   2752  aa14		       a5 af		      lda	LOADEND +1
   2753  aa16		       f0 12		      beq	.exit
   2754  aa18		       c6 af		      dec	LOADEND +1
   2755  aa1a				   .05
   2756  aa1a		       c6 ae		      dec	LOADEND
   2757  aa1c		       20 37 ae 	      jsr	RAMD_GETC	;BYTE FROM RAMDISK
   2758  aa1f
   2759  aa1f		       20 20 13 	      jsr	FlashCodeWriteXP
   2760  aa22		       b0 1b		      bcs	.rts
   2761  aa24		       20 3a 13 	      jsr	FlashCodeWriteXpInc	;INCREMENT ADDRESS
   2762  aa27		       4c 10 aa 	      jmp	.flash
   2763  aa2a
   2764  aa2a				   .exit
   2765  aa2a							;SET END BANK/ADDRESS
   2766  aa2a		       ad 22 13 	      lda	__flash_BANK
   2767  aa2d		       29 0f		      and	#$0f
   2768  aa2f		       a6 c1		      ldx	SAVESTART
   2769  aa31		       a4 c2		      ldy	SAVESTART +1
   2770  aa33
   2771  aa33		       8c 5d 03 	      sty	TBL_CLBUF +CLBUF_EADR +1	;ADR HI
   2772  aa36		       8e 5c 03 	      stx	TBL_CLBUF +CLBUF_EADR	;ADR LO
   2773  aa39		       8d 5e 03 	      sta	TBL_CLBUF +CLBUF_EBANK	;BANK
   2774  aa3c		       18		      clc		;OK!
   2775  aa3d		       90 3e		      bcc	PRINT_OK
   2776  aa3f
   2777  aa3f				   .rts
   2778  aa3f		       60		      rts
   2779  aa40
   2780  aa40
   2781  aa40
   2782  aa40							;WRITE ENTRY INTO CATALOG
   2783  aa40				   FLASH_ENTRY subroutine
   2784  aa40		       20 69 bf 	      jsr	SPAR_PRINTSTRING
   2785  aa43		       0d 46 4c 41*	      dc.b	CR,"FLASHING CATALOG...",0
   2786  aa58
   2787  aa58		       20 6d ad 	      jsr	FLASH_SEARCH_END	;SEARCH LAST ENTRY
   2788  aa5b		       8a		      txa		;ENTRY COUNT
   2789  aa5c		       f0 03		      beq	.00
   2790  aa5e		       20 8d ad 	      jsr	ADD_CLBUF	;NEXT ENTRY (FREE SLOT)
   2791  aa61				   .00
   2792  aa61							;jsr FLASH_EADR		       ;GET FLASH ADDRESS
   2793  aa61		       a5 c3		      lda	LOADPTR
   2794  aa63		       a6 c4		      ldx	LOADPTR +1
   2795  aa65		       85 c1		      sta	SAVESTART
   2796  aa67		       86 c2		      stx	SAVESTART +1
   2797  aa69
   2798  aa69		       a9 20		      lda	#FEMOD_FLASH	;PROG MODE, BANK 0
   2799  aa6b		       8d 22 13 	      sta	__flash_BANK
   2800  aa6e
   2801  aa6e		       a0 00		      ldy	#0
   2802  aa70				   .04
   2803  aa70		       b9 41 03 	      lda	TBL_CLBUF,y
   2804  aa73		       20 20 13 	      jsr	FlashCodeWriteXP
   2805  aa76		       b0 0e		      bcs	.rts
   2806  aa78
   2807  aa78		       c8		      iny
   2808  aa79		       c0 20		      cpy	#CLBUF_END
   2809  aa7b		       d0 f3		      bne	.04
   2810  aa7d
   2811  aa7d				   PRINT_OK
   2812  aa7d		       20 69 bf 	      jsr	SPAR_PRINTSTRING
   2813  aa80		       1e 4f 4b 1f*	      dc.b	GREEN,"OK",BLUE,0
   2814  aa85		       18		      clc
   2815  aa86				   .rts
   2816  aa86		       60		      rts
   2817  aa87
   2818  aa87
   2819  aa87
   2820  aa87							; =====================================================================
   2821  aa87							; FLASH LOADER
   2822  aa87							; lädt eine oder mehrere Dateien in den Speicher ab $2
   2823  aa87							; kopiert die Ladeanweisungen + Datei in den Super RAM
   2824  aa87							; =====================================================================
   2825  aa87
   2826  aa87
   2827  aa87							;FLASH LOADER PARAM	   :: "filename",B|P|C [,$adress]     B=BASIC Code,P=Program,C=Cartridge
   2828  aa87				   FLSH_LOADER subroutine
   2829  aa87		       20 55 ab 	      jsr	WRITE_CLHDR	;WRITE PACKAGE HEADER
   2830  aa8a
   2831  aa8a		       20 12 ab 	      jsr	SET_PT2_LDBUF
   2832  aa8d				   .00
   2833  aa8d							;  lda #2				  ; SA=2: CARTRIDGE - WHOLE FILE
   2834  aa8d		       20 24 ab 	      jsr	LOAD_CART_AT
   2835  aa90		       b0 45		      bcs	.err
   2836  aa92
   2837  aa92							;CALC FILE LENGTH
   2838  aa92							;  ldx LOADEND
   2839  aa92							;  ldy LOADEND +1
   2840  aa92		       98		      tya
   2841  aa93		       38		      sec
   2842  aa94		       e9 20		      sbc	#>FLLO_STARTADR
   2843  aa96		       85 af		      sta	LOADEND +1
   2844  aa98
   2845  aa98
   2846  aa98							;STORE FILE LENGTH INTO LOAD BUFFER
   2847  aa98		       a0 15		      ldy	#LDBUF_FLEN +1
   2848  aa9a		       91 24		      sta	(PT2),y	; FILE LENGTGH HI
   2849  aa9c		       88		      dey
   2850  aa9d		       8a		      txa
   2851  aa9e		       91 24		      sta	(PT2),y	; FILE LENGTGH LO
   2852  aaa0
   2853  aaa0
   2854  aaa0
   2855  aaa0							;COPY LOAD BUFFER INTO RAMDISK
   2856  aaa0		       a2 16		      ldx	#LDBUF_END
   2857  aaa2		       a0 00		      ldy	#0
   2858  aaa4				   .05
   2859  aaa4		       b1 24		      lda	(PT2),y
   2860  aaa6		       20 20 ae 	      jsr	RAMD_PUTC
   2861  aaa9		       c8		      iny
   2862  aaaa		       ca		      dex
   2863  aaab		       d0 f7		      bne	.05
   2864  aaad
   2865  aaad
   2866  aaad							;COPY FILE INTO RAMDISK
   2867  aaad		       20 1b ab 	      jsr	SET_LPT_STARTADR
   2868  aab0		       a0 00		      ldy	#0
   2869  aab2				   .07
   2870  aab2		       a5 ae		      lda	LOADEND
   2871  aab4		       d0 06		      bne	.06
   2872  aab6		       a5 af		      lda	LOADEND +1
   2873  aab8		       f0 10		      beq	.09
   2874  aaba		       c6 af		      dec	LOADEND +1
   2875  aabc				   .06
   2876  aabc		       c6 ae		      dec	LOADEND
   2877  aabe
   2878  aabe		       b1 c3		      lda	(LOADPTR),y	;BYTE FROM FILE
   2879  aac0		       20 20 ae 	      jsr	RAMD_PUTC	;INTO RAMDISK
   2880  aac3
   2881  aac3		       c8		      iny
   2882  aac4		       d0 ec		      bne	.07
   2883  aac6		       e6 c4		      inc	LOADPTR +1
   2884  aac8		       d0 e8		      bne	.07
   2885  aaca
   2886  aaca				   .09
   2887  aaca
   2888  aaca
   2889  aaca							;GOTO NEXT FILE
   2890  aaca		       20 df aa 	      jsr	ADD_PT2_LDBUF
   2891  aacd		       ce 67 03 	      dec	DL_CNTLDR
   2892  aad0		       d0 bb		      bne	.00
   2893  aad2
   2894  aad2				   .exit
   2895  aad2		       20 67 b2 	      jsr	PRINT_IO
   2896  aad5		       18		      clc
   2897  aad6		       60		      rts
   2898  aad7
   2899  aad7				   .err
   2900  aad7				   LOAD_ERR
   2901  aad7		       20 42 ab 	      jsr	PRINT_LOADERR
   2902  aada		       20 bc a1 	      jsr	WAITSPACE
   2903  aadd		       38		      sec
   2904  aade		       60		      rts
   2905  aadf
   2906  aadf
   2907  aadf
   2908  aadf							;NEXT LOAD HEADER
   2909  aadf				   ADD_PT2_LDBUF subroutine
   2910  aadf		       18		      clc
   2911  aae0		       a9 16		      lda	#LDBUF_END
   2912  aae2		       65 24		      adc	PT2
   2913  aae4		       85 24		      sta	PT2
   2914  aae6		       90 02		      bcc	.0
   2915  aae8		       e6 25		      inc	PT2 +1
   2916  aaea				   .0
   2917  aaea		       60		      rts
   2918  aaeb
   2919  aaeb
   2920  aaeb							;PRINT LOAD MESSAGE, GET FILENAME
   2921  aaeb				   PRINT_LOADING subroutine
   2922  aaeb		       20 9d bf 	      jsr	SPAR_GETPTR
   2923  aaee		       20 6c bf 	      jsr	SPAR_PRINTSTRING_2
   2924  aaf1
   2925  aaf1		       20 69 bf 	      jsr	SPAR_PRINTSTRING
   2926  aaf4		       0d 20 20 3c*	      dc.b	CR, "	",60,0
   2927  aaf9
   2928  aaf9		       a0 00		      ldy	#LDBUF_LEN
   2929  aafb		       b1 24		      lda	(PT2),y	; FILENAME LEN
   2930  aafd		       a4 25		      ldy	PT2 +1
   2931  aaff		       a6 24		      ldx	PT2
   2932  ab01		       e8		      inx
   2933  ab02		       d0 01		      bne	.2
   2934  ab04		       c8		      iny
   2935  ab05				   .2
   2936  ab05		       20 bd ff 	      jsr	SETFNAM	;SET FILENAME
   2937  ab08		       20 d8 bf 	      jsr	STRNOUT	;PRINT FILENAME
   2938  ab0b
   2939  ab0b		       a9 3e		      lda	#62	;">"
   2940  ab0d		       a2 0d		      ldx	#CR
   2941  ab0f		       4c cd b6 	      jmp	CHROUT2
   2942  ab12
   2943  ab12
   2944  ab12
   2945  ab12							;------------
   2946  ab12				   SET_PT2_LDBUF subroutine
   2947  ab12							;LOADER PARAM	     :: "filename",B|P|C [,$adress]	B=BASIC Code,P=Program,C=Cartridge
   2948  ab12		       a9 6d		      lda	#<(DL_LDBUF)
   2949  ab14		       a0 03		      ldy	#>(DL_LDBUF)
   2950  ab16				   SET_PT2_AY
   2951  ab16		       85 24		      sta	PT2
   2952  ab18		       84 25		      sty	PT2 +1
   2953  ab1a		       60		      rts
   2954  ab1b
   2955  ab1b							;------------
   2956  ab1b				   SET_LPT_STARTADR subroutine
   2957  ab1b		       a9 00		      lda	#<FLLO_STARTADR
   2958  ab1d		       a0 20		      ldy	#>FLLO_STARTADR
   2959  ab1f				   SET_LPT_AY
   2960  ab1f		       85 c3		      sta	LOADPTR
   2961  ab21		       84 c4		      sty	LOADPTR +1
   2962  ab23		       60		      rts
   2963  ab24
   2964  ab24
   2965  ab24							;LOAD FILE INTO BUFFER
   2966  ab24				   LOAD_CART_AT subroutine
   2967  ab24		       a9 02		      lda	#2	; SA! - CARTRIDGE
   2968  ab26				   LOAD_AT    subroutine
   2969  ab26		       a8		      tay		; SA
   2970  ab27		       ae 3e 03 	      ldx	F_CURDEV	; device#
   2971  ab2a		       20 ba ff 	      jsr	SETFNUM
   2972  ab2d
   2973  ab2d		       20 eb aa 	      jsr	PRINT_LOADING
   2974  ab30		       4c 4f 41 44*	      dc.b	"LOAD FILE",0
   2975  ab3a
   2976  ab3a		       20 1b ab 	      jsr	SET_LPT_STARTADR
   2977  ab3d
   2978  ab3d							;LOAD FILE AT (FLLO_STARTADR)
   2979  ab3d		       20 6a b3 	      jsr	MY_IECLOAD
   2980  ab40		       90 12		      bcc	.ok
   2981  ab42				   PRINT_LOADERR
   2982  ab42				   .err
   2983  ab42		       20 69 bf 	      jsr	SPAR_PRINTSTRING
   2984  ab45		       0d 4c 4f 41*	      dc.b	13,"LOAD ERROR!",13,0
   2985  ab53		       38		      sec
   2986  ab54				   .ok
   2987  ab54		       60		      rts
   2988  ab55
   2989  ab55
   2990  ab55
   2991  ab55
   2992  ab55
   2993  ab55							;BIP_CMD     = $0293			  ;COMMAND BYTE
   2994  ab55							;BIP_IOBASE  = BIP_CMD +1		  ;BASE FOR IO2 REGISTER 1 AND 2
   2995  ab55							;BIP_RUNADR  = BIP_CMD +3		  ;RUN ADDRESS: 0=RUN BASIC, 1=RESET, 2=invalid, n=SYS
   2996  ab55
   2997  ab55
   2998  ab55
   2999  ab55
   3000  ab55							;WRITE PACKAGE HEADER
   3001  ab55				   WRITE_CLHDR subroutine
   3002  ab55		       a0 00		      ldy	#0
   3003  ab57				   .00
   3004  ab57		       b9 93 02 	      lda	BIP_CMD,y
   3005  ab5a		       20 20 ae 	      jsr	RAMD_PUTC
   3006  ab5d		       c8		      iny
   3007  ab5e		       c0 05		      cpy	#CLHDR_END
   3008  ab60		       90 f5		      bcc	.00
   3009  ab62		       60		      rts
   3010  ab63
   3011  ab63
   3012  ab63
   3013  ab63
   3014  ab63							; ========================================================================
   3015  ab63							; CART LOADER
   3016  ab63							; Schaltet in den RAM Modus
   3017  ab63							; Ladet die Flash File List in den BASIC Speicher
   3018  ab63							; Baut eine String Zeigertabelle auf ab TBL_NAMES ($6)
   3019  ab63							; Führt die Menü Auswahl Prozedur aus
   3020  ab63							; ========================================================================
   3021  ab63
   3022  ab63							;-------------- PRINT CLOADER SCREEN AND START SELECTED FILES
   3023  ab63
   3024  ab63					      subroutine
   3025  ab63				   .00
   3026  ab63		       20 06 ac 	      jsr	MENU_CSEL
   3027  ab66		       b0 03		      bcs	.01
   3028  ab68		       20 19 ac 	      jsr	MENU_CLOADER
   3029  ab6b				   .01
   3030  ab6b
   3031  ab6b				   CART_LOADER
   3032  ab6b		       20 58 a0 	      jsr	INIT_CART	; Screen Colors
   3033  ab6e		       20 69 bf 	      jsr	SPAR_PRINTSTRING
   3034  ab71		       93 9e 0e 12*	      dc.b	CLRHOME,YELLOW,FONT2,RVSON,"---- cART	lOADER ----",CR,CR,0
   3035  ab8e
   3036  ab8e		       20 98 ab 	      jsr	CLOADER1
   3037  ab91		       e0 0d		      cpx	#13	;CR
   3038  ab93		       f0 ce		      beq	.00
   3039  ab95		       4c d3 a0 	      jmp	SSCREEN
   3040  ab98
   3041  ab98
   3042  ab98
   3043  ab98				   CLOADER1   subroutine
   3044  ab98		       20 34 a0 	      jsr	COPYROM	; COPY FIRMWARE TO SRAM
   3045  ab9b		       b0 1d		      bcs	.02	; ==> RAM OK
   3046  ab9d
   3047  ab9d		       20 7d bf 	      jsr	SPAR_MSGBOX
   3048  aba0		       02 03 1c 72*	      dc.b	2, 3, RED, "ram eRROR at $a ...",0
   3049  abb7				   .exit
   3050  abb7		       a2 00		      ldx	#0
   3051  abb9		       60		      rts
   3052  abba
   3053  abba				   .02
   3054  abba		       20 76 a4 	      jsr	MENU_INIT
   3055  abbd		       a9 01		      lda	#1
   3056  abbf		       85 08		      sta	FLGCOM	;STRING OFFSET
   3057  abc1		       20 ca ab 	      jsr	MENU_CATALOG
   3058  abc4							;bcs .exit
   3059  abc4
   3060  abc4		       20 dc a4 	      jsr	MENU_HANDLER
   3061  abc7
   3062  abc7		       b8		      clv
   3063  abc8		       50 ce		      bvc	CLOADER1
   3064  abca
   3065  abca
   3066  abca							;-------------- LOAD CATALOG LOADER FILE
   3067  abca				   MENU_CATALOG subroutine
   3068  abca		       a9 20		      lda	#>$2000
   3069  abcc		       a0 00		      ldy	#<$2000
   3070  abce		       a2 10		      ldx	#16	; copy 16 pages
   3071  abd0		       20 3a a0 	      jsr	COPYROM_2	; COPY CATALOG TO SRAM
   3072  abd3
   3073  abd3							;jsr FLASH_SEARCH_END
   3074  abd3							;  jmp BLD_TABLE_CAT
   3075  abd3
   3076  abd3
   3077  abd3
   3078  abd3							;----BUILD NAME TABLE FROM CATALOG
   3079  abd3				   BLD_TABLE_CAT subroutine
   3080  abd3		       20 de a7 	      jsr	BLD_TABLE_INIT	;INITIALIZE BLD TABLE
   3081  abd6		       20 eb ad 	      jsr	SET_CLO_START	;SET CLOADER TABLE ADDRESS
   3082  abd9		       a0 00		      ldy	#0
   3083  abdb				   .00
   3084  abdb		       b1 c3		      lda	(LOADPTR),y
   3085  abdd		       c9 ff		      cmp	#$ff
   3086  abdf		       f0 16		      beq	.tblend	;TABLE END!!
   3087  abe1
   3088  abe1		       a5 c3		      lda	LOADPTR
   3089  abe3		       91 24		      sta	(PT2),y
   3090  abe5		       20 f8 ab 	      jsr	INC_PT2
   3091  abe8
   3092  abe8		       a5 c4		      lda	LOADPTR +1
   3093  abea		       91 24		      sta	(PT2),y
   3094  abec		       20 f8 ab 	      jsr	INC_PT2
   3095  abef
   3096  abef		       20 8d ad 	      jsr	ADD_CLBUF
   3097  abf2
   3098  abf2		       ee 00 60 	      inc	TBL_NAMES
   3099  abf5		       10 e4		      bpl	.00
   3100  abf7
   3101  abf7				   .tblend
   3102  abf7		       60		      rts
   3103  abf8
   3104  abf8
   3105  abf8
   3106  abf8
   3107  abf8
   3108  abf8							;INCREMENT PT2
   3109  abf8				   INC_PT2    subroutine
   3110  abf8		       e6 24		      inc	PT2
   3111  abfa		       d0 02		      bne	.2
   3112  abfc		       e6 25		      inc	PT2 +1
   3113  abfe				   .2
   3114  abfe		       60		      rts
   3115  abff
   3116  abff
   3117  abff
   3118  abff							;INCREMENT LOADPTR
   3119  abff				   INC_LOADPTR subroutine
   3120  abff		       e6 c3		      inc	LOADPTR
   3121  ac01		       d0 02		      bne	.2
   3122  ac03		       e6 c4		      inc	LOADPTR +1
   3123  ac05				   .2
   3124  ac05		       60		      rts
   3125  ac06
   3126  ac06
   3127  ac06
   3128  ac06							;---EXECUTE SELECTED MENU ENTRY
   3129  ac06				   MENU_CSEL  subroutine
   3130  ac06		       20 9c a5 	      jsr	MENU_SEL_INIT	;SET PT2 TO ENTRY STRING
   3131  ac09		       b0 0d		      bcs	.err
   3132  ac0b
   3133  ac0b							;COPY CATALOG ENTRY
   3134  ac0b				   COPY_CATALOG
   3135  ac0b		       a0 00		      ldy	#0
   3136  ac0d				   .1
   3137  ac0d		       b1 24		      lda	(PT2),y
   3138  ac0f		       99 41 03 	      sta	TBL_CLBUF,y
   3139  ac12		       c8		      iny
   3140  ac13		       c0 20		      cpy	#CLBUF_END	;LENGTH
   3141  ac15		       d0 f6		      bne	.1
   3142  ac17		       18		      clc
   3143  ac18				   .err
   3144  ac18		       60		      rts
   3145  ac19
   3146  ac19
   3147  ac19
   3148  ac19
   3149  ac19							;---LOAD SELECTED MENU ENTRY
   3150  ac19				   MENU_CLOADER subroutine
   3151  ac19							;SAVE FILE COUNT
   3152  ac19		       ad 56 03 	      lda	TBL_CLBUF +CLBUF_CNT
   3153  ac1c		       d0 01		      bne	.1
   3154  ac1e		       60		      rts
   3155  ac1f				   .1
   3156  ac1f		       8d 67 03 	      sta	DL_CNTLDR
   3157  ac22
   3158  ac22							;------------------------
   3159  ac22							;PREPARE TO READ PACKAGE
   3160  ac22							;------------------------
   3161  ac22		       20 ff ad 	      jsr	RAMD_INIT	;INIT RAM DISK
   3162  ac25		       a9 40		      lda	#FEMOD_ROM	;ROM MODUS
   3163  ac27		       8d 1a 02 	      sta	__RAMD_READ_MODE
   3164  ac2a
   3165  ac2a		       a9 40		      lda	#FEMOD_ROM	;ROM MODUS
   3166  ac2c		       0d 5b 03 	      ora	TBL_CLBUF +CLBUF_SBANK	;+ BANK
   3167  ac2f		       a8		      tay
   3168  ac30		       ad 5a 03 	      lda	TBL_CLBUF +CLBUF_SADR +1
   3169  ac33		       ae 59 03 	      ldx	TBL_CLBUF +CLBUF_SADR
   3170  ac36		       8d 17 02 	      sta	__RAMD_READ_ADR +1	;ADR HI
   3171  ac39		       8e 16 02 	      stx	__RAMD_READ_ADR	;ADR LO
   3172  ac3c		       8c 11 02 	      sty	__RAMD_READ_BANK	;BANK
   3173  ac3f		       20 7c ac 	      jsr	READ_CLHDR	;RESTORE PACKAGE HEADER
   3174  ac42
   3175  ac42		       20 aa ae 	      jsr	SET_MEM_CONFIG
   3176  ac45		       20 04 e4 	      jsr	SY_INITMSG	; INIT Message (e404)
   3177  ac48		       20 69 bf 	      jsr	SPAR_PRINTSTRING
   3178  ac4b		       0d 0d 4c 4f*	      dc.b	CR,CR,"LOADING PACKAGE...",CR,0
   3179  ac61
   3180  ac61		       a9 40		      lda	#FEMOD_ROM
   3181  ac63		       8d 02 9c 	      sta	IO_FINAL	; EEPROM!
   3182  ac66
   3183  ac66		       ad 67 03 	      lda	DL_CNTLDR
   3184  ac69				   .loadfile
   3185  ac69		       48		      pha
   3186  ac6a		       20 8a ac 	      jsr	READ_LDBUF	;RESTORE FILE LOAD BUFFER
   3187  ac6d		       20 98 ac 	      jsr	READ_FILE	;READ FILE FROM RAMDISK
   3188  ac70		       68		      pla
   3189  ac71		       aa		      tax
   3190  ac72		       ca		      dex
   3191  ac73		       8a		      txa
   3192  ac74							;dec DL_CNTLDR
   3193  ac74		       d0 f3		      bne	.loadfile
   3194  ac76
   3195  ac76		       20 67 b2 	      jsr	PRINT_IO	;PRINT IO SETTING
   3196  ac79							;  jsr WAIT_KEY
   3197  ac79		       4c 62 a6 	      jmp	EXEC_PACKAGE
   3198  ac7c
   3199  ac7c
   3200  ac7c
   3201  ac7c							;RESTORE PACKAGE HEADER
   3202  ac7c				   READ_CLHDR subroutine
   3203  ac7c		       a0 00		      ldy	#0
   3204  ac7e				   .00
   3205  ac7e		       20 37 ae 	      jsr	RAMD_GETC
   3206  ac81		       99 93 02 	      sta	BIP_CMD,y
   3207  ac84		       c8		      iny
   3208  ac85		       c0 05		      cpy	#CLHDR_END
   3209  ac87		       90 f5		      bcc	.00
   3210  ac89		       60		      rts
   3211  ac8a
   3212  ac8a
   3213  ac8a
   3214  ac8a							;RESTORE FILE LOAD BUFFER
   3215  ac8a				   READ_LDBUF subroutine
   3216  ac8a		       a0 00		      ldy	#0
   3217  ac8c				   .00
   3218  ac8c		       20 37 ae 	      jsr	RAMD_GETC
   3219  ac8f		       99 6d 03 	      sta	DL_LDBUF,y
   3220  ac92		       c8		      iny
   3221  ac93		       c0 16		      cpy	#LDBUF_END
   3222  ac95		       90 f5		      bcc	.00
   3223  ac97		       60		      rts
   3224  ac98
   3225  ac98
   3226  ac98
   3227  ac98							;READ FILE FROM RAMDISK
   3228  ac98				   READ_FILE  subroutine
   3229  ac98		       20 12 ab 	      jsr	SET_PT2_LDBUF
   3230  ac9b		       20 a8 75 	      jsr	PRINT_LOADMSG	;SET LOAD INFO, PRINT MESSAGE
   3231  ac9e
   3232  ac9e		       ad 81 03 	      lda	DL_LDBUF +LDBUF_FLEN
   3233  aca1		       85 ae		      sta	LOADEND	;FILE LENGTH
   3234  aca3		       ad 82 03 	      lda	DL_LDBUF +LDBUF_FLEN +1
   3235  aca6		       85 af		      sta	LOADEND +1	;FILE LENGTH HI
   3236  aca8
   3237  aca8							;ldx DL_LDBUF +LDBUF_TYP
   3238  aca8							;cpx #"C"
   3239  aca8							;beq .0
   3240  aca8
   3241  aca8		       a6 b9		      ldx	SY_SA	;SA
   3242  acaa		       e0 02		      cpx	#2
   3243  acac		       f0 19		      beq	.0	;CARTRIDGE
   3244  acae
   3245  acae		       a5 ae		      lda	LOADEND	;SUBTRACT LOAD ADDRESS
   3246  acb0		       38		      sec
   3247  acb1		       e9 02		      sbc	#2
   3248  acb3		       85 ae		      sta	LOADEND
   3249  acb5		       b0 02		      bcs	.01
   3250  acb7		       c6 af		      dec	LOADEND +1
   3251  acb9				   .01
   3252  acb9
   3253  acb9		       20 37 ae 	      jsr	RAMD_GETC	;SKIP LOAD ADDRESS
   3254  acbc		       a8		      tay
   3255  acbd		       20 37 ae 	      jsr	RAMD_GETC
   3256  acc0		       ca		      dex
   3257  acc1		       d0 04		      bne	.0	;SA=0: -->
   3258  acc3		       85 c4		      sta	LOADPTR +1
   3259  acc5		       84 c3		      sty	LOADPTR	;LOAD ADDRESS FROM FILE
   3260  acc7				   .0
   3261  acc7		       a9 c3		      lda	#LOADPTR
   3262  acc9		       20 94 b4 	      jsr	PRINT_ATADR_2	;PRINT LOADING FROM $xxxx
   3263  accc		       a0 00		      ldy	#0
   3264  acce				   .1
   3265  acce		       a5 ae		      lda	LOADEND
   3266  acd0		       d0 06		      bne	.2
   3267  acd2		       a5 af		      lda	LOADEND +1
   3268  acd4		       f0 11		      beq	.le
   3269  acd6		       c6 af		      dec	LOADEND +1
   3270  acd8				   .2
   3271  acd8		       c6 ae		      dec	LOADEND
   3272  acda		       20 37 ae 	      jsr	RAMD_GETC
   3273  acdd		       91 c3		      sta	(LOADPTR),y
   3274  acdf		       e6 c3		      inc	LOADPTR
   3275  ace1		       d0 eb		      bne	.1
   3276  ace3		       e6 c4		      inc	LOADPTR +1
   3277  ace5		       d0 e7		      bne	.1
   3278  ace7
   3279  ace7				   .le
   3280  ace7		       a9 c3		      lda	#LOADPTR
   3281  ace9		       20 af b4 	      jsr	PRINT_TOADR_2	;PRINT TO $xxxx
   3282  acec
   3283  acec		       a6 c3		      ldx	LOADPTR
   3284  acee		       a4 c4		      ldy	LOADPTR +1
   3285  acf0		       86 ae		      stx	LOADEND	;LOAD END POINTER FOR 3d LABY ...
   3286  acf2		       84 af		      sty	LOADEND +1
   3287  acf4		       ad 7e 03 	      lda	DL_LDBUF +LDBUF_TYP
   3288  acf7		       c9 42		      cmp	#"B"
   3289  acf9		       d0 03		      bne	.nobas	;BASIC PROG? --> no
   3290  acfb		       20 5c b1 	      jsr	BASLOAD_END_2	;RELINK BASIC
   3291  acfe				   .nobas
   3292  acfe		       60		      rts
   3293  acff
   3294  acff
   3295  acff
   3296  acff
   3297  acff		       03 6d	   DL_LDBUF   =	TBL_DATA +12	;LOAD BUFFER - bis zu 4 x DATEI,OPTIONS
   3298  acff		       00 00	   LDBUF_LEN  =	0	;OFFSET FILENAME LENGTH
   3299  acff		       00 01	   LDBUF_FN   =	1	;OFFSET FILENAME
   3300  acff		       00 11	   LDBUF_TYP  =	17	;OFFSET TYPE: B=BASIC, P=PROGRAM, C=CARTRIDGE
   3301  acff		       00 12	   LDBUF_LAD  =	18	;OFFSET LOAD ADRESS
   3302  acff		       00 14	   LDBUF_FLEN =	20	;OFFSET FILE LENGTH
   3303  acff		       00 16	   LDBUF_END  =	22	;STRUCT LDBUF LEN
   3304  acff
   3305  acff
   3306  acff
   3307  acff		       00 00	   CLBUF_LEN  =	0	;OFFSET ENTRY NAME LENGTH
   3308  acff		       00 01	   CLBUF_NAM  =	1	;OFFSET ENTRY NAME
   3309  acff		       00 15	   CLBUF_CNT  =	21	;OFFSET FILES COUNT
   3310  acff		       00 16	   CLBUF_PLEN =	22	;OFFSET PACKAGE LENGTH
   3311  acff		       00 18	   CLBUF_SADR =	24	;OFFSET START ADDRESS
   3312  acff		       00 1a	   CLBUF_SBANK =	26	;OFFSET START BANK
   3313  acff		       00 1b	   CLBUF_EADR =	27	;OFFSET END ADDRESS
   3314  acff		       00 1d	   CLBUF_EBANK =	29	;OFFSET END BANK
   3315  acff		       00 20	   CLBUF_END  =	32	;STRUCT LDBUF LEN
   3316  acff
   3317  acff		       00 00	   CLHDR_CMD  =	0	;OFFSET START COMMAND (SYS/RES/RUN)
   3318  acff		       00 01	   CLHDR_IO1  =	1	;OFFSET IO REGISTER 1
   3319  acff		       00 02	   CLHDR_IO2  =	2	;OFFSET IO REGISTER 2
   3320  acff		       00 03	   CLHDR_ADR  =	3	;OFFSET START ADDRESS
   3321  acff		       00 05	   CLHDR_END  =	5	;STRUCT LDHDR LEN
   3322  acff
   3323  acff
   3324  acff							; ========================================================================
   3325  acff							; FLASH STATISTIC (F6,F3)
   3326  acff							; get info: number of entries, bytes free, bytes allocated
   3327  acff							; print info, wait for key
   3328  acff							; ========================================================================
   3329  acff
   3330  acff		       20 00	   CLO_STARTADR =	$2000
   3331  acff
   3332  acff				   FLASH_INFO subroutine
   3333  acff							;jsr CLROUT			       ;CLEAR SCREEN
   3334  acff		       20 69 bf 	      jsr	SPAR_PRINTSTRING
   3335  ad02		       93 0e 9e 	      dc.b	CLRHOME,FONT2,YELLOW
   3336  ad05		       23 23 20 66*	      dc.b	"## fLASH sTATUS ##",13,13,13
   3337  ad1a		       05 65 4e 54*	      dc.b	WHITE,"eNTRIES: ",0
   3338  ad25
   3339  ad25		       20 6d ad 	      jsr	FLASH_SEARCH_END	;SEARCH LAST ENTRY
   3340  ad28		       a9 00		      lda	#0
   3341  ad2a		       20 cd dd 	      jsr	PRNINT	;print integer in X/A
   3342  ad2d
   3343  ad2d							;txa
   3344  ad2d							;jsr HEXOUT2
   3345  ad2d
   3346  ad2d		       20 69 bf 	      jsr	SPAR_PRINTSTRING
   3347  ad30		       0d 0d 0d 62*	      dc.b	13,13,13,"bYTES FREE:$",0
   3348  ad40		       20 c1 ad 	      jsr	FLASH_FREE	;BYTES FREE
   3349  ad43		       20 61 ad 	      jsr	HEXOUT_LA
   3350  ad46
   3351  ad46		       20 69 bf 	      jsr	SPAR_PRINTSTRING
   3352  ad49		       0d 0d 41 4c*	      dc.b	13,13,"ALLOCATED: $",0
   3353  ad58		       20 d8 ad 	      jsr	FLASH_ALLOC	;BYTES ALLOCATED
   3354  ad5b		       20 61 ad 	      jsr	HEXOUT_LA
   3355  ad5e		       4c e0 a1 	      jmp	WAIT_KEY
   3356  ad61
   3357  ad61
   3358  ad61
   3359  ad61
   3360  ad61							;PRINT LARGE ADDRESS (24 bit)
   3361  ad61				   HEXOUT_LA  subroutine
   3362  ad61		       a5 b7		      lda	LEN_FNAM
   3363  ad63		       20 49 b8 	      jsr	HEXOUT2
   3364  ad66		       a5 bc		      lda	PTR_FNAM +1
   3365  ad68		       a6 bb		      ldx	PTR_FNAM
   3366  ad6a		       4c 45 b8 	      jmp	HEXOUT4
   3367  ad6d
   3368  ad6d
   3369  ad6d
   3370  ad6d							;SEARCH LAST ENTRY / COUNT IN XR
   3371  ad6d				   FLASH_SEARCH_END subroutine
   3372  ad6d		       a9 40		      lda	#FEMOD_ROM	;ROM MODUS
   3373  ad6f		       8d 02 9c 	      sta	IO_FINAL
   3374  ad72		       20 eb ad 	      jsr	SET_CLO_START	;SET CLOADER TABLE ADDRESS
   3375  ad75		       a2 00		      ldx	#0
   3376  ad77		       a0 00		      ldy	#0
   3377  ad79		       f0 03		      beq	.00
   3378  ad7b
   3379  ad7b				   .03
   3380  ad7b		       20 8f ad 	      jsr	.07
   3381  ad7e				   .00
   3382  ad7e		       b1 c3		      lda	(LOADPTR),y
   3383  ad80		       c9 ff		      cmp	#$ff
   3384  ad82		       f0 08		      beq	.tblend	;TABLE END!!
   3385  ad84		       e8		      inx
   3386  ad85		       98		      tya
   3387  ad86		       d0 f3		      bne	.03
   3388  ad88
   3389  ad88		       a0 20		      ldy	#CLBUF_END	;ENTRY LENGTH
   3390  ad8a		       d0 f2		      bne	.00
   3391  ad8c
   3392  ad8c				   .tblend
   3393  ad8c		       60		      rts
   3394  ad8d
   3395  ad8d
   3396  ad8d				   ADD_CLBUF
   3397  ad8d		       a9 20		      lda	#CLBUF_END	;ENTRY LENGTH
   3398  ad8f				   .07
   3399  ad8f		       18		      clc
   3400  ad90		       65 c3		      adc	LOADPTR
   3401  ad92		       85 c3		      sta	LOADPTR
   3402  ad94		       90 02		      bcc	.08
   3403  ad96		       e6 c4		      inc	LOADPTR +1
   3404  ad98				   .08
   3405  ad98		       60		      rts
   3406  ad99
   3407  ad99
   3408  ad99
   3409  ad99							;CALC PACKAGE START ADDRESS
   3410  ad99				   FLASH_SADR subroutine
   3411  ad99		       a0 18		      ldy	#CLBUF_SADR
   3412  ad9b		       d0 02		      bne	.00
   3413  ad9d
   3414  ad9d							;CALC PACKAGE END ADDRESS
   3415  ad9d				   FLASH_EADR
   3416  ad9d		       a0 1b		      ldy	#CLBUF_EADR
   3417  ad9f				   .00
   3418  ad9f		       b1 c3		      lda	(LOADPTR),y
   3419  ada1		       aa		      tax
   3420  ada2		       c8		      iny
   3421  ada3		       b1 c3		      lda	(LOADPTR),y
   3422  ada5		       48		      pha
   3423  ada6		       c8		      iny
   3424  ada7		       b1 c3		      lda	(LOADPTR),y
   3425  ada9		       c9 ff		      cmp	#$ff
   3426  adab		       d0 09		      bne	.01
   3427  adad
   3428  adad		       68		      pla
   3429  adae		       a9 20		      lda	#>$2000	;BLK 1 :: START OF CATALOG
   3430  adb0		       a2 00		      ldx	#<$2000
   3431  adb2		       a0 01		      ldy	#1
   3432  adb4		       d0 04		      bne	.02
   3433  adb6
   3434  adb6				   .01
   3435  adb6		       29 0f		      and	#$0f	;BANK
   3436  adb8		       a8		      tay
   3437  adb9		       68		      pla
   3438  adba				   .02
   3439  adba		       85 bc		      sta	PTR_FNAM +1	;ADR HI
   3440  adbc		       86 bb		      stx	PTR_FNAM	;ADR LO
   3441  adbe		       84 b7		      sty	LEN_FNAM	;BANK
   3442  adc0		       60		      rts
   3443  adc1
   3444  adc1
   3445  adc1
   3446  adc1							;CALC ALLOCATED BYTES IN FLASH (YR/XR/AC)
   3447  adc1				   FLASH_FREE subroutine
   3448  adc1		       20 d8 ad 	      jsr	FLASH_ALLOC
   3449  adc4		       38		      sec
   3450  adc5		       a9 00		      lda	#0	;BUILD COMPLEMENT
   3451  adc7		       e5 bb		      sbc	PTR_FNAM
   3452  adc9		       85 bb		      sta	PTR_FNAM
   3453  adcb		       a9 80		      lda	#$80
   3454  adcd		       e5 bc		      sbc	PTR_FNAM +1
   3455  adcf		       85 bc		      sta	PTR_FNAM +1
   3456  add1		       a9 07		      lda	#7
   3457  add3		       e5 b7		      sbc	LEN_FNAM
   3458  add5		       85 b7		      sta	LEN_FNAM
   3459  add7		       60		      rts
   3460  add8
   3461  add8
   3462  add8
   3463  add8							;CALC FREE BYTES IN FLASH (YR/XR/AC)
   3464  add8				   FLASH_ALLOC subroutine
   3465  add8		       20 9d ad 	      jsr	FLASH_EADR
   3466  addb		       a5 bc		      lda	PTR_FNAM +1	;ADR HI
   3467  addd		       20 f2 ad 	      jsr	CALC_BLK2OFFS	;BLOCK ADDRESS TO OFFSET
   3468  ade0		       c6 b7		      dec	LEN_FNAM
   3469  ade2		       46 b7		      lsr	LEN_FNAM	;64K BLOCK - HI HI
   3470  ade4		       90 02		      bcc	.04
   3471  ade6		       09 80		      ora	#$80	;ADD 32K ON ODD BANK
   3472  ade8				   .04
   3473  ade8		       85 bc		      sta	PTR_FNAM +1	;ADR HI
   3474  adea		       60		      rts
   3475  adeb
   3476  adeb
   3477  adeb
   3478  adeb							;---- SET CLOADER TABLE ADDRESS
   3479  adeb				   SET_CLO_START subroutine
   3480  adeb		       a9 00		      lda	#<CLO_STARTADR
   3481  aded		       a0 20		      ldy	#>CLO_STARTADR
   3482  adef		       4c 1f ab 	      jmp	SET_LPT_AY
   3483  adf2
   3484  adf2
   3485  adf2
   3486  adf2							;---- BLOCK ADDRESS TO OFFSET
   3487  adf2				   CALC_BLK2OFFS subroutine
   3488  adf2		       c9 a0		      cmp	#$a0
   3489  adf4		       90 03		      bcc	.00
   3490  adf6							;adr $A to $C
   3491  adf6		       38		      sec
   3492  adf7		       e9 20		      sbc	#$20
   3493  adf9				   .00
   3494  adf9							;adr $2 to $8
   3495  adf9		       38		      sec
   3496  adfa		       e9 20		      sbc	#$20
   3497  adfc		       29 7f		      and	#$7f
   3498  adfe		       60		      rts
   3499  adff
   3500  adff
   3501  adff
   3502  adff
   3503  adff							;CLOADER HEADER (CLOAD BUFFER)
   3504  adff		       00 00	   CLBUF_LEN  =	0	;OFFSET ENTRY NAME LENGTH
   3505  adff		       00 01	   CLBUF_NAM  =	1	;OFFSET ENTRY NAME
   3506  adff		       00 15	   CLBUF_CNT  =	21	;OFFSET FILES COUNT
   3507  adff		       00 16	   CLBUF_PLEN =	22	;OFFSET PACKAGE LENGTH
   3508  adff		       00 18	   CLBUF_SADR =	24	;OFFSET START ADDRESS
   3509  adff		       00 1a	   CLBUF_SBANK =	26	;OFFSET START BANK
   3510  adff		       00 1b	   CLBUF_EADR =	27	;OFFSET END ADDRESS
   3511  adff		       00 1d	   CLBUF_EBANK =	29	;OFFSET END BANK
   3512  adff		       00 20	   CLBUF_END  =	32	;STRUCT LDBUF LEN
   3513  adff
   3514  adff
   3515  adff
   3516  adff							; ========================================================================
   3517  adff							; RAM DISK
   3518  adff							; ========================================================================
   3519  adff
   3520  adff							;PREPARE FOR READ
   3521  adff				   RAMD_INIT  subroutine
   3522  adff		       a0 20		      ldy	#(__RAMDISK_E - __RAMDISK)
   3523  ae01		       a9 ae		      lda	#>__RAMDISK
   3524  ae03		       a2 66		      ldx	#<__RAMDISK
   3525  ae05		       4c 03 b9 	      jmp	COPY_PROC
   3526  ae08
   3527  ae08
   3528  ae08							;GET SIZE
   3529  ae08				   RAMD_SIZE  subroutine
   3530  ae08		       ad 02 02 	      lda	__RAMD_WRITE_BANK
   3531  ae0b		       29 0f		      and	#15
   3532  ae0d		       a8		      tay
   3533  ae0e		       88		      dey
   3534  ae0f		       88		      dey
   3535  ae10
   3536  ae10		       ad 09 02 	      lda	__RAMD_WRITE_ADR +1
   3537  ae13		       c9 80		      cmp	#$80
   3538  ae15		       90 02		      bcc	.08
   3539  ae17
   3540  ae17		       e9 20		      sbc	#($A0 - $80)
   3541  ae19				   .08
   3542  ae19		       38		      sec
   3543  ae1a		       e9 20		      sbc	#>FLLO_STARTADR
   3544  ae1c
   3545  ae1c		       ae 08 02 	      ldx	__RAMD_WRITE_ADR
   3546  ae1f		       60		      rts
   3547  ae20
   3548  ae20
   3549  ae20							;-----------------------
   3550  ae20				   RAMD_PUTC  subroutine
   3551  ae20		       20 00 02 	      jsr	__RAMD_PUTC
   3552  ae23							;-----------------------
   3553  ae23				   RAMD_PUTC_REST subroutine
   3554  ae23		       ee 08 02 	      inc	__RAMD_WRITE_ADR
   3555  ae26		       d0 0e		      bne	.exit
   3556  ae28
   3557  ae28		       ad 09 02 	      lda	__RAMD_WRITE_ADR +1
   3558  ae2b		       20 50 ae 	      jsr	RAMD_INC_PTR
   3559  ae2e		       8d 09 02 	      sta	__RAMD_WRITE_ADR +1
   3560  ae31		       90 03		      bcc	.exit
   3561  ae33
   3562  ae33		       ee 02 02 	      inc	__RAMD_WRITE_BANK
   3563  ae36				   .exit
   3564  ae36		       60		      rts
   3565  ae37
   3566  ae37
   3567  ae37							;-----------------------
   3568  ae37				   RAMD_GETC  subroutine
   3569  ae37		       20 10 02 	      jsr	__RAMD_GETC
   3570  ae3a							;-----------------------
   3571  ae3a				   RAMD_GETC_REST subroutine
   3572  ae3a		       ee 16 02 	      inc	__RAMD_READ_ADR
   3573  ae3d		       d0 10		      bne	.exit
   3574  ae3f
   3575  ae3f		       48		      pha
   3576  ae40		       ad 17 02 	      lda	__RAMD_READ_ADR +1
   3577  ae43		       20 50 ae 	      jsr	RAMD_INC_PTR
   3578  ae46		       8d 17 02 	      sta	__RAMD_READ_ADR +1
   3579  ae49		       90 03		      bcc	.exit2
   3580  ae4b		       ee 11 02 	      inc	__RAMD_READ_BANK
   3581  ae4e				   .exit2
   3582  ae4e		       68		      pla
   3583  ae4f				   .exit
   3584  ae4f		       60		      rts
   3585  ae50
   3586  ae50
   3587  ae50
   3588  ae50							;-----------------------
   3589  ae50				   RAMD_INC_PTR subroutine
   3590  ae50		       38		      sec
   3591  ae51		       69 00		      adc	#0
   3592  ae53		       c9 80		      cmp	#$80
   3593  ae55		       90 0e		      bcc	.exit
   3594  ae57
   3595  ae57		       c9 a0		      cmp	#$A0
   3596  ae59		       b0 04		      bcs	.01
   3597  ae5b
   3598  ae5b		       a9 a0		      lda	#$A0
   3599  ae5d		       d0 06		      bne	.exit
   3600  ae5f
   3601  ae5f				   .01
   3602  ae5f		       c9 c0		      cmp	#$C0
   3603  ae61		       90 02		      bcc	.exit
   3604  ae63				   .02
   3605  ae63		       a9 20		      lda	#>FLLO_STARTADR
   3606  ae65				   .exit
   3607  ae65		       60		      rts
   3608  ae66
   3609  ae66
   3610  ae66
   3611  ae66							;-------- SUPER RAM PROCEDURE TO WRITE A BYTE
   3612  ae66				   __RAMDISK
   3613  ae66					      RORG	BIP
   3614  ae66
   3615  ae66				   __RAMD_PUTC subroutine
   3616  ae66		       48		      pha
   3617  ae67
   3618  ae67		       02 02	   __RAMD_WRITE_BANK =	. +1
   3619  ae67		       a9 a0		      lda	#FEMOD_SRAM + 0	;SUPER RAM MODUS, BANK 0
   3620  ae69		       8d 02 9c 	      sta	IO_FINAL
   3621  ae6c
   3622  ae6c		       68		      pla
   3623  ae6c		       02 08	   __RAMD_WRITE_ADR =	. +1
   3624  ae6d		       8d 00 20 	      sta	FLLO_STARTADR
   3625  ae70
   3626  ae70		       02 0b	   __RAMD_WRITE_MODE =	. +1
   3627  ae70		       a9 90		      lda	#FEMOD_RAM_1 +$10	;RAM MODUS, BLK-5 PROTECTED
   3628  ae72							; lda #FEMOD_ROM			 ;ROM MODUS
   3629  ae72		       8d 02 9c 	      sta	IO_FINAL
   3630  ae75		       60		      rts
   3631  ae76
   3632  ae76
   3633  ae76							;-------- SUPER RAM PROCEDURE TO READ A BYTE
   3634  ae76
   3635  ae76				   __RAMD_GETC subroutine
   3636  ae76		       02 11	   __RAMD_READ_BANK =	. +1
   3637  ae76		       a9 a0		      lda	#FEMOD_SRAM + 0	;SUPER RAM MODUS, BANK 0
   3638  ae78		       8d 02 9c 	      sta	IO_FINAL
   3639  ae7b
   3640  ae7b		       02 16	   __RAMD_READ_ADR =	. +1
   3641  ae7b		       ad 00 20 	      lda	FLLO_STARTADR
   3642  ae7e		       48		      pha
   3643  ae7f
   3644  ae7f		       02 1a	   __RAMD_READ_MODE =	. +1
   3645  ae7f							;  lda #FEMOD_RAM_1 +$10		  ;RAM MODUS, BLK-5 PROTECTED
   3646  ae7f		       a9 40		      lda	#FEMOD_ROM	;ROM MODUS
   3647  ae81		       8d 02 9c 	      sta	IO_FINAL
   3648  ae84		       68		      pla
   3649  ae85		       60		      rts
   3650  ae86
   3651  ae86					      REND
   3652  ae86				   __RAMDISK_E
   3653  ae86
   3654  ae86
   3655  ae86
   3656  ae86
   3657  ae86
   3658  ae86
   3659  ae86
   3660  ae86							; ==============================================================
   3661  ae86							; SET MEMORY CONFIG
   3662  ae86							; ==============================================================
   3663  ae86
   3664  ae86				   MOVE_WEDGE_LOW subroutine
   3665  ae86		       a9 40		      lda	#<MY_WEDGE_LO	; store the new dest address lo-byte
   3666  ae88		       a0 03		      ldy	#>MY_WEDGE_LO	; store the new dest address hi-byte $516
   3667  ae8a
   3668  ae8a
   3669  ae8a							;MOVE_WEDGE
   3670  ae8a							;sty mwcmd + 1 		       ; store the new dest address hi-byte $516
   3671  ae8a							;stx mwcmd			       ; store the new dest address lo-byte
   3672  ae8a							;txa
   3673  ae8a
   3674  ae8a		       18		      clc
   3675  ae8b		       69 a7		      adc	#<(MY_WEDGE_END - MY_WEDGE_START)
   3676  ae8d		       85 58		      sta	$58	; low-byte new end address +1 $0501+fl len
   3677  ae8f
   3678  ae8f		       98		      tya
   3679  ae90		       69 0c		      adc	#>(MY_WEDGE_END - MY_WEDGE_START)
   3680  ae92		       85 59		      sta	$59	; high-byte new end address +1 $0501+fl len
   3681  ae94
   3682  ae94		       a9 26		      lda	#<MY_WEDGE_START
   3683  ae96		       85 5f		      sta	$5f	; low-byte start address $a000
   3684  ae98		       a9 af		      lda	#>MY_WEDGE_START
   3685  ae9a		       85 60		      sta	$60	; high-byte start address $a000
   3686  ae9c
   3687  ae9c		       a9 cd		      lda	#<MY_WEDGE_END
   3688  ae9e		       85 5a		      sta	$5a	; low-byte end address +1 $a???
   3689  aea0		       a9 bb		      lda	#>MY_WEDGE_END
   3690  aea2		       85 5b		      sta	$5b	; high-byte end address +1 $a???
   3691  aea4
   3692  aea4							;  sei
   3693  aea4		       20 bf c3 	      jsr	SY_MOVEMEM	; execute move memory vic routine and return
   3694  aea7							;  cli
   3695  aea7		       4c 40 03 	      jmp	MY_WEDGE_LO
   3696  aeaa
   3697  aeaa							;  jsr .01
   3698  aeaa							;  cli
   3699  aeaa							;  rts
   3700  aeaa
   3701  aeaa							;.01
   3702  aeaa							;  jmp (mwcmd)
   3703  aeaa
   3704  aeaa
   3705  aeaa				   MOVE_CODE
   3706  aeaa
   3707  aeaa
   3708  aeaa
   3709  aeaa
   3710  aeaa
   3711  aeaa
   3712  aeaa							; ==============================================================
   3713  aeaa							; SET MEMORY CONFIG
   3714  aeaa							; ==============================================================
   3715  aeaa
   3716  aeaa							;  lda #$9F			;0kb
   3717  aeaa							;  lda #$9E			;3kb
   3718  aeaa							;  lda #$9D			;8kb	      %1001 1101
   3719  aeaa							;  lda #$99			;16kb	      %1001 1001
   3720  aeaa							;  lda #$91			;24kb	      %1001 0001
   3721  aeaa							;  lda #$90			;24+3kb       %1001 0000
   3722  aeaa							;  lda #$80			;ALL RAM      %1000 0000
   3723  aeaa
   3724  aeaa				   SET_MEM_CONFIG SUBROUTINE
   3725  aeaa							;  jsr CLROUT				  ;CLEAR SCREEN
   3726  aeaa		       ad 94 02 	      lda	BIP_IOBASE
   3727  aead		       8d 02 9c 	      sta	IO_FINAL
   3728  aeb0		       0d 95 02 	      ora	BIP_IOBASE +1
   3729  aeb3
   3730  aeb3				   SetVicMemConfig subroutine
   3731  aeb3		       aa		      tax
   3732  aeb4		       29 03		      and	#$03
   3733  aeb6		       c9 02		      cmp	#$02
   3734  aeb8		       f0 1f		      beq	SetVicAs3K
   3735  aeba		       c9 03		      cmp	#$03
   3736  aebc		       f0 13		      beq	SetVicAsUnexpanded
   3737  aebe		       8a		      txa
   3738  aebf		       29 0c		      and	#$0c
   3739  aec1		       c9 0c		      cmp	#$0c
   3740  aec3		       f0 1c		      beq	SetVicAs8K
   3741  aec5		       c9 00		      cmp	#$00
   3742  aec7		       f0 20		      beq	SetVicAs24K
   3743  aec9
   3744  aec9				   SetVicAs16K		; set vic as 16k expanded
   3745  aec9		       a9 10		      lda	#$10	; Screen memory page start $1000 (hi-byte)
   3746  aecb		       a2 12		      ldx	#$12	; Start of memory $1200 (hi-byte)
   3747  aecd		       a0 60		      ldy	#$60	; Top of memory $6000 (hi-byte)
   3748  aecf		       d0 1e		      bne	dir_unexpand
   3749  aed1
   3750  aed1				   SetVicAsUnexpanded		; set vic as unexpanded
   3751  aed1		       a9 1e		      lda	#$1e	; Screen memory page start $1e00 (hi-byte)
   3752  aed3		       a2 10		      ldx	#$10	; Start of memory $1000 (hi-byte)
   3753  aed5		       a0 1e		      ldy	#$1e	; Top of memory $1e00 (hi-byte)
   3754  aed7		       d0 16		      bne	dir_unexpand
   3755  aed9
   3756  aed9				   SetVicAs3K		; set vic as 3k expanded
   3757  aed9		       a9 1e		      lda	#$1e	; Screen memory page start $1e00 (hi-byte)
   3758  aedb		       a2 04		      ldx	#$04	; Start of memory $0400 (hi-byte)
   3759  aedd		       a0 1e		      ldy	#$1e	; Top of memory $1e00 (hi-byte)
   3760  aedf		       d0 0e		      bne	dir_unexpand
   3761  aee1
   3762  aee1				   SetVicAs8K		; set vic as 8k expanded
   3763  aee1		       a9 10		      lda	#$10	; Screen memory page start $1000 (hi-byte)
   3764  aee3		       a2 12		      ldx	#$12	; Start of memory $1200 (hi-byte)
   3765  aee5		       a0 40		      ldy	#$40	; Top of memory $4000 (hi-byte)
   3766  aee7		       d0 06		      bne	dir_unexpand
   3767  aee9
   3768  aee9				   SetVicAs24K		; set vic as 24k expanded
   3769  aee9		       a9 10		      lda	#$10	; Screen memory page start $1000 (hi-byte)
   3770  aeeb		       a2 12		      ldx	#$12	; Start of memory $1200 (hi-byte)
   3771  aeed		       a0 80		      ldy	#$80	; Top of memory $6000 (hi-byte)
   3772  aeef
   3773  aeef				   dir_unexpand 		;@@@
   3774  aeef		       8d 88 02 	      sta	dir_screen_mem_page	; Screen memory page start (hi-byte)
   3775  aef2							;  lda dir_start_memory_hi
   3776  aef2		       8e 82 02 	      stx	dir_start_memory_hi	; Start of memory (hi-byte)
   3777  aef5		       8c 84 02 	      sty	dir_top_memory_hi	; Top of memory (hi-byte)
   3778  aef8
   3779  aef8							;jsr UnexpandMoveMemory
   3780  aef8
   3781  aef8							;jsr SY_INITIO2			; Initialize I/O
   3782  aef8		       4c 4e a1 	      jmp	INIT_BASIC
   3783  aefb
   3784  aefb
   3785  aefb
   3786  aefb
   3787  aefb
   3788  aefb							;Pad to end to create valid cart image
   3789  aefb							;  org $afff
   3790  aefb							;  dc.b #$00
   3791  aefb
   3792  aefb
   3793  aefb
   3794  aefb
   3795  aefb
   3796  aefb
   3797  aefb
   3798  aefb
   3799  aefb
   3800  aefb
   3801  aefb
   3802  aefb
   3803  aefb
   3804  aefb
   3805  aefb
   3806  aefb
   3807  aefb
   3808  aefb
   3809  aefb
   3810  aefb							; ==============================================================
   3811  aefb							; MY BIG WEDGE (ROM only)
   3812  aefb							; ==============================================================
   3813  aefb
   3814  aefb				   ROM_INPLOOP subroutine
   3815  aefb		       c9 5f		      cmp	#95	; SAVE? (left arrow)
   3816  aefd		       f0 07		      beq	DO_SAVE
   3817  aeff		       aa		      tax
   3818  af00		       68		      pla
   3819  af01		       68		      pla
   3820  af02		       8a		      txa
   3821  af03		       4c 3c b1 	      jmp	RAM_INPUT_LOOP
   3822  af06
   3823  af06
   3824  af06				   DO_SAVE    subroutine
   3825  af06		       ae 3e 03 	      ldx	F_CURDEV	; device#
   3826  af09		       a9 01		      lda	#$01	; lfn #01
   3827  af0b		       a8		      tay
   3828  af0c		       20 ba ff 	      jsr	SETLFS
   3829  af0f		       20 0c b3 	      jsr	GET_FILENAM
   3830  af12							;jmp $e156
   3831  af12
   3832  af12				   .1
   3833  af12		       a6 2d		      ldx	BASVAR
   3834  af14		       a4 2e		      ldy	BASVAR +1
   3835  af16		       a9 2b		      lda	#BASSTRT
   3836  af18		       20 d8 ff 	      jsr	$ffd8
   3837  af1b		       b0 01		      bcs	.2
   3838  af1d		       60		      rts
   3839  af1e							;jmp CROUT
   3840  af1e
   3841  af1e				   .2
   3842  af1e		       a9 00		      lda	#EXEC_SAVE
   3843  af20		       20 35 a1 	      jsr	EXECUTE_R
   3844  af23		       b0 ed		      bcs	.1
   3845  af25
   3846  af25				   .rts
   3847  af25		       60		      rts
   3848  af26
   3849  af26							;jmp MY_IECSAVE
   3850  af26
   3851  af26
   3852  af26
   3853  af26							;jmp MY_WDGE_START
   3854  af26
   3855  af26				   MY_WEDGE_START
   3856  af26
   3857  af26
   3858  af26
   3859  af26
   3860  af26							; == START OF MINI WEDGE ============================================================
   3861  af26
   3862  af26
   3863  af26							; ==============================================================
   3864  af26							; RELOCATOR
   3865  af26							; ==============================================================
   3866  af26
   3867  af26		       01 00	   STACK      =	$0100
   3868  af26
   3869  af26
   3870  af26		       ff a2	   SY_TIMOUTFLG =	$ffa2
   3871  af26		       ff b7	   SY_GETSTATUS =	$ffb7
   3872  af26
   3873  af26
   3874  af26				   MY_RELOCATOR subroutine
   3875  af26		       af 28	   _relo      =	. +2
   3876  af26		       20 b7 ff 	      jsr	SY_GETSTATUS	;WEDGE ADDRESS TO STACK
   3877  af26		       af 2a	   _relo0000  =	. +1
   3878  af29		       ad 28 af 	      lda	_relo
   3879  af2c		       ba		      tsx
   3880  af2d		       bd 00 01 	      lda	STACK,x	;ADR HIGH
   3881  af30		       a8		      tay
   3882  af31		       ca		      dex
   3883  af32		       bd 00 01 	      lda	STACK,x	;ADR LO
   3884  af35		       85 22		      sta	PT1
   3885  af37		       84 23		      sty	PT1 +1
   3886  af39							;  sta PT3
   3887  af39							;  sty PT3 +1				  ;BASE ADDRESS
   3888  af39
   3889  af39		       a0 02		      ldy	#(_relo0000 - _relo)
   3890  af3b		       38		      sec
   3891  af3c		       f1 22		      sbc	(PT1),y
   3892  af3e		       85 24		      sta	PT2
   3893  af40		       c8		      iny
   3894  af41		       a5 23		      lda	PT1 +1
   3895  af43		       f1 22		      sbc	(PT1),y
   3896  af45		       85 25		      sta	PT2 +1
   3897  af47		       05 24		      ora	PT2
   3898  af49		       f0 52		      beq	RELO_E	;RELOCATION NOT NESSECARY
   3899  af4b
   3900  af4b
   3901  af4b				   RELO_0
   3902  af4b		       18		      clc
   3903  af4c		       a9 00		      lda	#>(RELO_TAB - _relo)
   3904  af4e		       65 23		      adc	PT1 +1	;RELO_TAB POINTER HI
   3905  af50		       85 23		      sta	PT1 +1
   3906  af52		       a9 a3		      lda	#<(RELO_TAB - _relo)
   3907  af54		       a2 01		      ldx	#1
   3908  af56				   RELO_2
   3909  af56		       86 08		      stx	FLGCOM
   3910  af58				   RELO_3
   3911  af58		       18		      clc
   3912  af59		       65 22		      adc	PT1
   3913  af5b		       85 22		      sta	PT1	;RELO_TAB POINTER LO
   3914  af5d		       90 02		      bcc	RELO_3a
   3915  af5f		       e6 23		      inc	PT1 +1	;RELO_TAB POINTER HI
   3916  af61				   RELO_3a
   3917  af61		       a0 00		      ldy	#0
   3918  af63		       b1 22		      lda	(PT1),y
   3919  af65		       d0 12		      bne	RELO_3c
   3920  af67
   3921  af67		       aa		      tax
   3922  af68		       c8		      iny
   3923  af69		       b1 22		      lda	(PT1),y
   3924  af6b		       d0 0a		      bne	RELO_3b
   3925  af6d
   3926  af6d							;-------------- 00.00 GET OFFSET
   3927  af6d		       c8		      iny
   3928  af6e		       b1 22		      lda	(PT1),y
   3929  af70		       f0 2b		      beq	RELO_E
   3930  af72		       aa		      tax
   3931  af73		       a9 03		      lda	#3
   3932  af75		       d0 df		      bne	RELO_2
   3933  af77
   3934  af77				   RELO_3b
   3935  af77		       88		      dey
   3936  af78		       8a		      txa
   3937  af79				   RELO_3c
   3938  af79		       18		      clc
   3939  af7a		       65 24		      adc	PT2
   3940  af7c		       91 22		      sta	(PT1),y
   3941  af7e		       85 c3		      sta	LOADPTR	;MODIFY ADDRESS LO
   3942  af80		       c8		      iny
   3943  af81		       b1 22		      lda	(PT1),y
   3944  af83		       65 25		      adc	PT2 +1
   3945  af85		       91 22		      sta	(PT1),y
   3946  af87		       85 c4		      sta	LOADPTR +1	;MODIFY ADDRESS HI
   3947  af89
   3948  af89		       88		      dey
   3949  af8a		       18		      clc
   3950  af8b		       b1 c3		      lda	(LOADPTR),y
   3951  af8d		       65 24		      adc	PT2
   3952  af8f		       91 c3		      sta	(LOADPTR),y	;RELINK ADDRESS LO
   3953  af91		       a4 08		      ldy	FLGCOM
   3954  af93		       b1 c3		      lda	(LOADPTR),y
   3955  af95		       65 25		      adc	PT2 +1
   3956  af97		       91 c3		      sta	(LOADPTR),y	;RELINK ADDRESS HI
   3957  af99
   3958  af99		       a9 02		      lda	#2
   3959  af9b		       d0 bb		      bne	RELO_3
   3960  af9d
   3961  af9d				   RELO_E
   3962  af9d							;_relo0003 = . +1
   3963  af9d							;  jmp MY_WEDGE_INIT
   3964  af9d
   3965  af9d
   3966  af9d
   3967  af9d
   3968  af9d							; ==============================================================
   3969  af9d							; MY WEDGE
   3970  af9d							; ==============================================================
   3971  af9d
   3972  af9d		       03 00	   PTR_ERROR_OUT =	$0300
   3973  af9d		       03 02	   PTR_INPUT_LOOP =	$0302
   3974  af9d		       03 0a	   PTR_FRMELEM =	$030a
   3975  af9d		       03 30	   PTR_LOAD   =	$0330
   3976  af9d		       03 32	   PTR_SAVE   =	$0332
   3977  af9d
   3978  af9d							;-------------------- WEDGE INIT
   3979  af9d				   MY_WEDGE_INIT
   3980  af9d		       af 9e	   _relo5000  =	. +1
   3981  af9d		       a9 3f		      lda	#<INPUT_LOOP
   3982  af9f		       a2 b1		      ldx	#>INPUT_LOOP
   3983  afa1		       8d 02 03 	      sta	PTR_INPUT_LOOP
   3984  afa4		       8e 03 03 	      stx	PTR_INPUT_LOOP +1
   3985  afa4		       af a8	   _relo5001  =	. +1
   3986  afa7		       a9 61		      lda	#<MY_LOAD
   3987  afa9		       a2 b3		      ldx	#>MY_LOAD
   3988  afab		       8d 30 03 	      sta	PTR_LOAD
   3989  afae		       8e 31 03 	      stx	PTR_LOAD +1
   3990  afae		       af b2	   _relo5003  =	. +1
   3991  afb1		       a9 c2		      lda	#<MY_SAVE
   3992  afb3		       a2 b4		      ldx	#>MY_SAVE
   3993  afb5		       8d 32 03 	      sta	PTR_SAVE
   3994  afb8		       8e 33 03 	      stx	PTR_SAVE +1
   3995  afb8		       af bc	   _relo5002  =	. +1
   3996  afbb		       a9 45		      lda	#<MY_FRMELEM
   3997  afbd		       a2 b7		      ldx	#>MY_FRMELEM
   3998  afbf		       8d 0a 03 	      sta	PTR_FRMELEM
   3999  afc2		       8e 0b 03 	      stx	PTR_FRMELEM +1
   4000  afc5		       a9 08		      lda	#$08
   4001  afc7		       8d 3e 03 	      sta	F_CURDEV
   4002  afca		       60		      rts
   4003  afcb
   4004  afcb
   4005  afcb
   4006  afcb							; ==============================================================
   4007  afcb							; RELOCATOR TABLE
   4008  afcb							; ==============================================================
   4009  afcb
   4010  afcb							;  org $be00
   4011  afcb
   4012  afcb
   4013  afcb				   RELO_TAB		;RELOC TABLE - 2 BYTE OFFSET LOW/HI
   4014  afcb		       2a af		      dc.w	_relo0000
   4015  afcd		       3d b1 77 b1	      dc.w	_relo0001,_relo0002	;,_relo0003
   4016  afd1		       f3 b5 92 b1*	      dc.w	_relo0010,_relo0011,_relo0012,_relo0013,_relo0014,_relo0015,_relo0016
   4017  afdf		       c2 b1 c6 b1*	      dc.w	_relo0020,_relo0021,_relo0022,_relo0023,_relo0024,_relo0025,_relo0026
   4018  afed		       0d b2 10 b2*	      dc.w	_relo0030,_relo0031,_relo0032 ,_relo0037,_relo0038,_relo0039
   4019  aff9		       79 b2 ab b2*	      dc.w	_relo0040,_relo0041,_relo0042
   4020  afff		       e1 b2		      dc.w	_relo0050
   4021  b001		       1f b3 25 b3*	      dc.w	_relo0060,_relo0061,_relo0062
   4022  b007		       5f b3		      dc.w	_relo0072
   4023  b009		       75 b3 78 b3*	      dc.w	_relo0080,_relo0081,_relo0082 ,_relo0084,_relo0085,_relo0086,_relo0087,_relo0088	;,_relo0089
   4024  b019		       da b3 dd b3*	      dc.w	_relo0090,_relo0091, _relo0093,_relo0094,_relo0095 ,_relo0097,_relo0098
   4025  b027		       3f b5 96 b5*	      dc.w	_relo0100,_relo0101,_relo0102,_relo0103,_relo0104,_relo0105,_relo0106
   4026  b035		       f8 b5 03 b6*	      dc.w	_relo0110,_relo0111,_relo0112,_relo0113,_relo0114,_relo0115,_relo0116,_relo0117,_relo0118,_relo0119
   4027  b049		       36 b6 51 b6*	      dc.w	_relo0120,_relo0121,_relo0122,_relo0123,_relo0124,_relo0125,_relo0126,_relo0127,_relo0128,_relo0129
   4028  b05d		       8f b6 92 b6*	      dc.w	_relo0130,_relo0131,_relo0132,_relo0133,_relo0134,_relo0135
   4029  b069		       bf b6 ce b6	      dc.w	_relo0141,_relo0142	;,_relo0143,_relo0144
   4030  b06d		       5b b7 88 b7	      dc.w	_relo0150,_relo0151
   4031  b071		       9e b7		      dc.w	_relo0160
   4032  b073		       bb b7 c4 b7*	      dc.w	_relo0170,_relo0171,_relo0172,_relo0173,_relo0174,_relo0175
   4033  b07f		       0f b8 16 b8*	      dc.w	_relo0180,_relo0181,_relo0182, _relo0184,_relo0185,_relo0186,_relo0187,_relo0188,_relo0189
   4034  b091		       46 b8 4f b8	      dc.w	_relo0200,_relo0201
   4035  b095		       6a b8 70 b8	      dc.w	_relo0211,_relo0212
   4036  b099		       89 b8 8f b8*	      dc.w	_relo0220,_relo0221,_relo0222
   4037  b09f		       e0 b8 e4 b8	      dc.w	_relo0230,_relo0231
   4038  b0a3		       f8 b8 fb b8	      dc.w	_relo0250,_relo0251
   4039  b0a7		       9c b3 91 b5*	      dc.w	_relo0300, _relo0303, _relo0305,_relo0306,_relo0307,_relo0308,_relo0309
   4040  b0b5		       8a b5 99 b5*	      dc.w	_relo0310,_relo0311,_relo0312,_relo0313,_relo0314,_relo0315,_relo0316,_relo0317,_relo0318,_relo0319
   4041  b0c9		       89 b6 95 b6*	      dc.w	_relo0320 ,_relo0322,_relo0323,_relo0324	;,_relo0325,_relo0326,_relo0327,_relo0328,_relo0329
   4042  b0d1		       b9 b9 48 ba*	      dc.w	_relo0350,_relo0351,_relo0352,_relo0353,_relo0354,_relo0355,_relo0356,_relo0357,_relo0358,_relo0359
   4043  b0e5		       37 bb 43 b9*	      dc.w	_relo0360,_relo0361,_relo0362,_relo0363 ,_relo0365
   4044  b0ef		       e8 b4 eb b4*	      dc.w	_relo0400,_relo0401,_relo0402,_relo0403,_relo0404,_relo0405,_relo0406,_relo0407,_relo0408,_relo0409
   4045  b103		       2e b5 31 b5*	      dc.w	_relo0410,_relo0411,_relo0412	;,_relo0413,_relo0414,_relo0415,_relo0416,_relo0417,_relo0418,_relo0419
   4046  b109		       cc b4 d5 b4	      dc.w	_relo0420,_relo0421	;,_relo0412,_relo0413,_relo0414,_relo0415,_relo0416,_relo0417,_relo0418,_relo0419
   4047  b10d		       79 b4		      dc.w	_relo0430	;,_relo0431;,_relo0412,_relo0413,_relo0414,_relo0415,_relo0416,_relo0417,_relo0418,_relo0419
   4048  b10f		       00 00		      dc.w	0
   4049  b111
   4050  b111		       02		      dc.b	2	;RELOC TABLE - 2 BYTE OFFSET LOW/HI
   4051  b112		       9e af a8 af*	      dc.w	_relo5000,_relo5001,_relo5002,_relo5003
   4052  b11a		       1a b2 21 b2*	      dc.w	_relo5010,_relo5011,_relo5012,_relo5013
   4053  b122		       50 b3		      dc.w	_relo5070
   4054  b124		       9b b4 b5 b4	      dc.w	_relo5090,_relo5091
   4055  b128		       af b8		      dc.w	_relo5230
   4056  b12a		       f4 b8		      dc.w	_relo5250
   4057  b12c		       00 00		      dc.w	0
   4058  b12e		       00		      dc.b	0
   4059  b12f
   4060  b12f
   4061  b12f
   4062  b12f
   4063  b12f							; ==============================================================
   4064  b12f							; MY INPUT LOOP
   4065  b12f							; ==============================================================
   4066  b12f
   4067  b12f
   4068  b12f				   INLO_1     subroutine
   4069  b12f		       ae 03 03 	      ldx	PTR_INPUT_LOOP +1	; CODE IN ROM?
   4070  b132		       e0 b1		      cpx	#>INPUT_LOOP
   4071  b134		       d0 06		      bne	.10
   4072  b136		       20 fb ae 	      jsr	ROM_INPLOOP
   4073  b139		       4c 3f b1 	      jmp	INPUT_LOOP
   4074  b13c
   4075  b13c				   .10
   4076  b13c				   RAM_INPUT_LOOP
   4077  b13c		       b1 3d	   _relo0001  =	. +1
   4078  b13c		       20 62 b1 	      jsr	INLO_LOOP2
   4079  b13f
   4080  b13f				   INPUT_LOOP subroutine
   4081  b13f		       20 60 c5 	      jsr	$c560	; INPUT LINE
   4082  b142		       86 7a		      stx	CHRPTR
   4083  b144		       84 7b		      sty	CHRPTR +1
   4084  b146		       20 73 00 	      jsr	CHRGET
   4085  b149		       aa		      tax
   4086  b14a		       f0 f3		      beq	INPUT_LOOP
   4087  b14c		       a2 ff		      ldx	#$ff
   4088  b14e		       86 3a		      stx	dir_basiclinenumber_hi	; DIRECT MODE
   4089  b150		       b0 dd		      bcs	INLO_1
   4090  b152		       4c 9c c4 	      jmp	$c49c	; INSERT LINE INTO BASICTEXT
   4091  b155
   4092  b155
   4093  b155
   4094  b155
   4095  b155
   4096  b155				   DOLO_ERR
   4097  b155		       b1 56	   _relo0024  =	. +1
   4098  b155		       20 af b5 	      jsr	PRINT_DISK_ERR
   4099  b158		       38		      sec
   4100  b159		       60		      rts
   4101  b15a
   4102  b15a
   4103  b15a
   4104  b15a
   4105  b15a				   BASLOAD_END
   4106  b15a		       b0 f9		      bcs	DOLO_ERR
   4107  b15c				   BASLOAD_END_2
   4108  b15c		       86 2d		      stx	BASVAR
   4109  b15e		       84 2e		      sty	BASVAR +1
   4110  b160							;jsr SY_PGMLINK
   4111  b160				   DOLO_E
   4112  b160		       18		      clc		; LOAD OK
   4113  b161		       60		      rts
   4114  b162
   4115  b162
   4116  b162
   4117  b162				   INLO_LOOP2
   4118  b162		       c9 24		      cmp	#"$"	; CATALOG?
   4119  b164		       f0 2b		      beq	DO_CATALOG
   4120  b166		       c9 40		      cmp	#"@"	; DISK CMD?
   4121  b168		       f0 2d		      beq	DO_DISKCMD
   4122  b16a		       c9 2f		      cmp	#"/"	; LOAD BASIC?
   4123  b16c		       f0 3a		      beq	DO_LOADBAS
   4124  b16e		       c9 25		      cmp	#"%"	; LOAD BINARY?
   4125  b170		       f0 42		      beq	DO_LOADBIN
   4126  b172		       c9 3e		      cmp	#">"	; VERIFY BINARY?
   4127  b174		       f0 2d		      beq	DO_VERIFY
   4128  b176
   4129  b176
   4130  b176		       b1 77	   _relo0002  =	. +1
   4131  b176		       20 ab b8 	      jsr	TOKENIZER
   4132  b179		       d0 66		      bne	INLO_LOOP2b
   4133  b17b
   4134  b17b		       20 79 c5 	      jsr	$c579	; CONVERT LINE
   4135  b17e		       20 73 00 	      jsr	CHRGET
   4136  b181		       c9 23		      cmp	#"#"	; DEVICE?
   4137  b183		       f0 0f		      beq	DO_SETDEV
   4138  b185		       c9 2c		      cmp	#","	; HEX CALC
   4139  b187		       f0 11		      beq	DO_HEXCALC
   4140  b189				   INLO_LOOP2a
   4141  b189		       68		      pla
   4142  b18a		       68		      pla
   4143  b18b		       20 79 00 	      jsr	CHRGOT
   4144  b18e		       4c e7 c7 	      jmp	$c7e7	; EXECUTE LINE
   4145  b191
   4146  b191
   4147  b191							;LIST DISK CATALOG ($)
   4148  b191				   DO_CATALOG
   4149  b191		       b1 92	   _relo0011  =	. +1
   4150  b191		       4c f2 b5 	      jmp	PRINT_CATALOG	;JSR!!!!
   4151  b194
   4152  b194
   4153  b194							;SET / LIST DEVICE# FOR DISK COMMANDS (#)
   4154  b194				   DO_SETDEV
   4155  b194		       b1 95	   _relo0012  =	. +1
   4156  b194		       4c 3a b3 	      jmp	SET_DEVICE
   4157  b197
   4158  b197
   4159  b197							;SEND DISK COMMAND (@)
   4160  b197				   DO_DISKCMD
   4161  b197		       b1 98	   _relo0014  =	. +1
   4162  b197		       4c 37 b5 	      jmp	DISK_CMD
   4163  b19a
   4164  b19a
   4165  b19a							;SHOW WORD VALUE IN DEC, HEX, BIN, ASC (,)
   4166  b19a				   DO_HEXCALC
   4167  b19a		       20 73 00 	      jsr	CHRGET
   4168  b19a		       b1 9e	   _relo0015  =	. +1
   4169  b19d		       20 a2 b7 	      jsr	FRMWORD	; GET WORD VALUE
   4170  b19d		       b1 a1	   _relo0016  =	. +1
   4171  b1a0		       4c 0e b8 	      jmp	PRINT_VALUE
   4172  b1a3
   4173  b1a3
   4174  b1a3
   4175  b1a3							;LOAD BASIC OR ABSOLUTE (/)
   4176  b1a3				   DO_VERIFY
   4177  b1a3		       a0 01		      ldy	#$1	; SA=1
   4178  b1a5		       98		      tya
   4179  b1a6		       d0 10		      bne	DOLO_2
   4180  b1a8
   4181  b1a8							;LOAD BASIC OR ABSOLUTE (/)
   4182  b1a8				   DO_LOADBAS
   4183  b1a8		       a6 2b		      ldx	BASSTRT
   4184  b1aa		       a5 2c		      lda	BASSTRT +1
   4185  b1ac		       86 c3		      stx	LOADPTR
   4186  b1ae		       85 c4		      sta	LOADPTR +1
   4187  b1b0		       a0 00		      ldy	#$0	; SA=0
   4188  b1b2		       f0 02		      beq	DOLO_1
   4189  b1b4
   4190  b1b4							;LOAD BINARY OR CARTRIDGE (%)
   4191  b1b4				   DO_LOADBIN
   4192  b1b4		       a0 01		      ldy	#$1	; SA=1
   4193  b1b6				   DOLO_1
   4194  b1b6		       a9 00		      lda	#0	; LOAD
   4195  b1b8				   DOLO_2
   4196  b1b8		       48		      pha
   4197  b1b9		       ae 3e 03 	      ldx	F_CURDEV	; device#
   4198  b1bc		       a9 01		      lda	#$01	; lfn #01
   4199  b1be		       20 ba ff 	      jsr	SETLFS
   4200  b1be		       b1 c2	   _relo0020  =	. +1
   4201  b1c1		       20 21 b3 	      jsr	GET_LOADPAR
   4202  b1c4		       68		      pla
   4203  b1c4		       b1 c6	   _relo0021  =	. +1
   4204  b1c5		       20 6c b3 	      jsr	MY_IECLOAD_0
   4205  b1c8		       b0 8b		      bcs	DOLO_ERR
   4206  b1ca
   4207  b1ca		       a5 93		      lda	SY_VERIFY
   4208  b1cc		       f0 03		      beq	MYLO_1
   4209  b1ce		       4c 7b e1 	      jmp	$e17b	;verify error?
   4210  b1d1
   4211  b1d1				   MYLO_1
   4212  b1d1		       a5 b9		      lda	SY_SA	; SA=0
   4213  b1d3		       d0 8b		      bne	DOLO_E
   4214  b1d5
   4215  b1d5		       b1 d6	   _relo0022  =	. +1
   4216  b1d5		       20 5c b1 	      jsr	BASLOAD_END_2
   4217  b1d8		       20 59 c6 	      jsr	SY_BASCLR2
   4218  b1d8		       b1 dc	   _relo0023  =	. +1
   4219  b1db		       4c 3f b1 	      jmp	INPUT_LOOP
   4220  b1de
   4221  b1de
   4222  b1de
   4223  b1de							;------------ EXECUTE SOFT RESET
   4224  b1de				   INLO_UNNEW
   4225  b1de		       b1 df	   _relo0025  =	. +1
   4226  b1de		       4c b0 b2 	      jmp	DO_UNNEW
   4227  b1e1
   4228  b1e1
   4229  b1e1
   4230  b1e1							;------------ EXECUTE TOKEN
   4231  b1e1				   INLO_LOOP2b
   4232  b1e1							;cpx #TOK_RUN
   4233  b1e1							;beq INLO_LOOP2a
   4234  b1e1							;cpx #TOK_SYS
   4235  b1e1							;beq INLO_LOOP2a
   4236  b1e1
   4237  b1e1		       e0 04		      cpx	#TOK_RES
   4238  b1e3		       f0 21		      beq	INLO_RESET
   4239  b1e5							;cpx #TOK_RELO
   4240  b1e5		       e0 01		      cpx	#TOK_NOIO	;NOIO
   4241  b1e7		       f0 47		      beq	INLO_NOIO
   4242  b1e9
   4243  b1e9		       a0 00		      ldy	#0
   4244  b1eb		       e0 02		      cpx	#TOK_BLKP	;BLOCK WRITE PROTECT
   4245  b1ed		       f0 50		      beq	INLO_SETIO
   4246  b1ef		       c8		      iny
   4247  b1f0		       e0 03		      cpx	#TOK_BLKD	;BLOCK DISABLE
   4248  b1f2		       f0 4b		      beq	INLO_SETIO
   4249  b1f4
   4250  b1f4		       e0 08		      cpx	#TOK_OLD
   4251  b1f6		       f0 e6		      beq	INLO_UNNEW
   4252  b1f8		       e0 09		      cpx	#TOK_OFF
   4253  b1fa		       f0 1d		      beq	INLO_OFF
   4254  b1fc		       e0 0a		      cpx	#TOK_KILL
   4255  b1fe		       f0 0c		      beq	INLO_KILL
   4256  b200
   4257  b200		       a9 00		      lda	#0
   4258  b202		       85 7a		      sta	CHRPTR	;RESET CHRPTR TO START OF BIP
   4259  b204		       f0 83		      beq	INLO_LOOP2a
   4260  b206
   4261  b206
   4262  b206
   4263  b206
   4264  b206
   4265  b206							;------------ EXECUTE SOFT RESET
   4266  b206				   INLO_RESET
   4267  b206		       b2 07	   _relo0026  =	. +1
   4268  b206		       20 1a b9 	      jsr	RESET_IO
   4269  b209		       4c 22 fd 	      jmp	SOFT_RESET
   4270  b20c
   4271  b20c
   4272  b20c
   4273  b20c							;------------ KILL FE3 (IO,BANKS,WEDGE)
   4274  b20c				   INLO_KILL
   4275  b20c		       b2 0d	   _relo0030  =	. +1
   4276  b20c		       20 19 b2 	      jsr	INLO_OFF
   4277  b20c		       b2 10	   _relo0031  =	. +1
   4278  b20f		       20 38 b2 	      jsr	INLO_NOIO3
   4279  b212		       a9 80		      lda	#128
   4280  b214		       a2 9f		      ldx	#$9f
   4281  b214		       b2 17	   _relo0032  =	. +1
   4282  b216		       4c ee b8 	      jmp	RESET_SYSTEM
   4283  b219
   4284  b219
   4285  b219
   4286  b219
   4287  b219							;------------ DISABLE WEDGE
   4288  b219				   INLO_OFF
   4289  b219		       b2 1a	   _relo5010  =	. +1
   4290  b219		       a9 cd		      lda	#<WEDGEMESSAGE1b
   4291  b21b		       a0 bb		      ldy	#>WEDGEMESSAGE1b
   4292  b21d							;_relo0033 = . +1
   4293  b21d		       20 1e cb 	      jsr	SY_STROUT
   4294  b21d		       b2 21	   _relo5011  =	. +1
   4295  b220		       a9 db		      lda	#<WEDGEMESSAGE1c
   4296  b222		       a0 bb		      ldy	#>WEDGEMESSAGE1c
   4297  b224							;_relo0034 = . +1
   4298  b224		       20 1e cb 	      jsr	SY_STROUT
   4299  b227		       20 5b e4 	      jsr	$e45b	;INIT BASIC VECTORS
   4300  b22a		       20 8a ff 	      jsr	$ff8a	;INIT IO VECTORS
   4301  b22d		       4c 80 c4 	      jmp	$c480	;STD. INPUT LOOP
   4302  b230
   4303  b230
   4304  b230
   4305  b230
   4306  b230							;------------ SET NOIO
   4307  b230				   INLO_NOIO
   4308  b230		       a9 80		      lda	#$80	;RAM, NO-IO
   4309  b232				   INLO_NOIO2
   4310  b232		       0d 03 9c 	      ora	IO_FINAL +1
   4311  b235		       8d 03 9c 	      sta	IO_FINAL +1
   4312  b238				   INLO_NOIO3
   4313  b238		       b2 39	   _relo5012  =	. +1
   4314  b238		       a9 c5		      lda	#<MSG_NOIO
   4315  b23a		       a0 bb		      ldy	#>MSG_NOIO
   4316  b23c							;_relo0035 = . +1
   4317  b23c		       4c 1e cb 	      jmp	SY_STROUT
   4318  b23f
   4319  b23f
   4320  b23f
   4321  b23f							;------------ SET BLK IO
   4322  b23f				   INLO_SETIO
   4323  b23f		       ad 03 9c 	      lda	IO_FINAL +1
   4324  b242		       8d 6a 03 	      sta	DL_IOBASE +1
   4325  b245		       ad 02 9c 	      lda	IO_FINAL
   4326  b248		       8d 69 03 	      sta	DL_IOBASE
   4327  b24b
   4328  b24b		       20 79 00 	      jsr	CHRGOT
   4329  b24e		       f0 17		      beq	PRINT_IO
   4330  b250
   4331  b250		       b9 69 03 	      lda	DL_IOBASE,y
   4332  b253		       29 e0		      and	#$e0
   4333  b255		       99 69 03 	      sta	DL_IOBASE,y
   4334  b255		       b2 59	   _relo0042  =	. +1
   4335  b258		       20 86 b2 	      jsr	SEL_BLOCK_P
   4336  b25b
   4337  b25b		       ad 6a 03 	      lda	DL_IOBASE +1
   4338  b25e		       8d 03 9c 	      sta	IO_FINAL +1
   4339  b261		       ad 69 03 	      lda	DL_IOBASE
   4340  b264		       8d 02 9c 	      sta	IO_FINAL
   4341  b267
   4342  b267				   PRINT_IO
   4343  b267		       b2 68	   _relo5013  =	. +1
   4344  b267		       a9 c1		      lda	#<MSG_PRINTIO
   4345  b269		       a0 bb		      ldy	#>MSG_PRINTIO
   4346  b26b							;_relo0036 = . +1
   4347  b26b		       20 1e cb 	      jsr	SY_STROUT
   4348  b26e		       ae 94 02 	      ldx	BIP_IOBASE
   4349  b271		       a9 00		      lda	#0
   4350  b271		       b2 74	   _relo0037  =	. +1
   4351  b273		       20 3c b8 	      jsr	HEXOUT
   4352  b276		       a9 2f		      lda	#"/"
   4353  b276		       b2 79	   _relo0040  =	. +1
   4354  b278		       20 d1 b6 	      jsr	CHROUT
   4355  b27b		       ae 95 02 	      ldx	BIP_IOBASE +1
   4356  b27e		       a9 00		      lda	#0
   4357  b27e		       b2 81	   _relo0038  =	. +1
   4358  b280		       20 3c b8 	      jsr	HEXOUT
   4359  b280		       b2 84	   _relo0039  =	. +1
   4360  b283		       4c c9 b6 	      jmp	CROUT
   4361  b286
   4362  b286
   4363  b286
   4364  b286							;------------
   4365  b286				   SEL_BLOCK_P
   4366  b286		       20 79 00 	      jsr	CHRGOT
   4367  b289		       b0 24		      bcs	SEBL_E
   4368  b28b				   SEBL_1
   4369  b28b		       29 07		      and	#7
   4370  b28d		       aa		      tax
   4371  b28e		       a9 01		      lda	#1
   4372  b290		       e0 05		      cpx	#5
   4373  b292		       90 03		      bcc	SEBL_2	; <5
   4374  b294		       d0 0f		      bne	SEBL_8
   4375  b296		       ca		      dex		; 5 --> 4
   4376  b297				   SEBL_2
   4377  b297		       ca		      dex
   4378  b298		       30 03		      bmi	SEBL_6
   4379  b29a		       0a		      asl
   4380  b29b		       d0 fa		      bne	SEBL_2
   4381  b29d				   SEBL_6
   4382  b29d		       29 1f		      and	#$1f
   4383  b29f		       19 69 03 	      ora	DL_IOBASE,y
   4384  b2a2		       99 69 03 	      sta	DL_IOBASE,y
   4385  b2a5				   SEBL_8
   4386  b2a5		       20 73 00 	      jsr	CHRGET
   4387  b2a8		       90 e1		      bcc	SEBL_1
   4388  b2a8		       b2 ab	   _relo0041  =	. +1
   4389  b2aa		       20 aa b7 	      jsr	CHKCOM
   4390  b2ad		       90 d7		      bcc	SEL_BLOCK_P
   4391  b2af				   SEBL_E
   4392  b2af		       60		      rts
   4393  b2b0
   4394  b2b0
   4395  b2b0
   4396  b2b0
   4397  b2b0
   4398  b2b0							; ==============================================================
   4399  b2b0							; UNNEW (OLD) BASIC PROGRAM
   4400  b2b0							; ==============================================================
   4401  b2b0
   4402  b2b0
   4403  b2b0				   DO_UNNEW
   4404  b2b0		       a0 01		      ldy	#$01
   4405  b2b2		       98		      tya
   4406  b2b3		       91 2b		      sta	(BASSTRT),Y	; store a non zero in the MSB of the first link addr
   4407  b2b5		       20 33 c5 	      jsr	SY_PGMLINK	; relinker
   4408  b2b8		       a5 22		      lda	PT1	; set end of basic/start of variables to the address of the last '0' found + 2
   4409  b2ba		       18		      clc
   4410  b2bb		       69 02		      adc	#$02
   4411  b2bd		       85 2d		      sta	BASVAR
   4412  b2bf		       a5 23		      lda	PT1 +1
   4413  b2c1		       69 00		      adc	#$00
   4414  b2c3		       85 2e		      sta	BASVAR +1
   4415  b2c5		       20 59 c6 	      jsr	SY_BASCLR2	; Reset TXTPTR and Perform [clr]
   4416  b2c8							;lda #<UnNewMessage	; string start point lo-byte
   4417  b2c8							;ldy #>UnNewMessage	; string start point hi-byte
   4418  b2c8							;jsr PRNSTR		; print string in A/Y, 0 terminated
   4419  b2c8
   4420  b2c8		       4c 67 e4 	      jmp	BASIC_WARM	; BASIC Warm Restart [RUNSTOP-RESTORE]
   4421  b2cb
   4422  b2cb							;UnNewMessage:
   4423  b2cb							;	.byte "PROGRAM RESTORED",0
   4424  b2cb
   4425  b2cb
   4426  b2cb
   4427  b2cb							; ==============================================================
   4428  b2cb							; GET STRING PARAM
   4429  b2cb							; ==============================================================
   4430  b2cb
   4431  b2cb
   4432  b2cb				   GET_STRING
   4433  b2cb		       ad 3e 03 	      lda	F_CURDEV	; device
   4434  b2ce		       85 ba		      sta	SY_DN	; prime address
   4435  b2d0		       20 73 00 	      jsr	CHRGET
   4436  b2d3		       a8		      tay
   4437  b2d4		       f0 18		      beq	GEST_5
   4438  b2d6		       a0 00		      ldy	#0
   4439  b2d8		       84 08		      sty	FLGCOM
   4440  b2da		       c9 22		      cmp	#34
   4441  b2dc		       d0 05		      bne	GEST_3
   4442  b2de		       85 08		      sta	FLGCOM
   4443  b2de		       b2 e1	   _relo0050  =	. +1
   4444  b2e0		       20 07 b3 	      jsr	INC_CHRPTR
   4445  b2e3				   GEST_3
   4446  b2e3		       b1 7a		      lda	(CHRPTR),y
   4447  b2e5		       f0 07		      beq	GEST_5
   4448  b2e7		       c5 08		      cmp	FLGCOM
   4449  b2e9		       f0 03		      beq	GEST_5
   4450  b2eb		       c8		      iny
   4451  b2ec		       d0 f5		      bne	GEST_3
   4452  b2ee
   4453  b2ee				   GEST_5
   4454  b2ee		       98		      tya		; STR LEN
   4455  b2ef		       a6 7a		      ldx	CHRPTR
   4456  b2f1		       a4 7b		      ldy	CHRPTR +1
   4457  b2f3		       20 bd ff 	      jsr	SETFNAM
   4458  b2f6
   4459  b2f6		       a8		      tay
   4460  b2f7		       b1 7a		      lda	(CHRPTR),y
   4461  b2f9		       f0 01		      beq	GEST_7
   4462  b2fb		       c8		      iny
   4463  b2fc				   GEST_7
   4464  b2fc		       98		      tya
   4465  b2fd
   4466  b2fd				   ADD_CHRPTR
   4467  b2fd		       18		      clc
   4468  b2fe		       65 7a		      adc	CHRPTR
   4469  b300		       85 7a		      sta	CHRPTR
   4470  b302		       90 02		      bcc	ADCH_1
   4471  b304				   ADCH_0
   4472  b304		       e6 7b		      inc	CHRPTR +1
   4473  b306				   ADCH_1
   4474  b306		       60		      rts
   4475  b307
   4476  b307				   INC_CHRPTR
   4477  b307		       e6 7a		      inc	CHRPTR
   4478  b309		       f0 f9		      beq	ADCH_0
   4479  b30b		       60		      rts
   4480  b30c
   4481  b30c
   4482  b30c
   4483  b30c							; ==============================================================
   4484  b30c							; GET LOAD PARAM
   4485  b30c							; ==============================================================
   4486  b30c
   4487  b30c				   GET_FILENAM
   4488  b30c		       ad 01 02 	      lda	BIP +1
   4489  b30f		       c9 22		      cmp	#34
   4490  b311		       f0 0b		      beq	GELO_2
   4491  b313		       ad 03 02 	      lda	BIP +3
   4492  b316		       c9 22		      cmp	#34
   4493  b318		       d0 04		      bne	GELO_2
   4494  b31a		       e6 7a		      inc	CHRPTR
   4495  b31c		       e6 7a		      inc	CHRPTR
   4496  b31e				   GELO_2
   4497  b31e		       b3 1f	   _relo0060  =	. +1
   4498  b31e		       4c cb b2 	      jmp	GET_STRING
   4499  b321
   4500  b321				   GET_LOADPAR
   4501  b321		       b3 22	   _relo0062  =	. +1
   4502  b321		       20 0c b3 	      jsr	GET_FILENAM
   4503  b321		       b3 25	   _relo0061  =	. +1
   4504  b324		       20 9d b7 	      jsr	FRMWORD2	; GET WORD VALUE
   4505  b327		       b0 10		      bcs	GELO_5
   4506  b329
   4507  b329							; SET LOAD ADDRESS
   4508  b329		       a6 14		      ldx	PT3
   4509  b32b		       a5 15		      lda	PT3 +1
   4510  b32d		       86 c3		      stx	LOADPTR
   4511  b32f		       85 c4		      sta	LOADPTR +1
   4512  b331
   4513  b331		       a6 b9		      ldx	SY_SA	; SA
   4514  b333		       f0 04		      beq	GELO_5	; SA=0: LOAD AT
   4515  b335
   4516  b335		       a2 02		      ldx	#2	; LOAD CARTRIDGE ON :: %"jj",adr
   4517  b337		       86 b9		      stx	SY_SA	; SA
   4518  b339				   GELO_5
   4519  b339		       60		      rts
   4520  b33a
   4521  b33a
   4522  b33a
   4523  b33a							; ==============================================================
   4524  b33a							; SET DEVICE#
   4525  b33a							; ==============================================================
   4526  b33a
   4527  b33a				   SET_DEVICE
   4528  b33a		       20 73 00 	      jsr	CHRGET
   4529  b33d		       f0 10		      beq	PRINT_DEV
   4530  b33f
   4531  b33f							;_relo0070 = . +1
   4532  b33f
   4533  b33f		       20 9e d7 	      jsr	FRMBYTE
   4534  b342		       e0 04		      cpx	#4
   4535  b344		       90 04		      bcc	SEDE_2
   4536  b346		       e0 0d		      cpx	#13
   4537  b348		       90 02		      bcc	SEDE_E
   4538  b34a				   SEDE_2
   4539  b34a		       a2 08		      ldx	#8
   4540  b34c				   SEDE_E
   4541  b34c		       8e 3e 03 	      stx	F_CURDEV
   4542  b34f
   4543  b34f				   PRINT_DEV
   4544  b34f		       b3 50	   _relo5070  =	. +1
   4545  b34f		       a9 b9		      lda	#<MSG_DEVICE
   4546  b351		       a0 bb		      ldy	#>MSG_DEVICE
   4547  b353							;_relo0071 = . +1
   4548  b353		       20 1e cb 	      jsr	SY_STROUT
   4549  b356
   4550  b356		       ae 3e 03 	      ldx	F_CURDEV
   4551  b359		       a9 00		      lda	#0
   4552  b35b		       20 cd dd 	      jsr	PRNINT	;print integer in X/A
   4553  b35e
   4554  b35e		       b3 5f	   _relo0072  =	. +1
   4555  b35e		       4c c9 b6 	      jmp	CROUT
   4556  b361
   4557  b361
   4558  b361
   4559  b361
   4560  b361							; ==============================================================
   4561  b361							; SYS PROCS
   4562  b361							; ==============================================================
   4563  b361
   4564  b361							;UNLISTEN = $ffae			 ; send UNLISTEN command
   4565  b361							;LISTEN	 = $ffb1			 ; send LISTEN command
   4566  b361							;LISTENSA = $ff93			 ; send SA for LISTEN command
   4567  b361							;TALK	   = $ffb4			 ; send TALK command
   4568  b361							;UNTALK   = $ffab			 ; send UNTALK command
   4569  b361							;TALKSA   = $ff96			 ; send SA for TALK command
   4570  b361							;IECIN    = $ffa5			 ; get char from IEC
   4571  b361							;IECOUT   = $ffa8			 ; send char to IEC
   4572  b361
   4573  b361		       fe 6a	   SETSTAT    =	$fe6a	; set status
   4574  b361		       ff e1	   CHKSTOP    =	$ffe1	; check stop key
   4575  b361
   4576  b361		       b9 35	   LISTEN     =	JIF_LISTEN	; send LISTEN command
   4577  b361		       b9 32	   TALK       =	JIF_TALK	; send TALK command
   4578  b361		       bb 34	   LISTENSA   =	JIF_LISTENSA	; send SA for LISTEN command
   4579  b361		       bb 2c	   TALKSA     =	JIF_TALKSA	; send SA for TALK command
   4580  b361		       bb 17	   UNLISTEN   =	JIF_UNLISTEN	; send UNLISTEN command
   4581  b361		       bb 09	   UNTALK     =	JIF_UNTALK	; send UNTALK command
   4582  b361		       b9 f5	   IECIN      =	JIF_IECIN	; get char from IEC
   4583  b361		       ba 5b	   IECOUT     =	JIF_IECOUT	; send char to IEC
   4584  b361
   4585  b361
   4586  b361
   4587  b361							; ==============================================================
   4588  b361							; MY LOAD
   4589  b361							; ==============================================================
   4590  b361
   4591  b361		       cd 8a	   FRMNUM     =	$cd8a	; GET NUMERIC VALUE
   4592  b361		       d7 9e	   FRMBYTE    =	$d79e	; GET BYTE VALUE TO X
   4593  b361		       d7 f7	   CNVWORD    =	$d7f7	; CONVERT TO WORD VALUE INTO Y/A; $14 (PT3)
   4594  b361
   4595  b361
   4596  b361							; LOAD VECTOR			       :: "fnam",PA,SA[,loadadr]
   4597  b361				   MY_LOAD    subroutine
   4598  b361		       a6 ba		      ldx	SY_DN	; PA (device#)
   4599  b363		       e0 04		      cpx	#4
   4600  b365		       b0 05		      bcs	.0
   4601  b367		       4c 49 f5 	      jmp	$f549	; OLD LOAD PROC
   4602  b36a
   4603  b36a
   4604  b36a							;MY_IECVERIFY
   4605  b36a							;  lda #1
   4606  b36a							;  bne MYLO_0
   4607  b36a
   4608  b36a				   MY_IECLOAD
   4609  b36a		       a9 00		      lda	#0
   4610  b36c				   MY_IECLOAD_0
   4611  b36c				   .0
   4612  b36c		       85 93		      sta	SY_VERIFY
   4613  b36e		       a9 00		      lda	#0
   4614  b370		       85 b8		      sta	SY_FN	; file# - flag for first byte
   4615  b372
   4616  b372		       a9 f0		      lda	#$f0	; channel
   4617  b372		       b3 75	   _relo0080  =	. +1
   4618  b374		       20 67 b5 	      jsr	DISK_LISTEN
   4619  b374		       b3 78	   _relo0081  =	. +1
   4620  b377		       20 41 b5 	      jsr	IECNAMOUT
   4621  b37a		       90 01		      bcc	.00a
   4622  b37c							;MYLO_ERR2
   4623  b37c		       60		      rts
   4624  b37d
   4625  b37d				   .00a
   4626  b37d		       a0 00		      LDY	#$00
   4627  b37f		       b1 bb		      LDA	($BB),Y	;Filename
   4628  b381		       c9 24		      CMP	#$24	;"$"
   4629  b383		       d0 03		      BNE	.00b	;Directory? -->
   4630  b385		       4c 6d f5 	      jmp	$f56d	;normal LOAD
   4631  b388
   4632  b388
   4633  b388				   .00b
   4634  b388		       a9 60		      lda	#$60
   4635  b388		       b3 8b	   _relo0082  =	. +1
   4636  b38a		       20 7e b5 	      jsr	DISK_TALK
   4637  b38d
   4638  b38d
   4639  b38d
   4640  b38d		       b3 8e	   _relo0084  =	. +1
   4641  b38d		       20 f5 b9 	      jsr	IECIN	; load address lo
   4642  b390		       85 ae		      sta	LOADEND
   4643  b392
   4644  b392		       a5 90		      lda	SY_STATUS
   4645  b394		       4a		      lsr
   4646  b395		       4a		      lsr
   4647  b396		       90 03		      bcc	.00c
   4648  b398		       4c 87 f7 	      jmp	$f787
   4649  b39b
   4650  b39b				   .00c
   4651  b39b		       b3 9c	   _relo0300  =	. +1
   4652  b39b		       20 f5 b9 	      jsr	IECIN	; load address hi
   4653  b39e		       85 af		      sta	LOADEND +1
   4654  b3a0
   4655  b3a0		       a6 b9		      ldx	SY_SA	; SA
   4656  b3a2		       f0 08		      beq	.00	; SA=0 -->
   4657  b3a4
   4658  b3a4		       ca		      dex
   4659  b3a5		       ca		      dex
   4660  b3a6		       d0 15		      bne	.01	; SA=1 -->
   4661  b3a8
   4662  b3a8				   .02			; SA=2: LOAD CARTRIDGE AT $c3
   4663  b3a8		       48		      pha
   4664  b3a9		       a5 ae		      lda	LOADEND
   4665  b3ab		       48		      pha		; FIRST TWO BYTES ...
   4666  b3ac
   4667  b3ac				   .00			; SA=0: LOAD PROGRAM AT $c3
   4668  b3ac		       b3 ad	   _relo0085  =	. +1
   4669  b3ac		       20 9d b7 	      jsr	FRMWORD2	; GET WORD VALUE
   4670  b3af		       a5 c4		      lda	LOADPTR +1
   4671  b3b1		       a6 c3		      ldx	LOADPTR
   4672  b3b3		       b0 04		      bcs	.2
   4673  b3b5
   4674  b3b5		       a5 15		      lda	PT3 +1
   4675  b3b7		       a6 14		      ldx	PT3
   4676  b3b9
   4677  b3b9				   .2
   4678  b3b9		       85 af		      sta	LOADEND +1
   4679  b3bb		       86 ae		      stx	LOADEND
   4680  b3bd
   4681  b3bd
   4682  b3bd
   4683  b3bd				   .01
   4684  b3bd		       b3 be	   _relo0086  =	. +1
   4685  b3bd		       20 92 b4 	      jsr	PRINT_ATADR
   4686  b3c0
   4687  b3c0
   4688  b3c0		       a6 b9		      ldx	SY_SA	; SA
   4689  b3c2		       ca		      dex
   4690  b3c3		       ca		      dex
   4691  b3c4		       d0 0a		      bne	.3	; SA!=2 -->
   4692  b3c6
   4693  b3c6							;STORE FIRST TWO BYTES
   4694  b3c6		       a0 00		      ldy	#0
   4695  b3c8		       68		      pla
   4696  b3c8		       b3 ca	   _relo0097  =	. +1
   4697  b3c9		       20 7b b4 	      jsr	STOREBYTE
   4698  b3cc		       68		      pla
   4699  b3cc		       b3 ce	   _relo0098  =	. +1
   4700  b3cd		       20 7b b4 	      jsr	STOREBYTE
   4701  b3d0
   4702  b3d0				   .3
   4703  b3d0
   4704  b3d0
   4705  b3d0
   4706  b3d0							;_relo0087 = . +1
   4707  b3d0							;  jsr MY_IECIN
   4708  b3d0							;  bcc MYLO_6
   4709  b3d0
   4710  b3d0							;MYLO_ERR
   4711  b3d0							;_relo0302 = . +1
   4712  b3d0							;  jsr DISK_CLOSE_LO
   4713  b3d0							;  jmp $f787
   4714  b3d0
   4715  b3d0
   4716  b3d0							;--------------JIFFY FASTLOAD INIT
   4717  b3d0				   .FASTLOAD
   4718  b3d0		       24 a3		      BIT	$A3
   4719  b3d2							;  BVC .F253				  ;no Jiffy -->
   4720  b3d2		       70 1a		      BVS	.FB1F	;Jiffy -->
   4721  b3d4				   .F253
   4722  b3d4		       20 8a f5 	      JSR	$F58A	;normales LOAD
   4723  b3d7				   .err2
   4724  b3d7		       b0 5f		      bcs	.err
   4725  b3d9
   4726  b3d9				   .MYLO_E
   4727  b3d9		       b3 da	   _relo0090  =	. +1
   4728  b3d9		       20 90 b5 	      jsr	DISK_CLOSE_LO
   4729  b3dc
   4730  b3dc		       b3 dd	   _relo0091  =	. +1
   4731  b3dc		       20 ad b4 	      jsr	PRINT_TOADR
   4732  b3df
   4733  b3df							;PRINT DISKERR ON ERROR
   4734  b3df		       a5 90		      lda	SY_STATUS
   4735  b3e1		       48		      pha		;SAVE IECSTAT FOR VERIFY!!!
   4736  b3e1		       b3 e3	   _relo0412  =	. +1
   4737  b3e2		       20 af b5 	      jsr	PRINT_DISK_ERR
   4738  b3e5		       68		      pla
   4739  b3e6		       85 90		      sta	SY_STATUS
   4740  b3e8
   4741  b3e8		       18		      clc
   4742  b3e9		       a6 ae		      ldx	LOADEND
   4743  b3eb		       a4 af		      ldy	LOADEND +1
   4744  b3ed		       60		      rts
   4745  b3ee
   4746  b3ee
   4747  b3ee							;--------------JIFFY FASTLOAD INIT
   4748  b3ee				   .FB1F
   4749  b3ee		       b3 ef	   _relo0087  =	. +1
   4750  b3ee		       20 09 bb 	      JSR	UNTALK	;UNTALK
   4751  b3f1		       a9 61		      lda	#$61
   4752  b3f1		       b3 f4	   _relo0088  =	. +1
   4753  b3f3		       20 7e b5 	      jsr	DISK_TALK
   4754  b3f6							;--------------JIFFY FASTLOAD
   4755  b3f6		       78		      SEI
   4756  b3f7		       a5 b2		      LDA	$B2
   4757  b3f9		       48		      PHA
   4758  b3fa		       a0 00		      LDY	#$00
   4759  b3fc				   .FB25
   4760  b3fc		       20 55 f7 	      JSR	$F755	;STOP Taste abfragen
   4761  b3ff		       c9 fe		      CMP	#$FE
   4762  b401		       f0 2f		      BEQ	.FB5B
   4763  b403		       ad 2c 91 	      LDA	$912C
   4764  b406		       29 dd		      AND	#$DD
   4765  b408		       aa		      TAX
   4766  b409		       09 20		      ORA	#$20
   4767  b40b		       85 b2		      STA	$B2
   4768  b40d		       8e 2c 91 	      STX	$912C
   4769  b410		       a9 80		      LDA	#$80
   4770  b412		       85 9c		      STA	$9C
   4771  b414				   .FB3D
   4772  b414		       ad 1f 91 	      LDA	$911F
   4773  b417		       4a		      LSR
   4774  b418		       90 fa		      BCC	.FB3D
   4775  b41a		       29 01		      AND	#$01
   4776  b41c		       f0 1d		      BEQ	.FB67
   4777  b41e		       a2 6d		      LDX	#$6D
   4778  b420				   .FB49
   4779  b420		       2c 1f 91 	      BIT	$911F
   4780  b423		       f0 06		      BEQ	.FB54
   4781  b425		       ca		      DEX
   4782  b426		       d0 f8		      BNE	.FB49
   4783  b428		       a9 42		      LDA	#$42
   4784  b42a		       2c		      .byte.b	$2c	;BIT ABS
   4785  b42b				   .FB54
   4786  b42b		       a9 40		      LDA	#$40
   4787  b42d		       20 6a fe 	      JSR	$FE6A	;SET STATUS
   4788  b430		       18		      CLC
   4789  b431		       24		      .byte.b	$24	;BIT ZP
   4790  b432				   .FB5B		;STOP!
   4791  b432		       38		      SEC
   4792  b433		       68		      PLA
   4793  b434		       85 b2		      STA	$B2
   4794  b436		       90 a1		      bcc	.MYLO_E
   4795  b438				   .err
   4796  b438		       4c cb f6 	      JMP	$F6CB	;UNLISTEN, CLOSE, BREAK
   4797  b43b							; JMP $F5BF				 ;UNLISTEN, CLOSE
   4798  b43b
   4799  b43b
   4800  b43b				   .FB67
   4801  b43b		       a9 02		      LDA	#$02
   4802  b43d				   .FB69
   4803  b43d		       2c 1f 91 	      BIT	$911F
   4804  b440		       f0 fb		      BEQ	.FB69
   4805  b442				   .FB6E
   4806  b442		       48		      PHA
   4807  b443		       68		      PLA
   4808  b444		       ea		      NOP
   4809  b445		       a5 b2		      LDA	$B2
   4810  b447		       8d 2c 91 	      STA	$912C
   4811  b44a		       a9 01		      LDA	#$01
   4812  b44c		       2c 1f 91 	      BIT	$911F
   4813  b44f		       f0 ab		      BEQ	.FB25
   4814  b451		       8e 2c 91 	      STX	$912C
   4815  b454		       ad 1f 91 	      LDA	$911F
   4816  b457		       6a		      ROR
   4817  b458		       6a		      ROR
   4818  b459		       ea		      NOP
   4819  b45a		       29 80		      AND	#$80
   4820  b45c		       0d 1f 91 	      ORA	$911F
   4821  b45f		       2a		      ROL
   4822  b460		       2a		      ROL
   4823  b461		       ea		      NOP
   4824  b462		       85 b3		      STA	$B3
   4825  b464		       ad 1f 91 	      LDA	$911F
   4826  b467		       6a		      ROR
   4827  b468		       6a		      ROR
   4828  b469		       25 9c		      AND	$9C
   4829  b46b		       0d 1f 91 	      ORA	$911F
   4830  b46e		       2a		      ROL
   4831  b46f		       2a		      ROL
   4832  b470		       85 c0		      STA	$C0
   4833  b472
   4834  b472							;_relo0430 = . +1
   4835  b472							;  JSR lEC4E				 ;Byte zusammenbauen aus 2 Nibble
   4836  b472							;_relo0089 = . +1
   4837  b472							;  jsr STOREBYTE
   4838  b472							;  CLV
   4839  b472							;  BVC .FB6E
   4840  b472
   4841  b472		       a9 b4		      lda	#>(.FB6E -1)	;Rücksprungadresse auf Stack
   4842  b474		       48		      pha
   4843  b475		       a9 41		      lda	#<(.FB6E -1)
   4844  b477		       48		      pha
   4845  b477		       b4 79	   _relo0430  =	. +1
   4846  b478		       20 fa ba 	      JSR	lEC4E	;Byte zusammenbauen aus 2 Nibble
   4847  b47b
   4848  b47b				   STOREBYTE  subroutine
   4849  b47b		       c4 93		      CPY	$93
   4850  b47d		       d0 09		      BNE	.FBB0
   4851  b47f		       91 ae		      STA	($AE),Y
   4852  b481				   .FBA7
   4853  b481		       e6 ae		      INC	$AE
   4854  b483		       d0 02		      BNE	.FB6E
   4855  b485		       e6 af		      INC	$AF
   4856  b487				   .FB6E
   4857  b487		       60		      rts
   4858  b488
   4859  b488				   .FBB0		;VERIFY
   4860  b488		       d1 ae		      CMP	($AE),Y
   4861  b48a		       f0 f5		      BEQ	.FBA7
   4862  b48c		       a9 10		      LDA	#$10	;VERIFY ERROR
   4863  b48e		       85 90		      STA	$90
   4864  b490		       d0 ef		      BNE	.FBA7
   4865  b492
   4866  b492
   4867  b492
   4868  b492							;--------------JIFFY FASTLOAD
   4869  b492
   4870  b492
   4871  b492
   4872  b492
   4873  b492
   4874  b492
   4875  b492
   4876  b492
   4877  b492
   4878  b492							;.MYLO_5
   4879  b492							;  jsr CHKSTOP
   4880  b492							;  bne MYLO_05a
   4881  b492
   4882  b492							;_relo0088 = . +1
   4883  b492							;  jsr DISK_CLOSE_LO
   4884  b492							;  jmp $f6ce
   4885  b492
   4886  b492
   4887  b492							;.MYLO_05a
   4888  b492							;_relo0089 = . +1
   4889  b492							;  jsr MY_IECIN2
   4890  b492							;.MYLO_6
   4891  b492							;  ldy SY_VERIFY
   4892  b492							;  beq MYLO_7				  ; --> load
   4893  b492
   4894  b492							;  ldy #0
   4895  b492							;  cmp (LOADEND),y
   4896  b492							;  beq MYLO_8
   4897  b492
   4898  b492							;  lda #$10
   4899  b492							;  jsr SETSTAT
   4900  b492							;  .byte $2c
   4901  b492							;.MYLO_7
   4902  b492							;  sta (LOADEND),y
   4903  b492							;.MYLO_8
   4904  b492							;  inc LOADEND
   4905  b492							;  bne MYLO_7a
   4906  b492							;  inc LOADEND +1
   4907  b492							;.MYLO_7a
   4908  b492							;  bit SY_STATUS
   4909  b492							;  bvc MYLO_5				  ; EOI?
   4910  b492
   4911  b492
   4912  b492
   4913  b492
   4914  b492
   4915  b492							; PRINT LOAD AT ADDRESS
   4916  b492				   PRINT_ATADR subroutine
   4917  b492		       a9 ae		      lda	#LOADEND
   4918  b494				   PRINT_ATADR_2
   4919  b494		       a6 9d		      ldx	DIRECT_MODE
   4920  b496		       30 01		      bmi	.1
   4921  b498				   .rts
   4922  b498		       60		      rts
   4923  b499
   4924  b499				   .1
   4925  b499		       48		      pha
   4926  b499		       b4 9b	   _relo5090  =	. +1
   4927  b49a		       a9 ad		      lda	#<MSG_LOADAT
   4928  b49c		       a0 bb		      ldy	#>MSG_LOADAT
   4929  b49e							;_relo0096 = . +1
   4930  b49e		       20 1e cb 	      jsr	SY_STROUT
   4931  b4a1		       68		      pla
   4932  b4a2				   .3
   4933  b4a2		       aa		      tax
   4934  b4a3				   HEXOUT_ZP
   4935  b4a3		       b5 01		      lda	1,x
   4936  b4a5		       48		      pha
   4937  b4a6		       b5 00		      lda	0,x
   4938  b4a8		       aa		      tax
   4939  b4a9		       68		      pla
   4940  b4a9		       b4 ab	   _relo0095  =	. +1
   4941  b4aa		       4c 3c b8 	      jmp	HEXOUT
   4942  b4ad
   4943  b4ad							; PRINT LOAD AT ADDRESS
   4944  b4ad				   PRINT_TOADR
   4945  b4ad		       a9 ae		      lda	#LOADEND
   4946  b4af				   PRINT_TOADR_2
   4947  b4af		       a6 9d		      ldx	DIRECT_MODE
   4948  b4b1		       10 e5		      bpl	.rts
   4949  b4b3
   4950  b4b3		       48		      pha
   4951  b4b3		       b4 b5	   _relo5091  =	. +1
   4952  b4b4		       a9 b4		      lda	#<MSG_LOADTO
   4953  b4b6		       a0 bb		      ldy	#>MSG_LOADTO
   4954  b4b8		       20 1e cb 	      jsr	SY_STROUT
   4955  b4bb		       68		      pla
   4956  b4bb		       b4 bd	   _relo0093  =	. +1
   4957  b4bc		       20 a2 b4 	      jsr	.3
   4958  b4bc		       b4 c0	   _relo0094  =	. +1
   4959  b4bf		       4c c9 b6 	      jmp	CROUT
   4960  b4c2
   4961  b4c2
   4962  b4c2
   4963  b4c2							; ========================================================================
   4964  b4c2							; MY SAVE		     ENDADDR   = ($AE/$AF)    STARTADDR = ($C1/$C2)
   4965  b4c2							;
   4966  b4c2							; SAVESTART = $c1
   4967  b4c2							; LOADPTR   = $c3
   4968  b4c2							; LOADSTART = $ac
   4969  b4c2							; LOADEND   = $ae
   4970  b4c2							; ========================================================================
   4971  b4c2
   4972  b4c2							; SAVE VECTOR			       :: "fnam",PA,SA[,fromadr,toaddr]
   4973  b4c2				   MY_SAVE    subroutine
   4974  b4c2		       a6 ba		      ldx	SY_DN	; PA (device#)
   4975  b4c4		       e0 04		      cpx	#4
   4976  b4c6		       b0 03		      bcs	MY_IECSAVE
   4977  b4c8		       4c 85 f6 	      jmp	$f685	; OLD LOAD PROC
   4978  b4cb
   4979  b4cb
   4980  b4cb				   MY_IECSAVE
   4981  b4cb		       b4 cc	   _relo0420  =	. +1
   4982  b4cb		       20 9d b7 	      jsr	FRMWORD2	; GET WORD VALUE
   4983  b4ce		       b0 15		      bcs	MYSA_0
   4984  b4d0
   4985  b4d0		       84 ac		      sty	LOADSTART
   4986  b4d2		       85 ad		      sta	LOADSTART +1
   4987  b4d4
   4988  b4d4		       b4 d5	   _relo0421  =	. +1
   4989  b4d4		       20 9d b7 	      jsr	FRMWORD2	; GET WORD VALUE
   4990  b4d7		       b0 0c		      bcs	MYSA_0
   4991  b4d9
   4992  b4d9		       84 ae		      sty	LOADEND
   4993  b4db		       85 af		      sta	LOADEND +1
   4994  b4dd
   4995  b4dd		       a4 ac		      ldy	LOADSTART
   4996  b4df		       a5 ad		      lda	LOADSTART +1
   4997  b4e1		       84 c1		      sty	SAVESTART
   4998  b4e3		       85 c2		      sta	SAVESTART +1
   4999  b4e5
   5000  b4e5
   5001  b4e5				   MYSA_0
   5002  b4e5		       a9 f1		      lda	#$f1	; channel
   5003  b4e5		       b4 e8	   _relo0400  =	. +1
   5004  b4e7		       20 67 b5 	      jsr	DISK_LISTEN
   5005  b4e7		       b4 eb	   _relo0401  =	. +1
   5006  b4ea		       20 41 b5 	      jsr	IECNAMOUT
   5007  b4ed		       b0 46		      bcs	.err
   5008  b4ef
   5009  b4ef		       a9 61		      lda	#$61
   5010  b4ef		       b4 f2	   _relo0402  =	. +1
   5011  b4f1		       20 67 b5 	      jsr	DISK_LISTEN
   5012  b4f4
   5013  b4f4		       20 d2 fb 	      jsr	$fbd2	; $C1/$C2 --> $ac/$ad
   5014  b4f7
   5015  b4f7		       a5 ac		      lda	LOADSTART
   5016  b4f7		       b4 fa	   _relo0403  =	. +1
   5017  b4f9		       20 5b ba 	      jsr	IECOUT
   5018  b4fc		       a5 ad		      lda	LOADSTART +1
   5019  b4fc		       b4 ff	   _relo0404  =	. +1
   5020  b4fe		       20 5b ba 	      jsr	IECOUT
   5021  b501
   5022  b501		       a9 ac		      lda	#LOADSTART
   5023  b503		       20 94 b4 	      jsr	PRINT_ATADR_2
   5024  b506
   5025  b506		       a0 00		      ldy	#0
   5026  b508				   MYSA_00
   5027  b508		       20 11 fd 	      jsr	$fd11	;END ADDRESS?
   5028  b50b		       b0 18		      bcs	MYSA_E0	;YES -->
   5029  b50d		       b1 ac		      lda	(LOADSTART),y
   5030  b50d		       b5 10	   _relo0405  =	. +1
   5031  b50f		       20 5b ba 	      jsr	IECOUT
   5032  b512
   5033  b512		       20 e1 ff 	      jsr	CHKSTOP
   5034  b515		       d0 09		      bne	MYSA_02
   5035  b517
   5036  b517		       b5 18	   _relo0406  =	. +1
   5037  b517		       20 17 bb 	      jsr	UNLISTEN
   5038  b517		       b5 1b	   _relo0407  =	. +1
   5039  b51a		       20 8c b5 	      jsr	DISK_CLOSE_SA
   5040  b51d		       4c ce f6 	      jmp	$f6ce
   5041  b520
   5042  b520
   5043  b520				   MYSA_02
   5044  b520		       20 1b fd 	      jsr	$fd1b	;INCR ADDR
   5045  b523		       d0 e3		      bne	MYSA_00
   5046  b525
   5047  b525				   MYSA_E0
   5048  b525		       b5 26	   _relo0408  =	. +1
   5049  b525		       20 17 bb 	      jsr	UNLISTEN
   5050  b525		       b5 29	   _relo0409  =	. +1
   5051  b528		       20 8c b5 	      jsr	DISK_CLOSE_SA
   5052  b52b		       a9 ac		      lda	#LOADSTART
   5053  b52b		       b5 2e	   _relo0410  =	. +1
   5054  b52d		       20 af b4 	      jsr	PRINT_TOADR_2
   5055  b52d		       b5 31	   _relo0411  =	. +1
   5056  b530		       20 af b5 	      jsr	PRINT_DISK_ERR
   5057  b533		       f0 01		      beq	.rts
   5058  b535				   .err
   5059  b535		       38		      sec
   5060  b536				   .rts
   5061  b536		       60		      rts
   5062  b537
   5063  b537
   5064  b537
   5065  b537
   5066  b537							; ==============================================================
   5067  b537							; DISK CMD
   5068  b537							; ==============================================================
   5069  b537
   5070  b537							;DISK CMD PARAM       :: +@"cmd"
   5071  b537				   DISK_CMD
   5072  b537		       b5 38	   _relo0013  =	. +1
   5073  b537		       20 cb b2 	      jsr	GET_STRING
   5074  b53a
   5075  b53a				   DISK_CMD_2
   5076  b53a		       a6 b7		      ldx	LEN_FNAM
   5077  b53c		       f0 5d		      beq	PRINT_DISK_STAT
   5078  b53c		       b5 3f	   _relo0100  =	. +1
   5079  b53e		       20 65 b5 	      jsr	DISK_LISTEN_6F
   5080  b541
   5081  b541
   5082  b541							;PUT NAME TO IEC AND UNLISTEN
   5083  b541				   IECNAMOUT
   5084  b541		       a5 90		      lda	IECSTAT
   5085  b543		       30 1d		      bmi	DICM_ERR1
   5086  b545
   5087  b545		       b5 46	   _relo0363  =	. +1
   5088  b545		       20 4d b5 	      jsr	IECNAMOUT_2
   5089  b548				   DICM_OK2
   5090  b548		       b5 49	   _relo0306  =	. +1
   5091  b548		       20 17 bb 	      jsr	UNLISTEN
   5092  b54b				   DICM_OK
   5093  b54b		       18		      clc
   5094  b54c		       60		      rts
   5095  b54d
   5096  b54d
   5097  b54d
   5098  b54d							;PUT NAME TO IEC
   5099  b54d				   IECNAMOUT_2
   5100  b54d		       a6 b7		      ldx	LEN_FNAM
   5101  b54f		       f0 f7		      beq	DICM_OK2
   5102  b551		       a0 00		      ldy	#0
   5103  b553				   DICM_2
   5104  b553		       b1 bb		      lda	(PTR_FNAM),y
   5105  b553		       b5 56	   _relo0305  =	. +1
   5106  b555		       20 5b ba 	      jsr	IECOUT
   5107  b558		       c8		      iny
   5108  b559		       ca		      dex
   5109  b55a		       d0 f7		      bne	DICM_2
   5110  b55c		       60		      rts
   5111  b55d
   5112  b55d
   5113  b55d
   5114  b55d
   5115  b55d
   5116  b55d							;CHECK 'DEVICE NOT PRESENT'
   5117  b55d				   CHKDNP
   5118  b55d		       b5 5e	   _relo0106  =	. +1
   5119  b55d		       20 65 b5 	      jsr	DISK_LISTEN_6F
   5120  b560		       90 e6		      bcc	DICM_OK2
   5121  b562				   DICM_ERR1
   5122  b562		       4c 8a f7 	      jmp	$f78a	;ERR 'DEVICE NOT PRESENT'    CF=1
   5123  b565
   5124  b565
   5125  b565				   DISK_LISTEN_6F
   5126  b565		       a9 6f		      lda	#$6f	; channel
   5127  b567				   DISK_LISTEN
   5128  b567		       48		      pha
   5129  b568		       a9 00		      lda	#0
   5130  b56a		       85 90		      sta	IECSTAT
   5131  b56c		       f0 01		      beq	DILI_2
   5132  b56e
   5133  b56e				   DISK_LISTEN_2
   5134  b56e		       48		      pha
   5135  b56f				   DILI_2
   5136  b56f		       a5 ba		      lda	SY_DN	; device#
   5137  b56f		       b5 72	   _relo0307  =	. +1
   5138  b571		       20 35 b9 	      jsr	LISTEN
   5139  b574		       68		      pla
   5140  b574		       b5 76	   _relo0308  =	. +1
   5141  b575		       20 34 bb 	      jsr	LISTENSA
   5142  b578				   DITA_5
   5143  b578		       a5 90		      lda	IECSTAT
   5144  b57a		       10 cf		      bpl	DICM_OK
   5145  b57c		       38		      sec
   5146  b57d		       60		      rts
   5147  b57e
   5148  b57e
   5149  b57e				   DISK_TALK
   5150  b57e		       48		      pha
   5151  b57f		       a9 00		      lda	#0
   5152  b581		       85 90		      sta	IECSTAT
   5153  b583
   5154  b583		       a5 ba		      lda	SY_DN	; device#
   5155  b583		       b5 86	   _relo0309  =	. +1
   5156  b585		       20 32 b9 	      jsr	TALK
   5157  b588		       68		      pla
   5158  b588		       b5 8a	   _relo0310  =	. +1
   5159  b589		       4c 2c bb 	      jmp	TALKSA
   5160  b58c
   5161  b58c
   5162  b58c				   DISK_CLOSE_SA
   5163  b58c		       a9 e1		      lda	#$e1
   5164  b58e		       d0 05		      bne	DICL_1
   5165  b590
   5166  b590				   DISK_CLOSE_LO
   5167  b590		       b5 91	   _relo0303  =	. +1
   5168  b590		       20 09 bb 	      jsr	UNTALK
   5169  b593		       a9 e0		      lda	#$e0
   5170  b595				   DICL_1
   5171  b595		       b5 96	   _relo0101  =	. +1
   5172  b595		       20 6e b5 	      jsr	DISK_LISTEN_2
   5173  b595		       b5 99	   _relo0311  =	. +1
   5174  b598		       4c 17 bb 	      jmp	UNLISTEN
   5175  b59b
   5176  b59b
   5177  b59b							; PRINT DISK STATUS TO SCREEN
   5178  b59b				   PRINT_DISK_STAT
   5179  b59b		       b5 9c	   _relo0102  =	. +1
   5180  b59b		       20 b5 b5 	      jsr	GET_DISK_STAT
   5181  b59e				   PRINT_BIP_0
   5182  b59e		       b0 0e		      bcs	PRDI_E
   5183  b5a0				   PRINT_BIP
   5184  b5a0		       a0 00		      ldy	#0
   5185  b5a2				   PRDI_2
   5186  b5a2		       b9 00 01 	      lda	STP,y
   5187  b5a5		       f0 06		      beq	PRDI_7
   5188  b5a7		       20 d2 ff 	      jsr	BSOUT
   5189  b5aa		       c8		      iny
   5190  b5ab		       d0 f5		      bne	PRDI_2
   5191  b5ad				   PRDI_7
   5192  b5ad		       98		      tya
   5193  b5ae							;  beq PRDI_E
   5194  b5ae							;lda #13
   5195  b5ae							;jsr BSOUT
   5196  b5ae				   PRDI_E
   5197  b5ae		       60		      rts
   5198  b5af
   5199  b5af
   5200  b5af							; PRINT DISK STATUS TO SCREEN IF ERROR
   5201  b5af				   PRINT_DISK_ERR
   5202  b5af		       b5 b0	   _relo0103  =	. +1
   5203  b5af		       20 b5 b5 	      jsr	GET_DISK_STAT
   5204  b5b2		       d0 ea		      bne	PRINT_BIP_0
   5205  b5b4		       60		      rts
   5206  b5b5
   5207  b5b5
   5208  b5b5
   5209  b5b5							; LOAD DISK STAT TO BIP
   5210  b5b5				   GET_DISK_STAT
   5211  b5b5		       b5 b6	   _relo0104  =	. +1
   5212  b5b5		       20 5d b5 	      jsr	CHKDNP
   5213  b5b8		       b0 37		      bcs	DIST_ERR
   5214  b5ba
   5215  b5ba		       a9 6f		      lda	#$6f	; channel
   5216  b5ba		       b5 bd	   _relo0105  =	. +1
   5217  b5bc		       20 7e b5 	      jsr	DISK_TALK
   5218  b5bf
   5219  b5bf		       a0 00		      ldy	#0
   5220  b5c1				   DIST_2
   5221  b5c1		       b5 c2	   _relo0312  =	. +1
   5222  b5c1		       20 f5 b9 	      jsr	IECIN
   5223  b5c4		       99 00 01 	      sta	STP,y
   5224  b5c7		       c8		      iny
   5225  b5c8		       a5 90		      lda	IECSTAT
   5226  b5ca		       f0 f5		      beq	DIST_2
   5227  b5cc
   5228  b5cc		       b5 cd	   _relo0313  =	. +1
   5229  b5cc		       20 09 bb 	      jsr	UNTALK
   5230  b5cf		       98		      tya
   5231  b5d0		       f0 0b		      beq	DIST_7
   5232  b5d2		       a9 0d		      lda	#13
   5233  b5d4		       d9 00 01 	      cmp	STP,y
   5234  b5d7		       d0 04		      bne	DIST_7
   5235  b5d9		       99 00 01 	      sta	STP,y
   5236  b5dc		       c8		      iny
   5237  b5dd				   DIST_7
   5238  b5dd		       a9 00		      lda	#0
   5239  b5df		       99 00 01 	      sta	STP,y
   5240  b5e2		       ad 00 01 	      lda	STP
   5241  b5e5		       c9 30		      cmp	#"0"
   5242  b5e7		       d0 07		      bne	DIST_E
   5243  b5e9		       4d 01 01 	      eor	STP +1
   5244  b5ec		       f0 02		      beq	DIST_E
   5245  b5ee		       c9 01		      cmp	#1
   5246  b5f0				   DIST_E
   5247  b5f0		       18		      clc
   5248  b5f1				   DIST_ERR
   5249  b5f1		       60		      rts
   5250  b5f2
   5251  b5f2
   5252  b5f2
   5253  b5f2
   5254  b5f2
   5255  b5f2
   5256  b5f2							; ==============================================================
   5257  b5f2							; DISK CATALOG
   5258  b5f2							; ==============================================================
   5259  b5f2
   5260  b5f2							;DISK CATALOG	     :: +$"fil"
   5261  b5f2				   PRINT_CATALOG
   5262  b5f2		       b5 f3	   _relo0010  =	. +1
   5263  b5f2		       20 cb b2 	      jsr	GET_STRING
   5264  b5f5
   5265  b5f5		       a9 f0		      lda	#$f0	; channel
   5266  b5f5		       b5 f8	   _relo0110  =	. +1
   5267  b5f7		       20 67 b5 	      jsr	DISK_LISTEN
   5268  b5fa		       90 01		      bcc	PRCA_0
   5269  b5fc		       60		      rts
   5270  b5fd
   5271  b5fd				   PRCA_0
   5272  b5fd		       a9 24		      lda	#"$"
   5273  b5fd		       b6 00	   _relo0314  =	. +1
   5274  b5ff		       20 5b ba 	      jsr	IECOUT
   5275  b5ff		       b6 03	   _relo0111  =	. +1
   5276  b602		       20 4d b5 	      jsr	IECNAMOUT_2
   5277  b605		       a9 2a		      lda	#"*"
   5278  b605		       b6 08	   _relo0362  =	. +1
   5279  b607		       20 5b ba 	      jsr	IECOUT
   5280  b607		       b6 0b	   _relo0365  =	. +1
   5281  b60a		       20 17 bb 	      jsr	UNLISTEN
   5282  b60d
   5283  b60d		       a9 60		      lda	#$60
   5284  b60d		       b6 10	   _relo0112  =	. +1
   5285  b60f		       20 7e b5 	      jsr	DISK_TALK
   5286  b612
   5287  b612							;PRINT HEADLINE (DISKNAME)
   5288  b612
   5289  b612		       a2 06		      ldx	#6
   5290  b612		       b6 15	   _relo0113  =	. +1
   5291  b614		       20 9c b6 	      jsr	PRCA_SKIP_X	; skip x bytes
   5292  b617
   5293  b617							;PRCA_1
   5294  b617		       b6 18	   _relo0114  =	. +1
   5295  b617		       20 94 b6 	      jsr	PRCA_SKIPSPC	; skip spaces
   5296  b61a
   5297  b61a		       c9 12		      cmp	#18	; check for reverse on char (Disk Name, first row only)
   5298  b61c		       d0 73		      bne	PRCA_EE
   5299  b61e
   5300  b61e		       b6 1f	   _relo0115  =	. +1
   5301  b61e		       20 d1 b6 	      jsr	CHROUT	; here on first row only (Disk Name)
   5302  b61e		       b6 22	   _relo0315  =	. +1
   5303  b621		       20 f5 b9 	      jsr	IECIN	; skip a char (")
   5304  b624
   5305  b624		       b6 25	   _relo0116  =	. +1
   5306  b624		       20 a3 b6 	      jsr	PRCA_QSTR1	; PRINT QUOTED STRING
   5307  b627
   5308  b627		       a2 13		      ldx	#19
   5309  b627		       b6 2a	   _relo0117  =	. +1
   5310  b629		       20 b9 b6 	      jsr	PRCA_SPCOL	; print spaces up to column
   5311  b629		       b6 2d	   _relo0118  =	. +1
   5312  b62c		       20 94 b6 	      jsr	PRCA_SKIPSPC	; skip spaces
   5313  b62f
   5314  b62f		       b6 30	   _relo0119  =	. +1
   5315  b62f		       20 d1 b6 	      jsr	CHROUT	; ID1
   5316  b62f		       b6 33	   _relo0316  =	. +1
   5317  b632		       20 f5 b9 	      jsr	IECIN
   5318  b632		       b6 36	   _relo0120  =	. +1
   5319  b635		       20 d1 b6 	      jsr	CHROUT	; ID2
   5320  b638
   5321  b638							;PRINT STD. LINE (FILE)
   5322  b638
   5323  b638				   PRCA_4
   5324  b638		       b6 39	   _relo0317  =	. +1
   5325  b638		       20 f5 b9 	      jsr	IECIN
   5326  b63b		       aa		      tax
   5327  b63c		       d0 fa		      bne	PRCA_4
   5328  b63e
   5329  b63e				   PRCA_5
   5330  b63e		       a5 c5		      lda	dir_current_key
   5331  b640		       c9 18		      cmp	#24	; check for RUN-STOP key
   5332  b642		       f0 4a		      beq	PRCA_STOP
   5333  b644
   5334  b644		       ad 8d 02 	      lda	dir_shift_ctrl_cbm_flag
   5335  b647		       29 02		      and	#2	; filter commodore key (Bit 2)
   5336  b649		       d0 f3		      bne	PRCA_5
   5337  b64b
   5338  b64b		       b6 4c	   _relo0135  =	. +1
   5339  b64b		       20 c9 b6 	      jsr	CROUT	; CR
   5340  b64e
   5341  b64e		       a2 02		      ldx	#2
   5342  b64e		       b6 51	   _relo0121  =	. +1
   5343  b650		       20 9c b6 	      jsr	PRCA_SKIP_X	; skip x bytes
   5344  b653
   5345  b653		       a5 90		      lda	IECSTAT
   5346  b655		       d0 3a		      bne	PRCA_E
   5347  b657
   5348  b657		       b6 58	   _relo0318  =	. +1
   5349  b657		       20 f5 b9 	      jsr	IECIN
   5350  b65a		       aa		      tax		;LO
   5351  b65b							;sta PT3
   5352  b65b		       b6 5c	   _relo0319  =	. +1
   5353  b65b		       20 f5 b9 	      jsr	IECIN
   5354  b65e							;ldx PT3
   5355  b65e		       20 cd dd 	      jsr	PRNINT	;print integer in X/A
   5356  b661
   5357  b661		       b6 62	   _relo0122  =	. +1
   5358  b661		       20 94 b6 	      jsr	PRCA_SKIPSPC
   5359  b664		       c9 22		      cmp	#34
   5360  b666		       d0 18		      bne	PRCA_8
   5361  b668		       48		      pha
   5362  b669		       a2 02		      ldx	#2
   5363  b669		       b6 6c	   _relo0123  =	. +1
   5364  b66b		       20 b9 b6 	      jsr	PRCA_SPCOL	; print spaces up to column
   5365  b66e		       68		      pla
   5366  b66e		       b6 70	   _relo0124  =	. +1
   5367  b66f		       20 a3 b6 	      jsr	PRCA_QSTR1	; PRINT QUOTED STRING
   5368  b672
   5369  b672		       a2 14		      ldx	#20
   5370  b672		       b6 75	   _relo0125  =	. +1
   5371  b674		       20 b9 b6 	      jsr	PRCA_SPCOL	; print spaces up to column
   5372  b677
   5373  b677		       b6 78	   _relo0126  =	. +1
   5374  b677		       20 94 b6 	      jsr	PRCA_SKIPSPC
   5375  b677		       b6 7b	   _relo0127  =	. +1
   5376  b67a		       20 d1 b6 	      jsr	CHROUT	; FILETYP
   5377  b67d		       b8		      clv
   5378  b67e		       50 b8		      bvc	PRCA_4
   5379  b680
   5380  b680
   5381  b680
   5382  b680				   PRCA_8
   5383  b680		       48		      pha
   5384  b680		       b6 82	   _relo0128  =	. +1
   5385  b681		       20 c1 b6 	      jsr	SPCOUT	; BLANK
   5386  b684		       68		      pla
   5387  b685				   PRCA_9
   5388  b685		       b6 86	   _relo0129  =	. +1
   5389  b685		       20 d1 b6 	      jsr	CHROUT	;
   5390  b685		       b6 89	   _relo0320  =	. +1
   5391  b688		       20 f5 b9 	      jsr	IECIN
   5392  b68b		       aa		      tax
   5393  b68c		       d0 f7		      bne	PRCA_9
   5394  b68e
   5395  b68e				   PRCA_STOP
   5396  b68e		       b6 8f	   _relo0130  =	. +1
   5397  b68e		       20 c9 b6 	      jsr	CROUT	; CR
   5398  b691				   PRCA_E
   5399  b691				   PRCA_EE
   5400  b691				   PRCA_ERR
   5401  b691		       b6 92	   _relo0131  =	. +1
   5402  b691		       4c 90 b5 	      jmp	DISK_CLOSE_LO
   5403  b694
   5404  b694
   5405  b694
   5406  b694							; SKIP SPACE
   5407  b694				   PRCA_SKIPSPC
   5408  b694		       b6 95	   _relo0322  =	. +1
   5409  b694		       20 f5 b9 	      jsr	IECIN
   5410  b697		       c9 20		      cmp	#32	;spaces
   5411  b699		       f0 f9		      beq	PRCA_SKIPSPC
   5412  b69b		       60		      rts
   5413  b69c
   5414  b69c							; SKIP X BYTES
   5415  b69c				   PRCA_SKIP_X
   5416  b69c		       b6 9d	   _relo0323  =	. +1
   5417  b69c		       20 f5 b9 	      jsr	IECIN
   5418  b69f		       ca		      dex
   5419  b6a0		       d0 fa		      bne	PRCA_SKIP_X
   5420  b6a2		       60		      rts
   5421  b6a3
   5422  b6a3							; PRINT QUOTED STRING
   5423  b6a3				   PRCA_QSTR1
   5424  b6a3		       b6 a4	   _relo0132  =	. +1
   5425  b6a3		       20 d1 b6 	      jsr	CHROUT	; else print character in A
   5426  b6a6				   PRCA_QSTR2
   5427  b6a6		       a0 11		      ldy	#17
   5428  b6a8				   PRCAQS_2
   5429  b6a8		       b6 a9	   _relo0324  =	. +1
   5430  b6a8		       20 f5 b9 	      jsr	IECIN
   5431  b6a8		       b6 ac	   _relo0133  =	. +1
   5432  b6ab		       20 d1 b6 	      jsr	CHROUT	; else print character in A
   5433  b6ae		       c9 22		      cmp	#34	; check for "quote" char
   5434  b6b0		       f0 03		      beq	PRCAQS_E
   5435  b6b2		       88		      dey
   5436  b6b3		       d0 f3		      bne	PRCAQS_2
   5437  b6b5				   PRCAQS_E
   5438  b6b5		       60		      rts
   5439  b6b6
   5440  b6b6
   5441  b6b6				   PRCA_SP_1
   5442  b6b6		       b6 b7	   _relo0134  =	. +1
   5443  b6b6		       20 c1 b6 	      jsr	SPCOUT
   5444  b6b9
   5445  b6b9							; PRINT SPACE UP TO COL
   5446  b6b9				   PRCA_SPCOL
   5447  b6b9		       e4 d3		      cpx	C_COL
   5448  b6bb		       b0 f9		      bcs	PRCA_SP_1
   5449  b6bd		       60		      rts
   5450  b6be
   5451  b6be
   5452  b6be
   5453  b6be							; ==============================================================
   5454  b6be							; DISPLAY CHAR
   5455  b6be							; ==============================================================
   5456  b6be
   5457  b6be
   5458  b6be							;PRINT 2 BLANK
   5459  b6be				   SPCOUT2    subroutine
   5460  b6be		       b6 bf	   _relo0141  =	. +1
   5461  b6be		       20 c1 b6 	      jsr	SPCOUT
   5462  b6c1				   SPCOUT
   5463  b6c1		       a9 20		      lda	#32
   5464  b6c3		       d0 0c		      bne	CHROUT
   5465  b6c5
   5466  b6c5							;CLEAR SCREEN
   5467  b6c5				   CLROUT     subroutine
   5468  b6c5		       a9 93		      lda	#CLRHOME
   5469  b6c7		       d0 08		      bne	CHROUT
   5470  b6c9
   5471  b6c9							;PRINT CR
   5472  b6c9				   CROUT      subroutine
   5473  b6c9		       a9 0d		      lda	#13
   5474  b6cb		       d0 04		      bne	CHROUT
   5475  b6cd
   5476  b6cd							;PRINT 2 CHR IN AC/XR
   5477  b6cd				   CHROUT2    subroutine
   5478  b6cd		       b6 ce	   _relo0142  =	. +1
   5479  b6cd		       20 d1 b6 	      jsr	CHROUT
   5480  b6d0		       8a		      txa
   5481  b6d1				   CHROUT     subroutine
   5482  b6d1		       48		      pha
   5483  b6d2		       85 d7		      sta	$d7
   5484  b6d4		       8a		      txa
   5485  b6d5		       48		      pha
   5486  b6d6		       98		      tya
   5487  b6d7		       48		      pha
   5488  b6d8		       a5 d7		      lda	$d7
   5489  b6da		       30 2b		      bmi	.7
   5490  b6dc		       c9 20		      cmp	#$20
   5491  b6de		       b0 03		      bcs	.1
   5492  b6e0		       4c 56 e7 	      jmp	$e756
   5493  b6e3
   5494  b6e3				   .1
   5495  b6e3		       c9 60		      cmp	#$60
   5496  b6e5		       90 04		      bcc	.2
   5497  b6e7		       29 df		      and	#$df
   5498  b6e9		       d0 02		      bne	.3
   5499  b6eb				   .2
   5500  b6eb		       29 3f		      and	#$3f
   5501  b6ed				   .3
   5502  b6ed				   CHOU_3
   5503  b6ed		       a6 c7		      ldx	$c7	;revers?
   5504  b6ef		       f0 02		      beq	.4
   5505  b6f1		       09 80		      ora	#$80
   5506  b6f3				   .4
   5507  b6f3		       ae 86 02 	      ldx	$0286	;Farbcode
   5508  b6f6		       20 a1 ea 	      jsr	$eaa1	;Zeichen ausgeben
   5509  b6f9		       a5 d3		      lda	$d3
   5510  b6fb		       c9 15		      cmp	#$15
   5511  b6fd		       f0 02		      beq	.5
   5512  b6ff		       e6 d3		      inc	$d3
   5513  b701				   .5
   5514  b701		       68		      pla
   5515  b702		       a8		      tay
   5516  b703		       68		      pla
   5517  b704		       aa		      tax
   5518  b705		       68		      pla
   5519  b706		       60		      rts
   5520  b707
   5521  b707				   .7
   5522  b707		       29 7f		      and	#$7f
   5523  b709		       c9 20		      cmp	#$20
   5524  b70b		       b0 03		      bcs	.8
   5525  b70d		       4c 2a e8 	      jmp	$e82a
   5526  b710				   .8
   5527  b710		       09 40		      ora	#$40
   5528  b712		       d0 d9		      bne	.3
   5529  b714
   5530  b714				   PUTCHR     subroutine
   5531  b714		       48		      pha
   5532  b715		       20 b2 ea 	      jsr	$eab2	;zeiger in color RAM
   5533  b718		       68		      pla
   5534  b719				   PUTCHR2
   5535  b719		       a4 d3		      ldy	C_COL
   5536  b71b				   PUTCHR3
   5537  b71b		       91 d1		      sta	(C_LINE),y
   5538  b71d		       ad 86 02 	      lda	$0286	;Farbcode
   5539  b720		       91 f3		      sta	(C_COLP),y
   5540  b722		       60		      rts
   5541  b723
   5542  b723
   5543  b723
   5544  b723							; ==============================================================
   5545  b723							; CONVERT CHAR TO VRAM CODE	   C=1:CTRL CHAR
   5546  b723							; ==============================================================
   5547  b723
   5548  b723				   CONVCHR    subroutine
   5549  b723		       85 d7		      STA	C_CHR
   5550  b725
   5551  b725		       29 7f		      and	#$7f
   5552  b727		       c9 20		      cmp	#$20
   5553  b729		       90 19		      bcc	.9
   5554  b72b		       a6 d7		      ldx	C_CHR
   5555  b72d		       10 04		      bpl	.1
   5556  b72f		       09 40		      ora	#$40
   5557  b731		       d0 0a		      bne	.3
   5558  b733
   5559  b733				   .1
   5560  b733		       c9 60		      cmp	#$60
   5561  b735		       90 04		      bcc	.2
   5562  b737		       29 df		      and	#$df
   5563  b739		       d0 02		      bne	.3
   5564  b73b				   .2
   5565  b73b		       29 3f		      and	#$3f
   5566  b73d				   .3
   5567  b73d		       a6 c7		      ldx	$c7	;revers?
   5568  b73f		       f0 02		      beq	.4
   5569  b741		       09 80		      ora	#$80
   5570  b743				   .4
   5571  b743		       38		      sec
   5572  b744				   .9
   5573  b744		       60		      rts
   5574  b745
   5575  b745
   5576  b745							; ==============================================================
   5577  b745							; EVALUATE NEXT FORMULA ELEMENT
   5578  b745							; ==============================================================
   5579  b745
   5580  b745				   MY_FRMELEM subroutine
   5581  b745		       a9 00		      lda	#0
   5582  b747		       85 0d		      sta	$0d
   5583  b749		       20 73 00 	      jsr	CHRGET
   5584  b74c		       c9 24		      cmp	#"$"
   5585  b74e		       f0 0a		      beq	MYFR_HEX
   5586  b750		       c9 25		      cmp	#"%"
   5587  b752		       f0 15		      beq	MYFR_BIN
   5588  b754
   5589  b754		       20 79 00 	      jsr	CHRGOT
   5590  b757		       4c 8d ce 	      jmp	$ce8d	; ORIGINAL PROC
   5591  b75a
   5592  b75a
   5593  b75a				   MYFR_HEX   subroutine
   5594  b75a		       b7 5b	   _relo0150  =	. +1
   5595  b75a		       20 b7 b7 	      jsr	GETHEX	; GET HEX NUMBER A=HI, X=LO, C=0:error
   5596  b75d		       90 30		      bcc	ERR_TYPMIS
   5597  b75f
   5598  b75f				   AXFAC
   5599  b75f		       86 63		      stx	FAC +2
   5600  b761		       85 62		      sta	FAC +1
   5601  b763				   AXFAC_1
   5602  b763		       a2 90		      ldx	#$90
   5603  b765		       38		      sec
   5604  b766		       4c 49 dc 	      jmp	$dc49
   5605  b769
   5606  b769
   5607  b769				   MYFR_BIN
   5608  b769		       a2 10		      ldx	#16
   5609  b76b		       a9 00		      lda	#0
   5610  b76d		       85 62		      sta	FAC+1
   5611  b76f		       85 63		      sta	FAC+2
   5612  b771
   5613  b771				   MYBI_1
   5614  b771		       20 73 00 	      jsr	CHRGET
   5615  b774		       c9 31		      cmp	#"1"
   5616  b776		       f0 05		      beq	MYBI_2
   5617  b778		       c9 30		      cmp	#"0"
   5618  b77a		       d0 0e		      bne	MYBI_4
   5619  b77c		       18		      clc
   5620  b77d				   MYBI_2
   5621  b77d		       26 63		      rol	FAC+2
   5622  b77f		       26 62		      rol	FAC+1
   5623  b781		       ca		      dex
   5624  b782		       d0 ed		      bne	MYBI_1
   5625  b784		       20 73 00 	      jsr	CHRGET
   5626  b787				   MYBI_3
   5627  b787		       b7 88	   _relo0151  =	. +1
   5628  b787		       4c 63 b7 	      jmp	AXFAC_1
   5629  b78a
   5630  b78a				   MYBI_4
   5631  b78a		       8a		      txa
   5632  b78b		       29 13		      and	#19
   5633  b78d		       f0 f8		      beq	MYBI_3
   5634  b78f
   5635  b78f				   ERR_TYPMIS
   5636  b78f		       a2 16		      ldx	#$16
   5637  b791		       4c 37 c4 	      jmp	$c437	; ERROR
   5638  b794
   5639  b794
   5640  b794							; ==============================================================
   5641  b794							; CONVERT VALUES BETWEEN HEX/BIN
   5642  b794							; ==============================================================
   5643  b794
   5644  b794				   GETADR     subroutine		; GET HEX NUMBER A=HI, X=LO, C=0:error
   5645  b794		       20 79 00 	      jsr	CHRGOT
   5646  b797		       c9 24		      cmp	#"$"	; HEX VALUE
   5647  b799		       f0 1c		      beq	GETHEX
   5648  b79b		       18		      clc
   5649  b79c		       60		      rts
   5650  b79d
   5651  b79d
   5652  b79d							; GET WORD VALUE IN Y/A AND (PT3)
   5653  b79d				   FRMWORD2
   5654  b79d		       b7 9e	   _relo0160  =	. +1
   5655  b79d		       20 aa b7 	      jsr	CHKCOM
   5656  b7a0		       b0 07		      bcs	.3
   5657  b7a2				   FRMWORD
   5658  b7a2		       20 8a cd 	      jsr	FRMNUM
   5659  b7a5		       20 f7 d7 	      jsr	CNVWORD
   5660  b7a8		       18		      clc
   5661  b7a9				   .3
   5662  b7a9		       60		      rts
   5663  b7aa
   5664  b7aa
   5665  b7aa				   CHKCOM     subroutine
   5666  b7aa		       20 79 00 	      jsr	CHRGOT
   5667  b7ad		       c9 2c		      cmp	#$2c	; ","
   5668  b7af		       38		      sec
   5669  b7b0		       d0 04		      bne	.3
   5670  b7b2		       20 73 00 	      jsr	CHRGET
   5671  b7b5		       18		      clc
   5672  b7b6				   .3
   5673  b7b6		       60		      rts
   5674  b7b7
   5675  b7b7
   5676  b7b7
   5677  b7b7
   5678  b7b7				   GETHEX     subroutine		; GET HEX NUMBER A=HI, X=LO, C=0:error
   5679  b7b7		       20 73 00 	      jsr	CHRGET
   5680  b7ba
   5681  b7ba				   HEX_0
   5682  b7ba		       b7 bb	   _relo0170  =	. +1
   5683  b7ba		       20 d5 b7 	      jsr	HEXBYTE
   5684  b7bd		       90 15		      bcc	HEX_E
   5685  b7bf		       48		      pha
   5686  b7c0		       20 73 00 	      jsr	CHRGET
   5687  b7c0		       b7 c4	   _relo0171  =	. +1
   5688  b7c3		       20 d5 b7 	      jsr	HEXBYTE
   5689  b7c6		       b0 06		      bcs	HEX_2
   5690  b7c8		       68		      pla
   5691  b7c9		       aa		      tax
   5692  b7ca		       a9 00		      lda	#0
   5693  b7cc		       f0 05		      beq	HEX_3
   5694  b7ce
   5695  b7ce				   HEX_2
   5696  b7ce		       aa		      tax
   5697  b7cf		       20 73 00 	      jsr	CHRGET
   5698  b7d2		       68		      pla
   5699  b7d3				   HEX_3
   5700  b7d3		       38		      sec
   5701  b7d4				   HEX_E
   5702  b7d4		       60		      rts
   5703  b7d5
   5704  b7d5				   HEXBYTE
   5705  b7d5		       20 79 00 	      jsr	CHRGOT
   5706  b7d5		       b7 d9	   _relo0172  =	. +1
   5707  b7d8		       20 f5 b7 	      jsr	HEXCHAR
   5708  b7db		       90 17		      bcc	HEBY_E
   5709  b7db		       b7 de	   _relo0173  =	. +1
   5710  b7dd		       20 03 b8 	      jsr	ASCBYTE
   5711  b7e0		       0a		      asl
   5712  b7e1		       0a		      asl
   5713  b7e2		       0a		      asl
   5714  b7e3		       0a		      asl
   5715  b7e4		       85 61		      sta	FAC
   5716  b7e6		       20 73 00 	      jsr	CHRGET
   5717  b7e6		       b7 ea	   _relo0174  =	. +1
   5718  b7e9		       20 f5 b7 	      jsr	HEXCHAR
   5719  b7ec		       90 06		      bcc	HEBY_E
   5720  b7ec		       b7 ef	   _relo0175  =	. +1
   5721  b7ee		       20 03 b8 	      jsr	ASCBYTE
   5722  b7f1		       05 61		      ora	FAC
   5723  b7f3		       38		      sec
   5724  b7f4				   HEBY_E
   5725  b7f4		       60		      rts
   5726  b7f5
   5727  b7f5				   HEXCHAR
   5728  b7f5		       90 0a		      bcc	HECH_2
   5729  b7f7		       c9 41		      cmp	#65	; "A"
   5730  b7f9		       90 05		      bcc	HECH_E
   5731  b7fb		       e9 5b		      sbc	#91
   5732  b7fd		       38		      sec
   5733  b7fe		       e9 a5		      sbc	#165
   5734  b800				   HECH_E
   5735  b800		       60		      rts
   5736  b801				   HECH_2
   5737  b801		       38		      sec
   5738  b802		       60		      rts
   5739  b803
   5740  b803				   ASCBYTE
   5741  b803		       c9 3a		      cmp	#58
   5742  b805		       08		      php
   5743  b806		       29 0f		      and	#15
   5744  b808		       28		      plp
   5745  b809		       90 02		      bcc	ASBY_E
   5746  b80b		       69 08		      adc	#8
   5747  b80d				   ASBY_E
   5748  b80d		       60		      rts
   5749  b80e
   5750  b80e
   5751  b80e
   5752  b80e							; ==============================================================
   5753  b80e							; PRINT WORD VALUE BETWEEN HEX/BIN
   5754  b80e							; ==============================================================
   5755  b80e				   PRINT_VALUE
   5756  b80e		       b8 0f	   _relo0180  =	. +1
   5757  b80e		       20 c1 b6 	      jsr	SPCOUT
   5758  b811		       a6 14		      ldx	PT3
   5759  b813		       a5 15		      lda	PT3 +1
   5760  b813		       b8 16	   _relo0181  =	. +1
   5761  b815		       20 3c b8 	      jsr	HEXOUT
   5762  b818
   5763  b818		       b8 19	   _relo0182  =	. +1
   5764  b818		       20 be b6 	      jsr	SPCOUT2
   5765  b81b		       a6 14		      ldx	PT3
   5766  b81d		       a5 15		      lda	PT3 +1
   5767  b81f		       20 cd dd 	      jsr	PRNINT	;print integer in X/A
   5768  b822
   5769  b822		       b8 23	   _relo0184  =	. +1
   5770  b822		       20 be b6 	      jsr	SPCOUT2
   5771  b825		       a6 14		      ldx	PT3
   5772  b827		       a5 15		      lda	PT3 +1
   5773  b827		       b8 2a	   _relo0185  =	. +1
   5774  b829		       20 83 b8 	      jsr	ASCOUT
   5775  b82c
   5776  b82c		       b8 2d	   _relo0186  =	. +1
   5777  b82c		       20 c9 b6 	      jsr	CROUT
   5778  b82c		       b8 30	   _relo0187  =	. +1
   5779  b82f		       20 c1 b6 	      jsr	SPCOUT
   5780  b832		       a6 14		      ldx	PT3
   5781  b834		       a5 15		      lda	PT3 +1
   5782  b834		       b8 37	   _relo0188  =	. +1
   5783  b836		       20 60 b8 	      jsr	BINOUT
   5784  b836		       b8 3a	   _relo0189  =	. +1
   5785  b839		       4c c9 b6 	      jmp	CROUT
   5786  b83c
   5787  b83c
   5788  b83c
   5789  b83c							;------------ PRINT HEX VALUE IN  X/A
   5790  b83c				   HEXOUT     subroutine
   5791  b83c		       48		      pha
   5792  b83d		       a9 24		      lda	#"$"
   5793  b83f		       20 d2 ff 	      jsr	BSOUT
   5794  b842		       68		      pla
   5795  b843		       f0 03		      beq	.0
   5796  b845
   5797  b845				   HEXOUT4
   5798  b845		       b8 46	   _relo0200  =	. +1
   5799  b845		       20 49 b8 	      jsr	.2
   5800  b848				   .0
   5801  b848		       8a		      txa
   5802  b849				   HEXOUT2
   5803  b849				   .2
   5804  b849		       48		      pha
   5805  b84a		       4a		      lsr
   5806  b84b		       4a		      lsr
   5807  b84c		       4a		      lsr
   5808  b84d		       4a		      lsr
   5809  b84d		       b8 4f	   _relo0201  =	. +1
   5810  b84e		       20 54 b8 	      jsr	.1
   5811  b851		       68		      pla
   5812  b852		       29 0f		      and	#15
   5813  b854				   .1
   5814  b854		       18		      clc
   5815  b855		       69 f6		      adc	#246
   5816  b857		       90 02		      bcc	.12
   5817  b859		       69 06		      adc	#6
   5818  b85b				   .12
   5819  b85b		       69 3a		      adc	#58
   5820  b85d		       4c d2 ff 	      jmp	BSOUT
   5821  b860
   5822  b860
   5823  b860
   5824  b860
   5825  b860							;------------ PRINT BIN VALUE IN  X/A
   5826  b860				   BINOUT
   5827  b860		       48		      pha
   5828  b861		       a9 25		      lda	#"%"
   5829  b863		       20 d2 ff 	      jsr	BSOUT
   5830  b866		       68		      pla
   5831  b867		       f0 03		      beq	BIN0
   5832  b867		       b8 6a	   _relo0211  =	. +1
   5833  b869		       20 6d b8 	      jsr	BIN2
   5834  b86c				   BIN0
   5835  b86c		       8a		      txa
   5836  b86d				   BIN2
   5837  b86d		       a0 08		      ldy	#8
   5838  b86f				   BIN2a
   5839  b86f		       b8 70	   _relo0212  =	. +1
   5840  b86f		       20 76 b8 	      jsr	BIN1
   5841  b872		       88		      dey
   5842  b873		       d0 fa		      bne	BIN2a
   5843  b875		       60		      rts
   5844  b876
   5845  b876				   BIN1
   5846  b876		       0a		      asl
   5847  b877		       48		      pha
   5848  b878		       a9 30		      lda	#"0"
   5849  b87a		       90 02		      bcc	BIN1a
   5850  b87c		       a9 31		      lda	#"1"
   5851  b87e				   BIN1a
   5852  b87e		       20 d2 ff 	      jsr	BSOUT
   5853  b881		       68		      pla
   5854  b882		       60		      rts
   5855  b883
   5856  b883
   5857  b883
   5858  b883
   5859  b883							;------------ PRINT ASC VALUE IN  X/A
   5860  b883				   ASCOUT
   5861  b883		       48		      pha
   5862  b884		       8a		      txa
   5863  b885		       a8		      tay
   5864  b886		       a9 22		      lda	#34
   5865  b886		       b8 89	   _relo0220  =	. +1
   5866  b888		       20 d1 b6 	      jsr	CHROUT
   5867  b88b		       68		      pla
   5868  b88c		       f0 03		      beq	ASC0
   5869  b88c		       b8 8f	   _relo0221  =	. +1
   5870  b88e		       20 92 b8 	      jsr	ASC2
   5871  b891				   ASC0
   5872  b891		       98		      tya
   5873  b892				   ASC2
   5874  b892		       a2 00		      ldx	#0
   5875  b894		       86 d4		      stx	C_CTRL
   5876  b896		       aa		      tax
   5877  b897		       29 7f		      and	#127
   5878  b899		       c9 20		      cmp	#32
   5879  b89b		       90 04		      bcc	ASC1_1
   5880  b89d
   5881  b89d		       a9 92		      lda	#RVSOFF
   5882  b89f		       d0 07		      bne	ASC1_2
   5883  b8a1
   5884  b8a1				   ASC1_1
   5885  b8a1		       8a		      txa
   5886  b8a2		       18		      clc
   5887  b8a3		       69 40		      adc	#64
   5888  b8a5		       aa		      tax
   5889  b8a6		       a9 12		      lda	#RVSON
   5890  b8a8				   ASC1_2
   5891  b8a8		       b8 a9	   _relo0222  =	. +1
   5892  b8a8		       4c cd b6 	      jmp	CHROUT2
   5893  b8ab
   5894  b8ab
   5895  b8ab
   5896  b8ab
   5897  b8ab							; ==============================================================
   5898  b8ab							; TOKENIZER		       X=Token#, 0=no token found
   5899  b8ab							; ==============================================================
   5900  b8ab
   5901  b8ab				   TOKENIZER  subroutine
   5902  b8ab		       20 79 00 	      jsr	CHRGOT
   5903  b8ab		       b8 af	   _relo5230  =	. +1
   5904  b8ae		       a9 6c		      lda	#<TOKEN
   5905  b8b0		       a2 bb		      ldx	#>TOKEN
   5906  b8b2		       85 14		      sta	PT3
   5907  b8b4		       86 15		      stx	PT3 +1
   5908  b8b6
   5909  b8b6		       a2 01		      ldx	#1
   5910  b8b8				   TOZE_1
   5911  b8b8		       a0 00		      ldy	#0
   5912  b8ba				   TOZE_2
   5913  b8ba		       b1 14		      lda	(PT3),y
   5914  b8bc		       f0 1e		      beq	TOZE_10
   5915  b8be		       38		      sec
   5916  b8bf		       f1 7a		      sbc	(CHRPTR),y
   5917  b8c1		       f0 16		      beq	TOZE_3
   5918  b8c3		       c9 80		      cmp	#$80
   5919  b8c5		       f0 15		      beq	TOZE_10
   5920  b8c7
   5921  b8c7							;NEXT TOKEN
   5922  b8c7				   TOZE_8
   5923  b8c7		       c8		      iny
   5924  b8c8		       b1 14		      lda	(PT3),y
   5925  b8ca		       d0 fb		      bne	TOZE_8
   5926  b8cc
   5927  b8cc		       98		      tya
   5928  b8cd		       38		      sec
   5929  b8ce		       65 14		      adc	PT3
   5930  b8d0		       85 14		      sta	PT3
   5931  b8d2		       90 02		      bcc	TOZE_9
   5932  b8d4		       e6 15		      inc	PT3 +1
   5933  b8d6				   TOZE_9
   5934  b8d6		       e8		      inx
   5935  b8d7		       d0 df		      bne	TOZE_1
   5936  b8d9
   5937  b8d9				   TOZE_3
   5938  b8d9		       c8		      iny
   5939  b8da		       d0 de		      bne	TOZE_2
   5940  b8dc
   5941  b8dc							;TOKEN FOUND?
   5942  b8dc				   TOZE_10
   5943  b8dc		       98		      tya
   5944  b8dd		       f0 07		      beq	TOZE_11
   5945  b8df
   5946  b8df							;TOKEN FOUND!
   5947  b8df		       b8 e0	   _relo0230  =	. +1
   5948  b8df		       20 fd b2 	      jsr	ADD_CHRPTR	;SET CHRPTR AFTER TOKEN
   5949  b8e2		       8a		      txa
   5950  b8e2		       b8 e4	   _relo0231  =	. +1
   5951  b8e3		       bd a0 bb 	      lda	TOKEN_TAB -1,x
   5952  b8e6				   TOZE_11
   5953  b8e6		       aa		      tax
   5954  b8e7				   TOZE_E
   5955  b8e7		       60		      rts
   5956  b8e8
   5957  b8e8				   NEXT_STATEMENT
   5958  b8e8		       20 73 00 	      jsr	CHRGET
   5959  b8eb		       d0 fb		      bne	NEXT_STATEMENT	;SEARCH NEXT STATEMENT
   5960  b8ed		       60		      rts
   5961  b8ee
   5962  b8ee
   5963  b8ee
   5964  b8ee
   5965  b8ee
   5966  b8ee
   5967  b8ee
   5968  b8ee							;-------- SWITCH CARTRIDGE AND RESET SYSTEM
   5969  b8ee
   5970  b8ee		       90 00	   VIC	      =	$9000
   5971  b8ee		       91 10	   VIA1       =	$9110
   5972  b8ee		       91 20	   VIA2       =	$9120
   5973  b8ee
   5974  b8ee				   RESET_SYSTEM
   5975  b8ee		       48		      pha
   5976  b8ef		       8a		      txa
   5977  b8f0		       48		      pha
   5978  b8f1
   5979  b8f1		       a0 09		      ldy	#(__SET_IO_RESET_E - __SET_IO_RESET)
   5980  b8f1		       b8 f4	   _relo5250  =	. +1
   5981  b8f3		       a2 11		      ldx	#<__SET_IO_RESET
   5982  b8f5		       a9 b9		      lda	#>__SET_IO_RESET
   5983  b8f5		       b8 f8	   _relo0250  =	. +1
   5984  b8f7		       20 03 b9 	      jsr	COPY_PROC
   5985  b8fa
   5986  b8fa		       b8 fb	   _relo0251  =	. +1
   5987  b8fa		       20 1a b9 	      jsr	RESET_IO
   5988  b8fd
   5989  b8fd		       68		      pla
   5990  b8fe		       aa		      tax
   5991  b8ff		       68		      pla
   5992  b900		       4c 00 02 	      jmp	BIP
   5993  b903
   5994  b903							;-------- COPY PROCEDURE TO BIP AND EXECUTE
   5995  b903				   COPY_PROC  subroutine
   5996  b903		       85 23		      sta	PT1 +1
   5997  b905		       86 22		      stx	PT1
   5998  b907		       88		      dey
   5999  b908				   .2
   6000  b908		       b1 22		      lda	(PT1),y
   6001  b90a		       99 00 02 	      sta	BIP,y
   6002  b90d		       88		      dey
   6003  b90e		       10 f8		      bpl	.2
   6004  b910		       60		      rts
   6005  b911
   6006  b911
   6007  b911
   6008  b911
   6009  b911							;-------- RAM PROCEDURE TO SWITCH CARTRIDGE AND RESET
   6010  b911				   __SET_IO_RESET
   6011  b911		       8d 02 9c 	      sta	IO_FINAL
   6012  b914		       8e 03 9c 	      stx	IO_FINAL +1
   6013  b917		       4c 22 fd 	      jmp	SOFT_RESET
   6014  b91a				   __SET_IO_RESET_E
   6015  b91a
   6016  b91a
   6017  b91a
   6018  b91a
   6019  b91a
   6020  b91a				   RESET_IO
   6021  b91a		       78		      sei
   6022  b91b		       a9 00		      lda	#$00
   6023  b91d		       8d 12 91 	      sta	VIA1 +$02	; DDRA
   6024  b920		       8d 13 91 	      sta	VIA1 +$03	; DDRB
   6025  b923		       8d 22 91 	      sta	VIA2 +$02	; DDRA
   6026  b926		       8d 23 91 	      sta	VIA2 +$03	; DDRB
   6027  b929
   6028  b929		       a9 7f		      lda	#$7f
   6029  b92b		       8d 1e 91 	      sta	VIA1 +$0e	; IER: clear all bits
   6030  b92e		       8d 2e 91 	      sta	VIA2 +$0e	; IER: clear all bits
   6031  b931		       60		      rts
   6032  b932
   6033  b932
   6034  b932
   6035  b932							; ==============================================================
   6036  b932							; JIFFY PROCS
   6037  b932							; ==============================================================
   6038  b932
   6039  b932							;--------------JIFFY LISTEN
   6040  b932				   JIF_TALK
   6041  b932		       09 40		      ORA	#$40
   6042  b934		       2c		      .byte.b	$2c
   6043  b935				   JIF_LISTEN
   6044  b935		       09 20		      ORA	#$20
   6045  b937		       20 60 f1 	      JSR	$F160	;SET TIMER
   6046  b93a				   lEE1C
   6047  b93a		       48		      PHA
   6048  b93b		       24 94		      BIT	$94
   6049  b93d		       10 0a		      BPL	l6E2B
   6050  b93f		       38		      SEC
   6051  b940		       66 a3		      ROR	$A3
   6052  b940		       b9 43	   _relo0361  =	. +1
   6053  b942		       20 6d ba 	      JSR	lfc41	;NEW BYTE OUT
   6054  b945		       46 94		      LSR	$94
   6055  b947		       46 a3		      LSR	$A3
   6056  b949				   l6E2B
   6057  b949		       68		      PLA
   6058  b94a		       85 95		      STA	$95
   6059  b94c
   6060  b94c							;JSR lF19A			       ;NEW DAV hi
   6061  b94c		       78		      SEI
   6062  b94d		       a9 00		      LDA	#$00
   6063  b94f		       85 a3		      STA	$A3
   6064  b951		       20 a0 e4 	      JSR	$E4A0	;DAV hi
   6065  b954
   6066  b954		       c9 3f		      CMP	#$3F
   6067  b956		       d0 03		      BNE	l6E38
   6068  b958		       20 84 ef 	      JSR	$EF84	;NDAC lo
   6069  b95b				   l6E38
   6070  b95b		       ad 1f 91 	      LDA	$911F
   6071  b95e		       09 80		      ORA	#$80
   6072  b960		       8d 1f 91 	      STA	$911F
   6073  b963				   lEE40
   6074  b963		       20 8d ef 	      JSR	$EF8D	;PCR BIT 1 LÖSCHEN
   6075  b966		       20 a0 e4 	      JSR	$E4A0
   6076  b969		       20 96 ef 	      JSR	$EF96
   6077  b96c							;jmp $ee49			       ;ORIG BYTE OUT
   6078  b96c
   6079  b96c				   OLD_IECOUT
   6080  b96c		       78		      SEI
   6081  b96d		       20 a0 e4 	      JSR	$E4A0	;DAV lo
   6082  b970		       20 b2 e4 	      JSR	$E4B2	;NRFD hi
   6083  b973		       4a		      LSR
   6084  b974		       b0 4f		      BCS	l6EB4	;err DEV NOT PRES
   6085  b976
   6086  b976		       20 84 ef 	      JSR	$EF84	;NDAC lo
   6087  b979		       24 a3		      BIT	$A3
   6088  b97b		       10 0c		      BPL	l6E66
   6089  b97d				   l6E5A
   6090  b97d		       20 b2 e4 	      JSR	$E4B2	;NRFD hi
   6091  b980		       4a		      LSR
   6092  b981		       90 fa		      BCC	l6E5A
   6093  b983				   l6E60
   6094  b983		       20 b2 e4 	      JSR	$E4B2	;NRFD hi
   6095  b986		       4a		      LSR
   6096  b987		       b0 fa		      BCS	l6E60
   6097  b989				   l6E66
   6098  b989		       20 b2 e4 	      JSR	$E4B2	;NRFD hi
   6099  b98c		       4a		      LSR
   6100  b98d		       90 fa		      BCC	l6E66
   6101  b98f		       20 8d ef 	      JSR	$EF8D	;PCR BIT 1 LÖSCHEN
   6102  b992
   6103  b992		       8a		      TXA
   6104  b993		       48		      PHA
   6105  b994		       a2 08		      LDX	#$08	;8 BIT
   6106  b996
   6107  b996				   l6E73
   6108  b996		       ad 1f 91 	      LDA	$911F
   6109  b999		       29 02		      AND	#$02
   6110  b99b		       d0 05		      BNE	l6E7F
   6111  b99d		       68		      PLA
   6112  b99e		       aa		      TAX
   6113  b99f		       4c b7 ee 	      JMP	$EEB7	;ERR TIMEOUT
   6114  b9a2
   6115  b9a2				   l6E7F
   6116  b9a2		       20 a0 e4 	      JSR	$E4A0	;DAV hi
   6117  b9a5		       66 95		      ROR	$95
   6118  b9a7		       b0 03		      BCS	l6E89
   6119  b9a9		       20 a9 e4 	      JSR	$E4A9	;DAV lo
   6120  b9ac				   l6E89
   6121  b9ac		       20 84 ef 	      JSR	$EF84	;NDAC lo
   6122  b9af		       ad 2c 91 	      LDA	$912C
   6123  b9b2		       29 dd		      AND	#$DD
   6124  b9b4		       09 02		      ORA	#$02
   6125  b9b6		       08		      PHP
   6126  b9b7		       48		      PHA
   6127  b9b7		       b9 b9	   _relo0350  =	. +1
   6128  b9b8		       20 cb b9 	      JSR	lF96E
   6129  b9bb		       68		      PLA
   6130  b9bc		       28		      PLP
   6131  b9bd		       ca		      DEX
   6132  b9be		       d0 d6		      BNE	l6E73
   6133  b9c0
   6134  b9c0		       68		      PLA
   6135  b9c1		       aa		      TAX
   6136  b9c2		       4c a0 ee 	      jmp	$EEA0
   6137  b9c5							;  NOP
   6138  b9c5							;lEEA5
   6139  b9c5							;  LDA #$04
   6140  b9c5							;  STA $9129
   6141  b9c5							;l6EA5
   6142  b9c5							;  LDA $912D
   6143  b9c5							;  AND #$20
   6144  b9c5							;  BNE l6EB7
   6145  b9c5							;  JSR $E4B2
   6146  b9c5							;  LSR
   6147  b9c5							;  BCS l6EA5
   6148  b9c5							;  CLI
   6149  b9c5							;  RTS
   6150  b9c5
   6151  b9c5				   l6EB4
   6152  b9c5		       4c b4 ee 	      jmp	$eeb4	;err DEV NOT PRES
   6153  b9c8
   6154  b9c8				   l6EB7
   6155  b9c8		       4c b7 ee 	      jmp	$eeb7	;err TIME OUT
   6156  b9cb
   6157  b9cb
   6158  b9cb				   lF96E
   6159  b9cb		       8d 2c 91 	      STA	$912C
   6160  b9ce		       2c 1f 91 	      BIT	$911F
   6161  b9d1		       10 21		      BPL	lF997
   6162  b9d3		       e0 02		      CPX	#$02
   6163  b9d5		       d0 1d		      BNE	lF997
   6164  b9d7		       a9 02		      LDA	#$02
   6165  b9d9		       a2 20		      LDX	#$20
   6166  b9db				   lF97E
   6167  b9db		       2c 1f 91 	      BIT	$911F
   6168  b9de		       f0 05		      BEQ	lF988
   6169  b9e0		       ca		      DEX
   6170  b9e1		       d0 f8		      BNE	lF97E
   6171  b9e3		       f0 0d		      BEQ	lF995
   6172  b9e5				   lF988
   6173  b9e5		       2c 1f 91 	      BIT	$911F
   6174  b9e8		       f0 fb		      BEQ	lF988
   6175  b9ea		       a5 95		      LDA	$95
   6176  b9ec		       6a		      ROR
   6177  b9ed		       6a		      ROR
   6178  b9ee		       09 40		      ORA	#$40
   6179  b9f0		       85 a3		      STA	$A3
   6180  b9f2				   lF995
   6181  b9f2		       a2 02		      LDX	#$02
   6182  b9f4				   lF997
   6183  b9f4		       60		      rts
   6184  b9f5
   6185  b9f5
   6186  b9f5
   6187  b9f5
   6188  b9f5
   6189  b9f5							;--------------JIFFY BYTE IN
   6190  b9f5				   JIF_IECIN
   6191  b9f5				   lfbe0		;NEW BYTE IN??
   6192  b9f5		       78		      sei
   6193  b9f6		       24 a3		      bit	$a3
   6194  b9f8		       70 05		      bvs	l7be5
   6195  b9fa		       a9 00		      LDA	#$00
   6196  b9fc		       4c 1c ef 	      JMP	$EF1C	;ORIG BYTE IN
   6197  b9ff
   6198  b9ff				   JIFFY_IN
   6199  b9ff				   l7be5
   6200  b9ff		       ad 1f 91 	      LDA	$911F
   6201  ba02		       29 03		      AND	#$03
   6202  ba04		       f0 f9		      BEQ	l7be5
   6203  ba06		       a9 80		      LDA	#$80
   6204  ba08		       85 9c		      STA	$9C
   6205  ba0a		       8a		      TXA
   6206  ba0b		       48		      PHA
   6207  ba0c		       48		      PHA
   6208  ba0d		       68		      PLA
   6209  ba0e		       48		      PHA
   6210  ba0f		       68		      PLA
   6211  ba10		       ad 2c 91 	      LDA	$912C
   6212  ba13		       29 dd		      AND	#$DD
   6213  ba15		       8d 2c 91 	      STA	$912C
   6214  ba18		       09 20		      ORA	#$20
   6215  ba1a		       aa		      TAX
   6216  ba1b		       24 9c		      BIT	$9C
   6217  ba1d		       24 9c		      BIT	$9C
   6218  ba1f		       24 9c		      BIT	$9C
   6219  ba21		       ad 1f 91 	      LDA	$911F
   6220  ba24		       6a		      ROR
   6221  ba25		       6a		      ROR
   6222  ba26		       ea		      NOP
   6223  ba27		       29 80		      AND	#$80
   6224  ba29		       0d 1f 91 	      ORA	$911F
   6225  ba2c		       2a		      ROL
   6226  ba2d		       2a		      ROL
   6227  ba2e		       85 b3		      STA	$B3
   6228  ba30		       ad 1f 91 	      LDA	$911F
   6229  ba33		       6a		      ROR
   6230  ba34		       6a		      ROR
   6231  ba35		       29 80		      AND	#$80
   6232  ba37		       ea		      NOP
   6233  ba38		       0d 1f 91 	      ORA	$911F
   6234  ba3b		       2a		      ROL
   6235  ba3c		       2a		      ROL
   6236  ba3d		       85 c0		      STA	$C0
   6237  ba3f		       ad 1f 91 	      LDA	$911F
   6238  ba42		       8e 2c 91 	      STX	$912C
   6239  ba45		       85 9c		      STA	$9C
   6240  ba45		       ba 48	   _relo0351  =	. +1
   6241  ba47		       20 fa ba 	      JSR	lEC4E	;BYTE AUS 2 NIBBLES
   6242  ba4a
   6243  ba4a		       85 a4		      STA	$A4
   6244  ba4c		       68		      PLA
   6245  ba4d		       aa		      TAX
   6246  ba4e		       a5 9c		      LDA	$9C
   6247  ba50		       6a		      ROR
   6248  ba51		       6a		      ROR
   6249  ba52		       10 2c		      BPL	l7C54
   6250  ba54		       90 25		      BCC	lfC4f
   6251  ba56		       a9 42		      LDA	#$42
   6252  ba58		       4c b9 ee 	      JMP	$EEB9	;ERR STATUS, UNLISTEN
   6253  ba5b							;--------------JIFFY BYTE IN
   6254  ba5b
   6255  ba5b
   6256  ba5b							;--------------JIFFY BYTE OUT
   6257  ba5b				   JIF_IECOUT
   6258  ba5b		       24 94		      BIT	$94
   6259  ba5d		       30 05		      BMI	lEEED
   6260  ba5f		       38		      SEC
   6261  ba60		       66 94		      ROR	$94
   6262  ba62		       d0 05		      BNE	lEEF2
   6263  ba64				   lEEED
   6264  ba64		       48		      PHA
   6265  ba64		       ba 66	   _relo0352  =	. +1
   6266  ba65		       20 6d ba 	      JSR	NEW_IECOUT
   6267  ba68		       68		      PLA
   6268  ba69				   lEEF2
   6269  ba69		       85 95		      STA	$95
   6270  ba6b		       18		      CLC
   6271  ba6c		       60		      RTS
   6272  ba6d
   6273  ba6d
   6274  ba6d				   NEW_IECOUT
   6275  ba6d				   lfc41		;NEW BYTE OUT
   6276  ba6d		       78		      sei
   6277  ba6e		       24 a3		      bit	$a3
   6278  ba70		       70 13		      bvs	lfc59
   6279  ba72		       a5 a3		      LDA	$A3
   6280  ba74		       c9 a0		      CMP	#$A0
   6281  ba76		       b0 0d		      BCS	lfc59
   6282  ba76		       ba 79	   _relo0353  =	. +1
   6283  ba78		       4c 6c b9 	      JMP	OLD_IECOUT
   6284  ba7b							;JMP $EE49				;ORIG BYTE OUT
   6285  ba7b
   6286  ba7b				   lfC4f
   6287  ba7b		       a9 40		      LDA	#$40
   6288  ba7d		       20 6a fe 	      JSR	$FE6A	;SET STATUS
   6289  ba80				   l7C54
   6290  ba80		       a5 a4		      LDA	$A4
   6291  ba82				   l7C56
   6292  ba82		       58		      CLI
   6293  ba83		       18		      CLC
   6294  ba84		       60		      RTS
   6295  ba85
   6296  ba85
   6297  ba85				   JIFFY_OUT
   6298  ba85				   lfc59		;JIFFY BYTE OUT
   6299  ba85		       8a		      TXA
   6300  ba86		       48		      PHA
   6301  ba87		       a5 95		      LDA	$95
   6302  ba89		       4a		      LSR
   6303  ba8a		       4a		      LSR
   6304  ba8b		       4a		      LSR
   6305  ba8c		       4a		      LSR
   6306  ba8d		       aa		      TAX
   6307  ba8d		       ba 8f	   _relo0354  =	. +1
   6308  ba8e		       bd 3c bb 	      LDA	lFCCE,X
   6309  ba91		       48		      PHA
   6310  ba92		       8a		      TXA
   6311  ba93		       4a		      LSR
   6312  ba94		       4a		      LSR
   6313  ba95		       aa		      TAX
   6314  ba95		       ba 97	   _relo0355  =	. +1
   6315  ba96		       bd 3c bb 	      LDA	lFCCE,X
   6316  ba99		       85 b3		      STA	$B3
   6317  ba9b		       a5 95		      LDA	$95
   6318  ba9d		       29 0f		      AND	#$0F
   6319  ba9f		       aa		      TAX
   6320  baa0		       a9 02		      LDA	#$02
   6321  baa2				   l7C76
   6322  baa2		       2c 1f 91 	      BIT	$911F
   6323  baa5		       f0 fb		      BEQ	l7C76
   6324  baa7
   6325  baa7		       ad 2c 91 	      LDA	$912C
   6326  baaa		       29 dd		      AND	#$DD
   6327  baac		       85 9c		      STA	$9C
   6328  baae		       48		      PHA
   6329  baaf		       68		      PLA
   6330  bab0		       48		      PHA
   6331  bab1		       68		      PLA
   6332  bab2		       ea		      NOP
   6333  bab3		       ea		      NOP
   6334  bab4		       ea		      NOP
   6335  bab5		       8d 2c 91 	      STA	$912C
   6336  bab8		       68		      PLA
   6337  bab9		       05 9c		      ORA	$9C
   6338  babb		       ea		      NOP
   6339  babc		       8d 2c 91 	      STA	$912C
   6340  babf		       a5 b3		      LDA	$B3
   6341  bac1		       05 9c		      ORA	$9C
   6342  bac3		       05 9c		      ORA	$9C
   6343  bac5		       8d 2c 91 	      STA	$912C
   6344  bac5		       ba c9	   _relo0356  =	. +1
   6345  bac8		       bd 4c bb 	      LDA	lFBBA,X
   6346  bacb		       05 9c		      ORA	$9C
   6347  bacd		       ea		      NOP
   6348  bace		       8d 2c 91 	      STA	$912C
   6349  bace		       ba d2	   _relo0357  =	. +1
   6350  bad1		       bd 5c bb 	      LDA	lF39E,X
   6351  bad4		       05 9c		      ORA	$9C
   6352  bad6		       ea		      NOP
   6353  bad7		       8d 2c 91 	      STA	$912C
   6354  bada		       ea		      NOP
   6355  badb		       29 dd		      AND	#$DD
   6356  badd		       24 a3		      BIT	$A3
   6357  badf		       30 02		      BMI	l7CB7
   6358  bae1		       09 02		      ORA	#$02
   6359  bae3				   l7CB7
   6360  bae3		       8d 2c 91 	      STA	$912C
   6361  bae6		       68		      PLA
   6362  bae7		       aa		      TAX
   6363  bae8		       ea		      NOP
   6364  bae9		       a5 9c		      LDA	$9C
   6365  baeb		       09 02		      ORA	#$02
   6366  baed		       8d 2c 91 	      STA	$912C
   6367  baf0		       ad 1f 91 	      LDA	$911F
   6368  baf3		       29 02		      AND	#$02
   6369  baf5		       f0 8b		      BEQ	l7C56
   6370  baf7		       4c b7 ee 	      JMP	$EEB7	; err TIME OUT
   6371  bafa							;--------------JIFFY BYTE OUT
   6372  bafa
   6373  bafa
   6374  bafa
   6375  bafa							;--------------BAUT EIN BYTE AUS 2 NIBBLES ZUSAMMEN
   6376  bafa				   lEC4E
   6377  bafa		       a5 b3		      LDA	$B3
   6378  bafc		       29 0f		      AND	#$0F
   6379  bafe		       85 b3		      STA	$B3
   6380  bb00		       a5 c0		      LDA	$C0
   6381  bb02		       0a		      ASL
   6382  bb03		       0a		      ASL
   6383  bb04		       0a		      ASL
   6384  bb05		       0a		      ASL
   6385  bb06		       05 b3		      ORA	$B3
   6386  bb08		       60		      RTS
   6387  bb09							;--------------JIFFY BYTE IN
   6388  bb09
   6389  bb09
   6390  bb09
   6391  bb09							;--------------JIFFY UNTALK/UNLISTEN
   6392  bb09				   JIF_UNTALK
   6393  bb09				   lEEF6
   6394  bb09		       ad 1f 91 	      LDA	$911F
   6395  bb0c		       09 80		      ORA	#$80	;ATN ausgeben
   6396  bb0e		       8d 1f 91 	      STA	$911F
   6397  bb11		       20 8d ef 	      JSR	$EF8D
   6398  bb14		       a9 5f		      LDA	#$5F
   6399  bb16		       2c		      .byte.b	$2c
   6400  bb17				   JIF_UNLISTEN
   6401  bb17		       a9 3f		      LDA	#$3F
   6402  bb17		       bb 1a	   _relo0358  =	. +1
   6403  bb19		       20 3a b9 	      JSR	lEE1C	;PART OF LISTEN
   6404  bb1c		       20 c5 ee 	      JSR	$EEC5
   6405  bb1f		       8a		      TXA
   6406  bb20		       a2 0b		      LDX	#$0B
   6407  bb22				   lEF0F
   6408  bb22		       ca		      DEX
   6409  bb23		       d0 fd		      BNE	lEF0F
   6410  bb25		       aa		      TAX
   6411  bb26		       20 84 ef 	      JSR	$EF84
   6412  bb29		       4c a0 e4 	      JMP	$E4A0
   6413  bb2c							;--------------JIFFY UNTALK/UNLISTEN
   6414  bb2c
   6415  bb2c
   6416  bb2c
   6417  bb2c							;--------------JIFFY TALK SA
   6418  bb2c				   JIF_TALKSA
   6419  bb2c		       85 95		      STA	$95
   6420  bb2c		       bb 2f	   _relo0359  =	. +1
   6421  bb2e		       20 63 b9 	      JSR	lEE40
   6422  bb31		       4c d3 ee 	      jmp	$eed3
   6423  bb34							;--------------JIFFY TALK SA
   6424  bb34
   6425  bb34
   6426  bb34							;--------------JIFFY LISTEN SA
   6427  bb34				   JIF_LISTENSA
   6428  bb34		       85 95		      STA	$95
   6429  bb34		       bb 37	   _relo0360  =	. +1
   6430  bb36		       20 63 b9 	      JSR	lEE40
   6431  bb39		       4c c5 ee 	      jmp	$eec5
   6432  bb3c							;--------------JIFFY LISTEN SA
   6433  bb3c
   6434  bb3c
   6435  bb3c
   6436  bb3c
   6437  bb3c							;--------------JIFFY DATA TABLE
   6438  bb3c				   lFCCE
   6439  bb3c		       00 02 20 22*	      .byte.b	$00,$02,$20,$22,$00,$02,$20,$22,$00,$02,$20,$22,$00,$02,$20,$22
   6440  bb4c
   6441  bb4c				   lFBBA
   6442  bb4c		       00 00 20 20*	      .byte.b	$00,$00,$20,$20,$00,$00,$20,$20,$02,$02,$22,$22,$02,$02,$22,$22
   6443  bb5c
   6444  bb5c				   lF39E
   6445  bb5c		       00 20 00 20*	      .byte.b	$00,$20,$00,$20,$02,$22,$02,$22,$00,$20,$00,$20,$02,$22,$02,$22
   6446  bb6c							;--------------JIFFY DATA TABLE
   6447  bb6c
   6448  bb6c
   6449  bb6c
   6450  bb6c
   6451  bb6c
   6452  bb6c							; ==============================================================
   6453  bb6c							; LOADER TEXTE AND TOKEN TABLE
   6454  bb6c							; ==============================================================
   6455  bb6c
   6456  bb6c		       00 01	   TOK_NOIO   =	1
   6457  bb6c		       00 02	   TOK_BLKP   =	TOK_NOIO +1
   6458  bb6c		       00 03	   TOK_BLKD   =	TOK_NOIO +2
   6459  bb6c		       00 04	   TOK_RES    =	TOK_NOIO +3
   6460  bb6c		       00 05	   TOK_RELO   =	TOK_NOIO +4
   6461  bb6c		       00 06	   TOK_RUN    =	TOK_NOIO +5
   6462  bb6c		       00 07	   TOK_SYS    =	TOK_NOIO +6
   6463  bb6c		       00 08	   TOK_OLD    =	TOK_NOIO +7
   6464  bb6c		       00 09	   TOK_OFF    =	TOK_NOIO +8
   6465  bb6c		       00 0a	   TOK_KILL   =	TOK_NOIO +9
   6466  bb6c
   6467  bb6c
   6468  bb6c
   6469  bb6c				   TOKEN
   6470  bb6c		       4e 4f 49 4f*	      dc.b	"NOIO",0,"BLKD",0,"BLKP",0,"BLK",0
   6471  bb7f				   MSG_RES
   6472  bb7f		       52 45 53 45*	      dc.b	"RESET",0
   6473  bb85		       4f 46 46 00	      dc.b	"OFF",0
   6474  bb89		       4b 49 4c 4c*	      dc.b	"KILL",0
   6475  bb8e		       4f 4c 44 00	      dc.b	"OLD",0
   6476  bb92		       55 4e 4e 45*	      dc.b	"UNNEW",0
   6477  bb98		       52 45 93 00	      dc.b	"RE",$93,0	; RELOAD
   6478  bb9c		       8a 00		      dc.b	$8a,0	; RUN
   6479  bb9e		       9e 00		      dc.b	$9e,0	; SYS
   6480  bba0		       00		      dc.b	0	; ::END
   6481  bba1
   6482  bba1				   TOKEN_TAB
   6483  bba1		       01 03 02 02*	      dc.b	TOK_NOIO,TOK_BLKD,TOK_BLKP,TOK_BLKP,TOK_RES,TOK_OFF,TOK_KILL,TOK_OLD,TOK_OLD
   6484  bbaa		       05 06 07 	      dc.b	TOK_RELO,TOK_RUN,TOK_SYS
   6485  bbad
   6486  bbad
   6487  bbad
   6488  bbad
   6489  bbad
   6490  bbad
   6491  bbad							; ==============================================================
   6492  bbad							; MESSAGE TEXTE
   6493  bbad							; ==============================================================
   6494  bbad
   6495  bbad
   6496  bbad				   MSG_LOADAT
   6497  bbad		       20 46 52 4f*	      dc.b	" FROM ",0
   6498  bbb4				   MSG_LOADTO
   6499  bbb4		       20 54 4f 20*	      dc.b	" TO ",0
   6500  bbb9
   6501  bbb9				   MSG_DEVICE
   6502  bbb9		       44 45 56 49*	      dc.b	"DEVICE#",0
   6503  bbc1
   6504  bbc1
   6505  bbc1				   MSG_PRINTIO
   6506  bbc1		       49 4f 3d 00	      dc.b	"IO=",0
   6507  bbc5				   MSG_NOIO
   6508  bbc5		       49 4f 20 4f*	      dc.b	"IO OFF",13,0
   6509  bbcd
   6510  bbcd
   6511  bbcd				   MY_WEDGE_END
   6512  bbcd							; == END OF MINI WEDGE ============================================================
   6513  bbcd
   6514  bbcd
   6515  bbcd
   6516  bbcd				   WEDGEMESSAGE1b
   6517  bbcd		       11 1c 46 45*	      dc.b	$11, RED, "FE3 WEDGE (", 0
   6518  bbdb				   WEDGEMESSAGE1c
   6519  bbdb		       4f 46 46 29*	      dc.b	"OFF)",BLUE,13,0
   6520  bbe2
   6521  bbe2
   6522  bbe2
   6523  bbe2
   6524  bbe2
   6525  bbe2
   6526  bbe2
   6527  bbe2
   6528  bbe2
   6529  bbe2
   6530  bbe2
   6531  bbe2							; ==============================================================
   6532  bbe2							; JIFFY IO CODE (CHKIN, CHKOUT, BASIN, BSOUT)	 from SJLOAD-128
   6533  bbe2							; ==============================================================
   6534  bbe2
   6535  bbe2		       03 1e	   PTR_CHKIN  =	$031e
   6536  bbe2		       03 20	   PTR_CHKOUT =	$0320
   6537  bbe2		       03 24	   PTR_BASIN  =	$0324
   6538  bbe2		       03 22	   PTR_CLRCH  =	$0322
   6539  bbe2		       03 26	   PTR_BASOUT =	$0326
   6540  bbe2		       03 2a	   PTR_GETIN  =	$032a
   6541  bbe2		       03 2c	   PTR_CLRALL =	$032c
   6542  bbe2
   6543  bbe2							;-------------------- WEDGE INIT
   6544  bbe2				   SET_BASE_VECTORS
   6545  bbe2		       a9 29		      lda	#<JChkIn
   6546  bbe4		       a2 bc		      ldx	#>JChkIn
   6547  bbe6		       8d 1e 03 	      sta	PTR_CHKIN
   6548  bbe9		       8e 1f 03 	      stx	PTR_CHKIN +1
   6549  bbec		       a9 4e		      lda	#<JChkOut
   6550  bbee		       a2 bc		      ldx	#>JChkOut
   6551  bbf0		       8d 20 03 	      sta	PTR_CHKOUT
   6552  bbf3		       8e 21 03 	      stx	PTR_CHKOUT +1
   6553  bbf6		       a9 7c		      lda	#<JBasIn
   6554  bbf8		       a2 bc		      ldx	#>JBasIn
   6555  bbfa		       8d 24 03 	      sta	PTR_BASIN
   6556  bbfd		       8e 25 03 	      stx	PTR_BASIN +1
   6557  bc00		       a9 8f		      lda	#<JBasOut
   6558  bc02		       a2 bc		      ldx	#>JBasOut
   6559  bc04		       8d 26 03 	      sta	PTR_BASOUT
   6560  bc07		       8e 27 03 	      stx	PTR_BASOUT +1
   6561  bc0a		       a9 73		      lda	#<JGetIn
   6562  bc0c		       a2 bc		      ldx	#>JGetIn
   6563  bc0e		       8d 2a 03 	      sta	PTR_GETIN
   6564  bc11		       8e 2b 03 	      stx	PTR_GETIN +1
   6565  bc14		       a9 a1		      lda	#<JClrCh
   6566  bc16		       a2 bc		      ldx	#>JClrCh
   6567  bc18		       8d 22 03 	      sta	PTR_CLRCH
   6568  bc1b		       8e 23 03 	      stx	PTR_CLRCH +1
   6569  bc1e		       a9 9d		      lda	#<JClrAll
   6570  bc20		       a2 bc		      ldx	#>JClrAll
   6571  bc22		       8d 2c 03 	      sta	PTR_CLRALL
   6572  bc25		       8e 2d 03 	      stx	PTR_CLRALL +1
   6573  bc28		       60		      rts
   6574  bc29
   6575  bc29
   6576  bc29
   6577  bc29
   6578  bc29							;
   6579  bc29							; JIFFY CHKIN	  ($031e vector)
   6580  bc29							;
   6581  bc29				   JChkIn     subroutine
   6582  bc29		       20 cf f3 	      jsr	$f3cf	;search logical file#
   6583  bc2c		       f0 03		      beq	.1	;file not open error
   6584  bc2e		       4c 84 f7 	      jmp	$f784	;err "file not open"
   6585  bc31
   6586  bc31				   .1
   6587  bc31		       20 df f3 	      jsr	$f3df	;set file param
   6588  bc34		       a5 ba		      lda	SY_DN	;device#
   6589  bc36		       c9 08		      cmp	#8
   6590  bc38		       b0 03		      bcs	.2
   6591  bc3a		       4c d2 f2 	      jmp	$f2d2	;std. ChkIn
   6592  bc3d
   6593  bc3d				   .2
   6594  bc3d		       aa		      tax
   6595  bc3e		       20 32 b9 	      jsr	TALK
   6596  bc41		       a5 b9		      lda	SY_SA
   6597  bc43		       10 03		      bpl	.3
   6598  bc45		       4c f8 f2 	      jmp	$f2f8
   6599  bc48
   6600  bc48				   .3
   6601  bc48		       20 2c bb 	      jsr	TALKSA
   6602  bc4b		       4c 01 f3 	      jmp	$f301
   6603  bc4e
   6604  bc4e
   6605  bc4e
   6606  bc4e
   6607  bc4e
   6608  bc4e							;
   6609  bc4e							; JIFFY CHKOUT    ($0320 vector)
   6610  bc4e							;
   6611  bc4e				   JChkOut    subroutine
   6612  bc4e		       20 cf f3 	      jsr	$f3cf	;search logical file#
   6613  bc51		       f0 03		      beq	.1	;file not open error
   6614  bc53		       4c 84 f7 	      jmp	$f784	;err "file not open"
   6615  bc56
   6616  bc56				   .1
   6617  bc56		       20 df f3 	      jsr	$f3df	;set file param
   6618  bc59		       a5 ba		      lda	SY_DN	;device#
   6619  bc5b		       c9 08		      cmp	#8
   6620  bc5d		       b0 03		      bcs	.2
   6621  bc5f		       4c 14 f3 	      jmp	$f314	;std. ChkOut
   6622  bc62
   6623  bc62				   .2
   6624  bc62		       aa		      tax
   6625  bc63		       20 35 b9 	      jsr	LISTEN
   6626  bc66		       a5 b9		      lda	SY_SA
   6627  bc68		       10 03		      bpl	.3
   6628  bc6a		       4c 3a f3 	      jmp	$f33a
   6629  bc6d
   6630  bc6d				   .3
   6631  bc6d		       20 34 bb 	      jsr	LISTENSA
   6632  bc70		       4c 42 f3 	      jmp	$f342
   6633  bc73
   6634  bc73
   6635  bc73
   6636  bc73
   6637  bc73							;
   6638  bc73							; JIFFY GETIN	  ($032a vector)
   6639  bc73							;
   6640  bc73				   JGetIn     subroutine
   6641  bc73		       a5 99		      lda	$99	;device#
   6642  bc75		       c9 08		      cmp	#8
   6643  bc77		       b0 0c		      bcs	.2
   6644  bc79		       4c f5 f1 	      jmp	$f1f5	;std. GetIn
   6645  bc7c
   6646  bc7c
   6647  bc7c
   6648  bc7c							;
   6649  bc7c							; JIFFY BASIN	  ($0324 vector)
   6650  bc7c							;
   6651  bc7c				   JBasIn
   6652  bc7c		       a5 99		      lda	$99	;device#
   6653  bc7e		       c9 08		      cmp	#8
   6654  bc80		       b0 03		      bcs	.2
   6655  bc82		       4c 0e f2 	      jmp	$f20e	;std. BasIn
   6656  bc85
   6657  bc85				   .2
   6658  bc85		       a5 90		      lda	SY_STATUS
   6659  bc87		       f0 03		      beq	.3
   6660  bc89		       4c 68 f2 	      jmp	$f268	;std. IECIN
   6661  bc8c
   6662  bc8c				   .3
   6663  bc8c		       4c f5 b9 	      jmp	JIF_IECIN
   6664  bc8f
   6665  bc8f
   6666  bc8f
   6667  bc8f
   6668  bc8f							;
   6669  bc8f							; JIFFY BASOUT    ($0326 vector)
   6670  bc8f							;
   6671  bc8f				   JBasOut    subroutine
   6672  bc8f		       48		      pha
   6673  bc90		       a5 9a		      lda	$9a	;device#
   6674  bc92		       c9 08		      cmp	#8
   6675  bc94		       b0 03		      bcs	.2
   6676  bc96		       4c 7b f2 	      jmp	$f27b	;std. BasOut
   6677  bc99
   6678  bc99				   .2
   6679  bc99		       68		      pla
   6680  bc9a		       4c 5b ba 	      jmp	JIF_IECOUT
   6681  bc9d
   6682  bc9d
   6683  bc9d
   6684  bc9d							;
   6685  bc9d							; JIFFY CLRCH / CLRALL    ($0322 / $032c vector)
   6686  bc9d							;
   6687  bc9d				   JClrAll    subroutine
   6688  bc9d		       a9 00		      lda	#0
   6689  bc9f		       85 98		      sta	$98
   6690  bca1
   6691  bca1				   JClrCh
   6692  bca1		       a2 03		      ldx	#3
   6693  bca3		       e4 9a		      cpx	$9a	;device# out
   6694  bca5		       b0 03		      bcs	.1
   6695  bca7		       20 17 bb 	      jsr	JIF_UNLISTEN
   6696  bcaa				   .1
   6697  bcaa		       e4 99		      cpx	$99	;device# in
   6698  bcac		       b0 03		      bcs	.2
   6699  bcae		       20 09 bb 	      jsr	JIF_UNTALK
   6700  bcb1				   .2
   6701  bcb1		       4c 03 f4 	      jmp	$f403	;std. ClrAll
   6702  bcb4
   6703  bcb4
   6704  bcb4
   6705  bcb4
   6706  bcb4
   6707  bcb4							; ==============================================================
   6708  bcb4							; FIRMWARE FLASHER / 29F040 CODE
   6709  bcb4							; ==============================================================
   6710  bcb4
   6711  bcb4		       12 5c	   FLASH_FW_DEST =	4700	;$125c
   6712  bcb4
   6713  bcb4		       02 62	   FLASH_FW_LEN =	(FLASH_FW_END - FLASH_FW_START)
   6714  bcb4
   6715  bcb4
   6716  bcb4				   MOVE_FLASH_FW subroutine
   6717  bcb4		       a9 be		      lda	#<(FLASH_FW_DEST + FLASH_FW_LEN)
   6718  bcb6		       85 58		      sta	$58	; low-byte new end address +1 $0501+fl len
   6719  bcb8		       a9 14		      lda	#>(FLASH_FW_DEST + FLASH_FW_LEN)
   6720  bcba		       85 59		      sta	$59	; high-byte new end address +1 $0501+fl len
   6721  bcbc
   6722  bcbc		       a9 cf		      lda	#<FLASH_FW_START
   6723  bcbe		       85 5f		      sta	$5f	; low-byte start address $a000
   6724  bcc0		       a9 bc		      lda	#>FLASH_FW_START
   6725  bcc2		       85 60		      sta	$60	; high-byte start address $a000
   6726  bcc4
   6727  bcc4		       a9 31		      lda	#<FLASH_FW_END
   6728  bcc6		       85 5a		      sta	$5a	; low-byte end address +1 $a???
   6729  bcc8		       a9 bf		      lda	#>FLASH_FW_END
   6730  bcca		       85 5b		      sta	$5b	; high-byte end address +1 $a???
   6731  bccc
   6732  bccc		       4c bf c3 	      jmp	SY_MOVEMEM	; execute move memory vic routine and return
   6733  bccf
   6734  bccf
   6735  bccf							;FLASH_FW subroutine
   6736  bccf							;  jsr MOVE_FLASH_FW
   6737  bccf							;  jmp FLASHER
   6738  bccf
   6739  bccf
   6740  bccf							; ==============================================================
   6741  bccf							; FLASH CODE / 29F040 CODE
   6742  bccf							; ==============================================================
   6743  bccf
   6744  bccf				   FLASH_FW_START
   6745  bccf					      RORG	FLASH_FW_DEST
   6746  bccf
   6747  bccf				   FLASHER    subroutine
   6748  bccf		       85 ac		      sta	LOADSTART
   6749  bcd1		       84 ad		      sty	LOADSTART +1
   6750  bcd3
   6751  bcd3							;sta $a000				; UNLOCK IO
   6752  bcd3		       a9 20		      lda	#FEMOD_FLASH	; PROG MODE
   6753  bcd5		       8d 02 9c 	      sta	IO_FINAL
   6754  bcd8
   6755  bcd8		       20 ae 13 	      jsr	TestEE
   6756  bcdb		       b0 31		      bcs	.rts
   6757  bcdd
   6758  bcdd		       20 5f 14 	      jsr	BLANK_CHECK
   6759  bce0		       f0 17		      beq	.05
   6760  bce2
   6761  bce2		       20 23 14 	      jsr	FLASH_ERASE
   6762  bce5		       b0 05		      bcs	.err	; ERROR -->
   6763  bce7
   6764  bce7		       20 34 14 	      jsr	BLANK_CHECK_FULL
   6765  bcea		       90 0d		      bcc	.05
   6766  bcec
   6767  bcec				   .err
   6768  bcec		       20 ab 14 	      jsr	FLASH_CROUT
   6769  bcef		       a9 7c		      lda	#<MSG_ERROR
   6770  bcf1		       a0 13		      ldy	#>MSG_ERROR
   6771  bcf3		       20 1e cb 	      jsr	SY_STROUT
   6772  bcf6		       38		      sec
   6773  bcf7		       b0 03		      bcs	.exit
   6774  bcf9
   6775  bcf9				   .05
   6776  bcf9		       20 e2 13 	      jsr	FLASH_FIRMWARE
   6777  bcfc
   6778  bcfc				   .exit
   6779  bcfc		       08		      php
   6780  bcfd		       20 a7 12 	      jsr	FlashCodeEndSequ	; RESET
   6781  bd00
   6782  bd00		       a9 40		      lda	#FEMOD_ROM	; EEP MODE
   6783  bd02		       8d 02 9c 	      sta	IO_FINAL
   6784  bd05		       28		      plp
   6785  bd06		       b0 03		      bcs	.errexit
   6786  bd08		       4c 22 fd 	      jmp	SOFT_RESET
   6787  bd0b
   6788  bd0b				   .errexit
   6789  bd0b		       4c 67 e4 	      jmp	BASIC_WARM
   6790  bd0e
   6791  bd0e				   .rts
   6792  bd0e		       60		      rts
   6793  bd0f
   6794  bd0f
   6795  bd0f							; ==============================================================
   6796  bd0f							; 29F040 SUBS
   6797  bd0f							; ==============================================================
   6798  bd0f
   6799  bd0f		       20 00	   _flashBase =	$2000
   6800  bd0f		       25 55	   _flash555  =	_flashBase + $555
   6801  bd0f		       22 aa	   _flash2aa  =	_flashBase + $2aa
   6802  bd0f
   6803  bd0f		       00 20	   FLASH_ALG_ERROR_BIT =	$20
   6804  bd0f		       00 08	   FLASH_ALG_RUNNING_BIT =	$08
   6805  bd0f
   6806  bd0f
   6807  bd0f				   _flashCodeMagic subroutine
   6808  bd0f		       a9 aa		      lda	#$aa
   6809  bd11		       8d 55 25 	      sta	_flash555
   6810  bd14		       a9 55		      lda	#$55
   6811  bd16		       8d aa 22 	      sta	_flash2aa
   6812  bd19		       60		      rts
   6813  bd1a
   6814  bd1a				   FlashCodeEndSequ subroutine		; RESET
   6815  bd1a				   _flashCodeEndSequ
   6816  bd1a		       a9 f0		      lda	#$f0
   6817  bd1c		       8d 00 20 	      sta	_flashBase
   6818  bd1f		       60		      rts
   6819  bd20
   6820  bd20				   _flashCodeSectorErase subroutine
   6821  bd20		       20 9c 12 	      jsr	_flashCodeMagic
   6822  bd23		       a9 80		      lda	#$80
   6823  bd25		       8d 55 25 	      sta	_flash555
   6824  bd28		       20 9c 12 	      jsr	_flashCodeMagic
   6825  bd2b		       a9 30		      lda	#$30
   6826  bd2d		       8d 00 20 	      sta	_flashBase
   6827  bd30		       60		      rts
   6828  bd31
   6829  bd31				   _flashCodeChipErase subroutine
   6830  bd31		       20 9c 12 	      jsr	_flashCodeMagic
   6831  bd34		       a9 80		      lda	#$80
   6832  bd36		       8d 55 25 	      sta	_flash555
   6833  bd39		       20 9c 12 	      jsr	_flashCodeMagic
   6834  bd3c		       a9 10		      lda	#$10
   6835  bd3e		       8d 55 25 	      sta	_flash555
   6836  bd41		       60		      rts
   6837  bd42
   6838  bd42							;_flashCodeWrite subroutine
   6839  bd42							;  jsr _flashCodeWritePrep
   6840  bd42							;  sta (SAVESTART),y
   6841  bd42							;  rts
   6842  bd42
   6843  bd42
   6844  bd42				   _flashCodeWritePrep subroutine
   6845  bd42		       48		      pha
   6846  bd43		       20 9c 12 	      jsr	_flashCodeMagic
   6847  bd46		       a9 a0		      lda	#$A0
   6848  bd48		       8d 55 25 	      sta	_flash555
   6849  bd4b		       68		      pla
   6850  bd4c		       60		      rts
   6851  bd4d
   6852  bd4d
   6853  bd4d				   _flashCodeCheckProgress subroutine		; TOGGLE CHECK
   6854  bd4d		       48		      pha
   6855  bd4e		       8a		      txa
   6856  bd4f		       48		      pha
   6857  bd50				   _flashCodeCP0
   6858  bd50		       a2 02		      ldx	#2
   6859  bd52				   _flashCodeCP1
   6860  bd52		       ad 00 20 	      lda	_flashBase
   6861  bd55		       cd 00 20 	      cmp	_flashBase
   6862  bd58		       f0 12		      beq	_flashCodeCP2
   6863  bd5a
   6864  bd5a		       29 20		      and	#FLASH_ALG_ERROR_BIT
   6865  bd5c		       f0 f2		      beq	_flashCodeCP0
   6866  bd5e
   6867  bd5e							; ERROR!!
   6868  bd5e		       ad 00 20 	      lda	_flashBase
   6869  bd61		       cd 00 20 	      cmp	_flashBase
   6870  bd64		       f0 09		      beq	_flashCodeCP4
   6871  bd66
   6872  bd66		       20 a7 12 	      jsr	FlashCodeEndSequ	; RESET
   6873  bd69		       38		      sec
   6874  bd6a		       b0 04		      bcs	_flashCodeCPE	; ERROR!
   6875  bd6c
   6876  bd6c				   _flashCodeCP2
   6877  bd6c		       ca		      dex
   6878  bd6d		       d0 e3		      bne	_flashCodeCP1
   6879  bd6f				   _flashCodeCP4
   6880  bd6f		       18		      clc
   6881  bd70				   _flashCodeCPE
   6882  bd70		       68		      pla
   6883  bd71		       aa		      tax
   6884  bd72		       68		      pla
   6885  bd73		       60		      rts
   6886  bd74
   6887  bd74
   6888  bd74							;=============== GET VENDOR/DEVICE ID in X,Y
   6889  bd74				   FlashCodeVendorID subroutine
   6890  bd74		       20 9c 12 	      jsr	_flashCodeMagic
   6891  bd77		       a9 90		      lda	#$90
   6892  bd79		       8d 55 25 	      sta	_flash555
   6893  bd7c		       ae 00 20 	      ldx	_flashBase
   6894  bd7f		       ac 01 20 	      ldy	_flashBase+1
   6895  bd82		       4c a7 12 	      jmp	_flashCodeEndSequ
   6896  bd85
   6897  bd85							;=============== ERASE SECTOR
   6898  bd85				   FlashCodeSectorErase subroutine
   6899  bd85		       20 ad 12 	      jsr	_flashCodeSectorErase
   6900  bd88		       4c da 12 	      jmp	_flashCodeCheckProgress
   6901  bd8b
   6902  bd8b							;=============== FLASH BYTE	AC ==> (SAVESTART)
   6903  bd8b				   FlashCodeWrite subroutine
   6904  bd8b		       20 cf 12 	      jsr	_flashCodeWritePrep
   6905  bd8e		       91 c1		      sta	(SAVESTART),y
   6906  bd90		       4c da 12 	      jmp	_flashCodeCheckProgress
   6907  bd93
   6908  bd93							;=============== SET BANK AND FLASH BYTE    AC ==> (SAVESTART)  C=1:error
   6909  bd93				   FlashCodeWriteXP subroutine
   6910  bd93		       48		      pha
   6911  bd93		       13 22	   __flash_BANK =	. +1
   6912  bd94		       a9 20		      lda	#FEMOD_FLASH
   6913  bd96		       8d 02 9c 	      sta	IO_FINAL
   6914  bd99		       68		      pla
   6915  bd9a		       20 18 13 	      jsr	FlashCodeWrite
   6916  bd9d		       b0 08		      bcs	.exit
   6917  bd9f		       d1 c1		      cmp	(SAVESTART),y
   6918  bda1		       f0 03		      beq	.clc
   6919  bda3		       38		      sec
   6920  bda4		       b0 01		      bcs	.exit
   6921  bda6				   .clc
   6922  bda6		       18		      clc
   6923  bda7				   .exit
   6924  bda7							; lda #FEMOD_RAM +$10			 ;RAM MODUS, BLK-5 PROTECTED
   6925  bda7		       a9 40		      lda	#FEMOD_ROM	;ROM MODUS
   6926  bda9		       8d 02 9c 	      sta	IO_FINAL
   6927  bdac		       60		      rts
   6928  bdad
   6929  bdad
   6930  bdad							;-----------------------
   6931  bdad				   FlashCodeWriteXpInc subroutine
   6932  bdad		       e6 c1		      inc	SAVESTART
   6933  bdaf		       d0 0c		      bne	.exit
   6934  bdb1
   6935  bdb1		       a5 c2		      lda	SAVESTART +1
   6936  bdb3		       20 50 ae 	      jsr	RAMD_INC_PTR
   6937  bdb6		       85 c2		      sta	SAVESTART +1
   6938  bdb8		       90 03		      bcc	.exit
   6939  bdba
   6940  bdba		       ee 22 13 	      inc	__flash_BANK
   6941  bdbd				   .exit
   6942  bdbd		       60		      rts
   6943  bdbe
   6944  bdbe
   6945  bdbe
   6946  bdbe							;------------
   6947  bdbe				   MSG_VENDOR
   6948  bdbe		       12 0d 56 45*	      dc.b	RVSON,13,"VENDOR:",RVSOFF,0
   6949  bdc9				   MSG_DEVICEID
   6950  bdc9		       12 30 31 20*	      dc.b	RVSON,"01  DEVICE:",RVSOFF,0
   6951  bdd7				   MSG_A4
   6952  bdd7		       41 34 0d 00	      dc.b	"A4",13,0
   6953  bddb
   6954  bddb				   MSG_EEE
   6955  bddb		       3f 3f 0d 42*	      dc.b	"??",13,"BAD EEPROM",0
   6956  bde9
   6957  bde9
   6958  bde9
   6959  bde9
   6960  bde9
   6961  bde9
   6962  bde9							; ==============================================================
   6963  bde9							; OPEN FIRMWARE FILE AND FLASH
   6964  bde9							; ==============================================================
   6965  bde9
   6966  bde9				   MSG_ERRFLSH
   6967  bde9		       46 4c 41 53*	      dc.b	"FLASH "
   6968  bdef				   MSG_ERROR
   6969  bdef		       45 52 52 4f*	      dc.b	"ERROR",13,0
   6970  bdf6
   6971  bdf6				   MSG_FLASH
   6972  bdf6		       46 4c 41 53*	      dc.b	"FLASHING ...",13,0
   6973  be04				   MSG_ERASE
   6974  be04		       45 52 41 53*	      dc.b	"ERASING ...",13,0
   6975  be11				   MSG_BLANK
   6976  be11		       42 4c 41 4e*	      dc.b	"BLANK CHECK ...",0
   6977  be21
   6978  be21
   6979  be21
   6980  be21
   6981  be21							; ==============================================================
   6982  be21							; TEST FOR RIGHT EEPROM TYPE
   6983  be21							; ==============================================================
   6984  be21
   6985  be21				   TestEE     subroutine
   6986  be21		       a9 4b		      lda	#<MSG_VENDOR
   6987  be23		       a0 13		      ldy	#>MSG_VENDOR
   6988  be25		       20 1e cb 	      jsr	SY_STROUT
   6989  be28
   6990  be28		       20 01 13 	      jsr	FlashCodeVendorID
   6991  be2b		       98		      tya
   6992  be2c		       48		      pha
   6993  be2d		       e0 01		      cpx	#$01	; AMD
   6994  be2f		       f0 04		      beq	.VENDOROK
   6995  be31		       e0 c2		      cpx	#$c2	; AMD by MX
   6996  be33		       d0 16		      bne	.ERR0
   6997  be35
   6998  be35				   .VENDOROK
   6999  be35		       a9 56		      lda	#<MSG_DEVICEID
   7000  be37		       a0 13		      ldy	#>MSG_DEVICEID
   7001  be39		       20 1e cb 	      jsr	SY_STROUT
   7002  be3c		       68		      pla
   7003  be3d		       aa		      tax
   7004  be3e							;     ldx #$a4
   7005  be3e		       e0 a4		      cpx	#$a4	; 29F040
   7006  be40		       d0 0a		      bne	.ERR1
   7007  be42		       a9 64		      lda	#<MSG_A4
   7008  be44		       a0 13		      ldy	#>MSG_A4
   7009  be46		       20 1e cb 	      jsr	SY_STROUT
   7010  be49
   7011  be49		       18		      clc
   7012  be4a		       60		      rts
   7013  be4b
   7014  be4b				   .ERR0
   7015  be4b		       68		      pla
   7016  be4c				   .ERR1
   7017  be4c		       a9 68		      lda	#<MSG_EEE
   7018  be4e		       a0 13		      ldy	#>MSG_EEE
   7019  be50		       20 1e cb 	      jsr	SY_STROUT
   7020  be53		       38		      sec
   7021  be54		       60		      rts
   7022  be55
   7023  be55
   7024  be55
   7025  be55
   7026  be55
   7027  be55
   7028  be55							; ==============================================================
   7029  be55							; OPEN FIRMWARE FILE AND FLASH
   7030  be55							; ==============================================================
   7031  be55
   7032  be55
   7033  be55				   FLASH_FIRMWARE subroutine
   7034  be55		       a9 83		      lda	#<MSG_FLASH
   7035  be57		       a0 13		      ldy	#>MSG_FLASH
   7036  be59		       20 1e cb 	      jsr	SY_STROUT
   7037  be5c
   7038  be5c		       20 80 14 	      jsr	SET_LOADPTR
   7039  be5f		       20 89 14 	      jsr	SET_SAVEPTR
   7040  be62		       20 f7 13 	      jsr	FLASH_FIRMWARE_2
   7041  be65		       b0 25		      bcs	.rts
   7042  be67		       20 95 14 	      jsr	SET_SAVEPTR_2
   7043  be6a							;ldy #0
   7044  be6a				   FLASH_FIRMWARE_2
   7045  be6a				   .02
   7046  be6a		       a9 80		      lda	#FEMOD_RAM_1	; RAM MODE
   7047  be6c		       8d 02 9c 	      sta	IO_FINAL
   7048  be6f		       b1 c3		      lda	(LOADPTR),y
   7049  be71
   7050  be71		       48		      pha
   7051  be72		       a9 20		      lda	#FEMOD_FLASH	; PROG MODE
   7052  be74		       8d 02 9c 	      sta	IO_FINAL
   7053  be77		       68		      pla
   7054  be78
   7055  be78		       20 18 13 	      jsr	FlashCodeWrite
   7056  be7b		       b0 10		      bcs	.err2
   7057  be7d
   7058  be7d		       d1 c1		      cmp	(SAVESTART),y
   7059  be7f		       d0 0c		      bne	.err2
   7060  be81
   7061  be81		       c8		      iny
   7062  be82		       d0 e6		      bne	.02
   7063  be84		       e6 c2		      inc	SAVESTART +1
   7064  be86		       e6 c4		      inc	LOADPTR +1
   7065  be88		       ca		      dex
   7066  be89		       d0 df		      bne	.02
   7067  be8b		       18		      clc
   7068  be8c				   .rts
   7069  be8c		       60		      rts
   7070  be8d
   7071  be8d
   7072  be8d							;.err
   7073  be8d							;  pla
   7074  be8d							;  pla
   7075  be8d				   .err2
   7076  be8d		       a9 76		      lda	#<MSG_ERRFLSH
   7077  be8f		       a0 13		      ldy	#>MSG_ERRFLSH
   7078  be91		       20 1e cb 	      jsr	SY_STROUT
   7079  be94		       38		      sec
   7080  be95		       60		      rts
   7081  be96
   7082  be96
   7083  be96
   7084  be96							;ERASE CURRENT SECTOR
   7085  be96				   FLASH_ERASE
   7086  be96		       a9 91		      lda	#<MSG_ERASE
   7087  be98		       a0 13		      ldy	#>MSG_ERASE
   7088  be9a		       20 1e cb 	      jsr	SY_STROUT
   7089  be9d		       20 12 13 	      jsr	FlashCodeSectorErase
   7090  bea0		       b0 eb		      bcs	.err2
   7091  bea2		       20 a7 12 	      jsr	FlashCodeEndSequ	; RESET
   7092  bea5		       18		      clc
   7093  bea6		       60		      rts
   7094  bea7
   7095  bea7
   7096  bea7							;BLANK CHECK BANK 1 to 15
   7097  bea7				   BLANK_CHECK_FULL subroutine
   7098  bea7		       a9 20		      lda	#FEMOD_FLASH	; EEP MODE
   7099  bea9				   .2
   7100  bea9		       18		      clc
   7101  beaa		       69 02		      adc	#2
   7102  beac		       8d 02 9c 	      sta	IO_FINAL
   7103  beaf		       29 10		      and	#$10
   7104  beb1		       d0 15		      bne	.e	;BANK 16? -->
   7105  beb3
   7106  beb3		       20 5f 14 	      jsr	BLANK_CHECK
   7107  beb6		       f0 06		      beq	.3
   7108  beb8
   7109  beb8		       20 23 14 	      jsr	FLASH_ERASE
   7110  bebb		       90 06		      bcc	.4
   7111  bebd		       60		      rts
   7112  bebe
   7113  bebe				   .3
   7114  bebe		       a9 91		      lda	#145	;CURSOR UP
   7115  bec0		       20 d2 ff 	      jsr	BSOUT
   7116  bec3				   .4
   7117  bec3		       ad 02 9c 	      lda	IO_FINAL
   7118  bec6		       d0 e1		      bne	.2
   7119  bec8				   .e
   7120  bec8		       a9 40		      lda	#FEMOD_ROM	; EEP MODE
   7121  beca		       8d 02 9c 	      sta	IO_FINAL
   7122  becd		       20 ab 14 	      jsr	FLASH_CROUT
   7123  bed0		       18		      clc
   7124  bed1							;.rts
   7125  bed1		       60		      rts
   7126  bed2
   7127  bed2
   7128  bed2
   7129  bed2							;BLANK CHECK BANK 0
   7130  bed2				   BLANK_CHECK subroutine
   7131  bed2		       a9 9e		      lda	#<MSG_BLANK
   7132  bed4		       a0 13		      ldy	#>MSG_BLANK
   7133  bed6		       20 a2 14 	      jsr	P_BANK
   7134  bed9
   7135  bed9		       20 8f 14 	      jsr	SET_SAVEPTR_1
   7136  bedc		       20 71 14 	      jsr	.BLANK_CHECK
   7137  bedf		       d0 11		      bne	.exit
   7138  bee1
   7139  bee1		       20 95 14 	      jsr	SET_SAVEPTR_2
   7140  bee4				   .BLANK_CHECK
   7141  bee4		       a9 ff		      lda	#$ff
   7142  bee6				   .02
   7143  bee6		       d1 c1		      cmp	(SAVESTART),y
   7144  bee8		       d0 08		      bne	.exit
   7145  beea		       c8		      iny
   7146  beeb		       d0 f9		      bne	.02
   7147  beed		       e6 c2		      inc	SAVESTART +1
   7148  beef		       ca		      dex
   7149  bef0		       d0 f4		      bne	.02
   7150  bef2				   .exit
   7151  bef2		       60		      rts
   7152  bef3
   7153  bef3
   7154  bef3
   7155  bef3				   SET_LOADPTR subroutine
   7156  bef3		       a5 ac		      lda	LOADSTART
   7157  bef5		       85 c3		      sta	LOADPTR
   7158  bef7		       a5 ad		      lda	LOADSTART +1
   7159  bef9		       85 c4		      sta	LOADPTR +1
   7160  befb		       60		      rts
   7161  befc
   7162  befc				   SET_SAVEPTR subroutine
   7163  befc		       a9 70		      lda	#$70	;FIRMWARE START ADDRESS
   7164  befe		       a2 10		      ldx	#16	;BLOCK COUNT
   7165  bf00		       d0 0a		      bne	SET_SAVEPTR_E
   7166  bf02
   7167  bf02				   SET_SAVEPTR_1 subroutine
   7168  bf02		       a9 20		      lda	#$20	;DEFAULT LOW CARTRIDGE ADDRESS
   7169  bf04		       a2 60		      ldx	#96	;BLOCK COUNT
   7170  bf06		       d0 04		      bne	SET_SAVEPTR_E
   7171  bf08
   7172  bf08				   SET_SAVEPTR_2 subroutine
   7173  bf08		       a9 a0		      lda	#$A0	;DEFAULT HI CARTRIDGE ADDRESS
   7174  bf0a		       a2 20		      ldx	#32	;BLOCK COUNT
   7175  bf0c				   SET_SAVEPTR_E
   7176  bf0c		       85 c2		      sta	SAVESTART +1
   7177  bf0e		       a9 00		      lda	#$00	;DEFAULT CARTRIDGE ADDRESS
   7178  bf10		       85 c1		      sta	SAVESTART
   7179  bf12		       a0 00		      ldy	#0
   7180  bf14		       60		      rts
   7181  bf15
   7182  bf15
   7183  bf15				   P_BANK     subroutine
   7184  bf15		       20 1e cb 	      jsr	SY_STROUT
   7185  bf18		       ad 02 9c 	      lda	IO_FINAL
   7186  bf1b		       20 b0 14 	      jsr	FLASH_HEXOUT
   7187  bf1e							;  lda #157				    ;CURSOR LEFT
   7188  bf1e							;  jmp BSOUT
   7189  bf1e				   FLASH_CROUT subroutine
   7190  bf1e		       a9 0d		      lda	#13
   7191  bf20		       4c d2 ff 	      jmp	BSOUT
   7192  bf23
   7193  bf23
   7194  bf23				   FLASH_HEXOUT subroutine
   7195  bf23		       29 0f		      and	#15
   7196  bf25				   .1
   7197  bf25		       18		      clc
   7198  bf26		       69 f6		      adc	#246
   7199  bf28		       90 02		      bcc	.12
   7200  bf2a		       69 06		      adc	#6
   7201  bf2c				   .12
   7202  bf2c		       69 3a		      adc	#58
   7203  bf2e		       4c d2 ff 	      jmp	BSOUT
   7204  bf31
   7205  bf31
   7206  bf31
   7207  bf31					      REND
   7208  bf31				   FLASH_FW_END
   7209  bf31
   7210  bf31
   7211  bf31
   7212  bf31
   7213  bf31							; ==============================================================
   7214  bf31							; DISPLAY STRING    in AC/YR
   7215  bf31							; ==============================================================
   7216  bf31
   7217  bf31				   STROUT     subroutine
   7218  bf31		       85 22		      sta	PT1
   7219  bf33		       84 23		      sty	PT1 +1
   7220  bf35		       a0 00		      ldy	#0
   7221  bf37							;sty 658			       ;Scroll Flag
   7222  bf37							;dey
   7223  bf37				   .1
   7224  bf37		       b1 22		      lda	(PT1),y
   7225  bf39		       f0 06		      beq	.E
   7226  bf3b							;_relo0140 = . +1
   7227  bf3b		       20 d1 b6 	      jsr	CHROUT
   7228  bf3e		       c8		      iny
   7229  bf3f		       d0 f6		      bne	.1
   7230  bf41				   .E
   7231  bf41		       60		      rts
   7232  bf42
   7233  bf42
   7234  bf42
   7235  bf42							; ==============================================================
   7236  bf42							; DISPLAY STRING AT POS   in AC/YR
   7237  bf42							; ==============================================================
   7238  bf42
   7239  bf42				   STR_AT
   7240  bf42		       85 22		      sta	PT1
   7241  bf44		       84 23		      sty	PT1 +1
   7242  bf46		       a0 00		      ldy	#0
   7243  bf48		       b1 22		      lda	(PT1),y
   7244  bf4a		       aa		      tax
   7245  bf4b		       c8		      iny
   7246  bf4c		       b1 22		      lda	(PT1),y
   7247  bf4e		       a8		      tay
   7248  bf4f							;_relo0143 = . +1
   7249  bf4f		       20 65 bf 	      jsr	SET_CURSOR
   7250  bf52		       a0 02		      ldy	#2
   7251  bf54		       d0 e1		      bne	.1
   7252  bf56
   7253  bf56
   7254  bf56							; ==============================================================
   7255  bf56							; DELETE LINE	    XR=Row
   7256  bf56							; ==============================================================
   7257  bf56
   7258  bf56				   DEL_LINE
   7259  bf56		       a0 00		      ldy	#0
   7260  bf58							;_relo0144 = . +1
   7261  bf58		       20 65 bf 	      jsr	SET_CURSOR
   7262  bf5b		       a0 15		      ldy	#21
   7263  bf5d		       a9 20		      lda	#32
   7264  bf5f				   DELI_2
   7265  bf5f		       91 d1		      sta	(C_LINE),y
   7266  bf61		       88		      dey
   7267  bf62		       10 fb		      bpl	DELI_2
   7268  bf64		       60		      rts
   7269  bf65
   7270  bf65
   7271  bf65							; ==============================================================
   7272  bf65							; SET CURSO POS	  XR=Row, YR=Col
   7273  bf65							; ==============================================================
   7274  bf65
   7275  bf65				   SET_CURSOR
   7276  bf65		       18		      clc
   7277  bf66		       4c 0a e5 	      jmp	CURSOR_POS
   7278  bf69
   7279  bf69
   7280  bf69
   7281  bf69							; ==============================================================
   7282  bf69							; STACK PARAM PROCS
   7283  bf69							; ==============================================================
   7284  bf69
   7285  bf69							; PRINT STRING PARAMETER AT RETURN ADDRESS
   7286  bf69				   SPAR_PRINTSTRING
   7287  bf69		       20 9d bf 	      jsr	SPAR_GETPTR
   7288  bf6c				   SPAR_PRINTSTRING_2
   7289  bf6c		       20 b2 bf 	      jsr	STRGET_2
   7290  bf6f		       4c 31 bf 	      jmp	STROUT
   7291  bf72
   7292  bf72
   7293  bf72							; PRINT STRING PARAMETER AT RETURN ADDRESS
   7294  bf72				   SPAR_PRINTSTRING_AT
   7295  bf72		       20 9d bf 	      jsr	SPAR_GETPTR
   7296  bf75				   SPAR_PRAT
   7297  bf75		       a0 02		      ldy	#2
   7298  bf77		       20 b2 bf 	      jsr	STRGET_2
   7299  bf7a		       4c 42 bf 	      jmp	STR_AT
   7300  bf7d
   7301  bf7d
   7302  bf7d							; PRINT MESSAGE, WAIT KEY
   7303  bf7d				   SPAR_MSGBOX
   7304  bf7d		       20 9d bf 	      jsr	SPAR_GETPTR
   7305  bf80		       20 75 bf 	      jsr	SPAR_PRAT
   7306  bf83		       20 e0 a1 	      jsr	WAIT_KEY
   7307  bf86				   SPAR_MSGCLR
   7308  bf86		       a0 00		      ldy	#0
   7309  bf88		       b1 bb		      lda	(PTR_FNAM),y
   7310  bf8a		       aa		      tax
   7311  bf8b		       4c 56 bf 	      jmp	DEL_LINE
   7312  bf8e
   7313  bf8e
   7314  bf8e							; GET STRING
   7315  bf8e				   SPAR_GETSTRING subroutine
   7316  bf8e		       20 9d bf 	      jsr	SPAR_GETPTR
   7317  bf91		       4c b2 bf 	      jmp	STRGET_2
   7318  bf94
   7319  bf94
   7320  bf94							; SEND DISK COMMAND
   7321  bf94				   SPAR_DISKCMD subroutine
   7322  bf94		       20 9d bf 	      jsr	SPAR_GETPTR
   7323  bf97		       20 b2 bf 	      jsr	STRGET_2
   7324  bf9a		       4c 3a b5 	      jmp	DISK_CMD_2
   7325  bf9d
   7326  bf9d
   7327  bf9d							; GET POINTER TO PARAMETER AT RETURN ADDRESS
   7328  bf9d				   SPAR_GETPTR subroutine
   7329  bf9d		       ba		      tsx
   7330  bf9e		       bd 03 01 	      lda	STACK +3,x
   7331  bfa1		       18		      clc
   7332  bfa2		       69 01		      adc	#1
   7333  bfa4		       85 bb		      sta	PTR_FNAM
   7334  bfa6		       bd 04 01 	      lda	STACK +4,x
   7335  bfa9		       69 00		      adc	#0
   7336  bfab		       85 bc		      sta	PTR_FNAM+1
   7337  bfad		       a0 00		      ldy	#0
   7338  bfaf		       60		      rts
   7339  bfb0
   7340  bfb0
   7341  bfb0							; ADD OFFSET +1 TO RETURN ADDRESS
   7342  bfb0				   STRGET
   7343  bfb0		       a0 00		      ldy	#0
   7344  bfb2				   STRGET_2
   7345  bfb2		       20 ce bf 	      jsr	STRLEN_2
   7346  bfb5		       c8		      iny
   7347  bfb6				   MEMGET
   7348  bfb6		       98		      tya
   7349  bfb7				   MEMGET_2
   7350  bfb7							;dex
   7351  bfb7							;dex
   7352  bfb7		       20 bf bf 	      jsr	SPAR_ADD
   7353  bfba		       a5 bb		      lda	PTR_FNAM
   7354  bfbc		       a4 bc		      ldy	PTR_FNAM +1
   7355  bfbe		       60		      rts
   7356  bfbf
   7357  bfbf
   7358  bfbf							; ADD OFFSET +1 TO RETURN ADDRESS
   7359  bfbf				   SPAR_ADD
   7360  bfbf		       18		      clc
   7361  bfc0		       7d 03 01 	      adc	STACK +3,x
   7362  bfc3		       9d 03 01 	      sta	STACK +3,x
   7363  bfc6		       90 03		      bcc	SPAD_0
   7364  bfc8		       fe 04 01 	      inc	STACK +4,x
   7365  bfcb				   SPAD_0
   7366  bfcb		       60		      rts
   7367  bfcc
   7368  bfcc							; GET STRING LEN IN YR
   7369  bfcc				   STRLEN
   7370  bfcc		       a0 00		      ldy	#0
   7371  bfce				   STRLEN_2
   7372  bfce				   STLE_0
   7373  bfce		       b1 bb		      lda	(PTR_FNAM),y
   7374  bfd0		       f0 03		      beq	STLE_E
   7375  bfd2		       c8		      iny
   7376  bfd3		       d0 f9		      bne	STLE_0
   7377  bfd5				   STLE_E
   7378  bfd5		       84 b7		      sty	LEN_FNAM
   7379  bfd7		       60		      rts
   7380  bfd8
   7381  bfd8
   7382  bfd8							; PRINT STRING IN PTR_FNAM
   7383  bfd8				   STRNOUT
   7384  bfd8		       a0 00		      ldy	#0
   7385  bfda		       a6 b7		      ldx	LEN_FNAM
   7386  bfdc				   STNO_0
   7387  bfdc		       b1 bb		      lda	(PTR_FNAM),y
   7388  bfde		       f0 07		      beq	STNO_E
   7389  bfe0		       20 d1 b6 	      jsr	CHROUT
   7390  bfe3		       c8		      iny
   7391  bfe4		       ca		      dex
   7392  bfe5		       d0 f5		      bne	STNO_0
   7393  bfe7				   STNO_E
   7394  bfe7		       60		      rts
   7395  bfe8
   7396  bfe8
   7397  bfe8
   7398  bfe8
   7399  bfe8
   7400  bfe8
   7401  bfe8
   7402  bfe8
   7403  bfe8
   7404  bfe8
   7405  bfe8
   7406  bfff					      org	$bfff
   7407  bfff		       00		      dc.b	#$00
