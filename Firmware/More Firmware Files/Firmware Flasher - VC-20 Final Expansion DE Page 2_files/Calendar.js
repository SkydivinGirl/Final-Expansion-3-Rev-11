var Calendar={};Calendar.Event={},Calendar.Event.Coordinates={},Calendar.Event.Coordinates.PreSubmitHandler=Class.extend({_form:null,_locationInput:null,init:function(e){this._locationInput=e,this._form=$("#messageContainer").submit($.proxy(this._submit,this))},_submit:function(e){if(this._form.data("geocodingCompleted"))return!0;if(!$("#enableCoordinates").is(":checked"))return!0;var t=$.trim($("#geocode").val());return t?void this._setCoordinates():(WCF.Location.GoogleMaps.Util.reverseGeocoding($.proxy(this._reverseGeocoding,this),this._locationInput.getMarker()),e.preventDefault(),!1)},_reverseGeocoding:function(e){null===e?$("#enableCoordinates").prop("checked",!1):$("#geocode").val(e),this._setCoordinates(),this._form.trigger("submit")},_setCoordinates:function(){var e=this._form.find(".formSubmit");$('<input type="hidden" name="latitude" value="'+this._locationInput.getMarker().getPosition().lat()+'" />').appendTo(e),$('<input type="hidden" name="longitude" value="'+this._locationInput.getMarker().getPosition().lng()+'" />').appendTo(e),this._form.data("geocodingCompleted",!0)}}),Calendar.Event.Preview=WCF.Popover.extend({_proxy:null,init:function(){this._super(".calendarEventLink"),this._proxy=new WCF.Action.Proxy({showLoadingOverlay:!1}),WCF.DOMNodeInsertedHandler.addCallback("Calendar.Event.Preview",$.proxy(this._initContainers,this))},_loadContent:function(){var e=$("#"+this._activeElementID);this._proxy.setOption("data",{actionName:"getEventPreview",className:"calendar\\data\\event\\date\\EventDateAction",objectIDs:[e.data("eventDateID")]});var t=this._activeElementID,a=this;this._proxy.setOption("success",function(e){a._insertContent(t,e.returnValues.template,!0)}),this._proxy.sendRequest()}}),Calendar.Event.Share=WCF.Message.Share.Content.extend({_eventDateID:0,init:function(e){this._eventDateID=e,this._super()},_click:function(e){e.preventDefault();var t=$(e.currentTarget),a=t.prop("href"),i=t.data("linkTitle")?t.data("linkTitle"):a,n=a.hashCode();if(void 0===this._cache[n]){var s=!1;null===this._dialog?(this._dialog=$("<div />").hide().appendTo(document.body),s=!0):this._dialog.empty();var o=$('<fieldset><legend><label for="__sharePermalink">'+WCF.Language.get("wcf.message.share.permalink")+"</label></legend></fieldset>").appendTo(this._dialog);$('<input type="text" id="__sharePermalink" class="long" readonly="readonly" />').attr("value",a).appendTo(o);var o=$('<fieldset><legend><label for="__shareBBCode">'+WCF.Language.get("wcf.message.share.permalink.bbcode")+"</label></legend></fieldset>").appendTo(this._dialog);$('<input type="text" id="__shareBBCode" class="long" readonly="readonly" />').attr("value","[event]"+this._eventDateID+"[/event]").appendTo(o);var o=$('<fieldset><legend><label for="__sharePermalinkHTML">'+WCF.Language.get("wcf.message.share.permalink.html")+"</label></legend></fieldset>").appendTo(this._dialog);$('<input type="text" id="__sharePermalinkHTML" class="long" readonly="readonly" />').attr("value",'<a href="'+a+'">'+WCF.String.escapeHTML(i)+"</a>").appendTo(o),this._cache[n]=this._dialog.html(),this._dialog.wcfDialog(s?{title:WCF.Language.get("wcf.message.share")}:"open")}else this._dialog.html(this._cache[n]).wcfDialog("open");this._enableSelection()}}),Calendar.Event.Date={},Calendar.Event.Date.FullDay=Class.extend({_date:{end:"",start:""},_time:{end:"",start:""},_input:{end:null,start:null},_timezone:null,_isFullDay:null,init:function(){this._date={end:"",start:""},this._time={end:"",start:""},this._timezone=null,this._isFullDay=$("#isFullDay").change($.proxy(this._change,this)),this._input={end:$("#endTime"),start:$("#startTime")},this._change(null,!0)},_change:function(e,t){if(null===this._timezone){var a=this._input.end.datepicker("getDate").getTimezoneOffset();this._timezone=0>a?"+":"-",a=Math.abs(a);var i=Math.floor(a/60).toString(),n=(a%60).toString();1===i.length&&(i="0"+i),1===n.length&&(n="0"+n),this._timezone+=i+":"+n}this._isFullDay.is(":checked")?(this._toggle("end",!1),this._toggle("start",!1)):t!==!0?(this._toggle("end",!0),this._toggle("start",!0)):t&&this._bindOnClose(),this._isFullDay.is(":checked")?$("#timezone").parents("dl").hide():$("#timezone").parents("dl").show()},_toggle:function(e,t){var a=this._input[e].data("datepicker"),i=this._input[e].datepicker("getDate"),n=(a.selectedMonth+1).toString();1===n.length&&(n="0"+n);var s=a.selectedDay.toString();if(1===s.length&&(s="0"+s),this._date[e]=a.selectedYear+"-"+n+"-"+s,!t){var o=i.getHours().toString();1===o.length&&(o="0"+o);var r=i.getMinutes().toString();1===r.length&&(r="0"+r),this._time[e]=o+":"+r+":00"}var l=this._date[e];t&&(l+="T"+this._time[e]+this._timezone),this._input[e].datepicker("destroy").val(l).attr("type","date"+(t?"time":"")).removeClass("jsDatePicker"),WCF.DOMNodeInsertedHandler.execute(),"start"==e&&this._bindOnClose()},_bindOnClose:function(){var e=this._input.start.datepicker("option","onClose"),t=this;this._input.start.datepicker("option","onClose",function(a,i){var n=new Date(t._input.start.datepicker("getDate")).getTime(),s=new Date(t._input.end.datepicker("getDate")).getTime();n>s&&t._input.end.datepicker("setDate",new Date(n+36e5)),e(a,i)})}}),Calendar.Event.Date.Participation={},Calendar.Event.Date.Participation.Manager=Class.extend({_comment:"",_companions:0,_decision:"",_dialog:null,_event:{maxCompanions:0,maxParticipants:0,participationIsChangeable:0},_eventDate:{participants:0},_eventDateID:0,_eventDateParticipation:{decision:"",companions:0},_proxy:null,_ui:{container:{companions:null,decision:null,message:null},element:{companions:null,decision:null,message:null}},init:function(e){this._comment="",this._companions=0,this._decision="",this._event={maxCompanions:0,maxParticipants:0,participationIsChangeable:0},this._eventDate={participants:0},this._eventDateID=e,this._eventDateParticipation={companions:0,decision:""},this._proxy=new WCF.Action.Proxy({failure:$.proxy(this._failure,this),success:$.proxy(this._success,this)}),this._ui={container:{companions:null,decision:null,message:null},element:{companions:null,decision:null,inviteUsernames:null,inviteUserGroup:null,message:null}},$(".jsCalendarButtonParticipation").click($.proxy(this._click,this))},_click:function(){this._proxy.setOption("data",{actionName:"getParticipationForm",className:"calendar\\data\\event\\date\\EventDateAction",objectIDs:[this._eventDateID]}),this._proxy.sendRequest()},_success:function(e){switch(e.actionName){case"getParticipationForm":this._initDialog(e);break;case"save":$("#calendarParticipationContainer").html(e.returnValues.template),(new WCF.System.Notification).show(),this._dialog.wcfDialog("close")}},_failure:function(e){if(null===e||null===this._dialog||void 0===e.returnValues||void 0===e.returnValues.fieldName)return!0;switch(e.returnValues.fieldName){case"username":$('<small class="innerError">'+e.returnValues.errorType+"</small>").insertAfter($("#eventDateParticipationUsernameSearchField"));break;case"invitedUsernames":$('<small class="innerError">'+e.returnValues.errorType+"</small>").appendTo(this._ui.element.inviteUsernames.parents("dd"))}return!1},_initDialog:function(e){var t=!1;null===this._dialog?(this._dialog=$("<div />").html(e.returnValues.template).hide().appendTo(document.body),t=!0):this._dialog.html(e.returnValues.template),this._ui={container:{companions:$("#eventDateParticipationCompanionsContainer"),decision:$("#eventDateParticipationDecisionContainer"),message:$("#eventDateParticipationMessageContainer")},element:{companions:$("#eventDateParticipationCompanions"),decision:$("#eventDateParticipationDecision"),inviteUsernames:$("#eventDateInviteUsernames"),inviteUserGroup:$("#eventDateInviteUserGroup"),message:$("#eventDateParticipationMessage")}},$('<div class="formSubmit"><button>'+WCF.Language.get("wcf.global.button.submit")+"</button></div>").appendTo(this._dialog),this._dialog.find("button").click($.proxy(this._submit,this)),this._event={maxCompanions:parseInt(e.returnValues.event.maxCompanions),maxParticipants:parseInt(e.returnValues.event.maxParticipants),participationIsChangeable:parseInt(e.returnValues.event.participationIsChangeable)},this._eventDate={participants:parseInt(e.returnValues.eventDate.participants)},this._eventDateParticipation={companions:e.returnValues.participation?Math.max(e.returnValues.participation.participants-1,0):0,decision:e.returnValues.participation?e.returnValues.participation.decision:""},this._companions=this._eventDateParticipation.companions,this._decision=this._eventDateParticipation.decision,this._message=e.returnValues.participation?e.returnValues.participation.message:"";var a=this._event.maxParticipants-this._eventDate.participants-this._companions;this._event.maxParticipants||(a=999);var i=Math.max(Math.min(this._event.maxCompanions,a),this._eventDateParticipation.companions);if(this._ui.element.companions.val(this._companions).prop("max",i),this._ui.element.decision.val(this._decision),this._ui.element.message.val(this._message),this._event.participationIsChangeable||"yes"!=this._decision)this._ui.element.companions.blur($.proxy(this._validateCompanions,this)),this._ui.element.decision.change($.proxy(this._updateDecision,this));else{$("<small>"+WCF.Language.get("calendar.event.date.participation.notChangeable")+"</small>").insertAfter(this._ui.element.companions),$("<small>"+WCF.Language.get("calendar.event.date.participation.notChangeable")+"</small>").insertAfter(this._ui.element.decision);var n=this._ui.element.decision.children("option:checked").text();this._ui.element.decision.replaceWith(n),this._ui.element.companions.replaceWith(this._companions)}this._dialog.wcfDialog(t?{title:WCF.Language.get("calendar.event.date.participation")}:"open"),this._updateDecision(),$(window).trigger("resize")},_updateDecision:function(){switch(this._decision=this._ui.element.decision.val(),this._ui.container.companions.hide(),this._ui.container.message.hide(),this._decision){case"yes":this._event.maxCompanions&&this._ui.container.companions.show(),this._ui.container.message.show();break;case"maybe":this._event.maxCompanions&&this._ui.container.companions.show()}this._dialog.wcfDialog("render")},_submit:function(){this._validate(),this._dialog.find("small.innerError").remove();var e="";1==this._dialog.find("input[name=eventDateParticipationUsername]:checked").val()&&(e=$.trim($("#eventDateParticipationUsernameSearchField").val())),this._proxy.setOption("data",{actionName:"save",className:"calendar\\data\\event\\date\\EventDateAction",objectIDs:[this._eventDateID],parameters:{companions:this._ui.element.companions.val(),decision:this._ui.element.decision.val(),invitedUsernames:this._ui.element.inviteUsernames.val(),inviteUserGroup:this._ui.element.inviteUserGroup.val(),message:$.trim(this._ui.element.message.val()),username:e}}),this._proxy.sendRequest()},_validateCompanions:function(){var e=parseInt(this._ui.element.companions.prop("max")),t=parseInt(this._ui.element.companions.val()),a=this._ui.element.companions.parent();t>e?(a.children("small.innerError").remove(),$('<small class="innerError">'+WCF.Language.get("calendar.event.date.participation.companions.error.exceededMaxCompanions")+"</small>").appendTo(a),a.parent().addClass("formError")):(0>t&&this._ui.element.companions.val(0),a.children("small.innerError").remove(),a.parent().removeClass("formError"))},_validate:function(){var e=this._ui.element.decision.val();if("yes"===e||"maybe"===e){var t=parseInt(this._ui.element.companions.prop("max"));t<parseInt(this._ui.element.companions.val())&&this._ui.element.companions.val(t)}else this._ui.element.companions.val(0);"yes"!==e&&this._ui.element.message.val("")}}),Calendar.Event.Date.Participation.RemoveParticipant=WCF.Action.Delete.extend({init:function(){this._super("calendar\\data\\event\\date\\participation\\EventDateParticipationAction",".jsParticipant")},_sendRequest:function(e){this.proxy.setOption("data",{actionName:"removeParticipant",className:this._className,objectIDs:[$(e).data("objectID")]}),this.proxy.sendRequest()},_success:function(e){var t=e.returnValues.participationID;for(var a in this._containers){var i=$("#"+this._containers[a]);if(i.find(".jsDeleteButton").data("objectID")==t){var n=i.parent();if(i.remove(),!n.children("li").length){var s=n.parents("fieldset");n=s.parent(),s.remove(),n.children("fieldset").length||n.remove()}}}}}),Calendar.Event.InlineEditor=WCF.InlineEditor.extend({_redirectURL:"",setRedirectURL:function(e){this._redirectURL=e},_setOptions:function(){this._options=[{label:WCF.Language.get("calendar.event.enable"),optionName:"enable"},{label:WCF.Language.get("calendar.event.disable"),optionName:"disable"},{label:WCF.Language.get("calendar.event.trash"),optionName:"trash"},{label:WCF.Language.get("calendar.event.restore"),optionName:"restore"},{label:WCF.Language.get("calendar.event.delete"),optionName:"delete"},{optionName:"divider"},{label:WCF.Language.get("calendar.event.setAsFeatured"),optionName:"setAsFeatured"},{label:WCF.Language.get("calendar.event.unsetAsFeatured"),optionName:"unsetAsFeatured"},{optionName:"divider"},{label:WCF.Language.get("wcf.global.button.edit"),optionName:"edit",isQuickOption:!0}]},_show:function(e){var t=$(e.currentTarget).data("elementID"),a=null;if(this._dropdowns[t]||(a=this._getTriggerElement(this._elements[t]).addClass("dropdownToggle").parent().addClass("dropdown").end(),this._dropdowns[t]=$('<ul class="dropdownMenu" />').insertAfter(a)),this._super(e),null!==a){WCF.Dropdown.initDropdown(a,!0);var i=a.parent().wcfIdentify();WCF.Dropdown.registerCallback(i,$.proxy(this._toggleDropdown,this)),this._toggleDropdown(i,"open")}return!1},_toggleDropdown:function(e){WCF.Dropdown.getDropdown(e).parents(".messageOptions").toggleClass("forceOpen")},_getTriggerElement:function(e){return e.find(".jsButtonEventInlineEditor")},_validate:function(e,t){var a=$("#"+e);switch(t){case"delete":if(!a.data("canDeleteEvent"))return!1;if(a.data("isDeleted"))return!0;break;case"restore":if(!a.data("canRestoreEvent"))return!1;if(a.data("isDeleted"))return!0;break;case"trash":if(!a.data("canTrashEvent"))return!1;if(!a.data("isDeleted"))return!0;break;case"enable":case"disable":return a.data("canModerateEvent")?a.data("isDeleted")?!1:a.data("isDisabled")?"enable"===t:"disable"===t:!1;case"setAsFeatured":return a.data("canSetAsFeatured")?a.data("isFeatured")?!1:!0:!1;case"unsetAsFeatured":return a.data("canSetAsFeatured")&&a.data("isFeatured")?!0:!1;case"edit":return a.data("canEditEvent")?!0:!1}return!1},_execute:function(e,t){if(!this._validate(e,t))return!1;switch(t){case"disable":case"enable":this._updateEvent(e,t,{isDisabled:"enable"===t?0:1});break;case"delete":var a=this;WCF.System.Confirmation.show(WCF.Language.get("calendar.event.delete.confirmMessage"),function(i){"confirm"===i&&a._updateEvent(e,t,{deleted:1})});break;case"setAsFeatured":case"unsetAsFeatured":this._updateEvent(e,t,{isFeatured:"setAsFeatured"===t?1:0});break;case"edit":window.location=this._getTriggerElement($("#"+e)).prop("href");break;case"restore":this._updateEvent(e,t,{isDeleted:0});break;case"trash":var a=this;WCF.System.Confirmation.show(WCF.Language.get("calendar.event.trash.confirmMessage"),function(i){"confirm"===i&&a._updateEvent(e,t,{isDeleted:1,reason:$("#wcfSystemConfirmationContent").find("textarea").val()})},{},$("<fieldset><dl><dt>"+WCF.Language.get("calendar.event.trash.reason")+'</dt><dd><textarea cols="40" rows="4" /></dd></dl></fieldset>'))}},_updateEvent:function(e,t,a){if("delete"===t){var i=this,n=this._elements[e].data("objectID");new WCF.Action.Proxy({autoSend:!0,data:{actionName:"delete",className:"calendar\\data\\event\\EventAction",objectIDs:[n]},success:function(){i._redirectURL?window.location=i._redirectURL:window.location.reload()}})}else this._updateData.push({data:a,elementID:e,optionName:t}),this._proxy.setOption("data",{actionName:t,className:"calendar\\data\\event\\EventAction",objectIDs:[this._elements[e].data("objectID")],parameters:{data:a}}),this._proxy.sendRequest()},_updateState:function(){if(1==this._updateData.length&&"trash"==this._updateData[0].optionName&&!this._elements[this._updateData[0].elementID].data("canViewDeletedEvent"))return void this._notification.show($.proxy(function(){window.location=this._redirectURL},this));this._notification.show();for(var e=0,t=this._updateData.length;t>e;e++){var a=this._updateData[e],i=$("#"+a.elementID);switch(a.optionName){case"disable":case"enable":i.toggleClass("messageDisabled").data("isDisabled",a.data.isDisabled);break;case"restore":case"trash":i.toggleClass("messageDeleted").data("isDeleted",a.data.isDeleted);break;case"setAsFeatured":var n=$('<span class="badge label green jsLabelFeatured">'+WCF.Language.get("calendar.event.featured")+"</span>");$("#content > header.boxHeadline > h1").prepend(n),n.after(" "),i.data("isFeatured",1);break;case"unsetAsFeatured":i.data("isFeatured",0),$("#content > header.boxHeadline > h1 > .jsLabelFeatured").remove()}}}}),Calendar.Event.Like=WCF.Like.extend({_getContainers:function(){return $("article")},_getObjectID:function(e){return this._containers[e].data("objectID")},_getWidgetContainer:function(e){return this._containers[e].find(".messageHeader")},_buildWidget:function(e,t,a,i,n){var s=this._getWidgetContainer(e);if(this._canLike){var o=this._containers[e].find(".smallButtons");t.insertBefore(o.find(".toTopLink")),a.insertBefore(o.find(".toTopLink")),a.find("a").addClass("button"),t.find("a").addClass("button")}n&&(n.appendTo(this._containers[e].find(".messageBody > .messageFooter")),n.addClass("messageFooterNote")),s.find(".permalink").after(i)},_setActiveState:function(e,t,a){e=e.find(".button").removeClass("active"),t=t.find(".button").removeClass("active"),1==a?e.addClass("active"):-1==a&&t.addClass("active")},_addWidget:function(){}}),Calendar.Event.TabMenu={selectErroneousTab:function(){$(".tabMenuContent").each(function(e,t){var a=$(t);return a.find(".formError").length?(a.parents(".tabMenuContainer").wcfTabs("selectTab",a.wcfIdentify()),!1):void 0})}},Calendar.Event.QuoteHandler=WCF.Message.Quote.Handler.extend({init:function(e){this._super(e,"calendar\\data\\event\\EventAction","com.woltlab.calendar.event",".message",".messageBody",".messageBody > div > div.messageText")}}),Calendar.Event.List=Class.extend({_cache:{},_dialog:null,_proxy:null,_titles:{},init:function(){this._dialog=null,this._cache={},this._titles={},$(".jsCalendarDay").click($.proxy(this._click,this)),this._proxy=new WCF.Action.Proxy({success:$.proxy(this._success,this)})},_click:function(e){var t=$(e.currentTarget),a=t.data("date");this._cache[a]?this._render(a):(this._titles[a]=t.data("overlayTitle"),this._proxy.setOption("data",{actionName:"getEventList",className:"calendar\\data\\event\\date\\EventDateAction",parameters:{date:a}}),this._proxy.sendRequest())},_render:function(e){null===this._dialog?(this._dialog=$("<div />").hide().appendTo(document.body),this._dialog.html(this._cache[e]).wcfDialog({title:this._titles[e]})):(this._dialog.html(this._cache[e]),this._dialog.wcfDialog("option","title",this._titles[e]),this._dialog.wcfDialog("open"),this._dialog.wcfDialog("render"))},_success:function(e){this._cache[e.returnValues.date]=e.returnValues.template,this._render(e.returnValues.date)}}),Calendar.Export={},Calendar.Export.iCal=Class.extend({_dialog:null,init:function(){this._dialog=null,$(".jsCalendarExport").click(this._click.bind(this))},_click:function(e){e.preventDefault();var t=$(e.currentTarget);if(null===this._dialog){this._dialog=$("<div />");var a=$('<dl class="condensed"><dt><label for="calendarExportURL">'+WCF.Language.get("calendar.category.export.url")+'</label></dt><dd><input type="text" id="calendarExportURL" class="long" readonly="readonly" /><small>'+WCF.Language.get("calendar.category.export.url.description")+"</small></dd></dl>"),i=a.find("input").val(t.attr("href"));i.click(function(){$(this).select()}),navigator.userAgent.match(/iP(ad|hone|od)/)&&i.keydown(function(){return!1}).removeAttr("readonly").click(function(){this.setSelectionRange(0,9999)}),a.appendTo(this._dialog),$('<div class="formSubmit"><a href="'+t.attr("href")+'" class="button">'+WCF.Language.get("calendar.category.export.download")+"</a></div>").appendTo(this._dialog),this._dialog.appendTo(document.body),this._dialog.wcfDialog({title:t.data("tooltip")})}else this._dialog.wcfDialog("open")}}),Calendar.UI={},Calendar.UI.Calendar={_listItems:null,init:function(){this._listItems=$(".calendarFullMonthView > .calendarWeeks > li"),enquire.register("screen and (max-width: 800px)",{match:$.proxy(this._enable,this),unmatch:$.proxy(this._disable,this)})},_enable:function(){this._listItems.each(function(e,t){var a=$(t);a.children("div").each(function(e,t){var i=$(t);i.data("__originalValue",i.text()),i.text(i.prop("title")),i.click(function(){a.toggleClass("open")})}),a.find("> .calendarWeekDays > li > h3").each(function(e,t){var a=$(t);a.data("__originalValue",a.text()),a.find("a").text(a.data("fullDay"))}),1==a.find(".calendarToday").length&&a.addClass("open")})},_disable:function(){this._listItems.each(function(e,t){var a=$(t).removeClass("open");a.children("div").each(function(e,t){var a=$(t);a.text(a.data("__originalValue")).off("click")}),a.find("> .calendarWeekDays > li > h3").each(function(e,t){var a=$(t);a.find("a").text(a.data("__originalValue"))})})}},Calendar.Map={},Calendar.Map.LargeMap=WCF.Location.GoogleMaps.LargeMap.extend({_success:function(e){if(e.returnValues&&e.returnValues.markers)for(var t=0,a=e.returnValues.markers.length;a>t;t++){var i=e.returnValues.markers[t];this.addMarker(i.latitude,i.longitude,i.title,null,i.infoWindow,i.dialog,i.location),i.objectID?this._objectIDs.push(i.objectID):i.objectIDs&&(this._objectIDs=this._objectIDs.concat(i.objectIDs))}},addMarker:function(e,t,a,i,n,s,o){var r=$(n).get(0),l=this._super(e,t,a,i,r);return s&&google.maps.event.addListener(l.infoWindow,"domready",$.proxy(function(){new Calendar.Map.InfoWindowEventListDialog($(r).find(".jsCalendarLocationDialogEventListButton"),s,o)},this)),l.infoWindow}}),Calendar.Map.InfoWindowEventListDialog=Class.extend({_dialog:null,_dialogContent:"",_eventData:[],init:function(e,t,a){this._dialogContent=t,this._location=a,e.click($.proxy(this._click,this))},_click:function(){null===this._dialog?this._dialog=$("<div />").append(this._dialogContent).hide().appendTo(document.body).wcfDialog({title:WCF.Language.get(this._location)}):this._dialog.wcfDialog("open")}});