var Gallery={};!function(){for(var e=0,t=["ms","moz","webkit","o"],a=0;a<t.length&&!window.requestAnimationFrame;++a)window.requestAnimationFrame=window[t[a]+"RequestAnimationFrame"],window.cancelRequestAnimationFrame=window[t[a]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t){var a=(new Date).getTime(),i=Math.max(0,16-(a-e)),s=window.setTimeout(function(){t(a+i)},i);return e=a+i,s}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}(),Gallery.Album={},Gallery.Album.Dialog=Class.extend({_createdCallbacks:[],_descriptionError:null,_dialog:null,_dialogContainer:null,_saveCallbacks:[],_proxy:null,_titleError:null,_updatedCallbacks:[],_validationCallbacks:[],init:function(){this._proxy=new WCF.Action.Proxy({success:$.proxy(this._success,this)})},_cancel:function(){this._dialogContainer.wcfDialog("close")},_hideDescriptionError:function(){this._descriptionError&&(this._descriptionError.hide(),this._dialog.find('textarea[name="description"]').parents("dl").removeClass("formError"))},_hideTitleError:function(){this._titleError&&(this._titleError.hide(),this._dialog.find('input[name="title"]').parents("dl").removeClass("formError"))},_save:function(){var e=!1,t=this._dialog.find('input[name="title"]').val();t.length?t.length>255?(e=!0,this._showTitleError(WCF.Language.get("gallery.album.title.error.tooLong"))):this._hideTitleError():(e=!0,this._showTitleError(WCF.Language.get("wcf.global.form.error.empty")));var a=this._dialog.find('textarea[name="description"]').val();a.length>65535?(e=!0,this._showDescriptionError(WCF.Language.get("gallery.album.description.error.tooLong"))):this._hideDescriptionError();for(var i in this._validationCallbacks)this._validationCallbacks[i](this._dialogContainer)||(e=!0);if(!e){this._dialogContainer.find("button").disable();var s={accessLevel:this._dialog.find('select[name="accessLevel"] > option:selected').val()||0,description:a,title:t};for(var i in this._saveCallbacks)s=this._saveCallbacks[i](s);this._dialogContainer.data("albumID")?this._proxy.setOption("data",{actionName:"update",className:"gallery\\data\\album\\AlbumAction",objectIDs:[this._dialogContainer.data("albumID")],parameters:{data:s}}):this._proxy.setOption("data",{actionName:"create",className:"gallery\\data\\album\\AlbumAction",parameters:{data:s}}),this._proxy.sendRequest()}},_showDialog:function(e,t){if(null===this._dialog){this._dialogContainer=$('<div id="albumDialog" />').data("__api",this).appendTo(document.body),this._dialog=$("<div />").appendTo(this._dialogContainer);var a=$('<div class="formSubmit" />').appendTo(this._dialogContainer),i=$('<button class="buttonPrimary">'+WCF.Language.get("wcf.global.button.save")+"</button>").appendTo(a),s=$("<button>"+WCF.Language.get("wcf.global.button.cancel")+"</button>").appendTo(a);s.click($.proxy(this._cancel,this)),i.click($.proxy(this._save,this))}else this._dialogContainer.find("button").enable();this._dialogContainer.data("albumID",t),this._dialog.html(e),this._dialogContainer.wcfDialog({title:WCF.Language.get(t?"gallery.album.edit":"gallery.album.add")}),this._dialogContainer.wcfDialog("render"),this._dialog.find('input[name="title"]').focus()},_showDescriptionError:function(e){null===this._descriptionError&&(this._descriptionError=$('<small class="innerError" />').hide(),this._dialog.find('textarea[name="description"]').after(this._descriptionError),this._dialog.find('textarea[name="description"]').parents("dl").addClass("formError")),this._descriptionError.show().text(e)},_showTitleError:function(e){null===this._titleError&&(this._titleError=$('<small class="innerError" />').hide(),this._dialog.find('input[name="title"]').after(this._titleError),this._dialog.find('input[name="title"]').parents("dl").addClass("formError")),this._titleError.show().text(e)},_success:function(e){switch(e.actionName){case"create":this._cancel(),(new WCF.System.Notification).show();for(var t in this._createdCallbacks)this._createdCallbacks[t](e.returnValues);break;case"getDialog":this._showDialog(e.returnValues.template,e.returnValues.albumID);break;case"update":this._cancel(),(new WCF.System.Notification).show();for(var t in this._updatedCallbacks)this._updatedCallbacks[t](this._dialogContainer)}},registerCallback:function(e,t){if("created"!=e&&"save"!=e&&"updated"!=e&&"validate"!=e)return void console.debug('[Gallery.Album.Dialog] Unknown event "'+e+'"');if(!$.isFunction(t))return void console.debug("[Gallery.Album.Dialog] Given callback is invalid.");switch(e){case"created":this._createdCallbacks.push(t);break;case"updated":this._updatedCallbacks.push(t);break;case"save":this._saveCallbacks.push(t);break;case"validate":this._validationCallbacks.push(t)}},show:function(e){var t=[];e&&t.push(e),this._proxy.setOption("data",{actionName:"getDialog",className:"gallery\\data\\album\\AlbumAction",objectIDs:t}),this._proxy.sendRequest()}}),Gallery.Album.InlineEditor=WCF.InlineEditor.extend({_dialog:null,_permissions:{},_redirectURL:"",_sortImagesURL:"",_execute:function(e,t){if(!this._validate(e,t))return!1;var a=$("#"+e).data("albumID");switch(t){case"delete":var i=this._redirectURL;WCF.System.Confirmation.show(WCF.Language.get("gallery.album.delete.confirmMessage"),function(e){"confirm"===e&&new WCF.Action.Proxy({autoSend:!0,data:{actionName:"delete",className:"gallery\\data\\album\\AlbumAction",objectIDs:[a]},success:function(){new WCF.System.Notification(WCF.Language.get("gallery.album.delete.success")).show(function(){window.location=i})}})});break;case"edit":this.getDialog().show(a);break;case"sortImages":window.location=this._sortImagesURL}},_getPermission:function(e){return this._permissions[e]?this._permissions[e]:0},_getTriggerElement:function(e){return e.find(".jsAlbumInlineEditor")},_registerAlbumDialogCallbacks:function(){this._dialog.registerCallback("updated",$.proxy(this._updateAlbumData,this))},_setOptions:function(){this._options=[{label:WCF.Language.get("gallery.album.sortImages"),optionName:"sortImages"},{label:WCF.Language.get("gallery.album.delete"),optionName:"delete"},{optionName:"divider"},{label:WCF.Language.get("wcf.global.button.edit"),optionName:"edit",isQuickOption:!0}]},_updateAlbumData:function(e){var t=$(".boxHeadline > h1 > .badge");$(".boxHeadline > h1").text(e.find('input[name="title"]').val()+(t?" ":"")),t&&$(".boxHeadline > h1").append(t),$(".boxHeadline > p").text(e.find('textarea[name="description"]').val())},_validate:function(e,t){switch(t){case"delete":return this._getPermission("canDeleteAlbum")?!0:!1;case"edit":return this._getPermission("canEditAlbum")?!0:!1;case"sortImages":return this._getPermission("canSortImages")?!0:!1}return!1},getDialog:function(){return null===this._dialog&&(this._dialog=new Gallery.Album.Dialog,this._registerAlbumDialogCallbacks()),this._dialog},setPermission:function(e,t){this._permissions[e]=t},setPermissions:function(e){for(var t in e)this.setPermission(t,e[t])},setRedirectURL:function(e){this._redirectURL=e},setSortImagesURL:function(e){this._sortImagesURL=e}}),Gallery.Album.Share=WCF.Message.Share.Content.extend({_albumID:0,init:function(e){this._albumID=e,this._super()},_click:function(e){e.preventDefault();var t=$(e.currentTarget),a=t.prop("href"),i=a.hashCode();if(void 0===this._cache[i]){var s=!1;null===this._dialog?(this._dialog=$("<div />").hide().appendTo(document.body),s=!0):this._dialog.empty();var r=$('<fieldset><legend><label for="__sharePermalink">'+WCF.Language.get("wcf.message.share.permalink")+"</label></legend></fieldset>").appendTo(this._dialog);$('<input type="text" id="__sharePermalink" class="long" readonly="readonly" />').attr("value",a).appendTo(r);var r=$('<fieldset><legend><label for="__shareBBCode">'+WCF.Language.get("wcf.message.share.permalink.bbcode")+"</label></legend></fieldset>").appendTo(this._dialog);$('<input type="text" id="__shareBBCode" class="long" readonly="readonly" />').attr("value","[album]"+this._albumID+"[/album]").appendTo(r),this._cache[i]=this._dialog.html(),this._dialog.wcfDialog(s?{title:WCF.Language.get("wcf.message.share")}:"open")}else this._dialog.html(this._cache[i]).wcfDialog("open");this._enableSelection()}}),Gallery.Album.SortableImageList=Class.extend({_albumID:0,_offset:50,_proxy:null,init:function(e){this._albumID=e,this._offset=50,this._proxy=new WCF.Action.Proxy({success:$.proxy(this._success,this)}),new WCF.Sortable.List("imageList","gallery\\data\\image\\ImageAction",0,{axis:"",placeholder:"galleryImage galleryImageTiny gallerySortableImagePlaceholder",toleranceElement:""},!0,{albumID:e}),$("#loadMoreImages").click($.proxy(this._loadMoreImages,this))},_loadMoreImages:function(){this._proxy.setOption("data",{actionName:"loadSortableImages",className:"gallery\\data\\album\\AlbumAction",objectIDs:[this._albumID],parameters:{offset:this._offset}}),this._proxy.sendRequest()},_success:function(e){$("#imageList > .gallerySortableImageList").append(e.returnValues.template).sortable("refresh"),50!=e.returnValues.count&&$("#loadMoreImages").remove(),this._offset+=50}}),Gallery.Category={},Gallery.Category.MarkAllAsRead=Class.extend({_proxy:null,init:function(){this._proxy=new WCF.Action.Proxy({success:$.proxy(this._success,this)}),$(".markAllAsReadButton").click($.proxy(this._click,this))},_click:function(e){e.preventDefault(),this._proxy.setOption("data",{actionName:"markAllAsRead",className:"gallery\\data\\category\\GalleryCategoryAction"}),this._proxy.sendRequest()},_success:function(){$(".nestedCategoryList").find(".badge.badgeUpdate").hide(),$(".galleryImageList .galleryNewImageBagde").hide(),$("#mainMenu .active .badge").hide()}}),Gallery.Image={},Gallery.Image.Browser=Class.extend({_ckeditor:null,_dialog:null,_isOpen:!1,_redactor:null,init:function(e,t){this._ckeditor=e||null,this._redactor=t||null,this._dialog=null,this._isOpen=!1},open:function(){return this._isOpen?!1:(this._isOpen=!0,void(null===this._dialog?new WCF.Action.Proxy({autoSend:!0,data:{actionName:"getImageBrowser",className:"gallery\\data\\image\\UserImageAction",objectIDs:[WCF.User.userID]},success:$.proxy(this._initImageBrowser,this)}):(this._dialog.wcfDialog("open"),$(window).trigger("resize"))))},_initImageBrowser:function(e){this._dialog=$("<div />").hide().html(e.returnValues.template).appendTo(document.body),this._dialog.wcfDialog({onClose:$.proxy(function(){this._isOpen=!1},this),title:WCF.Language.get("gallery.image.browser")}),new Gallery.Image.Browser.AlbumList.Loader(this),new Gallery.Image.Browser.ImageList.Loader(this),new Gallery.Image.Browser.Search.Loader(this),WCF.DOMNodeInsertedHandler.addCallback("Gallery.Image.Browser."+(this._ckeditor?this._ckeditor.name:this._redactor.$textarea.wcfIdentify()),$.proxy(this._domNodeInserted,this)),$(window).trigger("resize"),this._dialog.wcfDialog("render")},_insertBBCode:function(e){var t=$(e.currentTarget).data("bbcode");this._ckeditor?this._ckeditor.insertText(t):this._redactor.wutil.insertDynamic(t)},_domNodeInserted:function(){this._dialog.find(".jsGalleryImageBrowserInsertAlbum").removeClass("jsGalleryImageBrowserInsertAlbum").click($.proxy(this._insertBBCode,this));var e=this;this._dialog.find(".jsGalleryImageBrowserInsertImage").removeClass("jsGalleryImageBrowserInsertImage").each(function(t,a){var i=$(a);$dropdownMenu=WCF.Dropdown.getDropdownMenu(i.wcfIdentify()),$dropdownMenu.find("li").click($.proxy(e._insertBBCode,e))})}}),Gallery.Image.Browser.Loader=Class.extend({_actionName:"loadImages",_cache:{},_imageBrowser:null,_list:null,_pagination:null,_pageNo:1,_pages:0,_previousPageNo:1,_proxy:null,init:function(e,t,a){this._actionName="loadImages",this._cache={},this._imageBrowser=e,this._list=$("#"+t),this._pagination=$("#"+a),this._pageNo=1,this._pages=0,this._proxy=new WCF.Action.Proxy({success:$.proxy(this._success,this)}),this._previousPageNo=1},_showPage:function(e,t){t&&t.activePage&&(t.template||(this._previousPageNo=this._pageNo),this._pageNo=t.activePage),this._cache[this._pageNo]||t&&t.template?(this._cache[this._previousPageNo]=this._list.children().detach(),t&&t.template?this._list.html(t.template):this._list.append(this._cache[this._pageNo])):this._loadItems()},_getParameters:function(){return{data:{pageNo:this._pageNo}}},_loadItems:function(){this._proxy.setOption("data",{actionName:this._actionName,className:"gallery\\data\\image\\UserImageAction",parameters:this._getParameters()}),this._proxy.sendRequest()},_success:function(e){this._showPage(null,{activePage:e.returnValues.pageNo,template:e.returnValues.template})}}),Gallery.Image.Browser.AlbumList={},Gallery.Image.Browser.AlbumList.Loader=Gallery.Image.Browser.Loader.extend({init:function(e){this._super(e,"galleryImageBrowserAlbumList","galleryImageBrowserAlbumPagination"),this._actionName="loadAlbums",this._pagination.data("pages")&&this._pagination.wcfPages({maxPage:this._pagination.data("pages")}).on("wcfpagesswitched",$.proxy(this._showPage,this))}}),Gallery.Image.Browser.ImageList={},Gallery.Image.Browser.ImageList.Loader=Gallery.Image.Browser.Loader.extend({init:function(e){this._super(e,"galleryImageBrowserImageList > ol","galleryImageBrowserImageListPagination"),this._pagination.data("pages")>1&&this._pagination.wcfPages({maxPage:this._pagination.data("pages")}).on("wcfpagesswitched",$.proxy(this._showPage,this))}}),Gallery.Image.Browser.Search={},Gallery.Image.Browser.Search.Handler=WCF.Search.Base.extend({_searchLoader:null,init:function(e){this._super("#galleryImageBrowserImageSearchInput",null,[],!1,!0),this._delay=500,this._searchLoader=e;var t=this._searchInput.parent().removeClass("dropdown");WCF.Dropdown.removeDropdown(t.wcfIdentify())},_keyUp:function(e){switch(e.which){case $.ui.keyCode.UP:case $.ui.keyCode.DOWN:return}this._super(e)},_queryServer:function(e){this._proxy.setOption("data",{actionName:"loadImages",className:"gallery\\data\\image\\UserImageAction",parameters:this._getParameters(e)}),this._proxy.sendRequest()},_getParameters:function(e){return e.data.pageNo=1,e},_success:function(e){this._searchLoader.handleSearchResult(e)},_clearList:function(e){e&&this._searchInput.val("")}}),Gallery.Image.Browser.Search.Loader=Gallery.Image.Browser.Loader.extend({_searchString:"",init:function(e){this._super(e,"galleryImageBrowserImageSearchResultList","galleryImageBrowserImageSearchResultPagination"),this._list.hide(),new Gallery.Image.Browser.Search.Handler(this)},handleSearchResult:function(e){this._pages>1&&this._pagination.wcfPages("destroy"),this._pageNo=1,this._pages=e.returnValues.pages,this._searchString=e.returnValues.searchString,this._pagination.empty(),this._pages>1&&this._pagination.wcfPages({maxPage:this._pages}).on("wcfpagesswitched",$.proxy(this._showPage,this)),this._list.empty().hide().next("p").remove(),this._pages?(this._list.html(e.returnValues.template).show(),WCF.DOMNodeInsertedHandler.execute()):$('<p class="info">'+e.returnValues.errorMessage+"</p>").insertAfter(this._list)},_getParameters:function(){var e=this._super();return e.data.searchString=this._searchString,e}}),Gallery.Image.Delete=WCF.Action.Delete.extend({_redirectURL:"",init:function(e,t,a){this._super(e,t),this._redirectURL=a},_success:function(){var e=new WCF.System.Notification(WCF.Language.get("gallery.image.delete.success"));e.show($.proxy(function(){window.location=this._redirectURL},this))}}),Gallery.Image.AlbumNavigation=Class.extend({_activeImage:null,_imageList:null,_side:"left",init:function(){this._activeImage=$(".gallerySidebarBoxImageNavigation").find("li.active"),this._imageList=$("#galleryAlbumImageNavigation"),"rtl"==WCF.Language.get("wcf.global.pageDirection")&&(this._side="right");var e=-this._activeImage.position().left+this._activeImage.outerWidth(!0),t=-this._activeImage.outerWidth(!0)*(this._imageList.children().size()-3);e>0?e=0:t>e&&(e=t),this._imageList.css(this._side,e),e?e==t&&$(".galleryNavigationArrowNext").addClass("disabled").children(".pointer").removeClass("pointer"):$(".galleryNavigationArrowPrevious").addClass("disabled").children(".pointer").removeClass("pointer"),$(".galleryNavigationArrowPrevious").click($.proxy(this._showPreviousImages,this)),$(".galleryNavigationArrowNext").click($.proxy(this._showNextImages,this))},_showPreviousImages:function(e){var t=$(e.currentTarget);if(!$(e.currentTarget).hasClass("disabled")){for(var a=parseInt(this._imageList.css(this._side)),i=this._activeImage.outerWidth(!0),s=a+3*i;s>0;)s-=i;if(s!=a){var r=$(".galleryNavigationArrowNext");r.hasClass("disabled")&&(r.removeClass("disabled"),r.children(".icon").addClass("pointer"))}var n={};n[this._side]=s,this._imageList.animate(n,500,function(){s!=a+3*i&&(t.addClass("disabled"),t.children(".pointer").removeClass("pointer"))})}},_showNextImages:function(e){var t=$(e.currentTarget);if(!$(e.currentTarget).hasClass("disabled")){for(var a=parseInt(this._imageList.css(this._side)),i=this._activeImage.outerWidth(!0),s=a-3*i;s<-i*(this._imageList.children().size()-3);)s+=i;if(s!=a){var r=$(".galleryNavigationArrowPrevious");r.hasClass("disabled")&&(r.removeClass("disabled"),r.children(".icon").addClass("pointer"))}var n={};n[this._side]=s,this._imageList.animate(n,500,function(){s!=a-3*i&&(t.addClass("disabled"),t.children(".pointer").removeClass("pointer"))})}}}),Gallery.Image.InlineEditor=WCF.InlineEditor.extend({_environment:"list",_permissions:{},_redirectURL:"",_updateHandler:null,setRedirectURL:function(e,t){this._redirectURL=e,this._environment=t||"list"},setUpdateHandler:function(e){this._updateHandler=e},_setOptions:function(){this._options=[{label:WCF.Language.get("gallery.image.enable"),optionName:"enable"},{label:WCF.Language.get("gallery.image.disable"),optionName:"disable"},{label:WCF.Language.get("gallery.image.trash"),optionName:"trash"},{label:WCF.Language.get("gallery.image.restore"),optionName:"restore"},{label:WCF.Language.get("gallery.image.delete"),optionName:"delete"},{optionName:"divider"},{label:WCF.Language.get("wcf.global.button.edit"),optionName:"edit",isQuickOption:!0}]},_show:function(e){var t=$(e.currentTarget).data("elementID"),a=null;if(this._dropdowns[t]||(a=this._getTriggerElement(this._elements[t]).addClass("dropdownToggle").parent().addClass("dropdown").end(),this._dropdowns[t]=$('<ul class="dropdownMenu" />').insertAfter(a)),this._super(e),null!==a){WCF.Dropdown.initDropdown(a,!0);var i=a.parent().wcfIdentify();WCF.Dropdown.registerCallback(i,$.proxy(this._toggleDropdown,this)),this._toggleDropdown(i,"open")}for(var s in this._elements)this._elements[s].removeClass("jsGalleryImageShowDetails");return this._elements[t].addClass("jsGalleryImageShowDetails"),!1},_hide:function(e){this._super(e),this._elements[e].removeClass("jsGalleryImageShowDetails")},_toggleDropdown:function(e){WCF.Dropdown.getDropdown(e).parents(".messageOptions").toggleClass("forceOpen")},_getTriggerElement:function(e){return e.find(".jsImageInlineEditor")},_validate:function(e,t){var a=$("#"+e).data("objectID");switch(t){case"delete":return this._getPermission("canDeleteImage")?this._updateHandler.getValue(a,"isDeleted"):!1;case"restore":return this._getPermission("canRestoreImage")?this._updateHandler.getValue(a,"isDeleted"):!1;case"trash":return this._getPermission("canTrashImage")?!this._updateHandler.getValue(a,"isDeleted"):!1;case"enable":return this._getPermission("canEnableImage")?this._updateHandler.getValue(a,"isDeleted")?!1:this._updateHandler.getValue(a,"isDisabled"):!1;case"disable":return this._getPermission("canEnableImage")?this._updateHandler.getValue(a,"isDeleted")?!1:!this._updateHandler.getValue(a,"isDisabled"):!1;case"edit":return!0}return!1},_execute:function(e,t){if(!this._validate(e,t))return!1;switch(t){case"disable":case"enable":this._updateImage(e,t,{isDisabled:"enable"===t?0:1});break;case"delete":var a=this;WCF.System.Confirmation.show(WCF.Language.get("gallery.image.delete.confirmMessage"),function(i){"confirm"===i&&a._updateImage(e,t,{deleted:1})});break;case"edit":window.location=this._getTriggerElement($("#"+e)).prop("href");break;case"restore":this._updateImage(e,t,{isDeleted:0});break;case"trash":var a=this;WCF.System.Confirmation.show(WCF.Language.get("gallery.image.trash.confirmMessage"),function(i){"confirm"===i&&a._updateImage(e,t,{isDeleted:1,reason:$("#wcfSystemConfirmationContent").find("textarea").val()})},{},$("<fieldset><dl><dt>"+WCF.Language.get("gallery.image.trash.reason")+'</dt><dd><textarea cols="40" rows="4" /></dd></dl></fieldset>'))}},_updateImage:function(e,t,a){if("delete"===t){var i=this,s=this._elements[e].data("objectID");new WCF.Action.Proxy({autoSend:!0,data:{actionName:"delete",className:"gallery\\data\\image\\ImageAction",objectIDs:[s]},success:function(){i._redirectURL?window.location=i._redirectURL:window.location.reload()}})}else this._updateData.push({data:a,elementID:e,optionName:t}),this._proxy.setOption("data",{actionName:t,className:"gallery\\data\\image\\ImageAction",objectIDs:[this._elements[e].data("objectID")],parameters:{data:a}}),this._proxy.sendRequest()},_updateState:function(){if("image"==this._environment&&1==this._updateData.length&&"trash"==this._updateData[0].optionName&&!this._getPermission("canViewDeletedImage"))return void this._notification.show($.proxy(function(){window.location=this._redirectURL},this));this._notification.show();for(var e=0,t=this._updateData.length;t>e;e++){var a=this._updateData[e];this._updateHandler.update($("#"+a.elementID).data("objectID"),a.data)}},_getPermission:function(e){return this._permissions[e]?this._permissions[e]:0},setPermission:function(e,t){this._permissions[e]=t},setPermissions:function(e){for(var t in e)this.setPermission(t,e[t])}}),Gallery.Image.Like=WCF.Like.extend({_getContainers:function(){return $(".galleryImageContainer")},_getObjectID:function(e){return this._containers[e].data("objectID")},_getWidgetContainer:function(){return $("#imageButtonContainer")},_buildWidget:function(e,t,a,i,s){var r=this._getWidgetContainer(e);this._canLike&&(r.prepend(a).prepend(t),a.find("a").addClass("button"),t.find("a").addClass("button")),s&&(s.appendTo($(".galleryImageContainer")),s.addClass("messageFooterNote marginTop")),$(".galleryImageHeadline > h1").append(i)},_setActiveState:function(e,t,a){e=e.find(".button").removeClass("active"),t=t.find(".button").removeClass("active"),1==a?e.addClass("active"):-1==a&&t.addClass("active")},_addWidget:function(){}}),Gallery.Image.Handler=Class.extend({_activeImageID:"",_callbacks:{addImage:[],removeImage:[]},_dataHandlers:{},_errorMessage:null,_image:null,_imageContainer:null,_imageProcessor:null,_images:{},_initialData:{},_options:{},_proxy:null,_saveButton:null,_saveRequestCount:0,_scrollEffect:null,_thumbnailListContainer:null,_thumbnailAreaSelector:null,_uploadHandler:null,_uploadWarning:null,_maxUserImageCount:0,_maxDescriptionLength:0,_maxInputVars:0,_redirectURL:"",_tmpHash:"",_userImageCount:0,init:function(e,t,a,i,s,r){$.isPlainObject(e)?(this._options=e,this._tmpHash=e.tmpHash||null,this._userImageCount=e.userImageCount,this._maxUserImageCount=e.maxUserImageCount,this._maxDescriptionLength=e.maxDescriptionLength,this._maxInputVars=e.maxInputVars):(this._tmpHash=e,this._userImageCount=t,this._maxUserImageCount=a,this._maxDescriptionLength=i,this._maxInputVars=s,this._options={maxDescriptionLength:this._maxDescriptionLength,maxInputVars:this._maxInputVars,maxParallelUploads:r,maxUserImageCount:this._maxUserImageCount,tmpHash:this._tmpHash,userImageCount:this._userImageCount}),this._saveRequestCount=0,this._callbacks={addImage:[],removeImage:[]},this._initialData={},this._image=$('<img src="" alt="" />').appendTo($("#image")),this._proxy=new WCF.Action.Proxy({success:$.proxy(this._success,this)}),this._thumbnailListContainer=$("#thumbnailListContainer"),this._imageContainer=$("#imageContainer"),this._overwriteDataButton=$("#overwriteDataButton").click($.proxy(this._overwriteData,this)).hide(),this._rotateImageButtons=$(".jsRotateImageButton").click($.proxy(this._rotateImage,this)),this._saveButton=$("#saveButton").click($.proxy(this._save,this)),this._thumbnailAreaSelector=new Gallery.Image.ThumbnailAreaSelector(this),this.getOption("tmpHash")&&(this._uploadHandler=new Gallery.Image.Upload(this,this.getOption("maxParallelUploads")),this.getOption("userImageCount")<this.getOption("maxUserImageCount")?this._thumbnailListContainer.show():(this._uploadHandler.hideUploadButton(),this._uploadWarning=$(".jsGalleryUploadWarning")),this._imageProcessor=new Gallery.Image.Processor(this)),$("#imageToogle").click($.proxy(this._toggleImage,this))},_toggleImage:function(e){var t=$(e.currentTarget);t.children(".icon").toggleClass("fa-chevron-right").toggleClass("fa-chevron-down"),t.parent().next("small").toggle(),$(".jsImageButton").toggle(),$("#image").toggle()},_getImageIDs:function(){var e=[];for(var t in this._images)e.push(t);return e},_getRequestData:function(){var e=[],t={},a=0;for(var i in this._images){var s=0,r=this._images[i].getData();r.__useCoordinates||(r.latitude=0,r.longitude=0,r.location="");for(var n in r)"__"==n.substr(0,2)?delete r[n]:$.isArray(r[n])?s+=r[n].length:$.isPlainObject(r[n])?s+=$.getLength(r[n]):s++;a+$.getLength(r)>this.getOption("maxInputVars")-150&&(e.push(t),t={},a=0),t[i]=r,a+=s}return e.push(t),e},_handleSavedImageData:function(e){if(void 0!==e.thumbnailImageIDs&&e.thumbnailImageIDs.length){new WCF.System.Notification(WCF.Language.get("gallery.image.upload.info.thumbnailGeneration"),"info").show(void 0,5e3);var t=new Gallery.Image.ThumbnailGenerator,a=0;for(var i in e.thumbnailImageIDs)t.generateThumbnails(e.thumbnailImageIDs[i],$.proxy(function(){a++,a==e.thumbnailImageIDs.length&&(this._saveRequestCount--,this._saveRequestCount||(window.location=this.getOption("redirectURL")))},this),!0)}else if(void 0!==e.errors){for(var s in this._images)this.getImage(s).setErrors(e.errors[s]||{}),this.getImage(s).getThumbnailContainer().addClass("imageError");this._showErrorMessage()}else this._saveRequestCount--,this._saveRequestCount||(window.location=this.getOption("redirectURL"))},_overwriteData:function(){WCF.System.Confirmation.show(WCF.Language.get("gallery.image.overwriteData.confirmMessage"),function(e){"confirm"===e&&(WCF.System.Event.fireEvent("com.woltlab.gallery.imageHandler","overwriteData"),(new WCF.System.Notification).show())})},_rotateImage:function(e,t){return!t&&this.getActiveImage().get("thumbnailWidth")?void WCF.System.Confirmation.show(WCF.Language.get("gallery.image.rotate.confirmMessage"),$.proxy(function(t){"confirm"===t&&this._rotateImage(null,$(e.currentTarget).data("angle"))},this)):(this._proxy.setOption("data",{actionName:"rotateImage",className:"gallery\\data\\image\\ImageAction",objectIDs:[this.getActiveImage().getImageID()],parameters:{angle:e?$(e.currentTarget).data("angle"):t}}),void this._proxy.sendRequest())},_save:function(){this._saveButton.disable(),this.setActiveImage(this.getActiveImage()),this.validate()?(null!==this._errorMessage&&this._errorMessage.hide(),this._sendRequests()):this._showErrorMessage()},_sendRequests:function(){var e=this._getRequestData();this._saveRequestCount=e.length;for(var t in e)this._proxy.setOption("data",{actionName:"saveImageData",className:"gallery\\data\\image\\ImageAction",objectIDs:Object.keys(e[t]),parameters:{data:e[t],isEdit:this.getOption("tmpHash")?0:1}}),this._proxy.sendRequest()},_showErrorMessage:function(){this.setActiveImage(this.getActiveImage()),null===this._errorMessage&&(this._errorMessage=$('<p class="error" />').text(WCF.Language.get(this.getOption("tmpHash")?"gallery.image.upload.error.markedImages":"wcf.global.form.error")).hide().insertBefore("#thumbnailListContainer"),this._scrollEffect=new WCF.Effect.Scroll),this._scrollEffect.scrollTo(this._errorMessage),this._errorMessage.show(),this._saveButton.enable()},_success:function(e){switch(e.actionName){case"delete":if(e.objectIDs)for(var t in e.objectIDs)this.removeImage(e.objectIDs[t]);this.setUserImageCount(e.returnValues.userImageCount),(new WCF.System.Notification).show();break;case"rotateImage":this.getImageNode().on("load",$.proxy(this._didRotateImage,this,e.returnValues)),this.getImageNode().removeAttr("src").attr("src",this.getActiveImage().get("url")+"?timestamp="+ +(new Date).getTime()),this.getActiveImage().set("height",e.returnValues.height),this.getActiveImage().set("width",e.returnValues.width),this.getActiveImage().set("thumbnailHeight",0),this.getActiveImage().set("thumbnailWidth",0),this.getActiveImage().set("thumbnailX",0),this.getActiveImage().set("thumbnailY",0),(new WCF.System.Notification).show();break;case"saveImageData":this._handleSavedImageData(e.returnValues)}},_didRotateImage:function(e){this.getImageNode().off("load",$.proxy(this._didRotateImage,this)),WCF.System.Event.fireEvent("com.woltlab.gallery.ImageHandler","didRotateImage",e)},addDataHandler:function(e,t){this._dataHandlers[e]=t,t.setImageHandler(this)},addError:function(e){var t;t="string"==typeof e?$('<p class="error" />').text(e).insertBefore(this._thumbnailListContainer):e,$('<span class="icon icon16 fa-times pointer jsTooltip" title="'+WCF.Language.get("wcf.global.button.hide")+'" />').appendTo(t).click(function(){$(this).parent().wcfFadeOut(function(){$(this).remove()})})},addImage:function(e,t){if(this._thumbnailListContainer.is(":visible")||!this.getOption("tmpHash")&&!$.getLength(this._images)||this._thumbnailListContainer.show(),this.getOption("tmpHash"))for(var a in this._initialData)t.set(a,this._initialData[a]);this._images[e]=t,t.setImageHandler(this);for(var i in this._callbacks.addImage)this._callbacks.addImage[i](t);$.getLength(this._images)>1&&this._overwriteDataButton.show()},addInitialData:function(e,t){this._initialData[e]=t},getActiveImage:function(){return void 0!==this._images[this._activeImageID]?this._images[this._activeImageID]:null},getDataHandler:function(e){return void 0!==this._dataHandlers[e]?this._dataHandlers[e]:null},getDataHandlers:function(){return this._dataHandlers},getImage:function(e){return void 0!==this._images[e]?this._images[e]:null},getImageNode:function(){return this._image},getImageProcessor:function(){return this._imageProcessor},getImages:function(){return this._images},registerCallback:function(e,t){return"addImage"!=e&&"removeImage"!=e?(console.debug("[Gallery.Image.Handler] Unknown callback event '"+e+"'"),!1):$.isFunction(t)?void this._callbacks[e].push(t):(console.debug("[Gallery.Image.Handler] Callback for '"+e+"' is invalid"),!1)},removeDataHandler:function(e){return void 0!==this._dataHandlers[e]?(delete this._dataHandlers[e],!0):!1},removeImage:function(e){if(void 0!==this._images[e]){this._images[e].remove(),delete this._images[e];for(var t in this._callbacks.removeImage)this._callbacks.removeImage[t](e);return $.getLength(this._images)?e==this._activeImageID&&(this._activeImageID=0,$("#thumbnailList > li:eq(0)").each($.proxy(function(e,t){this.setActiveImage(this._images[$(t).data("imageID")])},this))):(this._imageContainer.hide(),this._activeImageID=0),1==$.getLength(this._images)&&this._overwriteDataButton.hide(),!0}return!1},removeImageByClick:function(e){WCF.System.Confirmation.show(WCF.Language.get("gallery.image.delete.confirmMessage"),$.proxy(function(t){"confirm"===t&&(this._proxy.setOption("data",{actionName:"delete",className:"gallery\\data\\image\\ImageAction",objectIDs:[$(e.currentTarget).data("imageID")],parameters:{returnUserImageCount:1}}),this._proxy.sendRequest())},this))},setActiveImage:function(e){if(this._activeImageID){var t=this._images[this._activeImageID].getData();for(var a in this._dataHandlers)this._dataHandlers[a].readData(),t=$.extend(t,this._dataHandlers[a].getData());this._images[this._activeImageID].setData(t)}this._activeImageID=e.getImageID(),$("#thumbnailList").children("li").removeClass("active"),e.getThumbnail()&&e.getThumbnail().parent("li").addClass("active"),this._image.attr("src",e.get("url")).on("load",$.proxy(this._thumbnailAreaSelector.refresh,this._thumbnailAreaSelector));for(var a in this._dataHandlers)this._dataHandlers[a].updateData();

this._rotateImageButtons.show().each($.proxy(function(e,t){var a=$(t);a.data("angle")%180&&(this.getActiveImage().get("width")<this.getOption("minHeight")||this.getActiveImage().get("height")<this.getOption("minWidth"))&&a.hide()},this))},addEditedImageData:function(e){this.addImage(e.imageID,new Gallery.Image.Handler.Image(e.imageID,e,null,!0)),this._imageContainer.show()},setEditedImageData:function(e){this.addImage(e.imageID,new Gallery.Image.Handler.Image(e.imageID,e)),this._imageContainer.show(),this.setActiveImage(this.getImage(e.imageID))},setFirstImageActive:function(){var e=this.getImage($("#thumbnailList").children("li:eq(0)").data("imageID"));e&&(this._imageContainer.is(":visible")||this._imageContainer.show(),this.setActiveImage(e))},setUserImageCount:function(e){this._uploadHandler&&(this.getOption("userImageCount")>=this.getOption("maxUserImageCount")&&e<this.getOption("maxUserImageCount")?(this._thumbnailListContainer.show(),this._uploadHandler.showUploadButton(),this._uploadWarning&&this._uploadWarning.hide()):e>this.getOption("userImageCount")&&e>=this.getOption("maxUserImageCount")&&(this._uploadHandler.hideUploadButton(),this._uploadWarning?this._uploadWarning.show():this._uploadWarning=$('<p class="warning" />').text(WCF.Language.get("gallery.image.upload.error.tooManyImages")).insertBefore(this._thumbnailListContainer))),this.setOption("userImageCount",e)},validate:function(){var e=!0;for(var t in this._images)this._images[t].validate()||(e=!1);return e},getOption:function(e){return e in this._options?this._options[e]:null},setOption:function(e,t){this._options[e]=t},getTmpHash:function(){return this.getOption("tmpHash")},setRedirectURL:function(e){this.setOption("redirectURL",e),this._redirectURL=e}}),Gallery.Image.ImageGrid=Class.extend({_activeElement:-1,_baseInterval:3e3,_elements:[],_images:[],_intervalModifier:1,_isHover:!1,_pe:null,init:function(e){if(this._images=e,this._images.length<2)return void console.debug("[Gallery.Image.ImageGrid] At least two images are required but "+e.length+" are given, aborting.");var t=document.getElementById("galleryImageGrid");return null===!t?void console.debug("[Gallery.Image.ImageGrid] Container 'galleryImageGrid' is missing, aborting."):(this._initElements(t),this._pe=new WCF.PeriodicalExecuter(this.cycleImages.bind(this),this._baseInterval*this._intervalModifier),void this._initEventListener(t))},_initElements:function(e){this._elements=[].slice.call(e.children);var t=document.createElement("a"),a=document.createElement("span");t.appendChild(a),this._elements[0].appendChild(t),this._elements[0].setAttribute("data-active-image",0),this._elements[0].setAttribute("data-image-index",0),this._elements[1]&&this._elements[1].setAttribute("data-image-index",3),this._elements[2]&&this._elements[2].setAttribute("data-image-index",7),2===this._elements.length?this._intervalModifier=1.5:1===this._elements.length&&(this._intervalModifier=2)},_initEventListener:function(e){e.addEventListener("mouseover",function(){this._isHover=!0}.bind(this)),e.addEventListener("mouseout",function(){this._isHover=!1}.bind(this));var t=this._elements.length,a=function(){var e=this._elements[0].offsetTop,a=1;t>1&&this._elements[1].offsetTop===e&&(a=2,3===t&&this._elements[2].offsetTop===e&&(a=3));var i=2;2===a?i=1.5:3===a&&(i=1),i!==this._intervalModifier&&(this._intervalModifier=i,this._pe.setInterval(this._baseInterval*this._intervalModifier))}.bind(this);a(),window.addEventListener("resize",a)},cycleImages:function(){if(!this._isHover){var e=0;this._activeElement++,this._activeElement===this._elements.length&&(this._activeElement=e);var t=this._elements[this._activeElement];if(this._activeElement===e){var a=parseInt(t.getAttribute("data-image-index"))+1;a===this._images.length&&(a=0);var i=parseInt(t.getAttribute("data-active-image"))+1;2===i&&(i=0);var s=new Image;s.src=this._images[a].src;var r=t.children[i];r.setAttribute("href",this._images[a].url),r.classList.add("active"),r.children[0].style.setProperty("background-image","url("+this._images[a].src+")"),r.children[0].setAttribute("data-title",this._images[a].title),t.children[1===i?0:1].classList.remove("active"),t.setAttribute("data-active-image",i),t.setAttribute("data-image-index",a),s.complete?t.classList.add("hideLoading"):(t.classList.remove("hideLoading"),r.children[0].classList.add("imageLoading"),s.addEventListener("load",function(){t.classList.add("hideLoading"),r.children[0].classList.remove("imageLoading")}.bind(this)))}else{t.children.length>2&&t.removeChild(t.children[t.children.length-1]);var a=parseInt(t.getAttribute("data-image-index"))+1;a===this._images.length&&(a=0);var n=document.createElement("li");n.classList.add("imageGridItemOffset");var o=document.createElement("a");o.setAttribute("href",this._images[a].url),o.setAttribute("data-title",this._images[a].title),n.appendChild(o);var s=document.createElement("img");s.setAttribute("src",this._images[a].src),o.appendChild(s),t.insertBefore(n,this._elements[this._activeElement].children[0]),t.setAttribute("data-image-index",a),s.complete||(s.classList.add("imageLoading"),s.addEventListener("load",function(){s.classList.remove("imageLoading")})),setTimeout(function(){n.classList.remove("imageGridItemOffset")},10),t.offsetTop>this._elements[0].offsetTop&&setTimeout(this.cycleImages.bind(this),20)}}}}),Gallery.Image.ImagesInMotion=Class.extend({_container:null,_effectOptions:{},init:function(e,t,a){if(t.length<2)return void console.debug("[Gallery.Image.ImagesInMotion] At least two images are required but "+t.length+" are given, aborting.");if(this._container=$("#"+e),!this._container.length)return void console.debug("[Gallery.Image.ImagesInMotion] Container id '"+e+"' is invalid, aborting.");this._effectOptions=a||{},shuffle(t);for(var i=null,s=!1,r=0,n=t.length;n>r;r++)i=$('<img src="'+t[r].url+'" />').data("imageData",t[r]).appendTo(this._container),0===r&&(i.get(0).complete?s=!0:i.load($.proxy(this._initKenBurnsEffect,this)));s&&this._initKenBurnsEffect()},_initKenBurnsEffect:function(){this._container.removeClass("loading").kenburns(this._effectOptions)}}),$.widget("gallery.kenburns",{_activeCanvas:1,_animationIDs:[],_canvases:[],_caption:null,_current:{height:0,width:0,x:0,y:0},_images:[],_imageData:[],_index:-1,_link:null,_resumeAnimationCallbacks:[],_supportedAlignments:[],_updateCanvasDimensionsCallbacks:[],_userAvatar:null,options:{duration:7e3,randomizeZoom:!0,zoomFactor:.9},_create:function(){this._activeCanvas=1,this._animationIDs=[0,0],this._images=[],this._imageData=[],this._index=-1,this._resumeAnimationCallbacks=[null,null],this._updateCanvasDimensionsCallbacks=[null,null],this._supportedAlignments=["top","left","bottom","center","right"],this._canvases=[$('<canvas class="kenburns" />').appendTo(this.element).get(0),$('<canvas class="kenburns" />').appendTo(this.element).get(0)],this._link=$('<a class="box48 framed"></a>').appendTo(this.element),this._userAvatar=$("<img />").appendTo(this._link),this._caption=$("<h1 />").appendTo(this._link),this.updateCanvasDimensions(),this.options.zoomFactor=Math.abs(this.options.zoomFactor),this.options.zoomFactor=Math.min(Math.max(this.options.zoomFactor,.5),1.5),this.element.children("img").each($.proxy(function(e,t){this._images.push(t),this._imageData.push($(t).data("imageData"))},this)),WCF.PageVisibilityHandler.addCallback("gallery.kenburns."+this.element.wcfIdentify().hashCode(),$.proxy(function(e){e?this.pause():this.resume()},this)),$(window).resize($.proxy(this.updateCanvasDimensions,this)),this.start()},updateCanvasDimensions:function(){var e=this.element.getDimensions("inner");this._canvases[0].height=e.height,this._canvases[0].width=e.width,this._canvases[1].height=e.height,this._canvases[1].width=e.width,this._updateCanvasDimensionsCallbacks[0]&&this._updateCanvasDimensionsCallbacks[0](),this._updateCanvasDimensionsCallbacks[1]&&this._updateCanvasDimensionsCallbacks[1]()},start:function(){var e=-1===this._index;this._index++,this._index===this._images.length&&(this._index=0),$(this._canvases[this._activeCanvas]).removeClass("primary").addClass("secondary"),this._activeCanvas=this._activeCanvas?0:1;var t=this._canvases[this._activeCanvas];$(t).addClass("primary").removeClass("secondary");var a=this._images[this._index];this._current=this.getCurrentImageDimensions(a,t);var i=this._imageData[this._index];this._caption.html(i.title),this._link.prop("href",i.link),this._userAvatar.prop("src",i.avatar),this._render(t,e)},getCurrentImageDimensions:function(e,t){var a={height:Math.floor(t.width/e.width*e.height),width:t.width,x:0,y:0};if(a.height<t.height){var i=t.height/a.height;a.height=t.height,a.width=t.width*i}return t.width<700&&(a.height*=2,a.width*=2),a.x=(a.width-t.width)/2*-1,a.y=(a.height-t.height)/2*-1,a},pause:function(){this._animationIDs[0]&&cancelAnimationFrame(this._animationIDs[0]),this._animationIDs[1]&&cancelAnimationFrame(this._animationIDs[1])},resume:function(){null!==this._resumeAnimationCallbacks[0]&&this._resumeAnimationCallbacks[0](),null!==this._resumeAnimationCallbacks[1]&&this._resumeAnimationCallbacks[1]()},_getAlignment:function(e,t,a,i,s,r,n){var o=0,l=0;switch(n){case"top":o=(s-a)/2*-1;break;case"left":l=(r-i)/2*-1;break;case"bottom":o=(s-a)/2*-1,l=-1*(r-i);break;case"right":o=-1*(s-a),l=(r-i)/2*-1;break;default:o=(s-a)/2*-1,l=(r-i)/2*-1}return{x:e+o,y:t+l}},_scaleImage:function(e,t,a){var i=Math.floor(e.width*t),s=Math.floor(e.height*t),r=this._getAlignment(e.x,e.y,e.width,e.height,i,s,a);return{height:s,width:i,x:r.x,y:r.y}},_render:function(e,t){function a(t){null===c&&(c=t),v&&(v=!1,c=t-u),u=t-c;var w=y._scaleImage(n,g,i),C=y._images[o];p>u?_=u/p:u>f?(_=(y.options.duration-u)/1e3,I||(I=!0,y.start())):_=1,r.clearRect(0,0,e.width,e.height),r.globalAlpha=_,r.drawImage(C,0,0,C.width,C.height,w.x,w.y,w.width,w.height),b=!1,l>1?(g=1+h*u,m>g&&(b=!0)):(g=d-h*u,g>m&&(b=!0)),b?y._animationIDs[s]=requestAnimationFrame(a):(y._resumeAnimationCallbacks[s]=null,y._updateCanvasDimensionsCallbacks[s]=null)}var i=this._supportedAlignments[Math.floor(Math.random()*this._supportedAlignments.length)],s=this._activeCanvas,r=e.getContext("2d"),n=this._current,o=this._index,l=this.options.zoomFactor;this.options.randomizeZoom&&Math.round(Math.random())&&(l=2-l),e.width<700&&(1>l?(l=1-l,l=1-2*l):(l=1-l,l=1+2*l));var g=1,h=0,d=1,m=l;m>1?h=Math.abs(l-1)/this.options.duration:(g=1-l+1,d=g,h=(1-l)/this.options.duration,m=1);var c=null,u=0,_=0,p=t?1e3:0,f=this.options.duration-1e3,I=!1,v=!1,b=!1,y=this;this._resumeAnimationCallbacks[s]=function(){v=!0,y._animationIDs[s]=requestAnimationFrame(a)},this._updateCanvasDimensionsCallbacks[s]=function(){n=y.getCurrentImageDimensions(y._images[o],e)},this._animationIDs[s]=requestAnimationFrame(a)}}),Gallery.Image.Share=WCF.Message.Share.Content.extend({_smallImageURL:"",_largeImageURL:"",_imageID:0,init:function(e,t,a){this._imageID=e,this._smallImageURL=t,this._largeImageURL=a,this._super()},_click:function(e){e.preventDefault();var t=$(e.currentTarget),a=t.prop("href"),i=a.hashCode();if(void 0===this._cache[i]){var s=!1;null===this._dialog?(this._dialog=$("<div />").hide().appendTo(document.body),s=!0):this._dialog.empty();var r=$('<fieldset><legend><label for="__sharePermalink">'+WCF.Language.get("wcf.message.share.permalink")+"</label></legend></fieldset>").appendTo(this._dialog);if($('<input type="text" id="__sharePermalink" class="long" readonly="readonly" />').attr("value",a).appendTo(r),this._smallImageURL){var r=$('<fieldset><legend><label for="__shareSmallImageBBCode">'+WCF.Language.get("wcf.message.share.permalink.bbcode")+" ("+WCF.Language.get("gallery.image.share.smallImage")+")</label></legend></fieldset>").appendTo(this._dialog);$('<input type="text" id="__shareSmallImageBBCode" class="long" readonly="readonly" />').attr("value","[image='"+this._imageID+"',small][/image]").appendTo(r);var r=$('<fieldset><legend><label for="__shareLargeImageBBCode">'+WCF.Language.get("wcf.message.share.permalink.bbcode")+" ("+WCF.Language.get("gallery.image.share.largeImage")+")</label></legend></fieldset>").appendTo(this._dialog);$('<input type="text" id="__shareLargeImageBBCode" class="long" readonly="readonly" />').attr("value","[image='"+this._imageID+"',large][/image]").appendTo(r);var r=$('<fieldset><legend><label for="__shareSmallImageHTML">'+WCF.Language.get("wcf.message.share.permalink.html")+" ("+WCF.Language.get("gallery.image.share.smallImage")+")</label></legend></fieldset>").appendTo(this._dialog);$('<input type="text" id="__shareSmallImageHTML" class="long" readonly="readonly" />').attr("value",'<a href="'+a+'"><img src="'+this._smallImageURL+'" alt="" /></a>').appendTo(r);var r=$('<fieldset><legend><label for="__shareLargeImageHTML">'+WCF.Language.get("wcf.message.share.permalink.html")+" ("+WCF.Language.get("gallery.image.share.largeImage")+")</label></legend></fieldset>").appendTo(this._dialog);$('<input type="text" id="__shareLargeImageHTML" class="long" readonly="readonly" />').attr("value",'<a href="'+a+'"><img src="'+this._largeImageURL+'" alt="" /></a>').appendTo(r)}else{var r=$('<fieldset><legend><label for="__shareImageBBCode">'+WCF.Language.get("wcf.message.share.permalink.bbcode")+"</label></legend></fieldset>").appendTo(this._dialog);$('<input type="text" id="__shareImageBBCode" class="long" readonly="readonly" />').attr("value","[url='"+a+"'][img]"+this._largeImageURL+"[/img][/url]").appendTo(r);var r=$('<fieldset><legend><label for="__shareImageHTML">'+WCF.Language.get("wcf.message.share.permalink.html")+"</label></legend></fieldset>").appendTo(this._dialog);$('<input type="text" id="__shareImageHTML" class="long" readonly="readonly" />').attr("value",'<a href="'+a+'"><img src="'+this._largeImageURL+'" alt="" /></a>').appendTo(r)}this._cache[i]=this._dialog.html(),this._dialog.wcfDialog(s?{title:WCF.Language.get("wcf.message.share")}:"open")}else this._dialog.html(this._cache[i]).wcfDialog("open");this._enableSelection()}}),Gallery.Image.Slideshow={_didInit:!1,init:function(){this._didInit||(this._didInit=!0,this._domNodeInserted(),WCF.DOMNodeInsertedHandler.addCallback("Gallery.Image.Slideshow",$.proxy(this._domNodeInserted,this)))},_domNodeInserted:function(){$.browser.touch&&/[Mm]obile/.test(navigator.userAgent)&&!/iPad/.test(navigator.userAgent)?($(".jsGalleryAlbumImageViewer.button").hide(),$(".jsGalleryAlbumImageViewer").removeClass("jsGalleryAlbumImageViewer"),$(".jsGalleryCategoryImageViewer.button").hide(),$(".jsGalleryCategoryImageViewer").removeClass("jsGalleryCategoryImageViewer"),$(".jsGalleryUserImageViewer.button").hide(),$(".jsGalleryUserImageViewer").removeClass("jsGalleryUserImageViewer")):($(".jsGalleryAlbumImageViewer").removeClass("jsGalleryAlbumImageViewer").wcfImageViewer({className:"gallery\\data\\album\\AlbumAction"}),$(".jsGalleryCategoryImageViewer").removeClass("jsGalleryCategoryImageViewer").wcfImageViewer({className:"gallery\\data\\category\\GalleryCategoryAction"}),$(".jsGalleryUserImageViewer").removeClass("jsGalleryUserImageViewer").wcfImageViewer({className:"gallery\\data\\image\\ImageAction"}))}},Gallery.Image.Upload=WCF.Upload.Parallel.extend({_archiveUploadSuccess:null,_imageHandler:null,_listItems:{},_maxParallelUploads:0,_quotaExceededError:null,_thumbnailGenerator:null,_tooManyImagesError:null,_visibleArchiveUploadSuccess:!1,init:function(e,t){this._imageHandler=e,this._maxParallelUploads=t,this._super($("#thumbnailList"),$("#thumbnailList"),"gallery\\data\\image\\ImageAction")},_createButton:function(){if(this._supportsAJAXUpload){this._fileUpload=$('<input type="file" name="'+this._name+'" '+(this._options.multiple?'multiple="true" ':"")+"/>"),this._fileUpload.change($.proxy(this._upload,this));var e=$('<li class="jsImageUpload jsTooltip" title="'+WCF.Language.get("gallery.image.button.upload")+'"><span class="icon icon32 icon-upload"></span></li>');e.prepend(this._fileUpload)}else{var e=$('<li class="jsImageUpload jsImageUploadFallback jsTooltip" title="'+WCF.Language.get("gallery.image.button.upload")+'"><span class="icon icon32 icon-upload"></span> <span>'+WCF.Language.get("wcf.global.button.upload")+"</span></li>");e.click($.proxy(this._showOverlay,this))}this._insertButton(e),WCF.DOMNodeInsertedHandler.execute()},_error:function(e,t,a){console.log(e,t,a)},_getParameters:function(){return{tmpHash:this._imageHandler.getOption("tmpHash")}},_getThumbnailGenerator:function(){return null===this._thumbnailGenerator&&(this._thumbnailGenerator=new Gallery.Image.ThumbnailGenerator),this._thumbnailGenerator},_insertButton:function(e){this._buttonSelector.append(e)},_initFile:function(){var e=$('<li><progress max="100" /><span class="icon icon32 icon-spinner"></span></li>').insertBefore(this._fileListSelector.find(".jsImageUpload"));return 2==this._fileListSelector.children("li").length&&e.on("didLoadImage",$.proxy(this._imageHandler.setFirstImageActive,this._imageHandler)),e},_removeButton:function(){this._buttonSelector.find(".jsImageUpload").remove()},_success:function(e,t){if(t.returnValues){var a=this._uploadMatrix[e];a.find("progress").remove();var i={resize:1,rotate:1,thumbnails:1,watermarks:t.returnValues.delayWatermarks?0:1};if(t.returnValues.images&&t.returnValues.images[e]){var s=t.returnValues.images[e];this._imageHandler.addImage(s.imageID,new Gallery.Image.Handler.Image(s.imageID,s,a)),this._imageHandler.getImageProcessor().addImage(s.imageID,!1,i)}else if(t.returnValues.archiveImages&&t.returnValues.archiveImages[e]){a.remove(),this._archiveUploadSuccess||(this._archiveUploadSuccess=new WCF.System.Notification(WCF.Language.get("gallery.image.upload.archive.success"))),this._visibleArchiveUploadSuccess||(this._visibleArchiveUploadSuccess=!0,this._archiveUploadSuccess.show($.proxy(this._setArchiveUploadSuccessHidden)));for(var r in t.returnValues.archiveImages[e]){var s=t.returnValues.archiveImages[e][r],a=$("<li />").data("imageID",r).data("imageData",s).on("didLoadImage",$.proxy(this._imageHandler.setFirstImageActive,this._imageHandler)).append($('<span class="icon icon32 icon-spinner" />'));this._fileListSelector.find(".jsImageUpload").before(a),this._listItems[r]=a,this._imageHandler.addImage(s.imageID,new Gallery.Image.Handler.Image(s.imageID,s,a)),this._imageHandler.getImageProcessor().addImage(s.imageID,!1,i)}if(this._imageHandler.getImageProcessor().startProcessor(),t.returnValues.archiveErrors[e]&&t.returnValues.archiveErrors[e].files&&t.returnValues.archiveErrors[e].files.length){var n=$('<div class="info pointer" />').text(t.returnValues.archiveErrors[e].errorMessage),o=$('<ul class="nativeList" />').appendTo(n);for(var l in t.returnValues.archiveErrors[e].files)o.append($("<li />").text(t.returnValues.archiveErrors[e].files[l].errorMessage));this._imageHandler.addError(n)}}if(t.returnValues.errors&&t.returnValues.errors[e]){if(t.returnValues.archiveImages&&!t.returnValues.archiveImages[e]){var g=a.next("li");a.remove(),g&&g.data("imageID")&&g.on("didLoadImage",$.proxy(this._imageHandler.setFirstImageActive,this._imageHandler))}this._imageHandler.addError(t.returnValues.errors[e].errorMessage)}this._imageHandler.setUserImageCount(t.returnValues.userImageCount),WCF.DOMNodeInsertedHandler.execute()}},_upload:function(){var e=this._fileUpload.prop("files");e.length>this._maxParallelUploads?$('<p class="error pointer" />').text(WCF.Language.get("gallery.image.upload.error.maxParallelFileUpload")).insertBefore($("#thumbnailListContainer")).click(function(){this.remove()}):this._super(),this._fileUpload&&(this._removeButton(),this._createButton())},_setArchiveUploadSuccessHidden:function(){this._visibleArchiveUploadSuccess=!1},hideUploadButton:function(){this._buttonSelector.find(".jsImageUpload").hide()},showUploadButton:function(){this._buttonSelector.find(".jsImageUpload").show()}}),Gallery.Image.Processor=Class.extend({_imageHandler:null,_queue:{},_proxy:null,init:function(e){this._imageHandler=e,this._proxy=new WCF.Action.Proxy({showLoadingOverlay:!1,success:$.proxy(this._success,this)})},_sendRequest:function(){var e=this._queue;this._queue={};var t=[];for(var a in e)t.push(a);this._proxy.setOption("data",{actionName:"processImages",className:"gallery\\data\\image\\ImageAction",objectIDs:t,parameters:{queue:e}}),this._proxy.sendRequest()},_success:function(e){for(var t in e.returnValues.errors){this._imageHandler.addError(e.returnValues.errors[t]);var a=this._imageHandler.getImage(t),i=a.getThumbnailContainer().next("li");i&&i.data("imageID")&&i.on("didLoadImage",$.proxy(this._imageHandler.setFirstImageActive,this._imageHandler)),this._imageHandler.removeImage(t)}for(var t in e.returnValues.queue){var s=e.returnValues.queue[t],a=this._imageHandler.getImage(t);for(var r in e.returnValues.imageData[t])a.set(r,e.returnValues.imageData[t][r]);var n=parseInt(s.resize),o=parseInt(s.rotate),l=parseInt(s.thumbnails),g=parseInt(s.watermarks);n||o||l||g?this._queue[t]={resize:n,rotate:o,thumbnails:l,watermarks:g}:(s.tinyURL&&a.set("tinyURL",s.tinyURL),a.showTinyThumbnail())}$.getLength(this._queue)?this._sendRequest():WCF.System.Event.fireEvent("com.woltlab.gallery.image.processor","finishedProcessing")},addImage:function(e,t,a){this._queue[e]||(this._queue[e]={resize:1,rotate:1,thumbnails:1,watermarks:1},$.isPlainObject(a)&&(this._queue[e]=a),t||this.startProcessor())},startProcessor:function(){$.getLength(this._queue)&&this._sendRequest()}}),Gallery.Image.ThumbnailGenerator=Class.extend({generateThumbnails:function(e,t,a){a=a||!1,new WCF.Action.Proxy({autoSend:!0,data:{actionName:"generateThumbnails",className:"gallery\\data\\image\\ImageAction",objectIDs:[e],parameters:{refresh:a}},showLoadingOverlay:!1,success:$.proxy(function(a){a.returnValues.pendingThumbnails?this.generateThumbnails(e,t):$.isFunction(t)&&t(e,a.returnValues)},this)})}}),Gallery.Image.Handler.Image=Class.extend({_createThumbnail:!1,_data:{},_errors:{},_imageID:0,_imageHandler:null,_removeImageIcon:null,_thumbnail:null,_thumbnailContainer:null,init:function(e,t,a,i){if(this._imageID=e,this._data=t||{},this._thumbnailContainer=a,this._createThumbnail=i||!1,this._thumbnail=this._thumbnailContainer&&this._thumbnailContainer.children("img").length?this._thumbnailContainer.children("img").eq(0):null,this._thumbnail)this._thumbnail.click($.proxy(this._editImage,this));else if(this._createThumbnail){this._thumbnailContainer=$("<li />");var s=$("#thumbnailList > .jsImageUpload");s.length?this._thumbnailContainer.insertBefore(s):this._thumbnailContainer.appendTo($("#thumbnailList")),this._addThumbnail(this._thumbnailContainer)}this._thumbnailContainer.data({imageData:t,imageID:e})},_addThumbnail:function(e){e.children(".icon-spinner").remove(),this._thumbnail=$('<img src="'+this.get("tinyURL")+'" alt="" />').appendTo(e);var t=$('<ul class="imageOptions" />').appendTo(e);this._removeImageIcon=$('<span class="icon icon16 icon-remove pointer jsTooltip" title="'+WCF.Language.get("wcf.global.button.delete")+'" />').data("imageID",this.getImageID()),this._imageHandler&&this._removeImageIcon.click($.proxy(this._imageHandler.removeImageByClick,this._imageHandler)),t.append($("<li />").append(this._removeImageIcon)),e.append(t),e.trigger("didLoadImage"),this._thumbnail.click($.proxy(this._editImage,this))},_editImage:function(){this._imageHandler.setActiveImage(this)},addError:function(e,t){this._errors[e]=t},get:function(e){return void 0!==this._data[e]?this._data[e]:null},getData:function(){return this._data},getErrors:function(){return this._errors},getImageID:function(){return this._imageID},getImageHandler:function(){return this._imageHandler},getThumbnail:function(){return this._thumbnail},getThumbnailContainer:function(){return this._thumbnailContainer},remove:function(){this._thumbnailContainer.remove()},set:function(e,t){this._data[e]=t},setData:function(e){this._data=e},setErrors:function(e){this._errors=e},setImageHandler:function(e){this._imageHandler=e,this._removeImageIcon&&this._removeImageIcon.click($.proxy(this._imageHandler.removeImageByClick,this._imageHandler))},showTinyThumbnail:function(){this._addThumbnail(this._thumbnailContainer)},validate:function(){this.setErrors({});var e=this._imageHandler.getDataHandlers();for(var t in e)if(!e[t].validateData(this))return this._thumbnail&&this._thumbnail.parent("li").addClass("imageError"),!1;return this._thumbnail&&this._thumbnail.parent("li").hasClass("imageError")&&this._thumbnail.parent("li").removeClass("imageError"),!0}}),Gallery.Image.Clipboard=Class.extend({_categoryID:0,_environment:"category",_updateHandler:null,init:function(updateHandler,environment,categoryID){this._updateHandler=updateHandler,this._environment=environment,this._categoryID=categoryID?categoryID:0,this._dialog=$("<div />").appendTo(document.body),this._proxy=new WCF.Action.Proxy({success:$.proxy(this._success,this)}),$(".jsClipboardEditor").each($.proxy(function(index,container){var $container=$(container),$types=eval($container.data("types"));return WCF.inArray("com.woltlab.gallery.image",$types)?($container.on("clipboardAction",$.proxy(this._execute,this)),$container.on("clipboardActionResponse",$.proxy(this._evaluateResponse,this)),!1):void 0},this))},_execute:function(e,t,a,i){if("com.woltlab.gallery.image"===t)switch(a){case"com.woltlab.gallery.image.edit":window.location.redirect(i.redirectURL);break;case"com.woltlab.gallery.image.moveToAlbum":this._proxy.setOption("data",{actionName:"prepareMoveToAlbum",className:"gallery\\data\\image\\ImageAction",objectIDs:i.objectIDs}),this._proxy.sendRequest()}},_evaluateResponse:function(e,t,a){if("com.woltlab.gallery.image"===a&&t.returnValues.imageData&&$.getLength(t.returnValues.imageData))for(var i in t.returnValues.imageData)this._updateHandler.update(i,t.returnValues.imageData[i])},_moveToAlbum:function(){this._proxy.setOption("data",{actionName:"moveToAlbum",className:"gallery\\data\\image\\ImageAction",objectIDs:this._dialog.data("objectIDs"),parameters:{albumID:parseInt(this._dialog.find("#albumID").val())}}),this._proxy.sendRequest(),this._dialog.wcfDialog("close")},_success:function(e){switch(e.actionName){case"prepareMoveToAlbum":this._dialog.data("objectIDs",e.objectIDs).html(e.returnValues.template),this._dialog.wcfDialog({title:WCF.Language.get("gallery.image.moveToAlbum")}),this._dialog.find(".formSubmit > input[type=submit]").click($.proxy(this._moveToAlbum,this));break;case"moveToAlbum":window.location.reload()}}}),Gallery.Image.UpdateHandler=Class.extend({_images:{},init:function(){$(".galleryImage").each($.proxy(function(e,t){var a=$(t);this._images[a.data("objectID")]=a},this))},update:function(e,t){if(!this._images[e])return void console.debug("[Gallery.Image.UpdateHandler] Unknown image id "+e);for(var a in t)this._updateProperty(e,a,t[a])},_updateProperty:function(e,t,a){switch(t){case"deleted":this._delete(e,a);break;case"deleteNote":this._deleteNote(e,a);break;case"isDeleted":a?this._trash(e):this._restore(e);break;case"isDisabled":a?this._disable(e):this._enable(e);break;default:this._handleCustomProperty(e,t,a)}},_handleCustomProperty:function(e,t,a){this._images[e].trigger("imageUpdateHandlerProperty",[e,t,a])},_delete:function(){},_deleteNote:function(){},_disable:function(e){this._images[e].data("isDisabled",1)},_enable:function(e){this._images[e].data("isDisabled",0)},_restore:function(e){this._images[e].data("isDeleted",0)},_trash:function(e){this._images[e].data("isDeleted",1)},getValue:function(e,t){if(!this._images[e])return void console.debug("[Gallery.Image.UpdateHandler] Unknown image id "+e);switch(t){case"isDeleted":return this._images[e].data("isDeleted");case"isDisabled":return this._images[e].data("isDisabled")}}}),Gallery.Image.UpdateHandler.ImageList=Gallery.Image.UpdateHandler.extend({_delete:function(e){this._images[e].remove(),delete this._images[e],WCF.Clipboard.reload()},_disable:function(e){this._super(e),this._images[e].addClass("imageDisabled")},_enable:function(e){this._super(e),this._images[e].removeClass("imageDisabled")},_restore:function(e){this._super(e),this._images[e].removeClass("imageDeleted")},_trash:function(e){this._super(e),this._images[e].data("canViewDeletedImage")||window.location.reload(),this._images[e].addClass("imageDeleted")}}),Gallery.Image.UpdateHandler.Image=Gallery.Image.UpdateHandler.extend({_delete:function(e,t){new WCF.PeriodicalExecuter(function(e){e.stop(),window.location=t},1e3)},_deleteNote:function(e,t){$('<p class="messageFooterNote marginTopSmall galleryImageDeleteNote">'+t+"</p>").prependTo($(".galleryImageContainer"))},_disable:function(e){this._super(e);var t=$('<span class="badge label jsLabelDisabled">'+WCF.Language.get("gallery.image.isDisabled")+"</span>"),a=$(".galleryImageHeadline > h1"),i=a.children(".jsLabelDeleted");i.length?t.insertAfter(i):t.prependTo(a),t.append(" ")},_enable:function(e){this._super(e),$(".galleryImageHeadline > h1 > .jsLabelDisabled").remove()},_restore:function(e){this._super(e),$(".galleryImageHeadline > h1 > .jsLabelDeleted").remove(),this._images[e].parent().find(".galleryImageDeleteNote").remove()},_trash:function(e){this._super(e);var t=$('<span class="badge label red jsLabelDeleted">'+WCF.Language.get("gallery.image.isDeleted")+"</span>").prependTo($(".galleryImageHeadline > h1"));t.append(" ")}}),Gallery.Image.DataHandler={},Gallery.Image.DataHandler.Base=Class.extend({_data:{},_imageHandler:null,_overwriteIcons:[],init:function(){this._data={},this._imageHandler=null,this._overwriteIcons=[],WCF.System.Event.addListener("com.woltlab.gallery.imageHandler","overwriteData",$.proxy(this._overwriteData,this))},_overwriteData:function(){},_toggleOverwriteIcons:function(){if(1==$.getLength(this._imageHandler.getImages()))for(var e in this._overwriteIcons)this._overwriteIcons[e].hide();else for(var e in this._overwriteIcons)this._overwriteIcons[e].show()},getData:function(){return this._data},getImageHandler:function(){return this._imageHandler},readData:function(){},setImageHandler:function(e){this._imageHandler=e,this._imageHandler.registerCallback("addImage",$.proxy(this._toggleOverwriteIcons,this)),this._imageHandler.registerCallback("removeImage",$.proxy(this._toggleOverwriteIcons,this))},updateData:function(){},validateData:function(){return!0}}),Gallery.Image.DataHandler.Default=Gallery.Image.DataHandler.Base.extend({_categoryIDs:[],_categoryIDsError:null,_descriptionError:null,_maxDescriptionLength:0,_messageSettings:{},_titleError:null,init:function(e,t,a){this._super(),this._categoryIDs=e,this._maxDescriptionLength=t,this._messageSettings=a;var i=$('<span class="icon icon16 icon-refresh pointer jsTooltip galleryOverwriteIcon" title="'+WCF.Language.get("gallery.image.button.overwrite")+'" />').click($.proxy(this._overwriteTitle,this));this._overwriteIcons.push(i);var s=$("#title").parent().prev("dt");s.children("label").css("display","inline-block"),s.append(i);var r=$('<span class="icon icon16 icon-refresh pointer jsTooltip galleryOverwriteIcon" title="'+WCF.Language.get("gallery.image.button.overwrite")+'" />').click($.proxy(this._overwriteCategories,this));this._overwriteIcons.push(r),$("#flexibleCategoryList").prev("legend").append(r);var n=$('<span class="icon icon16 icon-refresh pointer jsTooltip galleryOverwriteIcon" title="'+WCF.Language.get("gallery.image.button.overwrite")+'" />').click($.proxy(this._overwriteDescription,this));this._overwriteIcons.push(n);var s=$("#text").parents("dl:eq(0)").prev("legend");s.children("label").css("display","inline-block"),s.append(n),$("#useFilenameAsTitle").on("change",$.proxy(this._change,this))},_change:function(e){if($(e.currentTarget).is(":checked")){var t=this.getImageHandler().getActiveImage().get("filename");t=t.substr(0,t.lastIndexOf(".")),$("#title").val(t).disable()}else $("#title").val("").enable()},_getCategoryIDs:function(){var e=[];return $('input[name="categoryIDs[]"]').each(function(t,a){var i=$(a);i.prop("checked")&&e.push(parseInt(i.val()))}),e},_hideCategoryIDsError:function(){null!==this._categoryIDsError&&this._categoryIDsError.hide();

},_hideDescriptionError:function(){null!==this._descriptionError&&this._descriptionError.hide()},_hideTitleError:function(){null!==this._titleError&&this._titleError.hide()},_needCategoriesOverwriteConfirmation:function(){var e=this.getImageHandler().getImages();for(var t in e)if(this.getImageHandler().getActiveImage().getImageID()!=t){var a=e[t].get("categoryIDs");if(a&&a.length)return!0}return!1},_needDescriptionOverwriteConfirmation:function(){var e=this.getImageHandler().getImages();for(var t in e)if(this.getImageHandler().getActiveImage().getImageID()!=t&&$.trim(e[t].get("description")))return!0;return!1},_needTitleOverwriteConfirmation:function(){var e=this.getImageHandler().getImages();for(var t in e)if(this.getImageHandler().getActiveImage().getImageID()!=t&&e[t].get("title"))return!0;return!1},_overwriteCategories:function(e){e.preventDefault(),this._needCategoriesOverwriteConfirmation()?WCF.System.Confirmation.show(WCF.Language.get("gallery.image.categoryIDs.overwrite.confirmMessage"),$.proxy(function(e){"confirm"===e&&this._setCategoryIDs()},this)):this._setCategoryIDs()},_overwriteData:function(){this._setCategoryIDs(!1),this._setDescription(!1),this._setTitle(!1)},_overwriteDescription:function(e){e.preventDefault(),this._needDescriptionOverwriteConfirmation()?WCF.System.Confirmation.show(WCF.Language.get("gallery.image.description.overwrite.confirmMessage"),$.proxy(function(e){"confirm"===e&&this._setDescription()},this)):this._setDescription()},_overwriteTitle:function(e){e.preventDefault(),this._needTitleOverwriteConfirmation()?WCF.System.Confirmation.show(WCF.Language.get("gallery.image.title.overwrite.confirmMessage"),$.proxy(function(e){"confirm"===e&&this._setTitle()},this)):this._setTitle()},_setCategoryIDs:function(e){void 0===e&&(e=!0);var t=this._getCategoryIDs(),a=this.getImageHandler().getImages();for(var i in a)this.getImageHandler().getActiveImage().getImageID()!=i&&a[i].set("categoryIDs",t);e&&(new WCF.System.Notification).show()},_setDescription:function(e){void 0===e&&(e=!0);var t=$("#text").redactor("wutil.getText"),a=$("#preParse").is(":checked")?1:0,i=$("#enableSmilies").is(":checked")?1:0,s=$("#enableBBCodes").is(":checked")?1:0,r=$("#enableHtml").is(":checked")?1:0,n=this.getImageHandler().getImages();for(var o in n)this.getImageHandler().getActiveImage().getImageID()!=o&&(n[o].set("description",t),n[o].set("preParse",a),n[o].set("enableSmilies",i),n[o].set("enableBBCodes",s),n[o].set("enableHtml",r));e&&(new WCF.System.Notification).show()},_setTitle:function(e){void 0===e&&(e=!0);var t=$("#useFilenameAsTitle").is(":checked"),a=$("#title").val(),i=this.getImageHandler().getImages();for(var s in i)if(this.getImageHandler().getActiveImage().getImageID()!=s){if(i[s].set("useFilenameAsTitle",t?1:0),t){var r=i[s].get("filename");r=r.substr(0,r.lastIndexOf("."))}i[s].set("title",t?r:a)}e&&(new WCF.System.Notification).show()},_showCategoryIDsError:function(e){null===this._categoryIDsError&&(this._categoryIDsError=$('<small class="innerError" />').hide(),$("#flexibleCategoryList").after(this._categoryIDsError)),this._categoryIDsError.text(e).show()},_showDescriptionError:function(e){null===this._descriptionError&&(this._descriptionError=$('<small class="innerError" />').hide(),$("#text").closest("dd").append(this._descriptionError)),this._descriptionError.text(e).show()},_showTitleError:function(e){null===this._titleError&&(this._titleError=$('<small class="innerError" />').hide(),$("#title").after(this._titleError)),this._titleError.text(e).show()},readData:function(){this._data={categoryIDs:this._getCategoryIDs(),description:$("#text").redactor("wutil.getText"),enableBBCodes:$("#enableBBCodes").is(":checked")?1:0,enableHtml:$("#enableHtml").is(":checked")?1:0,enableSmilies:$("#enableSmilies").is(":checked")?1:0,title:$("#title").val(),preParse:$("#preParse").is(":checked")?1:0,useFilenameAsTitle:$("#useFilenameAsTitle").is(":checked")?1:0}},updateData:function(){$(window).resize();var e=this.getImageHandler().getActiveImage().getData();this._data={categoryIDs:e.categoryIDs||[],description:e.description||"",enableBBCodes:e.enableBBCodes||this._messageSettings.enableBBCodes,enableHtml:e.enableHtml||this._messageSettings.enableHtml,enableSmilies:e.enableSmilies||this._messageSettings.enableSmilies,preParse:e.preParse||this._messageSettings.preParse,title:e.title||"",useFilenameAsTitle:e.useFilenameAsTitle||0};var t=this.getImageHandler().getActiveImage().getErrors();if(void 0!==t.categoryIDs?this._showCategoryIDsError(t.categoryIDs):this._hideCategoryIDsError(),void 0!==t.description?this._showDescriptionError(t.description):this._hideDescriptionError(),void 0!==t.title?this._showTitleError(t.title):this._hideTitleError(),$("#useFilenameAsTitle").prop("checked",this._data.useFilenameAsTitle?!0:!1),this._data.useFilenameAsTitle){var a=e.filename;a=a.substr(0,a.lastIndexOf(".")),$("#title").val(a).disable()}else $("#title").val(this._data.title).enable();$('input[name="categoryIDs[]"]').each($.proxy(function(e,t){var a=$(t);-1==this._data.categoryIDs.indexOf(parseInt(a.val()))?a.prop("checked",!1):a.prop("checked",!0)},this)),$("#text").redactor("wutil.replaceText",this._data.description);var i=$(document).scrollTop();$("#title").focus().blur(),$(document).scrollTop(i),$("#enableBBCodes").prop("checked",this._data.enableBBCodes?!0:!1),$("#enableHtml").prop("checked",this._data.enableHtml?!0:!1),$("#enableSmilies").prop("checked",this._data.enableSmilies?!0:!1),$("#preParse").prop("checked",this._data.preParse?!0:!1)},validateData:function(e){var t=e.getData(),a=!0;if(void 0===t.title||""==t.title?(e.addError("title",WCF.Language.get("wcf.global.form.error.empty")),a=!1):t.title.length>255&&(e.addError("title",WCF.Language.get("gallery.image.title.error.tooLong")),a=!1),void 0===t.description?t.description="":t.description.length>this._maxDescriptionLength&&(e.addError("description",WCF.Language.get("gallery.image.description.error.tooLong")),a=!1),void 0!==t.categoryIDs&&t.categoryIDs.length){for(var i in t.categoryIDs)if(-1==this._categoryIDs.indexOf(t.categoryIDs[i])){e.addError("categoryIDs",WCF.Language.get("gallery.image.categoryIDs.error.notValid")),a=!1;break}}else e.addError("categoryIDs",WCF.Language.get("wcf.global.form.error.empty")),a=!1;return a}}),Gallery.Image.DataHandler.EnableComments=Gallery.Image.DataHandler.Base.extend({init:function(){this._super();var e=$('<span class="icon icon16 icon-refresh pointer jsTooltip galleryOverwriteIcon" title="'+WCF.Language.get("gallery.image.button.overwrite")+'" />').click($.proxy(this._click,this));this._overwriteIcons.push(e);var t=$("#enableComments").closest("dl").children("dt");t.append(e),WCF.DOMNodeInsertedHandler.execute()},_click:function(e){e.preventDefault(),this._needOverwriteConfirmation()?WCF.System.Confirmation.show(WCF.Language.get("gallery.image.enableComments.overwrite.confirmMessage"),$.proxy(function(e){"confirm"===e&&this._setEnableComments()},this)):this._setEnableComments()},_needOverwriteConfirmation:function(){var e=$("#enableComments").is(":checked")?1:0,t=this.getImageHandler().getImages();for(var a in t)if(this.getImageHandler().getActiveImage().getImageID()!=a&&t[a].get("enableComments")!=e)return!0;return!1},_overwriteData:function(){this._setEnableComments(!1)},_setEnableComments:function(e){void 0===e&&(e=!0);var t=this.getImageHandler().getImages();for(var a in t)this.getImageHandler().getActiveImage().getImageID()!=a&&t[a].set("enableComments",$("#enableComments").is(":checked")?1:0);e&&(new WCF.System.Notification).show()},readData:function(){this._data={enableComments:$("#enableComments").is(":checked")?1:0}},updateData:function(){var e=this.getImageHandler().getActiveImage().getData();this._data={enableComments:void 0!==e.enableComments?e.enableComments:1},$("#enableComments").prop("checked",this._data.enableComments?!0:!1)}}),Gallery.Image.DataHandler.Album=Gallery.Image.DataHandler.Base.extend({_albumIDError:null,_albumIDs:[],_maxAlbums:0,_systemNotification:null,init:function(e,t){this._super(),this._albumIDs=e,this._maxAlbums=t,this._albumIDError=null;var a=$('<span class="icon icon16 icon-refresh pointer jsTooltip galleryOverwriteIcon" title="'+WCF.Language.get("gallery.image.button.overwrite")+'" />').click($.proxy(this._click,this));this._overwriteIcons.push(a);var i=$("#albumID").parent().prev("dt");if(i.children("label").css("display","inline-block"),i.append(a),!this._albumIDs.length){$("#albumID").hide();for(var s in this._overwriteIcons)this._overwriteIcons[s].hide()}e.length<t&&(this._albumDialog=new Gallery.Album.Dialog,this._albumDialog.registerCallback("created",$.proxy(this._addNewAlbum,this)),this._albumAddIcon=$('<span class="icon icon16 icon-plus pointer jsTooltip" title="'+WCF.Language.get("gallery.album.button.add")+'" />').click($.proxy(this._addAlbum,this)).css("margin-left","5px"),$("#albumID").after(this._albumAddIcon)),WCF.DOMNodeInsertedHandler.execute()},_addAlbum:function(){this._albumDialog.show()},_addNewAlbum:function(e){if(this._albumIDs.push(parseInt(e.albumID)),1==this._albumIDs.length&&($("#albumID").show(),$.getLength(this._imageHandler.getImages())>1))for(var t in this._overwriteIcons)this._overwriteIcons[t].show();$("#albumID").append($('<option value="'+e.albumID+'" />').text(e.title)).val(e.albumID),this._albumIDs.length>=this._maxAlbums?(this._albumAddIcon.remove(),new WCF.System.Notification(WCF.Language.get("gallery.image.upload.albumLimitReached"),"warning").show(void 0,5e3)):(null===this._systemNotification&&(this._systemNotification=new WCF.System.Notification),this._systemNotification.show())},_click:function(e){e.preventDefault(),this._needOverwriteConfirmation()?WCF.System.Confirmation.show(WCF.Language.get("gallery.image.albumID.overwrite.confirmMessage"),$.proxy(function(e){"confirm"===e&&this._setAlbumID()},this)):this._setAlbumID()},_hideAlbumIDError:function(){null!==this._albumIDError&&this._albumIDError.hide()},_needOverwriteConfirmation:function(){var e=this.getImageHandler().getImages();for(var t in e)if(this.getImageHandler().getActiveImage().getImageID()!=t&&e[t].get("albumID"))return!0;return!1},_overwriteData:function(){this._setAlbumID(!1)},_setAlbumID:function(e){void 0===e&&(e=!0);var t=this.getImageHandler().getImages();for(var a in t)this.getImageHandler().getActiveImage().getImageID()!=a&&t[a].set("albumID",parseInt($("#albumID").val()||0));e&&(new WCF.System.Notification).show()},_showAlbumIDError:function(e){null===this._albumIDError&&(this._albumIDError=$('<small class="innerError" />').hide(),$("#albumID").parent().append(this._albumIDError)),this._albumIDError.text(e).show()},_toggleOverwriteIcons:function(){this._albumIDs.length&&this._super()},readData:function(){this._data={albumID:parseInt($("#albumID").val()||0)}},updateData:function(){var e=this.getImageHandler().getActiveImage().getData();this._data={albumID:e.albumID||0},$("#albumID").val(this._data.albumID);var t=this.getImageHandler().getActiveImage().getErrors();void 0!==t.albumID?this._showAlbumIDError(t.albumID):this._hideAlbumIDError()},validateData:function(e){var t=e.getData();return t.albumID&&-1==this._albumIDs.indexOf(t.albumID)?(e.addError("albumID",WCF.Language.get("wcf.global.form.error.noValidSelection")),!1):!0}}),Gallery.Image.DataHandler.Tagging=Gallery.Image.DataHandler.Base.extend({_tagList:null,init:function(){this._super(),this._readTagList();var e=$('<span class="icon icon16 icon-refresh pointer jsTooltip galleryOverwriteIcon" title="'+WCF.Language.get("gallery.image.button.overwrite")+'" />').click($.proxy(this._click,this));this._overwriteIcons.push(e);var t=$("#tagList").parent().prev("dt");t.children("label").css("display","inline-block").append(e)},_click:function(e){e.preventDefault(),this._needOverwriteConfirmation()?WCF.System.Confirmation.show(WCF.Language.get("gallery.image.tags.overwrite.confirmMessage"),$.proxy(function(e){"confirm"===e&&this._setTags()},this)):this._setTags()},_getTags:function(){var e=this._tagList.getTags(),t=this._tagList.getSearchInput().val();return t&&-1==e.indexOf(t)&&e.push(this._tagList.getSearchInput().val()),e},_needOverwriteConfirmation:function(){var e=this.getImageHandler().getImages();for(var t in e)if(this.getImageHandler().getActiveImage().getImageID()!=t&&($tags=e[t].get("tags"),$tags&&$tags.length))return!0;return!1},_overwriteData:function(){this._setTags(!1)},_readTagList:function(){this._tagList=$("#tagList").data("__api")},_setTags:function(e){void 0===e&&(e=!0);var t=this._getTags(),a=this.getImageHandler().getImages();for(var i in a)this.getImageHandler().getActiveImage().getImageID()!=i&&a[i].set("tags",t);e&&(new WCF.System.Notification).show()},readData:function(){void 0===this._tagList&&this._readTagList(),this._data={tags:this._getTags()}},updateData:function(){void 0===this._tagList&&this._readTagList();var e=this.getImageHandler().getActiveImage().getData();this._data={tags:e.tags||""},this._tagList.clearList(),this._tagList.load(this._data.tags),this._tagList.getSearchInput().val("")}}),Gallery.Image.DataHandler.Location=Gallery.Image.DataHandler.Base.extend({_locationInput:null,_useCoordinates:null,_userLatitude:null,_userLongitude:null,init:function(){this._super(),this._locationInput=new WCF.Location.GoogleMaps.LocationInput("mapContainer",void 0,"#geocode",WCF.Location.GoogleMaps.Settings.get("defaultLatitude"),WCF.Location.GoogleMaps.Settings.get("defaultLongitude"),"gallery\\data\\image\\ImageAction"),WCF.Location.Util.getLocation($.proxy(function(e,t){void 0!==e&&void 0!==t&&(this._userLatitude=e,this._userLongitude=t)},this));var e=$('<span class="icon icon16 icon-refresh pointer jsTooltip galleryOverwriteIcon" title="'+WCF.Language.get("gallery.image.button.overwrite")+'" />').click($.proxy(this._click,this));this._overwriteIcons.push(e),$("#mapContainer").parents("fieldset:eq(0)").children("legend").append(e),this._useCoordinates=$("#useCoordinates").change($.proxy(this._change,this))},_change:function(){this._useCoordinates.prop("checked")?($(".jsCoordinatesField").show(),this._locationInput.getMap().refresh()):$(".jsCoordinatesField").hide()},_click:function(e){e.preventDefault(),this._needOverwriteConfirmation()?WCF.System.Confirmation.show(WCF.Language.get("gallery.image.coordinates.overwrite.confirmMessage"),$.proxy(function(e){"confirm"===e&&this._setCoordinates()},this)):this._setCoordinates()},_initLocation:function(e){if(0!=e.get("latitude")&&0!=e.get("longitude")&&!e.get("location")){var t=e.getImageID();WCF.Location.GoogleMaps.Util.reverseGeocoding($.proxy(function(e){if(e){var a=this.getImageHandler().getImage(t);a.set("__useCoordinates",!0),a.set("location",e)}},this),null,e.get("latitude"),e.get("longitude"))}},_needOverwriteConfirmation:function(){var e=this.getImageHandler().getImages();for(var t in e)if(this.getImageHandler().getActiveImage().getImageID()!=t&&0!=e[t].get("latitude")&&0!=e[t].get("longitude"))return!0;return!1},_overwriteData:function(){this._setCoordinates(!1)},_setCoordinates:function(e){void 0===e&&(e=!0);var t=WCF.Location.GoogleMaps.Util.getMarkerPosition(this._locationInput.getMarker()),a=this._useCoordinates.prop("checked"),i=this.getImageHandler().getImages(),s=$.trim($("#geocode").val());for(var r in i)if(this.getImageHandler().getActiveImage().getImageID()!=r){var n=i[r];n.set("latitude",t.latitude),n.set("location",s),n.set("longitude",t.longitude),n.set("__useCoordinates",a?1:0)}e&&(new WCF.System.Notification).show()},readData:function(){this._data=WCF.Location.GoogleMaps.Util.getMarkerPosition(this._locationInput.getMarker()),this._data.location=$("#geocode").val(),this._data.__useCoordinates=this._useCoordinates.prop("checked")?1:0},setImageHandler:function(e){this._super(e),this._imageHandler.registerCallback("addImage",$.proxy(this._initLocation,this))},updateData:function(){var e=this.getImageHandler().getActiveImage().getData();this._data={latitude:e.latitude||0,location:e.location||"",longitude:e.longitude||0,__useCoordinates:void 0!==e.__useCoordinates?e.__useCoordinates:0!=e.latitude&&0!=e.longitude},0!=this._data.latitude&&0!=this._data.longitude?WCF.Location.GoogleMaps.Util.moveMarker(this._locationInput.getMarker(),this._data.latitude,this._data.longitude,this._data.location?!1:!0):this._userLatitude&&this._userLongitude?WCF.Location.GoogleMaps.Util.moveMarker(this._locationInput.getMarker(),this._userLatitude,this._userLongitude,!0):WCF.Location.GoogleMaps.Util.moveMarker(this._locationInput.getMarker(),WCF.Location.GoogleMaps.Settings.get("defaultLatitude"),WCF.Location.GoogleMaps.Settings.get("defaultLongitude"),!0),WCF.Location.GoogleMaps.Util.focusMarker(this._locationInput.getMarker()),this._useCoordinates.prop("checked",this._data.__useCoordinates?!0:!1),$("#geocode").val(this._data.location),this._change()}}),Gallery.Image.PendingImageHandler=Class.extend({_imageHandler:null,init:function(e){this._imageHandler=e,$("#loadPendingImages").click($.proxy(this._loadImages,this)),$("#deletePendingImages").click($.proxy(this._deleteImages,this))},_deleteImages:function(){WCF.System.Confirmation.show(WCF.Language.get("gallery.image.pendingImages.delete.confirmMessage"),$.proxy(function(e){"confirm"===e&&new WCF.Action.Proxy({autoSend:!0,data:{actionName:"deletePendingImages",className:"gallery\\data\\image\\ImageAction",parameters:{tmpHash:this._imageHandler.getOption("tmpHash")}},success:$.proxy(this._success,this)})},this))},_loadImages:function(){new WCF.Action.Proxy({autoSend:!0,data:{actionName:"loadPendingImages",className:"gallery\\data\\image\\ImageAction",parameters:{tmpHash:this._imageHandler.getOption("tmpHash")}},success:$.proxy(this._success,this)})},_success:function(e){switch(e.actionName){case"deletePendingImages":$("#thumbnailListContainer > fieldset > small").html(e.returnValues.limits),this._imageHandler.setUserImageCount(e.returnValues.userImageCount);break;case"loadPendingImages":if(e.returnValues){for(var t in e.returnValues)this._imageHandler.addImage(t,new Gallery.Image.Handler.Image(t,e.returnValues[t],null,!0));this._imageHandler.getActiveImage()||this._imageHandler.setFirstImageActive()}}(new WCF.System.Notification).show(),$("#pendingImageContainer").remove()}}),Gallery.Image.ThumbnailAreaSelector=Class.extend({_button:null,_buttonList:null,_imageDimensions:{},_imageDiv:null,_imageHandler:null,_selection:null,init:function(e){this._imageHandler=e,this._overlay=$("#galleryThumbnailAreaSelectorOverlay"),this._overlay.length||(this._overlay=$('<div id="galleryThumbnailAreaSelectorOverlay" class="dialogOverlay" />').css({height:"100%",zIndex:399}).hide().appendTo(document.body)),this._imageDiv=$("<div />").css({overflow:"hidden",position:"absolute",zIndex:400}).hide().appendTo(document.body),this._selection=$('<div id="galleryImageThumbnailAreaSelector" />').appendTo(this._imageDiv).resizable({aspectRatio:!0,containment:"parent",handles:"n, e, s, w, ne, se, sw, nw",resize:$.proxy(this._updateSelection,this)}).draggable({containment:"parent",drag:$.proxy(this._updateSelection,this)}),this._selection.append($('<div class="galleryImageThumbnailArea" />')),this._buttonList=$('<ul id="galleryImageThumbnailAreaButtons" class="buttonList smallButtons" />').hide().appendTo(document.body);var t=$("<li />").appendTo(this._buttonList);$('<span class="button buttonPrimary small" />').text(WCF.Language.get("gallery.image.thumbnail.chooseSelection")).click($.proxy(this._saveArea,this)).appendTo(t);var a=$("<li />").appendTo(this._buttonList);$('<span class="button small" />').text(WCF.Language.get("wcf.global.button.cancel")).click($.proxy(this._cancelSelection,this)).appendTo(a),$(window).resize($.proxy(this._resize,this)),this._button=$("#selectThumbnailAreaButton").click($.proxy(this._click,this))},_cancelSelection:function(){this._buttonList.hide(),this._overlay.hide(),this._imageDiv.hide();var e=this._imageHandler.getActiveImage();if(e.get("thumbnailWidth")){var t=$("#image"),a=Math.ceil(e.get("thumbnailX")/e.get("width")*t.width()),i=Math.ceil(e.get("thumbnailY")/e.get("height")*t.height());this._selection.css({"background-position":"-"+a+"px -"+i+"px",height:Math.ceil(e.get("thumbnailHeight")*t.height()/e.get("height")),left:a,top:i,width:Math.ceil(e.get("thumbnailWidth")*t.width()/e.get("width"))}),this._selection.draggable("option","disabled",!0).resizable("option","disabled",!0).addClass("disabled")}},_click:function(){this.refresh(null,!0);var e=this._imageHandler.getImageNode(),t=this._imageHandler.getActiveImage();if(t.get("width")>1200&&t.get("height")>900)this._selection.resizable("option","minHeight",Math.floor(e.height()/t.get("height")*Math.min(t.get("height"),900))),this._selection.resizable("option","minWidth",Math.floor(e.width()/t.get("width")*Math.min(t.get("width"),1200)));else if(t.get("width")>560&&t.get("height")>420)this._selection.resizable("option","minHeight",Math.floor(e.height()/t.get("height")*Math.min(t.get("height"),420))),this._selection.resizable("option","minWidth",Math.floor(e.width()/t.get("width")*Math.min(t.get("width"),560)));else{if(!(t.get("width")>280&&t.get("height")>210))return;this._selection.resizable("option","minHeight",Math.floor(e.height()/t.get("height")*Math.min(t.get("height"),210))),this._selection.resizable("option","minWidth",Math.floor(e.width()/t.get("width")*Math.min(t.get("width"),280)))}this._buttonList.show(),this._overlay.show(),this._imageDiv.show(),this._selection.draggable("option","disabled",!1).resizable("option","disabled",!1).removeClass("disabled"),this._imageDiv.css("z-index",400)},_resize:function(){var e=this._imageHandler.getImageNode(),t=e.getDimensions();if(this._selection.is(":visible")){var a=t.height/this._imageDimensions.height,i=t.width/this._imageDimensions.width;this._selection.height(this._selection.height()*a),this._selection.width(this._selection.width()*i),this._imageDiv.height(this._imageDiv.height()*a),this._imageDiv.width(this._imageDiv.width()*i);var s=e.offset();this._imageDiv.css({left:s.left,top:s.top}),this._selection.css("background-size",t.width+"px "+t.height+"px")}this._imageDimensions=t},_saveArea:function(){var e=this._imageHandler.getActiveImage(),t=this._imageHandler.getImageNode(),a=this._selection.position();e.set("__selectionOutherHeight",this._selection.outerHeight()),e.set("__selectionOutherWidth",this._selection.outerWidth()),e.set("__selectionLeft",a.left),e.set("__selectionTop",a.top),e.set("thumbnailHeight",Math.ceil(this._selection.outerHeight()/t.height()*e.get("height"))),e.set("thumbnailWidth",Math.ceil(this._selection.outerWidth()/t.width()*e.get("width"))),e.set("thumbnailX",Math.ceil(a.left*e.get("width")/t.width())),e.set("thumbnailY",Math.ceil(a.top*e.get("height")/t.height())),e.get("thumbnailWidth")+e.get("thumbnailX")>e.get("width")&&e.set("thumbnailWidth",e.get("width")-e.get("thumbnailX")),e.get("thumbnailHeight")+e.get("thumbnailY")>e.get("height")&&e.set("thumbnailHeight",e.get("height")-e.get("thumbnailY")),this._buttonList.hide(),this._overlay.hide(),this._imageDiv.hide(),this._imageDiv.css("z-index",0)},_updateSelection:function(e,t){this._selection.css({"background-position":"-"+t.position.left+"px -"+t.position.top+"px"})},refresh:function(e,t){var a=this._imageHandler.getImageNode(),i=this._imageHandler.getActiveImage();if(i.get("width")<=280&&i.get("height")<=210)return this._selection.hide(),void this._button.hide();this._button.show();var s=a.offset();if(this._imageDiv.css({height:a.height(),left:s.left,top:s.top,width:a.width()}),i.get("thumbnailWidth")||t){var r=this._imageDiv.height(),n=this._imageDiv.width(),o=0,l=0;i.get("thumbnailWidth")?i.get("__selectionOutherWidth")?(r=i.get("__selectionOutherHeight"),n=i.get("__selectionOutherWidth"),o=i.get("__selectionLeft"),l=i.get("__selectionTop")):(r=Math.ceil(i.get("thumbnailHeight")*a.height()/i.get("height")),n=Math.ceil(i.get("thumbnailWidth")*a.width()/i.get("width")),o=Math.ceil(i.get("thumbnailX")/i.get("width")*a.width()),l=Math.ceil(i.get("thumbnailY")/i.get("height")*a.height())):.75>r/n?(n=parseInt(4*r/3),o=parseInt((this._imageDiv.width()-n)/2)):(r=parseInt(3*n/4),l=parseInt((this._imageDiv.height()-r)/2)),this._selection.css({"background-image":"url("+a.attr("src")+")","background-position":"-"+o+"px -"+l+"px","background-size":this._imageDiv.width()+"px "+this._imageDiv.height()+"px",height:r,left:o,top:l,width:n}),this._selection.parent().css({"background-color":"rgba(0, 0, 0, 0.5)"})}this._imageDimensions=a.getDimensions()}}),Gallery.Image.Marker={},Gallery.Image.Marker.Editor=Gallery.Image.DataHandler.Base.extend({_disableAdding:!1,_dialog:null,_markers:[],_markerHeightCorrection:3,init:function(){$("#image > img").click($.proxy(this._addMarker,this)).droppable({accept:".galleryImageMarker",drop:$.proxy(this._updateMarkerPosition,this),over:function(e,t){t.helper.switchClass("fa-trash","fa-map-marker")},out:function(e,t){t.helper.switchClass("fa-map-marker","fa-trash")},tolerance:"pointer"}),this._proxy=new WCF.Action.Proxy({success:$.proxy(this._success,this),autoAbortPrevious:!0}),$(window).resize($.proxy(this._refreshMarkerPositions,this)),WCF.System.Event.addListener("com.woltlab.gallery.ImageHandler","didRotateImage",$.proxy(this._rotateMarkers,this))},_addMarker:function(e){if(!this._disableAdding){this._disableAdding=!0;{$offsetY=0}if(void 0!==e.offsetX&&void 0!==e.offsetY)$offsetX=e.offsetX,$offsetY=e.offsetY;else{var t=$("#image > img").offset();$offsetX=e.pageX-t.left,$offsetY=e.pageY-t.top}var t=this.getImageHandler().getImageNode().position(),a=this._createMarker($offsetX+t.left,$offsetY+t.top);new WCF.PeriodicalExecuter($.proxy(function(e){this._showDialog(null,a),e.stop()},this),250)}},_addMarkerByData:function(e){var t=this.getImageHandler().getActiveImage(),a=this.getImageHandler().getImageNode();if(!a.width())return void a.on("load",$.proxy(this._addMarkerByData,this,e));a.off("load",$.proxy(this._addMarkerByData,this,e));var i=a.position(),s=parseInt(i.left+e.positionX/t.get("height")*a.height()),r=parseInt(e.positionY/t.get("width")*a.width());this._createMarker(s,r,e)},_changeMarkerType:function(e){"user"==$(e.currentTarget).val()?($("#galleryImageMarkerUser").show(),$("#galleryImageMarkerText").hide()):($("#galleryImageMarkerUser").hide(),$("#galleryImageMarkerText").show()),this._dialog.wcfDialog("render")},_createDialog:function(){this._dialog=$("<div />").appendTo(document.body),this._dialog.append("<fieldset><legend>"+WCF.Language.get("gallery.image.marker.type")+'</legend><dl class="wide"><dt></dt><dd class="floated"><label><input type="radio" name="markerType" value="user" /> '+WCF.Language.get("gallery.image.marker.type.user")+'</label><label><input type="radio" name="markerType" value="text" /> '+WCF.Language.get("gallery.image.marker.type.text")+'</label></dd></dl></fieldset><fieldset id="galleryImageMarkerUser" style="display: none"><legend>'+WCF.Language.get("gallery.image.marker.user")+"</legend><small>"+WCF.Language.get("gallery.image.marker.user.description")+'</small><dl class="wide"><dt></dt><dd><input type="text" name="markerUser" class="long" /></dd></dl></fieldset><fieldset id="galleryImageMarkerText" style="display: none"><legend>'+WCF.Language.get("gallery.image.marker.text")+"</legend><small>"+WCF.Language.get("gallery.image.marker.text.description")+'</small><dl class="wide"><dt></dt><dd><textarea name="markerDescription" cols="40" rows="4"></textarea></dd></dl></fieldset><div class="formSubmit"><button class="buttonPrimary" data-type="save">'+WCF.Language.get("wcf.global.button.save")+'</button><button data-type="delete">'+WCF.Language.get("wcf.global.button.delete")+"</button></div>"),this._dialog.find('input[name="markerType"]').change($.proxy(this._changeMarkerType,this)),this._dialog.find('button[data-type="delete"]').click($.proxy(this._deleteMarker,this)),this._dialog.find('button[data-type="save"]').click($.proxy(this._saveMarker,this)),new WCF.Search.User('#galleryImageMarkerUser input[name="markerUser"]',null,!1)},_createMarker:function(e,t,a){var i=$('<span class="galleryImageMarker pointer icon icon32 fa-map-marker" />').hide().appendTo(this.getImageHandler().getImageNode().parent());a&&i.data(a),i.css({left:e-parseInt(i.width()/2),position:"absolute",top:t-(i.height()-this._markerHeightCorrection)}).draggable({cursorAt:{left:parseInt(i.width()/2)+1,top:i.height()-this._markerHeightCorrection+1},start:$.proxy(this._dragStart,this),stack:".galleryImageMarker",stop:$.proxy(this._dragStop,this)});var s=this.getImageHandler().getActiveImage(),r=this.getImageHandler().getImageNode(),n=s.get("height")/r.height(),o=s.get("width")/r.width(),l=r.position();return i.data({imageID:this._imageHandler.getActiveImage().getImageID(),id:i.wcfIdentify(),positionX:(e-l.left)*n,positionY:t*o}),i.on("mouseup",$.proxy(this._showDialog,this)),i.show(),this._markers.push(i),i},_deleteMarker:function(){this._dialog.wcfDialog("close"),WCF.System.Confirmation.show(WCF.Language.get("gallery.image.marker.delete.confirmMessage"),$.proxy(function(e){"confirm"===e?this._removeMarker():this._dialog.wcfDialog("open")},this))},_dragStart:function(e,t){t.helper.data("dragStartPosition",t.helper.position())},_dragStop:function(e,t){t.helper.hasClass("fa-trash")&&(t.helper.removeClass("fa-trash").addClass("icon-spinner"),WCF.System.Confirmation.show(WCF.Language.get("gallery.image.marker.delete.confirmMessage"),$.proxy(function(e){if("confirm"===e)this._removeMarker(t.helper);else{var a=t.helper.data("dragStartPosition");t.helper.css({left:a.left,top:a.top}).removeClass("icon-spinner").addClass("fa-trash")}},this)))},_removeMarker:function(e){var t=null;t=e?e.wcfIdentify():this._dialog.data("id");for(var a=0,i=0,s=this._markers.length;s>i;i++){var r=this._markers[i];if(r.data("id")==t){a=i,e||(e=r,this._dialog.wcfDialog("close"));break}}e.wcfFadeOut(function(){$(this).remove()}),this._markers.splice(a,1)},_refreshMarkerPositions:function(){var e=this.getImageHandler().getImageNode();if(!e.width())return void e.on("load",$.proxy(this._refreshMarkerPositions,this));e.off("load",$.proxy(this._refreshMarkerPositions,this));{var t=this._imageHandler.getActiveImage(),a=e.position().left;t.get("markers")||[]}if(this._markers.length)for(var i=t.get("height")/e.height(),s=t.get("width")/e.width(),r=0;r<this._markers.length;r++){var n=this._markers[r];n.css({left:parseInt(a+n.data("positionX")/s-n.width()/2),top:parseInt(n.data("positionY")/i-(n.height()-this._markerHeightCorrection))})}},_rotateMarkers:function(e){var t=this.getMarkers();for(var a in t){var i=(t[a],$positionX=t[a].data("positionX")),s=$positionY=t[a].data("positionY");switch(e.angle){case 90:i=e.width*e.scaleFactor-$positionY,s=$positionX;break;case 180:i=e.width*e.scaleFactor-$positionX,s=e.height*e.scaleFactor-$positionY;break;case 270:i=$positionY,s=e.height*e.scaleFactor-$positionX}t[a].data("positionX",parseInt(i)),t[a].data("positionY",parseInt(s))}this._markers=t,this._refreshMarkerPositions()},_saveMarker:function(e,t){var a=this._dialog.find('input[name="markerType"]:checked').val(),i=this._dialog.find('input[name="markerUser"]').val(),s=this._dialog.find('textarea[name="markerDescription"]').val();if(this._validateData(a,i,t,s)){for(var r=null,n=0,o=this._markers.length;o>n;n++){var l=this._markers[n];if(l.wcfIdentify()==this._dialog.data("id")){r=l;break}}r.data({description:"text"==a?s:"",type:a,userID:"user"==a?t:null,username:"user"==a?i:null}),this._dialog.wcfDialog("close")}},_showDialog:function(e,t){var a=null;if(t)a=t;else var a=$(e.currentTarget);e&&a.hasClass("ui-draggable-dragging")||(this._dialog||this._createDialog(),this._dialog.data("id",a.wcfIdentify()),a.data("type")?(this._dialog.find('input[name="markerType"][value="'+a.data("type")+'"]').prop("checked",!0),this._dialog.find('input[name="markerUser"]').val(a.data("username")),this._dialog.find('textarea[name="markerDescription"]').val(a.data("description")),"user"==a.data("type")?($("#galleryImageMarkerUser").show(),
$("#galleryImageMarkerText").hide()):($("#galleryImageMarkerUser").hide(),$("#galleryImageMarkerText").show()),this._dialog.find(".innerError").hide(),this._dialog.wcfDialog({title:WCF.Language.get("gallery.image.marker.edit")})):(this._dialog.find('input[name="markerType"]').prop("checked",!1),this._dialog.find('input[name="markerUser"],textarea[name="markerDescription"]').val(""),$("#galleryImageMarkerUser, #galleryImageMarkerText").hide(),this._dialog.wcfDialog({closable:!1,title:WCF.Language.get("gallery.image.marker.add")}),this._disableAdding=!1))},_success:function(e){var t=this._dialog.find('input[name="markerUser"]').val();if($.getLength(e.returnValues))for(var a in e.returnValues)if(e.returnValues[a].label===t)return void this._saveMarker(null,e.returnValues[a].objectID);this._saveMarker(null,!1)},_updateMarkerPosition:function(e,t){var a=this.getImageHandler().getActiveImage(),i=this.getImageHandler().getImageNode(),s=a.get("height")/i.height(),r=a.get("width")/i.width(),n=i.position(),o=t.draggable,l=o.position();o.data({positionX:(l.left-n.left+parseInt(o.width()/2))*s,positionY:(l.top+(o.height()-this._markerHeightCorrection))*r})},_validateData:function(e,t,a,i){if($validFields=!0,"user"!=e&&"text"!=e){$validFields=!1;var s=this._dialog.find('input[name="markerType"]').parent().next(".innerError");s.length||(s=$('<small class="innerError" />').text(WCF.Language.get("wcf.global.form.error.empty")),this._dialog.find('input[name="markerType"]').parent().parent().append(s)),s.show()}else this._dialog.find('input[name="markerType"]').parent().next(".innerError").hide();if("user"==e)if(t){if(void 0===a)return this._proxy.setOption("data",{actionName:"getSearchResultList",className:"wcf\\data\\user\\UserAction",parameters:{data:{includeUserGroups:!1,searchString:t}}}),void this._proxy.sendRequest();if(a===!1){$validFields=!1;var s=this._dialog.find('input[name="markerUser"]').next(".innerError");s.length||(s=$('<small class="innerError" />').text(WCF.Language.get("wcf.user.username.error.notFound",{username:t})),this._dialog.find('input[name="markerUser"]').parent().append(s)),s.text(WCF.Language.get("wcf.user.username.error.notFound",{username:t})).show()}}else{$validFields=!1;var s=this._dialog.find('input[name="markerUser"]').next(".innerError");s.length||(s=$('<small class="innerError" />').text(WCF.Language.get("wcf.global.form.error.empty")),this._dialog.find('input[name="markerUser"]').parent().append(s)),s.text(WCF.Language.get("wcf.global.form.error.empty")).show()}else this._dialog.find('input[name="markerUser"]').next(".innerError").hide();if("text"!=e||i)this._dialog.find('textarea[name="markerDescription"]').next(".innerError").hide();else{$validFields=!1;var s=this._dialog.find('textarea[name="markerDescription"]').next(".innerError");s.length||(s=$('<small class="innerError" />').text(WCF.Language.get("wcf.global.form.error.empty")),this._dialog.find('textarea[name="markerDescription"]').parent().append(s)),s.show()}return $validFields},getData:function(){return{markers:this.getMarkersData(this.getMarkers())}},getMarkers:function(){return this._markers},getMarkersData:function(e){for(var t=[],a=0,i=e.length;i>a;a++){var s=e[a],r={description:s.data("description")||"",id:s.wcfIdentify(),imageID:s.data("imageID"),positionX:s.data("positionX"),positionY:s.data("positionY")};s.data("markerID")&&(r.markerID=s.data("markerID")),s.data("userID")&&(r.userID=s.data("userID"),r.username=s.data("username")),t.push(r)}return t},setMarkers:function(e){this.getImageHandler().getImageNode().parent().find(".galleryImageMarker").hide(),this._markers=[];for(var t=0,a=e.length;a>t;t++)e[t].id?this._markers.push($("#"+e[t].id).show()):this._addMarkerByData(e[t]);this._refreshMarkerPositions()},updateData:function(){this.setMarkers(this.getImageHandler().getActiveImage().get("markers")||[])}}),Gallery.Image.Marker.Handler=Class.extend({_image:null,_imageContainer:null,_imageHeight:0,_imageWidth:0,_markers:[],init:function(e,t,a){this._markers=e,this._imageWidth=t,this._imageHeight=a,this._imageContainer=$(".galleryImage"),this._image=this._imageContainer.find("> a > img").eq(0),this._image.width()?this._addMarkers():this._image.on("load",$.proxy(this._addMarkers,this)),$(window).resize($.proxy(this.refreshMarkerPositions,this)),$(".jsGalleryImageMarkedUser").hover($.proxy(this._highlightMarkedUser,this))},_addMarkers:function(){this._image.off("load",$.proxy(this._addMarkers,this));for(var e=0,t=this._markers.length;t>e;e++){var a=this._markers[e];a.userID?this._addUserMarker(a):this._addTextMarker(a)}},_addTextMarker:function(e){var t=$('<span class="galleryImageMarker galleryImageTextMarker" />').data(e);this._imageContainer.append(t),this._setMarkerPosition(t)},_addUserMarker:function(e){var t=$('<span class="galleryImageMarker galleryImageUserMarker userLink" />').data(e);this._imageContainer.append(t),this._setMarkerPosition(t)},_highlightMarkedUser:function(e){var t=$(e.currentTarget).data("userID");this._imageContainer.children(".galleryImageMarker").each(function(e,a){var i=$(a);i.data("userID")==t&&i.toggleClass("jsMarked")})},_setMarkerPosition:function(e){e.css({left:parseInt(this._image.position().left+e.data("positionX")*this._image.width()/this._imageWidth-e.width()/2),top:parseInt(e.data("positionY")*this._image.height()/this._imageHeight-e.height()/2)})},refreshMarkerPositions:function(){this._imageContainer.children(".galleryImageMarker").each($.proxy(function(e,t){this._setMarkerPosition($(t))},this))}}),Gallery.Image.Marker.TextPopover=WCF.Popover.extend({init:function(){this._super(".galleryImageTextMarker")},_loadContent:function(){var e=$("#"+this._activeElementID);this._insertContent(this._activeElementID,e.data("description"),!0)}}),Gallery.Map={},Gallery.Map.LargeMap=WCF.Location.GoogleMaps.LargeMap.extend({_success:function(e){if(e.returnValues&&e.returnValues.markers)for(var t=0,a=e.returnValues.markers.length;a>t;t++){var i=e.returnValues.markers[t];this.addMarker(i.latitude,i.longitude,i.title,null,i.infoWindow,i.dialog,i.location),i.objectID?this._objectIDs.push(i.objectID):i.objectIDs&&(this._objectIDs=this._objectIDs.concat(i.objectIDs))}},addMarker:function(e,t,a,i,s,r,n){var o=$(s).get(0),l=this._super(e,t,a,i,o);return r&&google.maps.event.addListener(l.infoWindow,"domready",$.proxy(function(){new Gallery.Map.InfoWindowImageListDialog($(o).find(".jsGalleryLocationDialogImageListButton"),r,n)},this)),l.infoWindow}}),Gallery.Map.InfoWindowImageListDialog=Class.extend({_dialog:null,_dialogContent:"",_imageData:[],init:function(e,t,a){this._dialogContent=t,this._location=a,e.click($.proxy(this._click,this))},_click:function(){null===this._dialog?this._dialog=$("<div />").append(this._dialogContent).hide().appendTo(document.body).wcfDialog({title:WCF.Language.get(this._location)}):this._dialog.wcfDialog("open")}});