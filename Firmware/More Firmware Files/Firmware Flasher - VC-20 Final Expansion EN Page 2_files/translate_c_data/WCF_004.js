WCF.User.Online={},WCF.User.Online.Proxy=Class.extend({_showLoadingOverlayOnce:!1,_suppressErrors:!1,_lastRequest:null,init:function(e){this.options=$.extend(!0,{autoSend:!1,data:{},dataType:"json",after:null,init:null,jsonp:"callback",async:!0,failure:null,showLoadingOverlay:!0,success:null,suppressErrors:!1,type:"POST",url:"index.php/AJAXProxy/?t="+SECURITY_TOKEN+SID_ARG_2ND,aborted:null,autoAbortPrevious:!1},e),this.options.url=WCF.convertLegacyURL(this.options.url),this.confirmationDialog=null,this.loading=null,this._showLoadingOverlayOnce=!1,this._suppressErrors=this.options.suppressErrors===!0,this.options.autoSend&&this.sendRequest();var s=this;$(window).on("beforeunload",function(){s._suppressErrors=!0})},sendRequest:function(e){return this._init(),(e||this.options.autoAbortPrevious)&&this.abortPrevious(),this._lastRequest=$.ajax({data:this.options.data,dataType:this.options.dataType,jsonp:this.options.jsonp,async:this.options.async,type:this.options.type,url:this.options.url,success:$.proxy(this._success,this),error:$.proxy(this._failure,this)}),this._lastRequest},abortPrevious:function(){null!==this._lastRequest&&(this._lastRequest.abort(),this._lastRequest=null)},showLoadingOverlayOnce:function(){this._showLoadingOverlayOnce=!0},suppressErrors:function(){this._suppressErrors=!0},_init:function(){$.isFunction(this.options.init)&&this.options.init(this),(this.options.showLoadingOverlay||this._showLoadingOverlayOnce)&&WCF.LoadingOverlayHandler.show()},_failure:function(e,s,t){return"abort"==s?void($.isFunction(this.options.aborted)&&this.options.aborted(e)):($.isFunction(this.options.failure)&&this.options.failure(null,e,s,t),void this._after())},_success:function(e,s,t){$.isFunction(this.options.success)&&(e&&e.returnValues&&void 0!==e.returnValues.template&&(e.returnValues.template=$.trim(e.returnValues.template)),this.options.success(e,s,t)),this._after()},_after:function(){this._lastRequest=null,$.isFunction(this.options.after)&&this.options.after(),(this.options.showLoadingOverlay||this._showLoadingOverlayOnce)&&(WCF.LoadingOverlayHandler.hide(),this._showLoadingOverlayOnce&&(this._showLoadingOverlayOnce=!1)),$("a[href*=#]").each(function(e,s){var t=$(s);if(-1!=t.prop("href").indexOf("AJAXProxy")){var a=t.prop("href").substr(t.prop("href").indexOf("#")),n=document.location.toString().replace(/#.*/,"");t.prop("href",n+a)}})},setOption:function(e,s){this.options[e]=s}}),WCF.User.Online.Marking=Class.extend({_container:null,_cache:null,_error:!1,_proxy:null,init:function(){this._cache={},this._userOnline(),WCF.DOMNodeInsertedHandler.addCallback("WCF.Action.Proxy",$.proxy(this._userOnline,this))},_userOnline:function(){if(0==this._error){this._container=$(".userLink");var e=new Array,s=!1;this._proxy=new WCF.User.Online.Proxy({success:$.proxy(this._success,this),failure:$.proxy(this._failure,this),showLoadingOverlay:!1}),this._container.each($.proxy(function(t,a){var n=$(a);n.hasClass("userOnlineChange")||(this._cache[n.data("userID")]?s=!0:e.push(n.data("userID")))},this)),0!==e.length?(this._proxy.setOption("data",{actionName:"userOnlineMarking",className:"wcf\\data\\user\\online\\UserOnlineAction",objectIDs:e}),this._proxy.sendRequest()):1==s&&this._addUserOnline()}},_success:function(e,s,t){e.returnValues.objects&&(cache=this._cache,$.each(e.returnValues.objects,function(s){cache[s]||(cache[s]=e.returnValues.objects[s])}),this._cache=cache),this._addUserOnline()},_failure:function(e,s,t){this._error=!0},_addUserOnline:function(){var e=this;this._container.each(function(s,t){var a=$(t);e._cache[a.data("userID")]&&(0==e._cache[a.data("userID")].offline?!a.hasClass("userOnlineChange")&&e._cache[a.data("userID")]&&e._cache[a.data("userID")].formattedUsername!=a.html()&&e._cache[a.data("userID")].notOnline!=a.html()&&(a.find("span")&&"name"==a.find("span").attr("itemprop")?!a.hasClass("userOnlineChange")&&e._cache[a.data("userID")]&&e._cache[a.data("userID")].formattedUsername!=a.find("span").html()&&e._cache[a.data("userID")].notOnline!=a.find("span").html()&&(a.addClass("userOnlineChange"),a.find("span").html(a.find("span").html().replace(e._cache[a.data("userID")].username,e._cache[a.data("userID")].formattedUsername))):(a.addClass("userOnlineChange"),a.html(a.html().replace(e._cache[a.data("userID")].username,e._cache[a.data("userID")].formattedUsername)))):!a.hasClass("userOnlineChange")&&e._cache[a.data("userID")]&&e._cache[a.data("userID")].username!=a.html()&&e._cache[a.data("userID")].notOnline!=a.html()&&(a.find("span")&&"name"==a.find("span").attr("itemprop")?!a.hasClass("userOnlineChange")&&e._cache[a.data("userID")]&&e._cache[a.data("userID")].username!=a.find("span").html()&&e._cache[a.data("userID")].notOnline!=a.find("span").html()&&(a.find("span").html(a.find("span").html().replace(e._cache[a.data("userID")].formattedUsername,e._cache[a.data("userID")].username)),a.addClass("userOnlineChange")):(a.addClass("userOnlineChange"),a.html(a.html().replace(e._cache[a.data("userID")].formattedUsername,e._cache[a.data("userID")].username)))))})}}),WCF.User.Online.MembersList=Class.extend({_container:null,_cache:null,_proxy:null,init:function(){this._container=$(".userList > li"),this._cache={};var e=new Array;this._proxy=new WCF.User.Online.Proxy({success:$.proxy(this._success,this),showLoadingOverlay:!1}),this._container.each($.proxy(function(s,t){var a=$(t);a.hasClass("userOnlineChange")||this._cache[a.data("userID")]||e.push(a.data("objectID"))},this)),0!==e.length&&(this._proxy.setOption("data",{actionName:"userOnlineMarking",className:"wcf\\data\\user\\online\\UserOnlineAction",objectIDs:e}),this._proxy.sendRequest())},_success:function(e,s,t){if(e.returnValues.objects){var a=this._cache;$.each(e.returnValues.objects,function(s){a[s]||(a[s]=e.returnValues.objects[s])}),this._cache=a}this._addUserOnline()},_addUserOnline:function(){var e=this;this._container.each($.proxy(function(s,t){var a=$(t);if(a&&a.data("objectID")){var n=a.find(".box48 > div > div > h3 > a");0==e._cache[a.data("objectID")].offline?!a.hasClass("userOnlineChange")&&this._cache[a.data("objectID")]&&this._cache[a.data("objectID")].formattedUsername!=n.html()&&this._cache[a.data("objectID")].notOnline!=n.html()&&(a.addClass("userOnlineChange"),n.html(n.html().replace(this._cache[a.data("objectID")].username,this._cache[a.data("objectID")].formattedUsername))):!a.hasClass("userOnlineChange")&&this._cache[a.data("objectID")]&&this._cache[a.data("objectID")].username!=n.html()&&this._cache[a.data("objectID")].notOnline!=n.html()&&(a.addClass("userOnlineChange"),n.html(n.html().replace(this._cache[a.data("objectID")].formattedUsername,this._cache[a.data("objectID")].username)))}},this))}}),WCF.User.Online.UserPage=Class.extend({_container:null,_userID:null,_proxy:null,init:function(e){this._userID=e,this._container=$("#tplUser #content > header > h1");var s=new Array;s.push(e),this._proxy=new WCF.User.Online.Proxy({success:$.proxy(this._success,this),showLoadingOverlay:!1}),0!==s.length&&(this._proxy.setOption("data",{actionName:"userOnlineMarking",className:"wcf\\data\\user\\online\\UserOnlineAction",objectIDs:s}),this._proxy.sendRequest())},_success:function(e,s,t){var a=this._userID;if(e.returnValues.objects&&e.returnValues.objects[a]){var n=this._container;n&&e.returnValues.objects[a]&&(0==e.returnValues.objects[a].offline?n.hasClass("userOnlineChange")||e.returnValues.objects[a].formattedUsername==n.html()||e.returnValues.objects[a].notOnline==n.html()||(n.addClass("userOnlineChange"),n.html(n.html().replace(e.returnValues.objects[a].username,e.returnValues.objects[a].formattedUsername))):n.hasClass("userOnlineChange")||e.returnValues.objects[a].username==n.html()||e.returnValues.objects[a].notOnline==n.html()||(n.addClass("userOnlineChange"),n.html(n.html().replace(e.returnValues.objects[a].formattedUsername,e.returnValues.objects[a].username))))}}});