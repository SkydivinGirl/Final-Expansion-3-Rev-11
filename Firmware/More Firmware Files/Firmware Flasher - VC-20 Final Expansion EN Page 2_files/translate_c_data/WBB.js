var WBB={};WBB.Board={},WBB.Board.Collapsible=WCF.Collapsible.Remote.extend({_getContainers:function(){return $(".wbbBoardList .wbbCollapsibleCategory")},_getTarget:function(e){return this._containers[e].children("ul").first()},_getButtonContainer:function(e){return this._containers[e].find("header h2").first()},_getObjectID:function(e){return this._containers[e].data("boardID")},_updateContent:function(e,t){var a=$(t).attr("id",e);this._containers[e].replaceWith(a),this._containers[e]=a,this._initContainer(e,a)},_getAdditionalParameters:function(e){return{depth:this._containers[e].data("depth")}}}),WBB.Board.MarkAllAsRead=Class.extend({_callback:null,_proxy:null,init:function(e){this._callback=e,this._proxy=new WCF.Action.Proxy({success:$.proxy(this._success,this)}),$(".markAllAsReadButton").click($.proxy(this._click,this))},_click:function(e){e.preventDefault(),this._proxy.setOption("data",{actionName:"markAllAsRead",className:"wbb\\data\\board\\BoardAction"}),this._proxy.sendRequest()},_success:function(){if(this._callback&&$.isFunction(this._callback))return this._callback();var e=$(".wbbBoardList");e.find(".new").removeClass("new"),e.find(".badge.badgeUpdate").hide(),$("#mainMenu .active .badge").hide(),e.find(".wbbBoard .icon32.markAsRead.icon-folder-close").removeClass("icon-folder-close").addClass("icon-folder-close-alt"),e.find(".wbbSubBoards .icon16.markAsRead.icon-folder-close").removeClass("icon-folder-close").addClass("icon-folder-close-alt"),e.find(".markAsRead").removeClass("markAsRead").unbind("dblclick")}}),WBB.Board.MarkAsRead=Class.extend({_proxy:null,init:function(){this._proxy=new WCF.Action.Proxy({success:$.proxy(this._success,this)}),$(document).on("dblclick",".wbbBoardList .markAsRead",$.proxy(this._dblClick,this))},_dblClick:function(e){this._proxy.setOption("data",{actionName:"markAsRead",className:"wbb\\data\\board\\BoardAction",objectIDs:[$(e.currentTarget).parents("li:eq(0)").data("boardID")]}),this._proxy.sendRequest()},_success:function(e){var t=this;$(".wbbBoardList .markAsRead").each(function(a,s){var i=$(s),o=i.parents("li:eq(0)");WCF.inArray(o.data("boardID"),e.objectIDs)&&t._markAsRead(o,i)})},_markAsRead:function(e,t){console.debug("Processing "+e.data("boardID")),e.removeClass("new").find(".new:eq(0)").removeClass("new"),t.removeClass("markAsRead"),e.find(".badge:eq(0)").hide(),t.hasClass("icon-folder-close")&&t.removeClass("icon-folder-close").addClass("icon-folder-close-alt"),t.unbind("dblclick");var a=this;e.find("ul:eq(0)").children("li").each(function(e,t){var s=$(t);a._markAsRead(s,s.find(".markAsRead:eq(0)"))})}}),WBB.Board.MarkAllThreadsAsRead=Class.extend({_boardID:0,_proxy:null,init:function(e){this._boardID=e,this._proxy=new WCF.Action.Proxy({success:$.proxy(this._success,this)}),$(".markAsReadButton").click($.proxy(this._click,this))},_click:function(e){e.preventDefault(),this._proxy.setOption("data",{actionName:"markAsRead",className:"wbb\\data\\board\\BoardAction",objectIDs:[this._boardID]}),this._proxy.sendRequest()},_success:function(){$(".wbbThreadList .new").each(function(e,t){var a=$(t);a.removeClass("new"),a.find(".firstNewPost").parent().remove(),a.find(".columnAvatar").off("dblclick")})}}),WBB.Board.IgnoreBoards=Class.extend({_dialog:null,_didInit:!1,_proxy:null,init:function(){$(".ignoreBoardsButton").click($.proxy(this._click,this))},_click:function(e){e.preventDefault(),this._didInit?this._dialog.wcfDialog("open"):(this._dialog=$("<div />").hide().appendTo(document.body),this._proxy=new WCF.Action.Proxy({autoSend:!0,data:{actionName:"loadIgnoredBoards",className:"wbb\\data\\board\\BoardAction"},success:$.proxy(this._success,this)}),this._didInit=!0)},_initBoardList:function(){this._dialog.find("input[type=submit]").click($.proxy(this._submit,this)),this._dialog.find("input[type=checkbox]").click($.proxy(this._checkboxClick,this)),this._dialog.find("li").each(function(e,t){var a=$(t);a.data("ignorable")===!1&&a.find("input[type=checkbox]:eq(0)").prop("checked","checked").disable().css("cursor","default").off("click")})},_checkboxClick:function(e){var t=$(e.currentTarget);t.parents("li:eq(0)").find("ul input[type=checkbox]").each(t.prop("checked")?function(){var e=$(this);e.data("ignorable")&&e.enable()}:function(){var e=$(this);e.data("ignorable")&&e.prop("checked",t.prop("checked")).disable()})},_submit:function(){var e=[];this._dialog.find("input[type=checkbox]:not(:checked)").each(function(){e.push($(this).val())}),this._dialog.find("input[type=submit]").disable(),this._proxy.setOption("data",{actionName:"saveIgnoredBoards",className:"wbb\\data\\board\\BoardAction",objectIDs:e}),this._proxy.sendRequest()},_success:function(e){"loadIgnoredBoards"===e.actionName?(this._dialog.html(e.returnValues.template),this._initBoardList(),this._dialog.wcfDialog({title:WCF.Language.get("wbb.index.ignoreBoards")})):(this._dialog.wcfDialog("close"),this._dialog.find("input[type=submit]").enable(),$(".wbbBoardList:eq(0)").html(e.returnValues.template))}}),WBB.Thread={},WBB.Thread.MarkAsRead=Class.extend({_proxy:null,init:function(){this._proxy=new WCF.Action.Proxy({success:$.proxy(this._success,this)}),$(document).on("dblclick",".wbbThreadList .new .columnAvatar",$.proxy(this._dblclick,this))},_dblclick:function(e){this._proxy.setOption("data",{actionName:"markAsRead",className:"wbb\\data\\thread\\ThreadAction",objectIDs:[$(e.currentTarget).parents("tr:eq(0)").data("threadID")]}),this._proxy.sendRequest()},_success:function(e){$(".wbbThreadList .new").each(function(t,a){var s=$(a);WCF.inArray(s.data("threadID"),e.objectIDs)&&(s.removeClass("new"),s.find(".firstNewPost").parent().remove(),s.find(".columnAvatar").off("dblclick"))})}}),WBB.Thread.Editor={_callbacks:[],_dialog:null,_dialogContainer:null,_environment:"",_notification:null,_proxy:null,_threadID:0,beginEdit:function(e,t){this._environment=e,this._threadID=t,null===this._proxy&&(this._proxy=new WCF.Action.Proxy({success:$.proxy(this._success,this)})),this._proxy.setOption("data",{actionName:"beginEdit",className:"wbb\\data\\thread\\ThreadAction",parameters:{data:{threadID:this._threadID}}}),this._proxy.sendRequest()},registerCallback:function(e){this._callbacks.push(e)},_success:function(e){switch(e.returnValues.actionName){case"beginEdit":this._showEditor(e);break;case"saveEdit":this._saveEdit(e)}},_showEditor:function(e){if(null===this._dialog){this._dialogContainer=$('<div id="threadEditor" />').data("wbbThreadEditor",this).appendTo(document.body),this._dialog=$("<div />").appendTo(this._dialogContainer);var t=$('<div class="formSubmit" />').appendTo(this._dialogContainer),a=$('<button class="buttonPrimary">'+WCF.Language.get("wcf.global.button.save")+"</button>").appendTo(t),s=$("<button>"+WCF.Language.get("wcf.global.button.cancel")+"</button>").appendTo(t);s.click($.proxy(this._cancel,this)),a.click($.proxy(this._save,this))}this._dialogContainer.data("threadID",e.returnValues.threadID),this._dialog.html(e.returnValues.template);var i=this;this._dialog.find("input:not(.jsPreventSubmit)").keyup(function(e){return e.which===$.ui.keyCode.ENTER?(i._save(),e.preventDefault(),!1):void 0}),this._dialogContainer.wcfDialog({title:WCF.Language.get("wbb.thread.edit")}),this._dialogContainer.wcfDialog("render")},_save:function(){var e={},t=this._dialog.find("fieldset");if(t.length){t.each($.proxy(function(t,a){var s=$(a),i=s.attr("id").replace(/^threadEditor/,"").toLowerCase();e[i]=this._getValues(s)},this));for(var a=0,s=this._callbacks.length;s>a;a++)e=this._callbacks[a].getValues(this._dialog,e);$.getLength(e)&&(this._proxy.setOption("data",{actionName:"saveEdit",className:"wbb\\data\\thread\\ThreadAction",parameters:{data:{values:e,threadID:this._threadID}}}),this._proxy.sendRequest())}},_saveEdit:function(e){if(e.returnValues.errors&&$.getLength(e.returnValues.errors)){this._dialog.find("small.innerError").remove();for(var t=0,a=this._callbacks.length;a>t;t++)"function"==typeof this._callbacks[t].showErrors&&this._callbacks[t].showErrors(e.returnValues.errors)}else if(null===this._notification&&(this._notification=new WCF.System.Notification(WCF.Language.get("wcf.global.success.edit"))),e.returnValues.forceReload)this._notification.show(function(){window.location.reload()},void 0,WCF.Language.get("wcf.global.success.edit"));else{for(var t in this._callbacks)this._callbacks[t].saved(this._environment,this._threadID,e);this._dialogContainer.wcfDialog("close"),this._notification.show()}},_getValues:function(e){var t={};return e.find("input:not([type=radio])").each(function(e,a){var s=$(a);t[s.attr("id")]="checkbox"===s.attr("type")?s.prop("checked")?1:0:s.val()}),e.find("input[type=radio]:checked").each(function(e,a){var s=$(a);t[s.attr("name")]=s.val()}),e.find("select").each(function(e,a){var s=$(a);t[s.attr("id")]=s.val()}),t},_cancel:function(){this._dialogContainer.wcfDialog("close")}},WBB.Thread.Editor.Default=Class.extend({init:function(){$("#threadEditor").data("wbbThreadEditor").registerCallback(this),this._handleThreadType()},_handleThreadType:function(){var e=$("#threadEditorAnnouncementLabel"),t=$("#threadEditorAnnouncementContainer"),a=function(a,s){switch(a){case 0:case 1:e.hide(),t.hide(),s||$("#threadEditor").wcfDialog("render");break;case 2:e.show(),t.show(),s||$("#threadEditor").wcfDialog("render")}},s=$("#threadEditor input[name=type]").click(function(e){a(parseInt($(e.currentTarget).val()),!1)});s.each(function(e,t){var s=$(t);return s.is(":checked")?(a(parseInt(s.val()),!0),!1):void 0})},_click:function(e){this._type=parseInt($(e.currentTarget).prop("value")),this._update()},_update:function(){this._type},getValues:function(e,t){return t},saved:function(e,t,a){void 0!==a.returnValues.default&&("board"===e?$("#thread"+t+" > td.columnSubject > h3 > a").text(a.returnValues.default.topic):($("header.wbbThread[data-thread-id="+t+"] > h1 > a").text(a.returnValues.default.topic),$("#post"+a.returnValues.default.firstPostID+" .messageHeader > .messageHeadline > h1").text(a.returnValues.default.topic)))},showErrors:function(e){if(e.default)for($fieldName in e.default)$('<small class="innerError">'+e.default[$fieldName]+"</small>").insertAfter($("#threadEditorDefault #"+$fieldName))}}),WBB.Thread.Editor.LabelChooser=WCF.Label.Chooser.extend({init:function(e,t,a,s){this._super(e,t,a,s),$("#threadEditor").data("wbbThreadEditor").registerCallback(this)},getValues:function(e,t){t.label={};for(var a in this._groups){var s=this._groups[a];void 0!==s.data("labelID")&&(t.label[a]=s.data("labelID"))}return t},saved:function(e,t,a){if(void 0!==a.returnValues.label){var s=a.returnValues.label.labels,i=null;if("board"===e){var o=$("#thread"+t+" > td.columnSubject");i=o.children(".labelList"),i.length?s.length?i.empty():i.remove():s.length&&(i=$('<ul class="labelList" />').prependTo(o));for(var n=0;n<s.length;n++){var r=s[n],d=$('<li><a href="'+r.link+'" class="badge label '+r.cssClassName+'">'+WCF.String.escapeHTML(r.label)+"</a></li>").appendTo(i);d.before(" ")}}else{var l=$("header.wbbThread[data-thread-id="+t+"]");i=l.children(".labelList"),i.length?s.length?i.empty():i.remove():s.length&&(i=$('<ul class="labelList" />').appendTo(l));for(var n=0;n<s.length;n++){var r=s[n],d=$('<li><span class="badge label '+r.cssClassName+'">'+WCF.String.escapeHTML(r.label)+"</span></li>").appendTo(i);d.after(" ")}}}},showErrors:function(e){if(e.label){var t=$("#threadEditorLabel");t.find(".labelList").each(function(t,a){var s=$(a),i=s.data("objectID");e.label.labelIDs[i]&&$('<small class="innerError">'+WCF.Language.get("wcf.label.error.missing")+"</small>").insertAfter(s)})}}}),WBB.Thread.Editor.Language=WCF.Language.Chooser.extend({init:function(e,t,a,s,i,o){this._super(e,t,a,s,i,o),$("#"+e).find("input[name=languageID]").attr("id","languageID")}}),WBB.Thread.Editor.TagList=WCF.Tagging.TagList.extend({init:function(e,t,a){this._super(e,t,a),$("#threadEditor").data("wbbThreadEditor").registerCallback(this)},getValues:function(e,t){return delete t.tags,t.tag=this._data.length?this._data:["__wcf_noTags"],t},saved:function(){}}),WBB.Thread.InlineEditor=WCF.InlineEditor.extend({_boardID:0,_environment:"thread",_permissions:{},_redirectURL:"",_updateHandler:null,_setOptions:function(){this._boardID=0,this._environment="thread",this._options=[{label:WCF.Language.get("wbb.thread.edit.done"),optionName:"done"},{label:WCF.Language.get("wbb.thread.edit.undone"),optionName:"undone"},{label:WCF.Language.get("wbb.thread.edit.close"),optionName:"close"},{label:WCF.Language.get("wbb.thread.edit.open"),optionName:"open"},{label:WCF.Language.get("wbb.thread.edit.sticky"),optionName:"sticky"},{label:WCF.Language.get("wbb.thread.edit.scrape"),optionName:"scrape"},{label:WCF.Language.get("wbb.thread.edit.enable"),optionName:"enable"},{label:WCF.Language.get("wbb.thread.edit.disable"),optionName:"disable"},{label:WCF.Language.get("wbb.thread.edit.move"),optionName:"move"},{label:WCF.Language.get("wbb.thread.edit.removeLink"),optionName:"removeLink"},{label:WCF.Language.get("wbb.thread.edit.trash"),optionName:"trash"},{label:WCF.Language.get("wbb.thread.edit.restore"),optionName:"restore"},{label:WCF.Language.get("wbb.thread.edit.delete"),optionName:"delete"},{optionName:"divider"},{label:WCF.Language.get("wbb.thread.edit.advanced"),optionName:"advanced",isQuickOption:!0}]},setUpdateHandler:function(e){this._updateHandler=e},_getTriggerElement:function(e){return e.find(".jsThreadInlineEditor")},_validate:function(e,t){var a=$("#"+e).data("threadID");if(this._updateHandler.getValue(a,"isLink"))return"removeLink"===t&&this._getPermission("canMoveThread")?!0:!1;switch(t){case"close":case"open":return this._getPermission("canCloseThread")?"open"===t?this._updateHandler.getValue(a,"isClosed"):!this._updateHandler.getValue(a,"isClosed"):!1;case"delete":return this._getPermission("canDeleteThreadCompletely")?this._updateHandler.getValue(a,"isDeleted"):!1;case"done":case"undone":return this._updateHandler.getValue(a,"canMarkAsDone")?"undone"===t?this._updateHandler.getValue(a,"isDone"):!this._updateHandler.getValue(a,"isDone"):!1;case"restore":return this._getPermission("canRestoreThread")?this._updateHandler.getValue(a,"isDeleted"):!1;case"trash":return this._getPermission("canDeleteThread")?!this._updateHandler.getValue(a,"isDeleted"):!1;case"sticky":case"scrape":return!this._getPermission("canPinThread")||this._updateHandler.getValue(a,"isAnnouncement")?!1:"scrape"===t?this._updateHandler.getValue(a,"isSticky"):!this._updateHandler.getValue(a,"isSticky");case"enable":return this._getPermission("canEnableThread")?this._updateHandler.getValue(a,"isDeleted")?!1:this._updateHandler.getValue(a,"isDisabled"):!1;case"disable":return this._getPermission("canEnableThread")?this._updateHandler.getValue(a,"isDeleted")?!1:!this._updateHandler.getValue(a,"isDisabled"):!1;case"move":return this._getPermission("canMoveThread");case"advanced":return!0}return!1},_execute:function(e,t){if(!this._validate(e,t))return!1;switch(t){case"close":case"open":var a="open"===t?0:1;this._updateThread(e,t,{isClosed:a});break;case"sticky":case"scrape":var s="scrape"===t?0:1;this._updateThread(e,t,{isSticky:s});break;case"done":case"undone":var i="done"===t?1:0;this._updateThread(e,t,{isDone:i});break;case"enable":case"disable":this._updateThread(e,t,{isDisabled:"enable"===t?0:1});break;case"move":var o=this._elements[e].data("threadID");WBB.Thread.MoveHandler.prepare([o],$.proxy(function(e){this._updateHandler.update(o,e.returnValues.threadData[o])},this),this._boardID,this._environment);break;case"removeLink":this._updateThread(e,t,{removeLink:1});break;case"delete":var n=this;WCF.System.Confirmation.show(WCF.Language.get("wbb.thread.confirmDelete"),function(a){"confirm"===a&&n._updateThread(e,t,{deleted:1})});break;case"restore":this._updateThread(e,t,{isDeleted:0});break;case"trash":var n=this;WCF.System.Confirmation.show(WCF.Language.get("wbb.thread.confirmTrash"),function(a){"confirm"===a&&n._updateThread(e,t,{isDeleted:1,reason:$("#wcfSystemConfirmationContent").find("textarea").val()})},{},$("<fieldset><dl><dt>"+WCF.Language.get("wbb.thread.confirmTrash.reason")+'</dt><dd><textarea cols="40" rows="4" /></dd></dl></fieldset>'));break;case"advanced":WBB.Thread.Editor.beginEdit(this._environment,this._elements[e].data("threadID"));break;default:return!1}return!0},_updateThread:function(e,t,a){if("delete"===t||"removeLink"===t){var s=this,i=this._elements[e].data("threadID");new WCF.Action.Proxy({autoSend:!0,data:{actionName:t,className:"wbb\\data\\thread\\ThreadAction",objectIDs:[i]},success:function(e){s._updateHandler.update(i,e.returnValues.threadData[i])}})}else this._updateData.push({data:a,elementID:e,optionName:t}),this._proxy.setOption("data",{actionName:t,className:"wbb\\data\\thread\\ThreadAction",objectIDs:[this._elements[e].data("threadID")],parameters:{data:a}}),this._proxy.sendRequest()},_updateState:function(){this._notification.show();for(var e=0,t=this._updateData.length;t>e;e++){var a=this._updateData[e];if(void 0!==a.data.isSticky&&this._redirectURL)return void(window.location=this._redirectURL);var s=$("#"+a.elementID).data("threadID");this._updateHandler.update(s,a.data)}},_getPermission:function(e){return this._permissions[e]?this._permissions[e]:0},setEnvironment:function(e,t,a){"board"!==e&&(e="thread"),this._boardID=t?t:0,this._environment=e,this._redirectURL=a},setPermission:function(e,t){this._permissions[e]=t},setPermissions:function(e){for(var t in e)this.setPermission(t,e[t])}}),WBB.Thread.QuickReply=WCF.Message.QuickReply.extend({init:function(e){this._super(!0,e),this._successMessageNonVisible="wbb.post.moderation.redirect"},_getClassName:function(){return"wbb\\data\\post\\PostAction"},_getObjectID:function(){return this._container.data("threadID")},_success:function(e,t,a){this._super(e,t,a),void 0!==e.returnValues.isSubscribed&&WCF.System.Event.fireEvent("com.woltlab.wcf.objectWatch","update",{isSubscribed:e.returnValues.isSubscribed?1:0,objectID:this._getObjectID()})}}),WBB.Thread.Clipboard=Class.extend({_boardID:0,_environment:"board",_updateHandler:null,init:function(updateHandler,environment,boardID){this._updateHandler=updateHandler,this._environment=environment,this._boardID=boardID?boardID:0,$(".jsClipboardEditor").each($.proxy(function(index,container){var $container=$(container),$types=eval($container.data("types"));return WCF.inArray("com.woltlab.wbb.thread",$types)?($container.on("clipboardAction",$.proxy(this._execute,this)),$container.on("clipboardActionResponse",$.proxy(this._evaluateResponse,this)),!1):void 0},this))},_execute:function(e,t,a,s){if("com.woltlab.wbb.thread"===t)switch(a){case"com.woltlab.wbb.thread.assignLabel":WBB.Thread.AssignLabelHandler.prepare(s);break;case"com.woltlab.wbb.thread.copy":WBB.Thread.CopyHandler.prepare(s);break;case"com.woltlab.wbb.thread.merge":var i=new WBB.Thread.MergeHandler(s.objectIDs);i.load();break;case"com.woltlab.wbb.thread.move":WBB.Thread.MoveHandler.prepare(s.objectIDs,$.proxy(this._move,this),this._boardID,this._environment)}},_move:function(e){this._evaluateResponse(null,e,"com.woltlab.wbb.thread","com.woltlab.wbb.thread.move",null)},_evaluateResponse:function(e,t,a){if("com.woltlab.wbb.thread"===a&&t.returnValues.threadData&&$.getLength(t.returnValues.threadData)){for(var s in t.returnValues.threadData)this._updateHandler.update(s,t.returnValues.threadData[s],!1);WCF.Clipboard.reload()}}}),WBB.Thread.UpdateHandler=Class.extend({_markAsDoneHandler:null,_threads:{},init:function(){var e=this;$(".wbbThread").each(function(t,a){var s=$(a);e._threads[s.data("threadID")]=s})},setMarkAsDoneHandler:function(e){this._markAsDoneHandler=e},update:function(e,t,a){if(t.moved)return void window.location.reload();if(!this._threads[e])return void console.debug("[WBB.Thread.UpdateHandler] Unknown thread id "+e);for(var s in t)this._updateProperty(e,s,t[s]);a!==!1&&WCF.Clipboard.reload()},_updateProperty:function(e,t,a){switch(t){case"deleted":this._delete(e,a);break;case"deleteNote":this._deleteNote(e,a);break;case"isClosed":a?this._close(e):this._open(e);break;case"isDeleted":a?this._trash(e):this._restore(e);break;case"isDisabled":a?this._disable(e):this._enable(e);break;case"isDone":a?this._done(e):this._undone(e);break;case"isSticky":a?this._sticky(e):this._scrape(e);break;case"moved":this._moved(e);break;case"showMoveNotice":this._showMoveNotice(e);break;case"title":this._updateTitle(e,a);break;default:this._handleCustomProperty(e,t,a)}},_handleCustomProperty:function(e,t,a){this._threads[e].trigger("threadUpdateHandlerProperty",[e,t,a])},_close:function(e){this._threads[e].data("isClosed",1)},_delete:function(){},_deleteNote:function(){},_disable:function(e){this._threads[e].data("isDisabled",1)},_done:function(e){this._threads[e].data("isDone",1)},_enable:function(e){this._threads[e].data("isDisabled",0)},_moved:function(){},_open:function(e){this._threads[e].data("isClosed",0)},_restore:function(e){this._threads[e].data("isDeleted",0)},_scrape:function(e){this._threads[e].data("isSticky",0)},_sticky:function(e){this._threads[e].data("isSticky",1)},_trash:function(e){this._threads[e].data("isDeleted",1)},_undone:function(e){this._threads[e].data("isDone",0)},_updateTitle:function(){},_getCloseIcon:function(){return $('<li><span title="'+WCF.Language.get("wbb.thread.closed")+'" class="icon icon16 icon-lock jsTooltip jsIconClosed" /></li>')},_getDoneIcon:function(){return $('<li><span title="'+WCF.Language.get("wbb.thread.done")+'" class="icon icon16 icon-check jsTooltip jsIconDone wbbMarkAsDone" /></li>')},_getMoveIcon:function(){return $('<li><span title="'+WCF.Language.get("wbb.thread.moved")+'" class="icon icon16 icon-arrow-right jsTooltip jsIconMoved" /></li>')},_getUndoneIcon:function(){return $('<li><span title="'+WCF.Language.get("wbb.thread.undone")+'" class="icon icon16 icon-check-empty jsTooltip jsIconUndone wbbMarkAsDone" /></li>')},getValue:function(e,t){if(!this._threads[e])return void console.debug("[WBB.Thread.UpdateHandler] Unknown thread id "+e);switch(t){case"isAnnouncement":return this._threads[e].data("isAnnouncement");case"isClosed":return this._threads[e].data("isClosed");case"isDeleted":return this._threads[e].data("isDeleted");case"isDisabled":return this._threads[e].data("isDisabled");case"isDone":return this._threads[e].data("isDone");case"isSticky":return this._threads[e].data("isSticky");case"isLink":return this._threads[e].data("isLink");case"canMarkAsDone":return this._threads[e].data("canMarkAsDone")}}}),WBB.Thread.UpdateHandler.Board=WBB.Thread.UpdateHandler.extend({_close:function(e){this._super(e),this._getCloseIcon().appendTo(this._threads[e].find(".statusIcons"))},_delete:function(e){this._threads[e].remove(),delete this._threads[e],WCF.Clipboard.reload()},_deleteNote:function(e,t){$('<small class="wbbThreadDeleteNote">'+t+"</small>").appendTo(this._threads[e].find(".columnSubject"))},_disable:function(e){this._super(e),this._threads[e].addClass("messageDisabled")},_done:function(e){this._super(e);var t=this._threads[e].find(".jsIconUndone").parent(),a=this._getDoneIcon();a.insertAfter(t),t.remove(),null!==this._markAsDoneHandler&&this._markAsDoneHandler.watch(e)},_enable:function(e){this._super(e),this._threads[e].removeClass("messageDisabled")},_moved:function(){window.location.reload()},_showMoveNotice:function(e){this._getMoveIcon().appendTo(this._threads[e].find(".statusIcons"))},_open:function(e){this._super(e),this._threads[e].find(".jsIconClosed").parent().remove()},_scrape:function(e){this._super(e)},_sticky:function(e){this._super(e)},_restore:function(e){this._super(e),this._threads[e].removeClass("messageDeleted"),this._threads[e].find(".columnSubject > .wbbThreadDeleteNote").remove()},_trash:function(e){this._super(e),this._threads[e].addClass("messageDeleted")},_undone:function(e){this._super(e);var t=this._threads[e].find(".jsIconDone").parent(),a=this._getUndoneIcon();a.insertAfter(t),t.remove(),null!==this._markAsDoneHandler&&this._markAsDoneHandler.watch(e)}}),WBB.Thread.UpdateHandler.Thread=WBB.Thread.UpdateHandler.extend({_boardID:0,_postHandler:null,init:function(e){this._boardID=e,this._super()},setPostHandler:function(e){this._postHandler=e},update:function(e,t){this._threads[e]&&(void 0===t.isDeleted||t.isDeleted||void 0===t.ignoreDeletedPosts||(this._restore(e,!0),delete t.isDeleted,delete t.ignoreDeletedPosts),void 0===t.isDisabled||t.isDisabled||void 0===t.ignoreDisabledPosts||(this._enable(e,!0),delete t.isDisabled,delete t.ignoreDisabledPosts)),this._super(e,t)},_close:function(e){this._super(e);var t=this._getCloseIcon();t.appendTo(this._threads[e].find("h1 + ul.statusIcons"))},_delete:function(e,t){new WCF.PeriodicalExecuter(function(e){e.stop(),window.location=t},1e3)},_disable:function(e){this._super(e),this._postHandler.updateAllPosts("isDisabled",1)},_done:function(e){this._super(e);var t=this._threads[e].find("h1 + ul.statusIcons span.jsIconUndone").parent(),a=this._getDoneIcon();a.insertAfter(t),t.remove(),null!==this._markAsDoneHandler&&this._markAsDoneHandler.watch(e)},_enable:function(e,t){this._super(e),t||this._postHandler.updateAllPosts("isDisabled",0)},_moved:function(){window.location.reload()},_showMoveNotice:function(){window.location.reload()},_open:function(e){this._super(e),this._threads[e].find("h1 + ul.statusIcons span.jsIconClosed").parent().remove()},_scrape:function(e){this._super(e),this._threads[e].find("h1 > span.jsSticky").remove()},_sticky:function(e){this._super(e);var t=$('<span class="badge label jsSticky">'+WCF.Language.get("wbb.thread.sticky")+"</span>").prependTo(this._threads[e].find("h1"));t.after(" ")},_restore:function(e,t){this._super(e),t||this._postHandler.updateAllPosts("isDeleted",0)},_trash:function(e){this._super(e),this._postHandler.updateAllPosts("isDeleted",1)},_undone:function(e){this._super(e);var t=this._threads[e].find("h1 + ul.statusIcons span.jsIconDone").parent(),a=this._getUndoneIcon();a.insertAfter(t),t.remove(),null!==this._markAsDoneHandler&&this._markAsDoneHandler.watch(e)}}),WBB.Thread.MergeHandler=Class.extend({_className:"",_dialog:null,_dialogTitle:"",_objectIDs:[],_proxy:null,_successMessage:"",init:function(e){this._className="wbb\\data\\thread\\ThreadAction",this._dialogTitle=WCF.Language.get("wbb.thread.edit.merge"),this._objectIDs=e,this._successMessage=WCF.Language.get("wbb.thread.edit.merge.success"),this._proxy=new WCF.Action.Proxy({success:$.proxy(this._success,this)})},load:function(){this._proxy.setOption("data",{actionName:"prepareMerge",className:this._className,objectIDs:this._objectIDs}),this._proxy.sendRequest()},_success:function(e){if(e.returnValues.redirectURL){var t=new WCF.System.Notification(this._successMessage);return void t.show(function(){window.location=e.returnValues.redirectURL})}null===this._dialog?(this._dialog=$("<div />").hide().appendTo(document.body),this._dialog.html(e.returnValues.template),this._dialog.wcfDialog({title:this._dialogTitle})):(this._dialog.html(e.returnValues.template),this._dialog.wcfDialog("show"));var a=this._dialog.find(".formSubmit > button[data-type=submit]").disable().click($.proxy(this._submit,this));this._dialog.find("input[type=radio]").change(function(){a.enable()})},_submit:function(){this._dialog.find(".formSubmit > button[data-type=submit]").disable(),this._proxy.setOption("data",{actionName:"merge",className:this._className,objectIDs:this._objectIDs,parameters:this._getParameters()}),this._proxy.sendRequest()},_getParameters:function(){return{threadID:this._dialog.find("input[type=radio]:checked").val()}}}),WBB.Thread.AssignLabelHandler={_boardID:0,_dialog:null,_objectIDs:[],prepare:function(e){this._boardID=e.boardID,this._objectIDs=e.objectIDs,null===this._dialog?(this._dialog=$("<div />").appendTo(document.body),this._dialog.html(e.template),this._dialog.wcfDialog({title:WCF.Language.get("wbb.thread.edit.assignLabel")})):(this._dialog.html(e.template),this._dialog.wcfDialog("open")),this._dialog.find(".formSubmit > .buttonPrimary").click($.proxy(this._click,this))},_click:function(){var e={};this._dialog.find(".labelList > .dropdown").each(function(t,a){var s=$(a);s.data("labelID")&&(e[s.data("groupID")]=s.data("labelID"))}),new WCF.Action.Proxy({autoSend:!0,data:{actionName:"assignLabel",className:"wbb\\data\\thread\\ThreadAction",objectIDs:this._objectIDs,parameters:{boardID:this._boardID,labelIDs:e}},success:$.proxy(this._success,this)})},_success:function(e){for(var t=e.returnValues.labels,a=0;a<e.objectIDs.length;a++){var s=$("#thread"+e.objectIDs[a]+" > td.columnSubject"),i=s.children(".labelList");i.length?t.length?i.empty():i.remove():t.length&&(i=$('<ul class="labelList" />').prependTo(s));for(var o=0;o<t.length;o++){var n=t[o],r=$('<li><a href="'+n.link+'" class="badge label '+n.cssClassName+'">'+WCF.String.escapeHTML(n.label)+"</a></li>").appendTo(i);r.before(" ")}}this._dialog.wcfDialog("close"),WCF.Clipboard.reload(),(new WCF.System.Notification).show()}},WBB.Thread.CopyHandler={_boardID:0,_i:0,_objectIDs:[],prepare:function(e){this._boardID=e.boardID,this._i=0,this._objectIDs=e.objectIDs,this.copy()},copy:function(e){e===!0&&this._i++;var t=WCF.Language.get("wbb.thread.copy.title",{count:this._objectIDs.length,item:this._i+1});this._i+1==this._objectIDs.length?new WCF.System.Worker("copy","wbb\\data\\thread\\ThreadAction",t,{boardID:this._boardID,sourceThreadID:this._objectIDs[this._i]}):new WCF.System.Worker("copy","wbb\\data\\thread\\ThreadAction",t,{boardID:this._boardID,sourceThreadID:this._objectIDs[this._i]},function(e){e._dialog.wcfDialog("option","onClose",null),e._dialog.wcfDialog("option","closeConfirmMessage",null),e._dialog.wcfDialog("close"),WBB.Thread.CopyHandler.copy(!0)})}},WBB.Thread.MoveHandler={_boardID:0,_callback:null,_dialog:null,_didInit:!1,_environment:"",_proxy:null,_threadIDs:[],_init:function(){this._dialog=$("<div />").hide().appendTo(document.body),this._proxy=new WCF.Action.Proxy,this._didInit=!0},prepare:function(e,t,a,s){return $.isFunction(t)?(this._callback=t,this._boardID=a||0,this._threadIDs=e,this._environment=s,this._didInit||this._init(),this._proxy.setOption("data",{actionName:"prepareMove",className:"wbb\\data\\thread\\ThreadAction",objectIDs:this._threadIDs,parameters:{boardID:this._boardID}}),this._proxy.setOption("success",$.proxy(this._success,this)),void this._proxy.sendRequest()):void console.debug("[WBB.Thread.MoveHandler] Given callback is invalid.")},_success:function(e){this._dialog.data("objectIDs",e.objectIDs).html(e.returnValues.template),this._dialog.wcfDialog({title:WCF.Language.get("wbb.thread.edit.moveThreads")}),this._dialog.find(".formSubmit > input[type=submit]").click($.proxy(this._move,this))},_move:function(){var e=this._dialog.find("#showMoveNotice").prop("checked"),t=parseInt(this._dialog.find("#boardID").prop("value"));if(t){if(t==this._boardID&&1==this._threadIDs.length&&"thread"===this._environment)return this._dialog.find("#boardID").next("small.innerError").remove(),void $('<small class="innerError">'+WCF.Language.get("wbb.thread.edit.moveDestination.error.equalsOrigin")+"</small>").insertAfter(this._dialog.find("#boardID"));this._proxy.setOption("data",{actionName:"move",className:"wbb\\data\\thread\\ThreadAction",objectIDs:this._dialog.data("objectIDs"),parameters:{boardID:t,showMoveNotice:e}}),this._proxy.setOption("success",$.proxy(function(e){this._callback(e)},this)),this._proxy.sendRequest()}this._dialog.wcfDialog("close")}},WBB.Thread.TypeChooser=Class.extend({_boardIDsContainer:null,_type:0,init:function(e){this._type=parseInt(e),this._boardIDsContainer=$("#boardIDsContainer");var t=$("input[name=type]").click($.proxy(this._click,this)),a=this;t.each(function(e,t){var s=$(t);return s.prop("value")==a._type?(s.prop("checked","checked"),a._update(),!1):void 0})},_click:function(e){this._type=parseInt($(e.currentTarget).prop("value")),this._update()},_update:function(){switch(this._type){case 0:case 1:this._boardIDsContainer.hide();break;case 2:this._boardIDsContainer.show();

}}}),WBB.Thread.LastPageHandler=Class.extend({_action:"",_isLoading:!1,_lastPostTime:0,_pageNo:0,_proxy:null,_threadID:0,init:function(e,t,a){this._isLoading=!1,this._lastPostTime=t,this._pageNo=a,this._threadID=e,this._action="",this._proxy=new WCF.Action.Proxy({showLoadingOverlay:!1,success:$.proxy(this._success,this),suppressErrors:!0}),new WCF.Action.Scroll(300,$.proxy(this._scroll,this),window,".wbbThreadPostList")},_scroll:function(e){e.stop(),this._action="getNewPosts",this._proxy.setOption("data",{actionName:"getNewPosts",className:"wbb\\data\\thread\\ThreadAction",objectIDs:[this._threadID],parameters:{countPosts:!0,lastPostTime:this._lastPostTime}}),this._proxy.sendRequest()},_success:function(e){if("getNewPosts"===this._action){if(e.returnValues.newPostsCount>0){var t=WCF.Language.get("wbb.thread.newPosts",{newPostsCount:e.returnValues.newPostsCount}),a=$('<p id="wbbNewPostsLink" class="info pointer">'+t+"</p>").insertAfter($(".wbbThreadPostList"));a.click($.proxy(this._click,this))}}else e.returnValues.redirectURL?window.location=e.returnValues.redirectURL:($("#wbbNewPostsLink").remove(),$(e.returnValues.template).insertBefore($("#messageQuickReply")),e.returnValues.nextPageNotice&&$('<p class="info">'+e.returnValues.nextPageNotice+"</p>").insertAfter($(".wbbThreadPostList")),$("#messageQuickReply").data("lastPostTime",e.returnValues.lastPostTime))},_click:function(e){return this._isLoading?!1:($(e.currentTarget).removeClass("pointer"),this._isLoading=!0,this._action="loadPosts",this._proxy.setOption("data",{actionName:"getNewPosts",className:"wbb\\data\\thread\\ThreadAction",objectIDs:[this._threadID],parameters:{countPosts:!1,lastPostTime:this._lastPostTime,pageNo:this._pageNo}}),void this._proxy.sendRequest())}}),WBB.Thread.MarkAsDone=Class.extend({_proxy:null,_updateHandler:null,_threads:{},init:function(e){this._updateHandler=e,this._threads={},this._proxy=new WCF.Action.Proxy({success:$.proxy(this._success,this)});var t=this;$(".wbbThread").each(function(e,a){var s=$(a),i=s.data("threadID");t._threads[i]=s,s.data("canMarkAsDone")&&t.watch(i)}),this._updateHandler.setMarkAsDoneHandler(this)},watch:function(e){this._threads[e]&&this._threads[e].data("canMarkAsDone")&&this._threads[e].find(".jsIconDone, .jsIconUndone").data("threadID",e).dblclick($.proxy(this._dblclick,this))},_dblclick:function(e){var t=$(e.currentTarget),a=t.hasClass("jsIconDone")?!0:!1;this._proxy.setOption("data",{actionName:(a?"un":"")+"done",className:"wbb\\data\\thread\\ThreadAction",objectIDs:[t.data("threadID")]}),this._proxy.sendRequest()},_success:function(e){for(var t in e.returnValues.threadData)this._updateHandler.update(t,e.returnValues.threadData[t])}}),WBB.Thread.SimilarThreads=Class.extend({_proxy:null,_element:null,_boardID:0,init:function(e,t){this._element=e,this._boardID=t,this._proxy=new WCF.Action.Proxy({showLoadingOverlay:!1,success:$.proxy(this._success,this)}),e.on("blur",$.proxy(this._load,this))},_load:function(e){var t=$(e.currentTarget),a=t.val(),s=null;if(""!=a&&a.length>3){var i=$("#languageIDContainer > input[name=languageID]");i.length&&(s=i.val()),this._proxy.setOption("data",{actionName:"getSimilarThreads",className:"wbb\\data\\thread\\ThreadAction",parameters:{topic:a,boardID:this._boardID,languageID:s}}),this._proxy.sendRequest()}else this._element.parent().find(".wbbInlineSimilarThreadList").remove()},_success:function(e){this._element.parent().find(".wbbInlineSimilarThreadList").length>0?this._element.parent().find(".wbbInlineSimilarThreadList").replaceWith(e.returnValues.template):this._element.parent().append(e.returnValues.template)}}),WBB.Thread.WatchedThreadList=Class.extend({_button:null,_markAllCheckbox:null,init:function(){this._button=$("#stopWatchingButton").click($.proxy(this._stopWatching,this)),this._markAllCheckbox=$(".jsMarkAllWatchedThreads").change($.proxy(this._markAll,this)),$(".jsWatchedThread").change($.proxy(this._mark,this))},_mark:function(e){$(e.target).parents("tr").toggleClass("jsMarked"),this._markAllCheckbox.is(":checked")?this._markAllCheckbox.prop("checked",!1):this._markAllCheckbox.prop("checked",0==$(".jsWatchedThread:not(:checked)").length),this._updateButtonLabel()},_markAll:function(){$(".jsWatchedThread").prop("checked",this._markAllCheckbox.prop("checked")).parents("tr").toggleClass("jsMarked",this._markAllCheckbox.prop("checked")),this._updateButtonLabel()},_stopWatching:function(){var e=$(".jsWatchedThread:checked"),t=[],a=!1;e.length?e.each(function(e,a){t.push($(a).data("objectID"))}):a=!0;var s="wbb.thread.watchedThreads.stopWatchingMarked.confirmMessage";a&&(s="wbb.thread.watchedThreads.stopWatchingAll.confirmMessage"),WCF.System.Confirmation.show(WCF.Language.get(s),function(e){"confirm"===e&&new WCF.Action.Proxy({autoSend:!0,data:{actionName:"stopWatching",className:"wbb\\data\\thread\\ThreadAction",parameters:{stopWatchingAll:a,threadIDs:t}},success:function(){window.location.reload()}})})},_updateButtonLabel:function(){var e=$(".jsWatchedThread:checked"),t="";t=e.length?WCF.Language.get("wbb.thread.watchedThreads.stopWatchingMarked",{count:e.length}):WCF.Language.get("wbb.thread.watchedThreads.stopWatchingAll"),this._button.html(t)}}),WBB.Post={},WBB.Post.Add={},WBB.Post.Add.MessageOptions=Class.extend({_subscribeButton:null,init:function(){this._subscribeButton=$(".jsSubscribeButton"),WCF.System.Event.addListener("com.woltlab.wcf.redactor","updateMessageOptions",$.proxy(this._updateMessageOptions,this)),WCF.System.Event.addListener("com.woltlab.wcf.objectWatch","updatedSubscription",$.proxy(this._updateMessageOptions,this))},_updateMessageOptions:function(){var e=$("#settings_text").find("input[name=subscribeThread]");e.length&&(this._subscribeButton.data("isSubscribed")?e.prop("checked","checked"):e.prop("checked",!1))}}),WBB.Post.Clipboard=Class.extend({_postHandler:null,_threadUpdateHandler:null,init:function(postHandler){this._postHandler=postHandler,$(".jsClipboardEditor").each($.proxy(function(index,container){var $container=$(container),$types=eval($container.data("types"));return WCF.inArray("com.woltlab.wbb.post",$types)?($container.on("clipboardAction",$.proxy(this._execute,this)),$container.on("clipboardActionResponse",$.proxy(this._evaluateResponse,this)),!1):void 0},this))},setThreadUpdateHandler:function(e){this._threadUpdateHandler=e},_execute:function(e,t,a,s){if("com.woltlab.wbb.post"===t)switch(a){case"com.woltlab.wbb.post.copyToExistingThread":WBB.Post.CopyToExistingThread.prepare(s);break;case"com.woltlab.wbb.post.copyToNewThread":WBB.Post.CopyToNewThread.prepare(s);break;case"com.woltlab.wbb.post.merge":var i=new WBB.Post.MergeHandler(s.objectIDs);i.load();break;case"com.woltlab.wbb.post.moveToNewThread":WBB.Post.MoveToNewThread.prepare(s)}},_evaluateResponse:function(e,t,a,s){if("com.woltlab.wbb.post"===a){if("com.woltlab.wbb.post.moveToExistingThread"===s){var i=new WCF.System.Notification;return void i.show(function(){window.location=t.returnValues.redirectURL})}if(t.returnValues.postData&&$.getLength(t.returnValues.postData)&&this._postHandler.updatePosts(t),this._threadUpdateHandler&&t.returnValues.threadData&&$.getLength(t.returnValues.threadData))for(var o in t.returnValues.threadData)this._threadUpdateHandler.update(o,t.returnValues.threadData[o])}}}),WBB.Post.MergeHandler=WBB.Thread.MergeHandler.extend({init:function(e){this._super(e),this._className="wbb\\data\\post\\PostAction",this._dialogTitle=WCF.Language.get("wbb.post.edit.merge"),this._successMessage=WCF.Language.get("wbb.post.edit.merge.success")},_success:function(e,t,a){this._super(e,t,a),void 0===e.returnValues.redirectURL&&this._dialog.find(".formSubmit > button[data-type=submit]").enable()},_getParameters:function(){var e=[];return this._dialog.find(".jsPostContainer").each(function(t,a){e.push($(a).data("postID"))}),{postOrder:e}}}),WBB.Post.CopyToExistingThread={prepare:function(e){new WCF.System.Worker("copyToExistingThread","wbb\\data\\post\\PostAction",WCF.Language.get("wbb.post.copy.title"),e)}},WBB.Post.CopyToNewThread={_boardSelect:null,_dialog:null,_objectIDs:[],_submitButton:null,_topic:null,prepare:function(e){null===this._dialog?(this._dialog=$("<div>"+e.template+"</div>").hide().appendTo(document.body),this._dialog.wcfDialog({title:WCF.Language.get("wbb.post.copy.title")})):this._dialog.html($.parseHTML(e.template)).wcfDialog("open"),this._boardSelect=$("#postCopyNewThreadBoardID"),this._objectIDs=e.objectIDs,this._submitButton=this._dialog.find(".formSubmit > button[data-type=submit]").disable().click($.proxy(this._submit,this)),this._topic=$("#postCopyNewThreadTopic").keyup($.proxy(this._keyUp,this)).focus(),$.browser.mozilla&&$.browser.touch&&this._topic.on("input",$.proxy(this._keyUp,this))},_keyUp:function(){$.trim(this._topic.val()).length>0?this._submitButton.enable():this._submitButton.disable()},_submit:function(){this._dialog.wcfDialog("close"),new WCF.System.Worker("copyToNewThread","wbb\\data\\post\\PostAction",WCF.Language.get("wbb.post.copy.title"),{boardID:parseInt(this._boardSelect.val()),objectIDs:this._objectIDs,topic:$.trim(this._topic.val())})}},WBB.Post.MoveToNewThread={_boardSelect:null,_dialog:null,_objectIDs:[],_submitButton:null,_topic:null,prepare:function(e){null===this._dialog?(this._dialog=$("<div>"+e.template+"</div>").hide().appendTo(document.body),this._dialog.wcfDialog({title:WCF.Language.get("wbb.post.moveToNewThread")})):this._dialog.html($.parseHTML(e.template)).wcfDialog("open"),this._boardSelect=$("#postMoveNewThreadBoardID"),this._objectIDs=e.objectIDs,this._submitButton=this._dialog.find(".formSubmit > button[data-type=submit]").disable().click($.proxy(this._submit,this)),this._topic=$("#postMoveNewThreadTopic").keyup($.proxy(this._keyUp,this)).focus(),$.browser.mozilla&&$.browser.touch&&this._topic.on("input",$.proxy(this._keyUp,this))},_keyUp:function(){$.trim(this._topic.val()).length>0?this._submitButton.enable():this._submitButton.disable()},_submit:function(){this._submitButton.disable(),new WCF.Action.Proxy({autoSend:!0,data:{actionName:"moveToNewThread",className:"wbb\\data\\post\\PostAction",objectIDs:this._objectIDs,parameters:{boardID:parseInt(this._boardSelect.val()),topic:$.trim(this._topic.val())}},success:$.proxy(this._success,this)})},_success:function(e){var t=new WCF.System.Notification;t.show(function(){window.location=e.returnValues.redirectURL})}},WBB.Post.Preview=WCF.Popover.extend({_proxy:null,init:function(){this._super(".wbbTopicLink, .wbbPostLink"),this._proxy=new WCF.Action.Proxy({showLoadingOverlay:!1}),WCF.DOMNodeInsertedHandler.addCallback("WBB.Post.Preview",$.proxy(this._initContainers,this))},_loadContent:function(){var e=$("#"+this._activeElementID);e.hasClass("wbbTopicLink")?this._proxy.setOption("data",{actionName:"getPostPreview",className:"wbb\\data\\thread\\ThreadAction",objectIDs:[e.data("threadID")],parameters:{sortOrder:e.data("sortOrder")?e.data("sortOrder"):"ASC"}}):this._proxy.setOption("data",{actionName:"getPostPreview",className:"wbb\\data\\post\\PostAction",objectIDs:[e.data("postID")]});var t=this._activeElementID,a=this;this._proxy.setOption("success",function(e){a._insertContent(t,e.returnValues.template,!0)}),this._proxy.setOption("failure",function(e){return a._insertContent(t,e.message,!0),!1}),this._proxy.sendRequest()}}),WBB.Post.Handler=Class.extend({_callbacks:{},_editor:null,_collapsedPostLoader:null,_posts:{},_proxy:null,_selector:"",_threadUpdateHandler:null,init:function(e){this._callbacks={},this._editor=null,this._selector=e,this._proxy=new WCF.Action.Proxy({success:$.proxy(this.updatePosts,this)}),this._initPosts(),WCF.DOMNodeInsertedHandler.addCallback("WBB.Post.Handler",$.proxy(this._initPosts,this))},setCollapsedPostLoader:function(e){this._collapsedPostLoader=e},setPostEditor:function(e){this._editor=e},setPost:function(e,t){this._posts[e]=t},setThreadUpdateHandler:function(e){this._threadUpdateHandler=e},_initPosts:function(){$(this._selector).each($.proxy(function(e,t){var a=$(t),s=a.data("objectID");void 0===this._posts[s]&&this.setPost(s,a)},this))},updateAllPosts:function(e,t){var a={};for(var s in this._posts)a[s]={},a[s][e]=t;this.updatePosts({returnValues:{postData:a}})},updatePosts:function(e){var t=[];for(var a in e.returnValues.postData)if(void 0!==this._posts[a]){var s=this._posts[a],i=e.returnValues.postData[a];for(var o in i)s.data(o,i[o]),"isDeleted"===o?i[o]?s.addClass("messageDeleted"):(s.hasClass("wbbPostDeleted")&&t.push(a),s.removeClass("messageDeleted"),s.find(".wbbPostDeleteNote").remove()):"isDisabled"===o?i[o]?s.addClass("messageDisabled"):s.removeClass("messageDisabled"):"deleted"===o?s.parent().remove():"isClosed"===o&&(i[o]?s.find(".messageQuickOptions").prepend($('<li class="wbbPostClosed"><span class="jsTooltip icon icon16 icon-lock" title="'+WCF.Language.get("wbb.post.closed")+'"></span></li>')):s.find(".wbbPostClosed").remove());if(this._callbacks[a]){for(var n=0,r=this._callbacks[a].length;r>n;n++)this._callbacks[a][n]();delete this._callbacks[a]}}if(t.length&&this._collapsedPostLoader&&this._collapsedPostLoader.loadPosts(t),this._threadUpdateHandler&&e.returnValues.threadData)for(var d in e.returnValues.threadData)this._threadUpdateHandler.update(d,e.returnValues.threadData[d]);null!==this._editor&&this._editor.rebuild(),WCF.Clipboard.reload()},update:function(e,t,a,s){a=a||{},this._proxy.setOption("data",{actionName:t,className:"wbb\\data\\post\\PostAction",objectIDs:[e],parameters:a}),this._proxy.sendRequest(),$.isFunction(s)&&(this._callbacks[e]||(this._callbacks[e]=[]),this._callbacks[e].push(s))},getPost:function(e){return this._posts[e]?this._posts[e]:null}}),WBB.Post.Like=WCF.Like.extend({_getContainers:function(){return $("article.message:not(.messageCollapsed)")},_getObjectID:function(e){return this._containers[e].data("postID")},_getWidgetContainer:function(e){return this._containers[e].find(".messageHeader")},_buildWidget:function(e,t,a,s,i){var o=this._getWidgetContainer(e);if(this._canLike){var n=this._containers[e].find(".smallButtons");t.insertBefore(n.find(".toTopLink")),a.insertBefore(n.find(".toTopLink")),a.find("a").addClass("button"),t.find("a").addClass("button")}i&&(i.appendTo(this._containers[e].find(".messageBody > .messageFooter")),i.addClass("messageFooterNote")),o.find(".permalink").after(s)},_setActiveState:function(e,t,a){e=e.find(".button").removeClass("active"),t=t.find(".button").removeClass("active"),1==a?e.addClass("active"):-1==a&&t.addClass("active")},_addWidget:function(){}}),WBB.Post.InlineEditor=WCF.Message.InlineEditor.extend({_postHandler:null,init:function(e,t,a){this._super(e,!0,a),this._postHandler=t,this._postHandler.setPostEditor(this)},_getClassName:function(){return"wbb\\data\\post\\PostAction"},_initDropdownMenu:function(e,t){var a=this._container[e],s=a.data("objectID");if(a.data("canEnable")){var i=$('<li class="jsEnablePost"><span>'+WCF.Language.get("wbb.post.edit.enable")+"</span></li>").appendTo(t);i.data("postID",s).data("actionName","enable").click($.proxy(this._updatePost,this));var o=$('<li class="jsDisablePost"><span>'+WCF.Language.get("wbb.post.edit.disable")+"</span></li>").appendTo(t);o.data("postID",s).data("actionName","disable").click($.proxy(this._updatePost,this)),(a.data("isDisabled")||a.data("isDeleted"))&&o.hide(),(!a.data("isDisabled")||a.data("isDeleted"))&&i.hide()}if(a.data("canClose")){var n=$('<li class="jsClosePost"><span>'+WCF.Language.get("wbb.post.edit.close")+"</span></li>").appendTo(t),r=$('<li class="jsOpenPost"><span>'+WCF.Language.get("wbb.post.edit.open")+"</span></li>").appendTo(t);n.data("postID",s).data("actionName","close").click($.proxy(this._updatePost,this)),r.data("postID",s).data("actionName","open").click($.proxy(this._updatePost,this)),a.data("isClosed")?n.hide():r.hide()}if(a.data("canDelete")){var d=$('<li class="jsDeletePost"><span>'+WCF.Language.get("wbb.post.edit.delete")+"</span></li>").appendTo(t);d.data("postID",s).data("actionName","trash").click($.proxy(this._updatePost,this)),a.data("isDeleted")&&d.hide()}if(a.data("canRestore")){var l=$('<li class="jsRestorePost"><span>'+WCF.Language.get("wbb.post.edit.restore")+"</span></li>").appendTo(t);l.data("postID",s).data("actionName","restore").click($.proxy(this._updatePost,this)),a.data("isDeleted")||l.hide()}if(a.data("canDeleteCompletely")){var c=$('<li class="jsDeletePostCompletely"><span>'+WCF.Language.get("wbb.post.edit.deleteCompletely")+"</span></li>").appendTo(t);c.data("postID",s).data("actionName","delete").click($.proxy(this._updatePost,this)),a.data("isDeleted")||c.hide()}a.data("canEdit")&&($('<li class="dropdownDivider" />').appendTo(t),$("<li><span>"+WCF.Language.get("wbb.post.edit")+"</span></li>").click($.proxy(function(){this._click(null,e)},this)).appendTo(t))},_updatePost:function(e){{var t=$(e.currentTarget);this._postHandler.getPost(t.data("postID"))}switch(t.data("actionName")){case"trash":var a=$("<fieldset><dl></dl></fieldset>");$('<dt><label for="postTrashReason">'+WCF.Language.get("wbb.post.edit.trash.reason")+"</label></dt>").appendTo(a.children("dl")),$('<dd><textarea id="postTrashReason" name="reason" cols="40" rows="3" /></dd>').appendTo(a.children("dl")),WCF.System.Confirmation.show(WCF.Language.get("wbb.post.edit.trash.confirmMessage"),$.proxy(function(e){"confirm"===e&&this._postHandler.update(t.data("postID"),t.data("actionName"),{reason:$("#postTrashReason").val()},function(){(new WCF.System.Notification).show()})},this),"",a);break;case"delete":WCF.System.Confirmation.show(WCF.Language.get("wbb.post.edit.delete.confirmMessage"),$.proxy(function(e){"confirm"===e&&this._postHandler.update(t.data("postID"),t.data("actionName"),void 0,function(){(new WCF.System.Notification).show()})},this));break;default:this._postHandler.update(t.data("postID"),t.data("actionName"),void 0,function(){(new WCF.System.Notification).show()})}},rebuild:function(){for(var e in this._container){var t=this._container[e],a=t.data("objectID");if(void 0!==this._dropdowns[a]){var s=this._dropdowns[a];s.children(".jsEnablePost, .jsDisablePost, .jsClosePost, .jsOpenPost, .jsRestorePost, .jsDeletePostCompletely, .jsDeletePost").hide(),t.data("canClose")&&(t.data("isClosed")?s.children(".jsOpenPost").show():s.children(".jsClosePost").show()),t.data("isDeleted")?(t.data("canRestore")&&s.children(".jsRestorePost").show(),t.data("canDeleteCompletely")&&s.children(".jsDeletePostCompletely").show()):t.data("canDelete")&&s.children(".jsDeletePost").show(),t.data("canEnable")&&!t.data("isDeleted")&&(t.data("isDisabled")?s.children(".jsEnablePost").show():s.children(".jsDisablePost").show())}}},_getHash:function(e){return"#post"+e}}),WBB.Post.CollapsedPostLoader=Class.extend({_postHandler:null,_posts:{},_proxy:null,init:function(e){var t=this;$(e).each(function(e,a){var s=$(a).data("postID"),i=$("#post"+s);t._posts[s]=i.click($.proxy(t._loadPost,t))}),$.getLength(this._posts)&&(this._proxy=new WCF.Action.Proxy({success:$.proxy(this._success,this)}))},setPostHandler:function(e){this._postHandler=e,this._postHandler.setCollapsedPostLoader(this)},loadPosts:function(e){this._proxy.setOption("data",{actionName:"getPosts",className:"wbb\\data\\post\\PostAction",objectIDs:e,parameters:{showCollapsedPosts:!0}}),this._proxy.sendRequest()},_loadPost:function(e){var t=$(e.target);"a"!==t.getTagName()&&"input"!==t.getTagName()&&this.loadPosts([$(e.currentTarget).children("article").data("postID")])},_success:function(e){var t=$(""+e.returnValues.template);t.each($.proxy(function(e,a){var s=$(a);if(s.is("li")){var i=s.children("article"),o=i.data("postID");this._posts[o]&&(1===t.length&&s.hide(),this._posts[o].replaceWith(s),1===t.length&&s.wcfFadeIn(function(){var e=new WCF.Effect.Scroll;e.scrollTo(s,!0)}),this._postHandler&&this._postHandler.setPost(o,i))}},this)),WCF.Clipboard.reload()}}),WBB.Post.IPAddressHandler=Class.extend({_cache:{},_dialog:null,_proxy:null,init:function(){this._cache={},this._dialog=null,this._proxy=new WCF.Action.Proxy({success:$.proxy(this._success,this)}),this._initButtons(),WCF.DOMNodeInsertedHandler.addCallback("WBB.Post.IPAddressHandler",$.proxy(this._initButtons,this))},_initButtons:function(){var e=this;$(".jsIpAddress").each(function(t,a){var s=$(a),i=s.data("postID");void 0===e._cache[i]&&(e._cache[i]="",s.click($.proxy(e._click,e)))})},_click:function(e){e.preventDefault();var t=$(e.currentTarget).data("postID");this._cache[t]?this._showDialog(t):(this._proxy.setOption("data",{actionName:"getIpLog",className:"wbb\\data\\post\\PostAction",parameters:{postID:t}}),this._proxy.sendRequest())},_success:function(e){this._cache[e.returnValues.postID]=e.returnValues.template,this._showDialog(e.returnValues.postID)},_showDialog:function(e){null===this._dialog&&(this._dialog=$('<div id="wbbIpAddressLog" />').hide().appendTo(document.body)),this._dialog.html(this._cache[e]),this._dialog.wcfDialog({title:WCF.Language.get("wbb.post.ipAddress.title")}),this._dialog.wcfDialog("render")}}),WBB.Post.QuoteHandler=WCF.Message.Quote.Handler.extend({init:function(e){this._super(e,"wbb\\data\\post\\PostAction","com.woltlab.wbb.post",".message",".messageBody",".messageBody > div > div.messageText",!0)}});